schema_version: "1.0"
sample_id: "ms_tc_006"
vulnerability_type: "price_oracle_manipulation"
vulnerable_lines: [102]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    lines: [20]
    code: "IOracle public oracle;"
    security_function: "PREREQ"
    rationale: "PREREQ because this stores the oracle contract reference. The oracle can be manipulated via flash loan attacks on underlying AMM pools."

  - id: "CA2"
    type: "DECLARATION"
    lines: [23]
    code: "mapping(address => uint256) public collateralFactors;"
    security_function: "BENIGN"
    rationale: "Collateral factor storage. Correctly implemented."

  - id: "CA3"
    type: "DECLARATION"
    lines: [26]
    code: "mapping(address => mapping(address => uint256)) public userDeposits;"
    security_function: "BENIGN"
    rationale: "User deposit tracking. Correctly implemented."

  - id: "CA4"
    type: "DECLARATION"
    lines: [29]
    code: "mapping(address => mapping(address => uint256)) public userBorrows;"
    security_function: "BENIGN"
    rationale: "User borrow tracking. Correctly implemented."

  - id: "CA5"
    type: "DECLARATION"
    lines: [32]
    code: "mapping(address => bool) public supportedMarkets;"
    security_function: "BENIGN"
    rationale: "Market support tracking. Correctly implemented."

  - id: "CA6"
    type: "INITIALIZATION"
    lines: [37, 38, 39]
    code: "constructor(address _oracle) { oracle = IOracle(_oracle); }"
    security_function: "BENIGN"
    rationale: "Constructor correctly sets oracle address."

  - id: "CA7"
    type: "INPUT_VAL"
    lines: [48]
    code: 'require(supportedMarkets[cToken], "Market not supported");'
    security_function: "BENIGN"
    rationale: "Market validation check. Correctly implemented."

  - id: "CA8"
    type: "STATE_MOD"
    lines: [55]
    code: "userDeposits[msg.sender][cToken] += amount;"
    security_function: "BENIGN"
    rationale: "Updates user deposit balance. Correctly implemented."

  - id: "CA9"
    type: "EVENT_EMIT"
    lines: [57]
    code: "emit Deposit(msg.sender, cToken, amount);"
    security_function: "BENIGN"
    rationale: "Event emission for deposit. Correctly implemented."

  - id: "CA10"
    type: "INPUT_VAL"
    lines: [61]
    code: 'require(supportedMarkets[cToken], "Market not supported");'
    security_function: "BENIGN"
    rationale: "Market validation in borrow. Correctly implemented."

  - id: "CA11"
    type: "COMPUTATION"
    lines: [64]
    code: "uint256 borrowPower = calculateBorrowPower(msg.sender);"
    security_function: "PREREQ"
    rationale: "PREREQ because this calls calculateBorrowPower which uses manipulable oracle prices. Returns inflated value during attack."

  - id: "CA12"
    type: "COMPUTATION"
    lines: [67]
    code: "uint256 currentBorrows = calculateTotalBorrows(msg.sender);"
    security_function: "BENIGN"
    rationale: "Calculates current borrow value. Correctly implemented."

  - id: "CA13"
    type: "EXT_CALL"
    lines: [70, 71]
    code: "uint256 borrowValue = (oracle.getUnderlyingPrice(cToken) * amount) / 1e18;"
    security_function: "PREREQ"
    rationale: "PREREQ - Uses same manipulable oracle as CA20, but this calculates borrow value (not collateral). The primary exploit is via collateral inflation (CA20), this is secondary."

  - id: "CA14"
    type: "INPUT_VAL"
    lines: [74, 75, 76, 77]
    code: 'require(currentBorrows + borrowValue <= borrowPower, "Insufficient collateral");'
    security_function: "PREREQ"
    rationale: "PREREQ because this check uses borrowPower calculated from manipulated oracle prices. Check passes because attacker's collateral is valued at $1.5B instead of $500M."

  - id: "CA15"
    type: "STATE_MOD"
    lines: [80]
    code: "userBorrows[msg.sender][cToken] += amount;"
    security_function: "BENIGN"
    rationale: "Updates borrow balance. Correctly implemented."

  - id: "CA16"
    type: "EVENT_EMIT"
    lines: [86]
    code: "emit Borrow(msg.sender, cToken, amount);"
    security_function: "BENIGN"
    rationale: "Event emission for borrow. Correctly implemented."

  # --- calculateBorrowPower function ---

  - id: "CA17"
    type: "DECLARATION"
    lines: [89, 90]
    code: "function calculateBorrowPower(address user) public view returns (uint256)"
    security_function: "BENIGN"
    rationale: "Function signature and local variable declaration."

  - id: "CA18"
    type: "DECLARATION"
    lines: [94]
    code: "address[] memory markets = new address[](2);"
    security_function: "BENIGN"
    rationale: "Placeholder market array. Correctly implemented."

  - id: "CA19"
    type: "CTRL_FLOW"
    lines: [96, 97, 98, 100]
    code: "for loop iterating through markets"
    security_function: "BENIGN"
    rationale: "Loop iteration. Correctly implemented."

  - id: "CA20"
    type: "EXT_CALL"
    lines: [102]
    code: "uint256 price = oracle.getUnderlyingPrice(cToken);"
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - Oracle call returns manipulated spot price. During attack, yUSD price is artificially inflated by draining Curve pool. This inflated price multiplies collateral value from $500M to $1.5B."

  - id: "CA21"
    type: "COMPUTATION"
    lines: [105]
    code: "uint256 value = (balance * price) / 1e18;"
    security_function: "BENIGN"
    rationale: "Arithmetic propagation of price. The computation itself is correct - it just processes the already-corrupted oracle price from CA20."

  - id: "CA22"
    type: "COMPUTATION"
    lines: [108]
    code: "uint256 power = (value * collateralFactors[cToken]) / 1e18;"
    security_function: "BENIGN"
    rationale: "Applies collateral factor. Correctly implemented - processes already-corrupted value."

  - id: "CA23"
    type: "STATE_MOD"
    lines: [110]
    code: "totalPower += power;"
    security_function: "BENIGN"
    rationale: "Accumulates borrow power. Correctly implemented - processes already-corrupted value."

  - id: "CA24"
    type: "CTRL_FLOW"
    lines: [114]
    code: "return totalPower;"
    security_function: "BENIGN"
    rationale: "Return statement."

  # --- calculateTotalBorrows function ---

  - id: "CA25"
    type: "DECLARATION"
    lines: [122, 123]
    code: "function calculateTotalBorrows(address user) public view returns (uint256)"
    security_function: "BENIGN"
    rationale: "Function signature and local variable declaration."

  - id: "CA26"
    type: "DECLARATION"
    lines: [126]
    code: "address[] memory markets = new address[](2);"
    security_function: "BENIGN"
    rationale: "Placeholder market array."

  - id: "CA27"
    type: "CTRL_FLOW"
    lines: [128, 129, 130, 132]
    code: "for loop iterating through markets"
    security_function: "BENIGN"
    rationale: "Loop iteration. Correctly implemented."

  - id: "CA28"
    type: "EXT_CALL"
    lines: [133]
    code: "uint256 price = oracle.getUnderlyingPrice(cToken);"
    security_function: "BENIGN"
    rationale: "Oracle call for borrow valuation. While using same oracle, this doesn't contribute to the attack since attackers want HIGH collateral value."

  - id: "CA29"
    type: "COMPUTATION"
    lines: [134, 135]
    code: "uint256 value = (borrowed * price) / 1e18; totalBorrows += value;"
    security_function: "BENIGN"
    rationale: "Borrow value calculation. Correctly implemented."

  - id: "CA30"
    type: "CTRL_FLOW"
    lines: [139]
    code: "return totalBorrows;"
    security_function: "BENIGN"
    rationale: "Return statement."

  # --- addMarket function ---

  - id: "CA31"
    type: "STATE_MOD"
    lines: [147, 148, 149, 150]
    code: "function addMarket(address cToken, uint256 collateralFactor) external"
    security_function: "SECONDARY_VULN"
    rationale: "SECONDARY_VULN - Admin function has NO ACCESS CONTROL. Anyone can add markets or change collateral factors."

  # ============================================
  # UNRELATED CODE ACTS (batched)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [19, 22, 25, 28, 31, 41, 42, 43, 44, 45, 46, 50, 51, 52, 54, 63, 66, 69, 73, 79, 82, 83, 84, 92, 93, 101, 104, 107, 117, 118, 119, 120, 121, 125, 142, 143, 144, 145, 146]
    security_function: "UNRELATED"
    rationale: "Inline comments and NatSpec documentation"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 6, 8, 9, 11, 13, 15, 16, 18, 47, 58, 60, 87, 111, 112, 115, 136, 137, 140, 151]
    security_function: "UNRELATED"
    rationale: "Interface, contract, and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [113, 138]
    security_function: "UNRELATED"
    rationale: "Closing braces and structural tokens"

  - id: "CA_EVENT_DEFS"
    type: "EVENT_DEF"
    lines: [34, 35]
    security_function: "UNRELATED"
    rationale: "Event declarations"

summary:
  total_code_acts: 36
  total_lines_covered: 113  # excludes empty lines

  by_security_function:
    ROOT_CAUSE: 1      # CA20
    SECONDARY_VULN: 1  # CA31
    PREREQ: 4          # CA1, CA11, CA13, CA14
    BENIGN: 25         # CA2-CA10, CA12, CA15-CA19, CA21-CA30
    UNRELATED: 5       # batched

  root_causes:
    - id: "CA20"
      line: 102
      type: "EXT_CALL"
      description: "Oracle spot price in calculateBorrowPower() - inflates collateral value"

  secondary_vulnerabilities:
    - id: "CA31"
      lines: [147, 148, 149, 150]
      type: "STATE_MOD"
      description: "addMarket has no access control"

  prerequisites:
    - id: "CA1"
      description: "Oracle storage - stores manipulable price source"
    - id: "CA11"
      description: "calculateBorrowPower call uses manipulated prices"
    - id: "CA13"
      description: "Secondary oracle call in borrow() - same manipulable source"
    - id: "CA14"
      description: "Collateral check passes with inflated values"

line_to_code_act:
    1: "CA_DIRECTIVES"
    2: "CA_DIRECTIVES"
    # Line 3: empty
    4: "CA_DECLARATIONS"
    5: "CA_DECLARATIONS"
    6: "CA_DECLARATIONS"
    # Line 7: empty
    8: "CA_DECLARATIONS"
    9: "CA_DECLARATIONS"
    # Line 10: empty
    11: "CA_DECLARATIONS"
    # Line 12: empty
    13: "CA_DECLARATIONS"
    # Line 14: empty
    15: "CA_DECLARATIONS"
    16: "CA_DECLARATIONS"
    # Line 17: empty
    18: "CA_DECLARATIONS"
    19: "CA_COMMENTS"
    20: "CA1"
    # Line 21: empty
    22: "CA_COMMENTS"
    23: "CA2"
    # Line 24: empty
    25: "CA_COMMENTS"
    26: "CA3"
    # Line 27: empty
    28: "CA_COMMENTS"
    29: "CA4"
    # Line 30: empty
    31: "CA_COMMENTS"
    32: "CA5"
    # Line 33: empty
    34: "CA_EVENT_DEFS"
    35: "CA_EVENT_DEFS"
    # Line 36: empty
    37: "CA6"
    38: "CA6"
    39: "CA6"
    # Line 40: empty
    41: "CA_COMMENTS"
    42: "CA_COMMENTS"
    43: "CA_COMMENTS"
    44: "CA_COMMENTS"
    45: "CA_COMMENTS"
    46: "CA_COMMENTS"
    47: "CA_DECLARATIONS"
    48: "CA7"
    # Line 49: empty
    50: "CA_COMMENTS"
    51: "CA_COMMENTS"
    52: "CA_COMMENTS"
    # Line 53: empty
    54: "CA_COMMENTS"
    55: "CA8"
    # Line 56: empty
    57: "CA9"
    58: "CA_DECLARATIONS"
    # Line 59: empty
    60: "CA_DECLARATIONS"
    61: "CA10"
    # Line 62: empty
    63: "CA_COMMENTS"
    64: "CA11"
    # Line 65: empty
    66: "CA_COMMENTS"
    67: "CA12"
    # Line 68: empty
    69: "CA_COMMENTS"
    70: "CA13"
    71: "CA13"
    # Line 72: empty
    73: "CA_COMMENTS"
    74: "CA14"
    75: "CA14"
    76: "CA14"
    77: "CA14"
    # Line 78: empty
    79: "CA_COMMENTS"
    80: "CA15"
    # Line 81: empty
    82: "CA_COMMENTS"
    83: "CA_COMMENTS"
    84: "CA_COMMENTS"
    # Line 85: empty
    86: "CA16"
    87: "CA_DECLARATIONS"
    # Line 88: empty
    89: "CA17"
    90: "CA17"
    # Line 91: empty
    92: "CA_COMMENTS"
    93: "CA_COMMENTS"
    94: "CA18"
    # Line 95: empty
    96: "CA19"
    97: "CA19"
    98: "CA19"
    # Line 99: empty
    100: "CA19"
    101: "CA_COMMENTS"
    102: "CA20"
    # Line 103: empty
    104: "CA_COMMENTS"
    105: "CA21"
    # Line 106: empty
    107: "CA_COMMENTS"
    108: "CA22"
    # Line 109: empty
    110: "CA23"
    111: "CA_DECLARATIONS"
    112: "CA_DECLARATIONS"
    # Line 113: empty
    # Line 114: empty (well, has return)
    114: "CA24"
    115: "CA_DECLARATIONS"
    # Line 116: empty
    117: "CA_COMMENTS"
    118: "CA_COMMENTS"
    119: "CA_COMMENTS"
    120: "CA_COMMENTS"
    121: "CA_COMMENTS"
    122: "CA25"
    123: "CA25"
    # Line 124: empty
    125: "CA_COMMENTS"
    126: "CA26"
    # Line 127: empty
    128: "CA27"
    129: "CA27"
    130: "CA27"
    # Line 131: empty
    132: "CA27"
    133: "CA28"
    134: "CA29"
    135: "CA29"
    136: "CA_DECLARATIONS"
    137: "CA_DECLARATIONS"
    # Line 138: empty
    # Line 139: empty (well, has return)
    139: "CA30"
    140: "CA_DECLARATIONS"
    # Line 141: empty
    142: "CA_COMMENTS"
    143: "CA_COMMENTS"
    144: "CA_COMMENTS"
    145: "CA_COMMENTS"
    146: "CA_COMMENTS"
    147: "CA31"
    148: "CA31"
    149: "CA31"
    150: "CA31"
    151: "CA_DECLARATIONS"
    # Line 152: empty

code_act_security_functions:
  CA1: "PREREQ"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "PREREQ"
  CA12: "BENIGN"
  CA13: "PREREQ"
  CA14: "PREREQ"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA17: "BENIGN"
  CA18: "BENIGN"
  CA19: "BENIGN"
  CA20: "ROOT_CAUSE"
  CA21: "BENIGN"
  CA22: "BENIGN"
  CA23: "BENIGN"
  CA24: "BENIGN"
  CA25: "BENIGN"
  CA26: "BENIGN"
  CA27: "BENIGN"
  CA28: "BENIGN"
  CA29: "BENIGN"
  CA30: "BENIGN"
  CA31: "SECONDARY_VULN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"
  CA_EVENT_DEFS: "UNRELATED"

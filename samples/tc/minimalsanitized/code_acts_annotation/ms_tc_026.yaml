schema_version: "1.0"
sample_id: "ms_tc_026"
vulnerability_type: "price_oracle_manipulation"
vulnerable_lines: [31, 45]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    lines: [14, 15, 16]
    code: |
      address public wantToken;
      address public oracle;
      uint256 public totalShares;
    security_function: "BENIGN"
    rationale: "Storage declarations. The declarations themselves don't enable the exploit."

  - id: "CA2"
    type: "DECLARATION"
    lines: [18]
    code: "mapping(address => uint256) public shares;"
    security_function: "BENIGN"
    rationale: "User shares mapping. Correctly implemented."

  - id: "CA3"
    type: "INITIALIZATION"
    lines: [20, 21, 22, 23]
    code: |
      constructor(address _want, address _oracle) {
          wantToken = _want;
          oracle = _oracle;
      }
    security_function: "BENIGN"
    rationale: "Constructor sets token and oracle. Correctly implemented."

  - id: "CA4"
    type: "EXT_CALL"
    lines: [26]
    code: "uint256 pool = IERC20(wantToken).balanceOf(address(this));"
    security_function: "BENIGN"
    rationale: "Balance read. Correctly implemented."

  - id: "CA5"
    type: "CTRL_FLOW"
    lines: [28, 29, 30]
    code: |
      if (totalShares == 0) {
          sharesAdded = amount;
      } else {
    security_function: "BENIGN"
    rationale: "First deposit case. Correctly handles initial shares."

  - id: "CA6"
    type: "EXT_CALL"
    lines: [31]
    code: "uint256 price = IPriceOracle(oracle).getPrice(wantToken);"
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - Gets price from manipulable oracle. Flash loan can temporarily lower price, allowing attacker to get more shares than deserved."

  - id: "CA7"
    type: "COMPUTATION"
    lines: [32, 33]
    code: |
      sharesAdded = (amount * totalShares * 1e18) / (pool * price);
      }
    security_function: "BENIGN"
    rationale: "Share calculation using price. Downstream computation that consumes the manipulated oracle price."

  - id: "CA8"
    type: "STATE_MOD"
    lines: [35, 36]
    code: |
      shares[msg.sender] += sharesAdded;
      totalShares += sharesAdded;
    security_function: "BENIGN"
    rationale: "Share state updates. Correctly implemented."

  - id: "CA9"
    type: "EXT_CALL"
    lines: [38, 39, 40]
    code: |
      IERC20(wantToken).transferFrom(msg.sender, address(this), amount);
      return sharesAdded;
      }
    security_function: "BENIGN"
    rationale: "Token transfer. Correctly transfers amount."

  - id: "CA10"
    type: "EXT_CALL"
    lines: [43]
    code: "uint256 pool = IERC20(wantToken).balanceOf(address(this));"
    security_function: "BENIGN"
    rationale: "Balance read in withdraw. Correctly implemented."

  - id: "CA11"
    type: "EXT_CALL"
    lines: [45]
    code: "uint256 price = IPriceOracle(oracle).getPrice(wantToken);"
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - Gets price from manipulable oracle during withdrawal. Attacker manipulates price UP to get more tokens per share."

  - id: "CA12"
    type: "COMPUTATION"
    lines: [46]
    code: "uint256 amount = (sharesAmount * pool * price) / (totalShares * 1e18);"
    security_function: "BENIGN"
    rationale: "Withdrawal amount calculation. Downstream computation using manipulated price."

  - id: "CA13"
    type: "STATE_MOD"
    lines: [48, 49]
    code: |
      shares[msg.sender] -= sharesAmount;
      totalShares -= sharesAmount;
    security_function: "BENIGN"
    rationale: "Share decrement. Correctly implemented."

  - id: "CA14"
    type: "EXT_CALL"
    lines: [51, 52]
    code: |
      IERC20(wantToken).transfer(msg.sender, amount);
      }
    security_function: "BENIGN"
    rationale: "Token transfer on withdrawal."

  # ============================================
  # BATCHED UNRELATED CODE ACTS (for scoring)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: []
    security_function: "UNRELATED"
    rationale: "No standalone comments"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 6, 7, 9, 10, 11, 13, 25, 42, 53]
    security_function: "UNRELATED"
    rationale: "Interface, contract, and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: []
    security_function: "UNRELATED"
    rationale: "Closing braces included in respective code_acts"

summary:
  total_code_acts: 18
  total_lines_covered: 40

  by_security_function:
    ROOT_CAUSE: 2      # CA6, CA11
    PREREQ: 0
    BENIGN: 12         # CA1-CA5, CA7-CA10, CA12-CA14
    UNRELATED: 4       # batched

  root_causes:
    - id: "CA6"
      line: 31
      type: "EXT_CALL"
      description: "Oracle price in deposit is manipulable"
    - id: "CA11"
      line: 45
      type: "EXT_CALL"
      description: "Oracle price in withdraw is manipulable"

  prerequisites: []

line_to_code_act:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  6: "CA_DECLARATIONS"
  7: "CA_DECLARATIONS"
  # Line 8: empty
  9: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  # Line 12: empty
  13: "CA_DECLARATIONS"
  14: "CA1"
  15: "CA1"
  16: "CA1"
  # Line 17: empty
  18: "CA2"
  # Line 19: empty
  20: "CA3"
  21: "CA3"
  22: "CA3"
  23: "CA3"
  # Line 24: empty
  25: "CA_DECLARATIONS"
  26: "CA4"
  # Line 27: empty
  28: "CA5"
  29: "CA5"
  30: "CA5"
  31: "CA6"
  32: "CA7"
  33: "CA7"
  # Line 34: empty
  35: "CA8"
  36: "CA8"
  # Line 37: empty
  38: "CA9"
  39: "CA9"
  40: "CA9"
  # Line 41: empty
  42: "CA_DECLARATIONS"
  43: "CA10"
  # Line 44: empty
  45: "CA11"
  46: "CA12"
  # Line 47: empty
  48: "CA13"
  49: "CA13"
  # Line 50: empty
  51: "CA14"
  52: "CA14"
  53: "CA_DECLARATIONS"
  # Line 54: empty

code_act_security_functions:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "ROOT_CAUSE"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "ROOT_CAUSE"
  CA12: "BENIGN"
  CA13: "BENIGN"
  CA14: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

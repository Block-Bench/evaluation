schema_version: "1.0"
sample_id: "ms_tc_007"
vulnerability_type: "arithmetic_error"
vulnerable_lines: [157, 159]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  # --- State Variables ---

  - id: "CA1"
    type: "DECLARATION"
    lines: [6, 7]
    code: |
      address public token0;
      address public token1;
    security_function: "BENIGN"
    rationale: "Token address storage. Correctly implemented."

  - id: "CA2"
    type: "DECLARATION"
    lines: [10, 11, 12]
    code: |
      uint160 public sqrtPriceX96;
      int24 public currentTick;
      uint128 public liquidity;
    security_function: "BENIGN"
    rationale: "State variable declarations. These are neutral storage - the vulnerability is in the arithmetic operations, not in having these variables."

  - id: "CA3"
    type: "DECLARATION"
    lines: [15]
    code: "mapping(int24 => int128) public liquidityNet;"
    security_function: "BENIGN"
    rationale: "Mapping declaration. The existence of this storage is not the vulnerability - the issue is the unchecked arithmetic that uses its values."

  - id: "CA4"
    type: "DECLARATION"
    lines: [18, 19, 20, 21, 22]
    code: "struct Position { uint128 liquidity; int24 tickLower; int24 tickUpper; }"
    security_function: "BENIGN"
    rationale: "Position struct declaration. Correctly implemented."

  - id: "CA5"
    type: "DECLARATION"
    lines: [24]
    code: "mapping(bytes32 => Position) public positions;"
    security_function: "BENIGN"
    rationale: "Position storage mapping. Correctly implemented."

  # --- addLiquidity function ---

  - id: "CA6"
    type: "INPUT_VAL"
    lines: [54, 55]
    code: |
      require(tickLower < tickUpper, "Invalid ticks");
      require(liquidityDelta > 0, "Zero liquidity");
    security_function: "BENIGN"
    rationale: "Input validation checks. Correctly implemented."

  - id: "CA7"
    type: "COMPUTATION"
    lines: [58, 59, 60]
    code: "bytes32 positionKey = keccak256(abi.encodePacked(msg.sender, tickLower, tickUpper));"
    security_function: "BENIGN"
    rationale: "Position key computation. Correctly implemented."

  - id: "CA8"
    type: "STATE_MOD"
    lines: [63, 64, 65, 66]
    code: "Position storage position = positions[positionKey]; position.liquidity += liquidityDelta; ..."
    security_function: "BENIGN"
    rationale: "Updates position state. Correctly implemented."

  - id: "CA9"
    type: "STATE_MOD"
    lines: [69, 70]
    code: |
      liquidityNet[tickLower] += int128(liquidityDelta);
      liquidityNet[tickUpper] -= int128(liquidityDelta);
    security_function: "PREREQ"
    rationale: "PREREQ because these modifications set up liquidityNet values that can be manipulated to trigger arithmetic errors during tick crossings."

  - id: "CA10"
    type: "CTRL_FLOW"
    lines: [73, 74, 75]
    code: "if (currentTick >= tickLower && currentTick < tickUpper) { liquidity += liquidityDelta; }"
    security_function: "BENIGN"
    rationale: "Updates active liquidity if in range. Correctly implemented."

  - id: "CA11"
    type: "COMPUTATION"
    lines: [78, 79, 80, 81, 82, 83]
    code: "(amount0, amount1) = _calculateAmounts(sqrtPriceX96, tickLower, tickUpper, int128(liquidityDelta));"
    security_function: "BENIGN"
    rationale: "Calculates required token amounts. Simplified implementation."

  - id: "CA12"
    type: "EVENT_EMIT"
    lines: [85]
    code: "emit LiquidityAdded(msg.sender, tickLower, tickUpper, liquidityDelta);"
    security_function: "BENIGN"
    rationale: "Event emission. Correctly implemented."

  # --- swap function ---

  - id: "CA13"
    type: "INPUT_VAL"
    lines: [93]
    code: 'require(amountSpecified != 0, "Zero amount");'
    security_function: "BENIGN"
    rationale: "Input validation. Correctly implemented."

  - id: "CA14"
    type: "DECLARATION"
    lines: [96, 97, 98]
    code: |
      uint160 sqrtPriceX96Next = sqrtPriceX96;
      uint128 liquidityNext = liquidity;
      int24 tickNext = currentTick;
    security_function: "BENIGN"
    rationale: "Local state copies for swap simulation."

  - id: "CA15"
    type: "CTRL_FLOW"
    lines: [102]
    code: "while (amountSpecified != 0) {"
    security_function: "BENIGN"
    rationale: "Swap loop control. Correctly implemented - allows processing of swap amount."

  - id: "CA16"
    type: "COMPUTATION"
    lines: [104, 105, 106, 107, 108, 109, 110, 111, 112, 113]
    code: "_computeSwapStep(sqrtPriceX96Next, sqrtPriceLimitX96, liquidityNext, amountSpecified);"
    security_function: "BENIGN"
    rationale: "Computes swap step amounts. Simplified implementation."

  - id: "CA17"
    type: "STATE_MOD"
    lines: [116]
    code: "sqrtPriceX96Next = sqrtPriceX96Target;"
    security_function: "BENIGN"
    rationale: "Updates next price. Correctly implemented."

  - id: "CA18"
    type: "COMPUTATION"
    lines: [119]
    code: "int24 tickCrossed = _getTickAtSqrtRatio(sqrtPriceX96Next);"
    security_function: "BENIGN"
    rationale: "Tick calculation. Correctly implemented."

  - id: "CA19"
    type: "CTRL_FLOW"
    lines: [120]
    code: "if (tickCrossed != tickNext) {"
    security_function: "BENIGN"
    rationale: "Tick crossing detection. Correctly implemented."

  - id: "CA20"
    type: "STORAGE_READ"
    lines: [122]
    code: "int128 liquidityNetAtTick = liquidityNet[tickCrossed];"
    security_function: "PREREQ"
    rationale: "PREREQ because this retrieves the liquidityNet value that can be crafted to cause overflow/underflow."

  - id: "CA21"
    type: "CTRL_FLOW"
    lines: [124, 125, 126]
    code: "if (zeroForOne) { liquidityNetAtTick = -liquidityNetAtTick; }"
    security_function: "BENIGN"
    rationale: "Direction-based sign adjustment. Correctly implemented."

  - id: "CA22"
    type: "COMPUTATION"
    lines: [128, 129, 130, 131]
    code: "liquidityNext = _addLiquidity(liquidityNext, liquidityNetAtTick);"
    security_function: "BENIGN"
    rationale: "Internal function call to _addLiquidity. The call itself is correct - the vulnerability is in the _addLiquidity function (CA29, CA30). (Note: Changed from EXT_CALL since _addLiquidity is an internal function.)"

  - id: "CA23"
    type: "STATE_MOD"
    lines: [133]
    code: "tickNext = tickCrossed;"
    security_function: "BENIGN"
    rationale: "Updates tick tracking. Correctly implemented."

  - id: "CA24"
    type: "CTRL_FLOW"
    lines: [137, 138, 139, 140, 141]
    code: "if (amountSpecified > 0) { ... } else { ... }"
    security_function: "BENIGN"
    rationale: "Updates remaining amount. Correctly implemented."

  - id: "CA25"
    type: "STATE_MOD"
    lines: [145, 146, 147]
    code: |
      sqrtPriceX96 = sqrtPriceX96Next;
      liquidity = liquidityNext;
      currentTick = tickNext;
    security_function: "PREREQ"
    rationale: "PREREQ because this persists the corrupted liquidity value to storage, enabling token extraction."

  - id: "CA26"
    type: "CTRL_FLOW"
    lines: [149]
    code: "return (amount0, amount1);"
    security_function: "BENIGN"
    rationale: "Return statement."

  # --- _addLiquidity function (VULNERABLE) ---

  - id: "CA27"
    type: "DECLARATION"
    lines: [152, 153, 154, 155]
    code: "function _addLiquidity(uint128 x, int128 y) internal pure returns (uint128 z) {"
    security_function: "BENIGN"
    rationale: "Function signature declaration."

  - id: "CA28"
    type: "CTRL_FLOW"
    lines: [156]
    code: "if (y < 0) {"
    security_function: "BENIGN"
    rationale: "Branch selection in _addLiquidity. Correctly determines which arithmetic operation to use."

  - id: "CA29"
    type: "ARITHMETIC"
    lines: [157]
    code: "z = x - uint128(-y);"
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - Unchecked subtraction that can underflow. When y is a large negative value and x is small, this underflows, resulting in a massive liquidity value."

  - id: "CA30"
    type: "ARITHMETIC"
    lines: [159]
    code: "z = x + uint128(y);"
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - Unchecked addition that can overflow. When x and y are both large positive values, this can overflow and wrap around to a small value."

  # --- Helper functions ---

  - id: "CA31"
    type: "COMPUTATION"
    lines: [167, 168, 169, 170, 171, 172, 175, 176, 177]
    code: "function _calculateAmounts(...) internal pure returns (...)"
    security_function: "BENIGN"
    rationale: "Simplified amount calculation helper."

  - id: "CA32"
    type: "COMPUTATION"
    lines: [182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 193, 194, 195, 196, 197, 198]
    code: "function _computeSwapStep(...) internal pure returns (...)"
    security_function: "BENIGN"
    rationale: "Simplified swap step computation."

  - id: "CA33"
    type: "COMPUTATION"
    lines: [203, 204, 205, 207, 208]
    code: "function _getTickAtSqrtRatio(...) internal pure returns (...)"
    security_function: "BENIGN"
    rationale: "Simplified tick calculation."

  # ============================================
  # UNRELATED CODE ACTS (batched)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [5, 9, 14, 17, 41, 42, 43, 44, 45, 46, 47, 48, 57, 62, 68, 72, 77, 95, 100, 101, 103, 115, 118, 121, 136, 144, 164, 165, 166, 173, 174, 179, 180, 181, 192, 200, 201, 202, 206]
    security_function: "UNRELATED"
    rationale: "Inline comments and NatSpec documentation"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 23, 49, 50, 51, 52, 53, 86, 88, 89, 90, 91, 92, 150, 161, 162, 178, 199, 209]
    security_function: "UNRELATED"
    rationale: "Contract, struct, and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [114, 127, 134, 142, 160]
    security_function: "UNRELATED"
    rationale: "Closing braces and structural tokens"

  - id: "CA_EVENT_DEFS"
    type: "EVENT_DEF"
    lines: [26, 27, 28, 29, 30, 31, 32, 34, 35, 36, 37, 38, 39]
    security_function: "UNRELATED"
    rationale: "Event declarations"

summary:
  total_code_acts: 38
  total_lines_covered: 179  # excludes empty lines

  by_security_function:
    ROOT_CAUSE: 2      # CA29, CA30
    PREREQ: 3          # CA9, CA20, CA25
    BENIGN: 28         # CA1-CA8, CA10-CA19, CA21-CA24, CA26-CA28, CA31-CA33
    UNRELATED: 5       # batched

  root_causes:
    - id: "CA29"
      line: 157
      type: "ARITHMETIC"
      description: "Unchecked subtraction can underflow"
    - id: "CA30"
      line: 159
      type: "ARITHMETIC"
      description: "Unchecked addition can overflow"

  prerequisites:
    - id: "CA9"
      description: "Sets up liquidityNet values for exploitation"
    - id: "CA20"
      description: "Retrieves crafted liquidityNet value"
    - id: "CA25"
      description: "Persists corrupted liquidity to storage"

line_to_code_act:
    1: "CA_DIRECTIVES"
    2: "CA_DIRECTIVES"
    # Line 3: empty
    4: "CA_DECLARATIONS"
    5: "CA_COMMENTS"
    6: "CA1"
    7: "CA1"
    # Line 8: empty
    9: "CA_COMMENTS"
    10: "CA2"
    11: "CA2"
    12: "CA2"
    # Line 13: empty
    14: "CA_COMMENTS"
    15: "CA3"
    # Line 16: empty
    17: "CA_COMMENTS"
    18: "CA4"
    19: "CA4"
    20: "CA4"
    21: "CA4"
    22: "CA4"
    # Line 23: empty
    24: "CA5"
    # Line 25: empty
    26: "CA_EVENT_DEFS"
    27: "CA_EVENT_DEFS"
    28: "CA_EVENT_DEFS"
    29: "CA_EVENT_DEFS"
    30: "CA_EVENT_DEFS"
    31: "CA_EVENT_DEFS"
    32: "CA_EVENT_DEFS"
    # Line 33: empty
    34: "CA_EVENT_DEFS"
    35: "CA_EVENT_DEFS"
    36: "CA_EVENT_DEFS"
    37: "CA_EVENT_DEFS"
    38: "CA_EVENT_DEFS"
    39: "CA_EVENT_DEFS"
    # Line 40: empty
    41: "CA_COMMENTS"
    42: "CA_COMMENTS"
    43: "CA_COMMENTS"
    44: "CA_COMMENTS"
    45: "CA_COMMENTS"
    46: "CA_COMMENTS"
    47: "CA_COMMENTS"
    48: "CA_COMMENTS"
    49: "CA_DECLARATIONS"
    50: "CA_DECLARATIONS"
    51: "CA_DECLARATIONS"
    52: "CA_DECLARATIONS"
    53: "CA_DECLARATIONS"
    54: "CA6"
    55: "CA6"
    # Line 56: empty
    57: "CA_COMMENTS"
    58: "CA7"
    59: "CA7"
    60: "CA7"
    # Line 61: empty
    62: "CA_COMMENTS"
    63: "CA8"
    64: "CA8"
    65: "CA8"
    66: "CA8"
    # Line 67: empty
    68: "CA_COMMENTS"
    69: "CA9"
    70: "CA9"
    # Line 71: empty
    72: "CA_COMMENTS"
    73: "CA10"
    74: "CA10"
    75: "CA10"
    # Line 76: empty
    77: "CA_COMMENTS"
    78: "CA11"
    79: "CA11"
    80: "CA11"
    81: "CA11"
    82: "CA11"
    83: "CA11"
    # Line 84: empty
    85: "CA12"
    86: "CA_DECLARATIONS"
    # Line 87: empty
    88: "CA_DECLARATIONS"
    89: "CA_DECLARATIONS"
    90: "CA_DECLARATIONS"
    91: "CA_DECLARATIONS"
    92: "CA_DECLARATIONS"
    93: "CA13"
    # Line 94: empty
    95: "CA_COMMENTS"
    96: "CA14"
    97: "CA14"
    98: "CA14"
    # Line 99: empty
    100: "CA_COMMENTS"
    101: "CA_COMMENTS"
    102: "CA15"
    103: "CA_COMMENTS"
    104: "CA16"
    105: "CA16"
    106: "CA16"
    107: "CA16"
    108: "CA16"
    109: "CA16"
    110: "CA16"
    111: "CA16"
    112: "CA16"
    113: "CA16"
    # Line 114: empty
    # Line 115: empty (well, comment)
    115: "CA_COMMENTS"
    116: "CA17"
    # Line 117: empty
    118: "CA_COMMENTS"
    119: "CA18"
    120: "CA19"
    121: "CA_COMMENTS"
    122: "CA20"
    # Line 123: empty
    124: "CA21"
    125: "CA21"
    126: "CA21"
    # Line 127: empty
    128: "CA22"
    129: "CA22"
    130: "CA22"
    131: "CA22"
    # Line 132: empty
    133: "CA23"
    134: "CA_SYNTAX"
    # Line 135: empty
    136: "CA_COMMENTS"
    137: "CA24"
    138: "CA24"
    139: "CA24"
    140: "CA24"
    141: "CA24"
    142: "CA_SYNTAX"
    # Line 143: empty
    144: "CA_COMMENTS"
    145: "CA25"
    146: "CA25"
    147: "CA25"
    # Line 148: empty
    149: "CA26"
    150: "CA_DECLARATIONS"
    # Line 151: empty
    152: "CA27"
    153: "CA27"
    154: "CA27"
    155: "CA27"
    156: "CA28"
    157: "CA29"
    158: "CA_SYNTAX"
    159: "CA30"
    160: "CA_SYNTAX"
    # Line 161: empty
    162: "CA_DECLARATIONS"
    # Line 163: empty
    164: "CA_COMMENTS"
    165: "CA_COMMENTS"
    166: "CA_COMMENTS"
    167: "CA31"
    168: "CA31"
    169: "CA31"
    170: "CA31"
    171: "CA31"
    172: "CA31"
    173: "CA_COMMENTS"
    174: "CA_COMMENTS"
    175: "CA31"
    176: "CA31"
    177: "CA31"
    # Line 178: empty
    179: "CA_COMMENTS"
    180: "CA_COMMENTS"
    181: "CA_COMMENTS"
    182: "CA32"
    183: "CA32"
    184: "CA32"
    185: "CA32"
    186: "CA32"
    187: "CA32"
    188: "CA32"
    189: "CA32"
    190: "CA32"
    191: "CA32"
    192: "CA_COMMENTS"
    193: "CA32"
    194: "CA32"
    195: "CA32"
    196: "CA32"
    197: "CA32"
    198: "CA32"
    # Line 199: empty
    200: "CA_COMMENTS"
    201: "CA_COMMENTS"
    202: "CA_COMMENTS"
    203: "CA33"
    204: "CA33"
    205: "CA33"
    206: "CA_COMMENTS"
    207: "CA33"
    208: "CA33"
    209: "CA_DECLARATIONS"
    # Line 210: empty

code_act_security_functions:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "PREREQ"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "BENIGN"
  CA14: "BENIGN"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA17: "BENIGN"
  CA18: "BENIGN"
  CA19: "BENIGN"
  CA20: "PREREQ"
  CA21: "BENIGN"
  CA22: "BENIGN"
  CA23: "BENIGN"
  CA24: "BENIGN"
  CA25: "PREREQ"
  CA26: "BENIGN"
  CA27: "BENIGN"
  CA28: "BENIGN"
  CA29: "ROOT_CAUSE"
  CA30: "ROOT_CAUSE"
  CA31: "BENIGN"
  CA32: "BENIGN"
  CA33: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"
  CA_EVENT_DEFS: "UNRELATED"

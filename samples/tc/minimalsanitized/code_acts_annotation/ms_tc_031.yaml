schema_version: "1.0"
sample_id: "ms_tc_031"
vulnerability_type: "price_manipulation"
vulnerable_lines: [77]

code_acts:

  - id: "CA1"
    type: "COMPUTATION"
    lines: [77]
    code: "shares = (totalSupply * (deposit0 + deposit1)) / (total0 + total1);"
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - Share calculation uses spot balances (total0, total1) which can be manipulated via flashloan. Attacker manipulates pool price, deposits at skewed ratio, receives inflated shares."

  - id: "CA2"
    type: "EXT_CALL"
    lines: [63, 64]
    code: |
      uint256 total0 = token0.balanceOf(address(this));
      uint256 total1 = token1.balanceOf(address(this));
    security_function: "BENIGN"
    rationale: "Spot balance reads. These feed into CA1 - the vulnerability is using these for pricing (CA1), not the reads themselves."

  - id: "CA3"
    type: "EXT_CALL"
    lines: [67, 68]
    code: |
      token0.transferFrom(msg.sender, address(this), deposit0);
      token1.transferFrom(msg.sender, address(this), deposit1);
    security_function: "BENIGN"
    rationale: "Token transfers from depositor."

  - id: "CA4"
    type: "CTRL_FLOW"
    lines: [70, 71, 72, 74, 75, 78]
    code: "Share calculation branches"
    security_function: "BENIGN"
    rationale: "Control flow for share calculation."

  - id: "CA5"
    type: "STATE_MOD"
    lines: [82, 83]
    code: |
      balanceOf[to] += shares;
      totalSupply += shares;
    security_function: "BENIGN"
    rationale: "State updates for minted shares."

  - id: "CA6"
    type: "CTRL_FLOW"
    lines: [86]
    code: "_addLiquidity(deposit0, deposit1);"
    security_function: "BENIGN"
    rationale: "Add liquidity call."

  - id: "CA7"
    type: "INPUT_VAL"
    lines: [96]
    code: 'require(balanceOf[msg.sender] >= shares, "Insufficient balance");'
    security_function: "BENIGN"
    rationale: "Balance check in withdraw."

  - id: "CA8"
    type: "EXT_CALL"
    lines: [98, 99]
    code: "Balance reads in withdraw"
    security_function: "BENIGN"
    rationale: "Balance reads for withdrawal calculation."

  - id: "CA9"
    type: "COMPUTATION"
    lines: [102, 103]
    code: |
      amount0 = (shares * total0) / totalSupply;
      amount1 = (shares * total1) / totalSupply;
    security_function: "BENIGN"
    rationale: "Withdrawal calculation. Downstream value realization using inflated shares."

  - id: "CA10"
    type: "STATE_MOD"
    lines: [105, 106]
    code: |
      balanceOf[msg.sender] -= shares;
      totalSupply -= shares;
    security_function: "BENIGN"
    rationale: "State updates for burned shares."

  - id: "CA11"
    type: "EXT_CALL"
    lines: [109, 110]
    code: |
      token0.transfer(to, amount0);
      token1.transfer(to, amount1);
    security_function: "BENIGN"
    rationale: "Token transfers to withdrawer."

  - id: "CA12"
    type: "CTRL_FLOW"
    lines: [118, 123, 124, 125, 126]
    code: "Rebalance operations"
    security_function: "BENIGN"
    rationale: "Rebalance function. Amplifier that isn't required for exploitation."

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [52, 53, 54, 62, 66, 73, 85, 89, 90, 91, 101, 108, 113, 114, 115, 120, 130, 134]
    security_function: "UNRELATED"
    rationale: "Comments and NatSpec"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 7, 8, 9, 10, 11, 13, 15, 16, 18, 19, 20, 21, 22, 23, 24, 25, 27, 28, 29, 30, 31, 32, 33, 35, 36, 37, 38, 40, 41, 43, 44, 45, 46, 47, 49, 50, 55, 56, 57, 58, 59, 87, 92, 93, 94, 95, 111, 116, 127, 129, 131, 133, 135, 136]
    security_function: "UNRELATED"
    rationale: "Declarations and signatures"

summary:
  total_code_acts: 15
  total_lines_covered: 104

  by_security_function:
    ROOT_CAUSE: 1
    PREREQ: 0
    BENIGN: 11
    UNRELATED: 3

  root_causes:
    - id: "CA1"
      lines: [77]
      description: "Share calculation uses manipulable spot balances"

line_to_code_act:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  # Line 6: empty
  7: "CA_DECLARATIONS"
  8: "CA_DECLARATIONS"
  9: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  # Line 12: empty
  13: "CA_DECLARATIONS"
  # Line 14: empty
  15: "CA_DECLARATIONS"
  16: "CA_DECLARATIONS"
  # Line 17: empty
  18: "CA_DECLARATIONS"
  19: "CA_DECLARATIONS"
  20: "CA_DECLARATIONS"
  21: "CA_DECLARATIONS"
  22: "CA_DECLARATIONS"
  23: "CA_DECLARATIONS"
  24: "CA_DECLARATIONS"
  25: "CA_DECLARATIONS"
  # Line 26: empty
  27: "CA_DECLARATIONS"
  28: "CA_DECLARATIONS"
  29: "CA_DECLARATIONS"
  30: "CA_DECLARATIONS"
  31: "CA_DECLARATIONS"
  32: "CA_DECLARATIONS"
  33: "CA_DECLARATIONS"
  # Line 34: empty
  35: "CA_DECLARATIONS"
  36: "CA_DECLARATIONS"
  37: "CA_DECLARATIONS"
  38: "CA_DECLARATIONS"
  # Line 39: empty
  40: "CA_DECLARATIONS"
  41: "CA_DECLARATIONS"
  # Line 42: empty
  43: "CA_DECLARATIONS"
  44: "CA_DECLARATIONS"
  45: "CA_DECLARATIONS"
  46: "CA_DECLARATIONS"
  47: "CA_DECLARATIONS"
  # Line 48: empty
  49: "CA_DECLARATIONS"
  50: "CA_DECLARATIONS"
  # Line 51: empty
  52: "CA_COMMENTS"
  53: "CA_COMMENTS"
  54: "CA_COMMENTS"
  55: "CA_DECLARATIONS"
  56: "CA_DECLARATIONS"
  57: "CA_DECLARATIONS"
  58: "CA_DECLARATIONS"
  59: "CA_DECLARATIONS"
  # Line 60: empty
  # Line 61: empty
  62: "CA_COMMENTS"
  63: "CA2"
  64: "CA2"
  # Line 65: empty
  66: "CA_COMMENTS"
  67: "CA3"
  68: "CA3"
  # Line 69: empty
  70: "CA4"
  71: "CA4"
  72: "CA4"
  73: "CA_COMMENTS"
  74: "CA4"
  75: "CA4"
  # Line 76: empty
  77: "CA1"
  78: "CA4"
  # Line 79: empty
  # Line 80: empty
  # Line 81: empty
  82: "CA5"
  83: "CA5"
  # Line 84: empty
  85: "CA_COMMENTS"
  86: "CA6"
  87: "CA_DECLARATIONS"
  # Line 88: empty
  89: "CA_COMMENTS"
  90: "CA_COMMENTS"
  91: "CA_COMMENTS"
  92: "CA_DECLARATIONS"
  93: "CA_DECLARATIONS"
  94: "CA_DECLARATIONS"
  95: "CA_DECLARATIONS"
  96: "CA7"
  # Line 97: empty
  98: "CA8"
  99: "CA8"
  # Line 100: empty
  101: "CA_COMMENTS"
  102: "CA9"
  103: "CA9"
  # Line 104: empty
  105: "CA10"
  106: "CA10"
  # Line 107: empty
  108: "CA_COMMENTS"
  109: "CA11"
  110: "CA11"
  111: "CA_DECLARATIONS"
  # Line 112: empty
  113: "CA_COMMENTS"
  114: "CA_COMMENTS"
  115: "CA_COMMENTS"
  116: "CA_DECLARATIONS"
  # Line 117: empty
  118: "CA12"
  # Line 119: empty
  120: "CA_COMMENTS"
  # Line 121: empty
  # Line 122: empty
  123: "CA12"
  124: "CA12"
  125: "CA12"
  126: "CA12"
  127: "CA_DECLARATIONS"
  # Line 128: empty
  129: "CA_DECLARATIONS"
  130: "CA_COMMENTS"
  131: "CA_DECLARATIONS"
  # Line 132: empty
  133: "CA_DECLARATIONS"
  134: "CA_COMMENTS"
  135: "CA_DECLARATIONS"
  136: "CA_DECLARATIONS"
  # Line 137: empty

code_act_security_functions:
  CA1: "ROOT_CAUSE"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"

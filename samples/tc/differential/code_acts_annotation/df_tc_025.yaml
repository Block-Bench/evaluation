schema_version: "1.0"
sample_id: "df_tc_025"
base_sample_id: "ms_tc_025"
vulnerability_type: "accounting_error"
is_fixed: true

fix_summary:
  description: "Added balance check before/after transfer to handle deflationary tokens"
  fix_type: "balance_verification"
  vulnerable_pattern: "Credited full amount without verifying actual receipt"
  fixed_pattern: "Credits actual received amount"

vulnerable_version:
  reference: "../minimalsanitized/code_acts_annotation/ms_tc_025.yaml"
  root_cause_description: "Vault credited full amount but received less due to token fees"

fixed_version:
  fix_lines: [19, 21, 22, 24]
  fix_description: "Added balBefore/balAfter check and credits actual received"

code_acts:

  - id: "CA_FIX1"
    type: "EXT_CALL"
    lines: [19]
    code: "uint256 balBefore = IERC20(token).balanceOf(address(this));"
    security_function: "BENIGN"
    rationale: "FIX - Records balance before transfer"

  - id: "CA_FIX2"
    type: "EXT_CALL"
    lines: [21]
    code: "uint256 balAfter = IERC20(token).balanceOf(address(this));"
    security_function: "BENIGN"
    rationale: "FIX - Records balance after transfer"

  - id: "CA_FIX3"
    type: "COMPUTATION"
    lines: [22]
    code: "uint256 received = balAfter - balBefore;"
    security_function: "BENIGN"
    rationale: "FIX - Calculates actual received amount"

  - id: "CA_FIX4"
    type: "STATE_MOD"
    lines: [24]
    code: "deposits[msg.sender] += received;"
    security_function: "BENIGN"
    rationale: "FIX - Credits actual received amount, not requested"

  - id: "CA1"
    type: "DECLARATION"
    lines: [11, 12]
    code: |
      address public token;
      mapping(address => uint256) public deposits;
    security_function: "BENIGN"
    rationale: "State variables"

  - id: "CA2"
    type: "INITIALIZATION"
    lines: [14, 15, 16]
    code: |
      constructor(address _token) {
          token = _token;
      }
    security_function: "BENIGN"
    rationale: "Constructor"

  - id: "CA3"
    type: "EXT_CALL"
    lines: [20]
    code: "IERC20(token).transferFrom(msg.sender, address(this), amount);"
    security_function: "BENIGN"
    rationale: "Token transfer"

  - id: "CA4"
    type: "CTRL_FLOW"
    lines: [25]
    code: "}"
    security_function: "BENIGN"
    rationale: "Deposit function close"

  - id: "CA5"
    type: "INPUT_VAL"
    lines: [28]
    code: 'require(deposits[msg.sender] >= amount, "Insufficient");'
    security_function: "BENIGN"
    rationale: "Withdrawal validation"

  - id: "CA6"
    type: "STATE_MOD"
    lines: [30]
    code: "deposits[msg.sender] -= amount;"
    security_function: "BENIGN"
    rationale: "Deposit decrement"

  - id: "CA7"
    type: "EXT_CALL"
    lines: [32, 33, 34]
    code: |
      IERC20(token).transfer(msg.sender, amount);
      }
      }
    security_function: "BENIGN"
    rationale: "Withdrawal transfer"

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: []
    security_function: "UNRELATED"
    rationale: "No standalone comments"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 6, 7, 8, 10, 18, 27]
    security_function: "UNRELATED"
    rationale: "Interface and function declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: []
    security_function: "UNRELATED"
    rationale: "Braces included in code_acts"

summary:
  total_code_acts_fixed: 15

  fix_applied:
    type: "balance_verification"
    description: "Credits actual received amount"
    lines_changed: [19, 21, 22, 24]

  by_security_function_fixed:
    BENIGN: 11
    UNRELATED: 4

line_to_code_act_fixed:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  6: "CA_DECLARATIONS"
  7: "CA_DECLARATIONS"
  8: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  11: "CA1"
  12: "CA1"
  14: "CA2"
  15: "CA2"
  16: "CA2"
  18: "CA_DECLARATIONS"
  19: "CA_FIX1"
  20: "CA3"
  21: "CA_FIX2"
  22: "CA_FIX3"
  24: "CA_FIX4"
  25: "CA4"
  27: "CA_DECLARATIONS"
  28: "CA5"
  30: "CA6"
  32: "CA7"
  33: "CA7"
  34: "CA7"

code_act_security_functions_fixed:
  CA_FIX1: "BENIGN"
  CA_FIX2: "BENIGN"
  CA_FIX3: "BENIGN"
  CA_FIX4: "BENIGN"
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

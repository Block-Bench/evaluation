schema_version: "1.0"
sample_id: "df_tc_015"
base_sample_id: "ms_tc_015"
vulnerability_type: "pool_manipulation"
is_fixed: true

fix_summary:
  description: "Removed automatic weight update. Added time-based update with TWAP calculation."
  fix_type: "manipulation_resistance"
  vulnerable_pattern: "Weight update after every swap based on spot balances"
  fixed_pattern: "Time-gated weight updates with TWAP averaging"

vulnerable_version:
  reference: "../minimalsanitized/code_acts_annotation/ms_tc_015.yaml"
  # vulnerable_lines (reference only): [56, 101]
  root_cause_description: "_updateWeights after swap allows weight manipulation"

fixed_version:
  fix_lines: [21, 22, 23, 77, 78, 84, 89, 90, 91]
  fix_description: "Added lastBalance and lastUpdate tracking (lines 21-22). Added time interval constant (line 23). updateWeights is now external with time check (line 78). Uses TWAP calculation (lines 84, 89). Removed automatic call from swap."

code_acts:

  - id: "CA_FIX1"
    type: "DECLARATION"
    lines: [21, 22, 23]
    code: |
      mapping(address => uint256) public lastBalance;
      mapping(address => uint256) public lastUpdate;
      uint256 public constant WEIGHT_UPDATE_INTERVAL = 1 hours;
    security_function: "BENIGN"
    rationale: "FIX - State for TWAP calculation and time-gating."

  - id: "CA_FIX2"
    type: "STATE_MOD"
    lines: [32, 33]
    code: |
      lastBalance[token] = 0;
      lastUpdate[token] = block.timestamp;
    security_function: "BENIGN"
    rationale: "FIX - Initialize TWAP tracking on token addition."

  - id: "CA_FIX3"
    type: "INPUT_VAL"
    lines: [78]
    code: 'require(block.timestamp - lastUpdate[msg.sender] >= WEIGHT_UPDATE_INTERVAL, "Wait for update interval");'
    security_function: "BENIGN"
    rationale: "FIX - Time-gate prevents rapid weight manipulation."

  - id: "CA_FIX4"
    type: "COMPUTATION"
    lines: [84]
    code: "totalValue += (tokens[token].balance + lastBalance[token]) / 2;"
    security_function: "BENIGN"
    rationale: "FIX - TWAP calculation uses average of current and last balance."

  - id: "CA_FIX5"
    type: "COMPUTATION"
    lines: [89, 90, 91]
    code: |
      tokens[token].weight = ((tokens[token].balance + lastBalance[token]) / 2 * 100) / totalValue;
      lastBalance[token] = tokens[token].balance;
      lastUpdate[token] = block.timestamp;
    security_function: "BENIGN"
    rationale: "FIX - Weight calculation uses TWAP and updates tracking state."

  - id: "CA1"
    type: "DECLARATION"
    lines: [11, 12, 13, 14, 15]
    code: |
      struct Token {
          address addr;
          uint256 balance;
          uint256 weight;
      }
    security_function: "BENIGN"
    rationale: "Token struct."

  - id: "CA2"
    type: "STATE_MOD"
    lines: [45]
    code: "tokens[tokenIn].balance += amountIn;"
    security_function: "BENIGN"
    rationale: "Balance update on swap."

  - id: "CA3"
    type: "COMPUTATION"
    lines: [47]
    code: "amountOut = calculateSwapAmount(tokenIn, tokenOut, amountIn);"
    security_function: "BENIGN"
    rationale: "Swap amount calculation."

  - id: "CA4"
    type: "STATE_MOD"
    lines: [53]
    code: "tokens[tokenOut].balance -= amountOut;"
    security_function: "BENIGN"
    rationale: "Balance update for output token."

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 7, 8, 10, 17, 18, 19, 25, 26, 27, 29, 30, 31, 34, 36, 37, 38, 39, 40, 41, 42, 44, 49, 50, 51, 52, 54, 56, 57, 59, 60, 61, 62, 63, 64, 65, 66, 68, 69, 70, 71, 72, 74, 75, 77, 80, 82, 83, 87, 88, 92, 93, 95, 96, 97, 99, 100, 101, 102, 103, 104]
    security_function: "UNRELATED"
    rationale: "Interface, contract, and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [9, 16, 35, 58, 76, 85, 98]
    security_function: "UNRELATED"
    rationale: "Closing braces"

summary:
  total_code_acts: 12

  fix_applied:
    type: "manipulation_resistance"
    description: "Time-gated TWAP weight updates instead of per-swap updates"
    lines_changed: [21, 22, 23, 32, 33, 78, 84, 89, 90, 91]

  by_security_function_fixed:
    BENIGN: 9
    UNRELATED: 3

line_to_code_act_fixed:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  7: "CA_DECLARATIONS"
  8: "CA_DECLARATIONS"
  # Line 9: empty
  10: "CA_DECLARATIONS"
  11: "CA1"
  12: "CA1"
  13: "CA1"
  14: "CA1"
  15: "CA1"
  # Line 16: empty
  17: "CA_DECLARATIONS"
  18: "CA_DECLARATIONS"
  19: "CA_DECLARATIONS"
  21: "CA_FIX1"
  22: "CA_FIX1"
  23: "CA_FIX1"
  25: "CA_DECLARATIONS"
  26: "CA_DECLARATIONS"
  27: "CA_DECLARATIONS"
  29: "CA_DECLARATIONS"
  30: "CA_DECLARATIONS"
  31: "CA_DECLARATIONS"
  32: "CA_FIX2"
  33: "CA_FIX2"
  34: "CA_DECLARATIONS"
  # Line 35: empty
  36: "CA_DECLARATIONS"
  37: "CA_DECLARATIONS"
  38: "CA_DECLARATIONS"
  39: "CA_DECLARATIONS"
  40: "CA_DECLARATIONS"
  41: "CA_DECLARATIONS"
  42: "CA_DECLARATIONS"
  44: "CA_DECLARATIONS"
  45: "CA2"
  47: "CA3"
  49: "CA_DECLARATIONS"
  50: "CA_DECLARATIONS"
  51: "CA_DECLARATIONS"
  52: "CA_DECLARATIONS"
  53: "CA4"
  54: "CA_DECLARATIONS"
  56: "CA_DECLARATIONS"
  57: "CA_DECLARATIONS"
  # Line 58: empty
  59: "CA_DECLARATIONS"
  60: "CA_DECLARATIONS"
  61: "CA_DECLARATIONS"
  62: "CA_DECLARATIONS"
  63: "CA_DECLARATIONS"
  64: "CA_DECLARATIONS"
  65: "CA_DECLARATIONS"
  66: "CA_DECLARATIONS"
  68: "CA_DECLARATIONS"
  69: "CA_DECLARATIONS"
  70: "CA_DECLARATIONS"
  71: "CA_DECLARATIONS"
  72: "CA_DECLARATIONS"
  74: "CA_DECLARATIONS"
  75: "CA_DECLARATIONS"
  # Line 76: empty
  77: "CA_DECLARATIONS"
  78: "CA_FIX3"
  80: "CA_DECLARATIONS"
  82: "CA_DECLARATIONS"
  83: "CA_DECLARATIONS"
  84: "CA_FIX4"
  85: "CA_SYNTAX"
  87: "CA_DECLARATIONS"
  88: "CA_DECLARATIONS"
  89: "CA_FIX5"
  90: "CA_FIX5"
  91: "CA_FIX5"
  92: "CA_DECLARATIONS"
  93: "CA_DECLARATIONS"
  95: "CA_DECLARATIONS"
  96: "CA_DECLARATIONS"
  97: "CA_DECLARATIONS"
  # Line 98: empty
  99: "CA_DECLARATIONS"
  100: "CA_DECLARATIONS"
  101: "CA_DECLARATIONS"
  102: "CA_DECLARATIONS"
  103: "CA_DECLARATIONS"
  104: "CA_DECLARATIONS"

code_act_security_functions_fixed:
  CA_FIX1: "BENIGN"
  CA_FIX2: "BENIGN"
  CA_FIX3: "BENIGN"
  CA_FIX4: "BENIGN"
  CA_FIX5: "BENIGN"
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

schema_version: "1.0"
sample_id: "df_tc_012"
base_sample_id: "ms_tc_012"
vulnerability_type: "logic_error"
is_fixed: true

fix_summary:
  description: "Added validUnderlying mapping that includes both OLD_TUSD and NEW_TUSD."
  fix_type: "validation_fix"
  vulnerable_pattern: "Checks only underlying (OLD_TUSD) but uses NEW_TUSD"
  fixed_pattern: "Uses validUnderlying mapping containing both tokens"

vulnerable_version:
  reference: "../minimalsanitized/code_acts_annotation/ms_tc_012.yaml"
  # vulnerable_lines (reference only): [39]
  root_cause_description: "sweepToken checked against underlying (OLD_TUSD) but contract uses NEW_TUSD"

fixed_version:
  fix_lines: [27, 31, 32, 33, 37, 44]
  fix_description: "Added validUnderlying mapping (line 27). Constructor sets both OLD and NEW TUSD as valid (lines 31-33). mint validates (line 37). sweepToken uses mapping (line 44)."

code_acts:

  - id: "CA_FIX1"
    type: "DECLARATION"
    lines: [27]
    code: "mapping(address => bool) public validUnderlying;"
    security_function: "BENIGN"
    rationale: "FIX - Mapping to track all valid underlying tokens."

  - id: "CA_FIX2"
    type: "INITIALIZATION"
    lines: [29, 30, 31, 32, 33, 34]
    code: |
      constructor() {
          admin = msg.sender;
          underlying = NEW_TUSD;
          validUnderlying[OLD_TUSD] = true;
          validUnderlying[NEW_TUSD] = true;
      }
    security_function: "BENIGN"
    rationale: "FIX - Constructor now sets underlying to NEW_TUSD and marks both tokens as valid."

  - id: "CA_FIX3"
    type: "INPUT_VAL"
    lines: [37]
    code: 'require(validUnderlying[NEW_TUSD], "Invalid underlying");'
    security_function: "BENIGN"
    rationale: "Validation in mint. Uses validUnderlying."

  - id: "CA_FIX4"
    type: "INPUT_VAL"
    lines: [44]
    code: 'require(!validUnderlying[token], "Cannot sweep underlying token");'
    security_function: "BENIGN"
    rationale: "FIX - sweepToken now checks validUnderlying mapping which includes BOTH OLD and NEW TUSD."

  - id: "CA1"
    type: "DECLARATION"
    lines: [16, 17]
    code: |
      address public underlying;
      address public admin;
    security_function: "BENIGN"
    rationale: "State variable declarations."

  - id: "CA2"
    type: "DECLARATION"
    lines: [22, 23, 24, 25]
    code: |
      address public constant OLD_TUSD = 0x8dd5fbCe2F6a956C3022bA3663759011Dd51e73E;
      address public constant NEW_TUSD = 0x0000000000085d4780B73119b644AE5ecd22b376;
    security_function: "BENIGN"
    rationale: "Token address constants."

  - id: "CA3"
    type: "EXT_CALL"
    lines: [38]
    code: "IERC20(NEW_TUSD).transfer(address(this), amount);"
    security_function: "BENIGN"
    rationale: "Mint transfer."

  - id: "CA4"
    type: "STATE_MOD"
    lines: [39, 40]
    code: |
      accountTokens[msg.sender] += amount;
      totalSupply += amount;
    security_function: "BENIGN"
    rationale: "Mint state updates."

  - id: "CA5"
    type: "EXT_CALL"
    lines: [46, 47]
    code: |
      uint256 balance = IERC20(token).balanceOf(address(this));
      IERC20(token).transfer(msg.sender, balance);
    security_function: "BENIGN"
    rationale: "Sweep transfer. Now properly protected."

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [4, 5, 6, 7]
    security_function: "UNRELATED"
    rationale: "NatSpec documentation"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [9, 10, 11, 12, 13, 15, 19, 20, 36, 43, 50, 51, 53, 54, 56, 57, 58]
    security_function: "UNRELATED"
    rationale: "Interface, contract, and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [14, 41, 48]
    security_function: "UNRELATED"
    rationale: "Closing braces"

summary:
  total_code_acts: 13

  fix_applied:
    type: "validation_fix"
    description: "validUnderlying mapping protects both OLD and NEW token"
    lines_changed: [27, 31, 32, 33, 44]

  by_security_function_fixed:
    BENIGN: 9
    UNRELATED: 4

line_to_code_act_fixed:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  4: "CA_COMMENTS"
  5: "CA_COMMENTS"
  6: "CA_COMMENTS"
  7: "CA_COMMENTS"
  9: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  # Line 11: empty
  12: "CA_DECLARATIONS"
  13: "CA_DECLARATIONS"
  # Line 14: empty
  15: "CA_DECLARATIONS"
  16: "CA1"
  17: "CA1"
  19: "CA_DECLARATIONS"
  20: "CA_DECLARATIONS"
  22: "CA2"
  23: "CA2"
  24: "CA2"
  25: "CA2"
  27: "CA_FIX1"
  29: "CA_FIX2"
  30: "CA_FIX2"
  31: "CA_FIX2"
  32: "CA_FIX2"
  33: "CA_FIX2"
  34: "CA_FIX2"
  36: "CA_DECLARATIONS"
  37: "CA_FIX3"
  38: "CA3"
  39: "CA4"
  40: "CA4"
  41: "CA_SYNTAX"
  43: "CA_DECLARATIONS"
  44: "CA_FIX4"
  46: "CA5"
  47: "CA5"
  48: "CA_SYNTAX"
  50: "CA_DECLARATIONS"
  51: "CA_DECLARATIONS"
  53: "CA_DECLARATIONS"
  54: "CA_DECLARATIONS"
  56: "CA_DECLARATIONS"
  57: "CA_DECLARATIONS"
  58: "CA_DECLARATIONS"

code_act_security_functions_fixed:
  CA_FIX1: "BENIGN"
  CA_FIX2: "BENIGN"
  CA_FIX3: "BENIGN"
  CA_FIX4: "BENIGN"
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

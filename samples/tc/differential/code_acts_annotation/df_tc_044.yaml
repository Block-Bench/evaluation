schema_version: "1.0"
sample_id: "df_tc_044"
base_sample_id: "ms_tc_044"
vulnerability_type: "oracle_manipulation"
is_fixed: true

fix_summary:
  description: "Added virtual reserves, tracked underlying, and minimum liquidity requirements"
  fix_type: "donation_attack_protection"
  vulnerable_pattern: "Exchange rate uses balanceOf allowing donation attacks"
  fixed_pattern: "Uses tracked underlying with virtual reserves for manipulation resistance"

vulnerable_version:
  reference: "../minimalsanitized/code_acts_annotation/ms_tc_044.yaml"
  root_cause_description: "Exchange rate could be manipulated by donating tokens to empty pool"

fixed_version:
  fix_lines: [27, 28, 29, 30, 31, 45, 46, 47, 48, 49, 54, 61, 65, 66, 67, 78, 82]
  fix_description: "Added MINIMUM_LIQUIDITY, VIRTUAL_RESERVE, VIRTUAL_SUPPLY, liquidityBootstrapped, trackedUnderlying and exchange rate protections"

code_acts:

  # ============================================
  # FIX CODE ACTS
  # ============================================

  - id: "CA_FIX1"
    type: "DECLARATION"
    lines: [27, 28, 29, 30, 31]
    code: |
      uint256 public constant MINIMUM_LIQUIDITY = 1e18;
      uint256 public constant VIRTUAL_RESERVE = 1e18;
      uint256 public constant VIRTUAL_SUPPLY = 1e8;
      bool public liquidityBootstrapped;
      uint256 public trackedUnderlying;
    security_function: "BENIGN"
    rationale: "FIX - Constants and state for donation attack protection."

  - id: "CA_FIX2"
    type: "COMPUTATION"
    lines: [46, 47, 49]
    code: |
      // Use tracked underlying instead of balanceOf
      uint256 totalUnderlying = trackedUnderlying + totalBorrows - totalReserves + VIRTUAL_RESERVE;
      uint256 effectiveSupply = totalSupply + VIRTUAL_SUPPLY;
      return (totalUnderlying * 1e18) / effectiveSupply;
    security_function: "BENIGN"
    rationale: "FIX - Exchange rate uses tracked underlying with virtual reserves, preventing donation manipulation."

  - id: "CA_FIX3"
    type: "INPUT_VAL"
    lines: [54]
    code: 'require(liquidityBootstrapped || totalSupply + mintAmount >= MINIMUM_LIQUIDITY, "Insufficient liquidity");'
    security_function: "BENIGN"
    rationale: "FIX - Minimum liquidity requirement before bootstrap."

  - id: "CA_FIX4"
    type: "STATE_MOD"
    lines: [61, 65, 66, 67]
    code: |
      trackedUnderlying += mintAmount;
      if (!liquidityBootstrapped && totalSupply >= MINIMUM_LIQUIDITY) {
          liquidityBootstrapped = true;
      }
    security_function: "BENIGN"
    rationale: "FIX - Tracked underlying update and bootstrap flag logic."

  - id: "CA_FIX5"
    type: "INPUT_VAL"
    lines: [78, 82]
    code: |
      require(redeemAmount <= trackedUnderlying, "Insufficient liquidity");
      trackedUnderlying -= redeemAmount;
    security_function: "BENIGN"
    rationale: "FIX - Redeem checks and updates tracked underlying."

  # ============================================
  # BENIGN CODE ACTS
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    lines: [14, 15, 17, 18, 19, 21, 22, 24, 25, 33, 34, 36, 37, 38]
    code: "CompMarket state and constructor"
    security_function: "BENIGN"
    rationale: "Contract initialization."

  - id: "CA2"
    type: "CTRL_FLOW"
    lines: [40, 41, 42, 43, 50]
    code: "exchangeRate function structure"
    security_function: "BENIGN"
    rationale: "Exchange rate function - now protected by virtual reserves."

  - id: "CA3"
    type: "STATE_MOD"
    lines: [52, 53, 56, 57, 59, 60, 63, 69, 70, 71]
    code: "mint function"
    security_function: "BENIGN"
    rationale: "Mint function - now with tracked underlying and bootstrap."

  - id: "CA4"
    type: "STATE_MOD"
    lines: [73, 74, 76, 77, 80, 81, 84, 86, 87, 88]
    code: "redeem function"
    security_function: "BENIGN"
    rationale: "Redeem function - now with tracked underlying check."

  - id: "CA5"
    type: "COMPUTATION"
    lines: [90, 91, 92, 93, 94, 95]
    code: "balanceOfUnderlying function"
    security_function: "BENIGN"
    rationale: "Balance calculation - now uses protected exchange rate."

  # ============================================
  # BATCHED UNRELATED CODE ACTS
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [45]
    security_function: "UNRELATED"
    rationale: "Comment line"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 6, 7, 8, 9, 10, 11, 12, 96]
    security_function: "UNRELATED"
    rationale: "Interface and contract declarations"

summary:
  total_code_acts_fixed: 13

  fix_applied:
    type: "donation_attack_protection"
    description: "Added virtual reserves and tracked underlying"
    lines_changed: [27, 28, 29, 30, 31, 45, 46, 47, 48, 49, 54, 61, 65, 66, 67, 78, 82]

  by_security_function_fixed:
    BENIGN: 10
    UNRELATED: 3

line_to_code_act_fixed:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  6: "CA_DECLARATIONS"
  7: "CA_DECLARATIONS"
  8: "CA_DECLARATIONS"
  9: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  12: "CA_DECLARATIONS"
  # Line 13: empty
  14: "CA1"
  15: "CA1"
  # Line 16: empty
  17: "CA1"
  18: "CA1"
  19: "CA1"
  # Line 20: empty
  21: "CA1"
  22: "CA1"
  # Line 23: empty
  24: "CA1"
  25: "CA1"
  # Line 26: empty
  27: "CA_FIX1"
  28: "CA_FIX1"
  29: "CA_FIX1"
  30: "CA_FIX1"
  31: "CA_FIX1"
  # Line 32: empty
  33: "CA1"
  34: "CA1"
  # Line 35: empty
  36: "CA1"
  37: "CA1"
  38: "CA1"
  # Line 39: empty
  40: "CA2"
  41: "CA2"
  42: "CA2"
  43: "CA2"
  # Line 44: empty
  45: "CA_COMMENTS"
  46: "CA_FIX2"
  47: "CA_FIX2"
  # Line 48: empty
  49: "CA_FIX2"
  50: "CA2"
  # Line 51: empty
  52: "CA3"
  53: "CA3"
  54: "CA_FIX3"
  # Line 55: empty
  56: "CA3"
  57: "CA3"
  # Line 58: empty
  59: "CA3"
  60: "CA3"
  61: "CA_FIX4"
  # Line 62: empty
  63: "CA3"
  # Line 64: empty
  65: "CA_FIX4"
  66: "CA_FIX4"
  67: "CA_FIX4"
  # Line 68: empty
  69: "CA3"
  70: "CA3"
  71: "CA3"
  # Line 72: empty
  73: "CA4"
  74: "CA4"
  # Line 75: empty
  76: "CA4"
  77: "CA4"
  78: "CA_FIX5"
  # Line 79: empty
  80: "CA4"
  81: "CA4"
  82: "CA_FIX5"
  # Line 83: empty
  84: "CA4"
  # Line 85: empty
  86: "CA4"
  87: "CA4"
  88: "CA4"
  # Line 89: empty
  90: "CA5"
  91: "CA5"
  92: "CA5"
  93: "CA5"
  94: "CA5"
  95: "CA5"
  96: "CA_DECLARATIONS"
  # Line 97: empty

code_act_security_functions_fixed:
  CA_FIX1: "BENIGN"
  CA_FIX2: "BENIGN"
  CA_FIX3: "BENIGN"
  CA_FIX4: "BENIGN"
  CA_FIX5: "BENIGN"
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"

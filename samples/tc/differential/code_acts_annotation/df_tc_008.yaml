schema_version: "1.0"
sample_id: "df_tc_008"
base_sample_id: "ms_tc_008"
vulnerability_type: "reentrancy"
is_vulnerable: false

# Differential annotation tracks Security Function transitions from vulnerable to fixed version.

vulnerability_summary:
  type: "reentrancy"
  severity: "critical"
  affected_functions: ["withdrawAll"]
  root_cause_summary: "In ms_tc_008, external call (msg.sender.call) was made BEFORE zeroing credit[msg.sender], allowing reentrancy attack."
  fix_summary: "Moved credit[msg.sender] = 0 BEFORE the external call, following checks-effects-interactions pattern."

code_acts:

  # ============================================
  # TRANSITIONED CODE ACTS (ROOT_CAUSE -> BENIGN)
  # ============================================

  - id: "CA7"
    type: "EXT_CALL"
    description: "External ETH transfer"

    vulnerable:
      file: "ms_tc_008.sol"
      function: "withdrawAll"
      line: 31
      code: "bool callResult = msg.sender.call.value(oCredit)();"
      security_function: "ROOT_CAUSE"
      rationale: "External call BEFORE state update - enables reentrancy"

    fixed:
      file: "df_tc_008.sol"
      function: "withdrawAll"
      line: 22
      code: '(bool callResult, ) = msg.sender.call{value: oCredit}("");'
      security_function: "BENIGN"
      rationale: "External call now AFTER state update (credit zeroed at line 20)"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "State is updated before external call"

  - id: "CA9"
    type: "STATE_MOD"
    description: "Credit zeroing"

    vulnerable:
      file: "ms_tc_008.sol"
      function: "withdrawAll"
      line: 33
      code: "credit[msg.sender] = 0;"
      security_function: "ROOT_CAUSE"
      rationale: "State update AFTER external call - CEI violation"

    fixed:
      file: "df_tc_008.sol"
      function: "withdrawAll"
      line: 20
      code: "credit[msg.sender] = 0;"
      security_function: "BENIGN"
      rationale: "State update now BEFORE external call - CEI pattern followed"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Moved before external call"

  # ============================================
  # TRANSITIONED (PREREQ -> BENIGN)
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    description: "Credit mapping"

    vulnerable:
      file: "ms_tc_008.sol"
      line: 5
      security_function: "PREREQ"
      rationale: "Updated too late, enabling attack"

    fixed:
      file: "df_tc_008.sol"
      line: 9
      security_function: "BENIGN"
      rationale: "Now updated in correct order"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Update order fixed"

  # ============================================
  # UNCHANGED CODE ACTS (BENIGN -> BENIGN)
  # ============================================

  - id: "CA2"
    type: "DECLARATION"
    description: "Balance variable"
    vulnerable:
      file: "ms_tc_008.sol"
      line: 6
      security_function: "BENIGN"
    fixed:
      file: "df_tc_008.sol"
      line: 10
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA3"
    type: "STATE_MOD"
    description: "Deposit function"
    vulnerable:
      file: "ms_tc_008.sol"
      lines: [12, 13]
      security_function: "BENIGN"
    fixed:
      file: "df_tc_008.sol"
      lines: [13, 14]
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA4"
    type: "DECLARATION"
    description: "oCredit local variable"
    vulnerable:
      file: "ms_tc_008.sol"
      line: 28
      security_function: "BENIGN"
    fixed:
      file: "df_tc_008.sol"
      line: 18
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA5"
    type: "CTRL_FLOW"
    description: "if (oCredit > 0) check"
    vulnerable:
      file: "ms_tc_008.sol"
      line: 29
      security_function: "BENIGN"
    fixed:
      file: "df_tc_008.sol"
      line: 19
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA6"
    type: "STATE_MOD"
    description: "Balance decrement"
    vulnerable:
      file: "ms_tc_008.sol"
      line: 30
      security_function: "BENIGN"
    fixed:
      file: "df_tc_008.sol"
      line: 21
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA8"
    type: "INPUT_VAL"
    description: "Call result check"
    vulnerable:
      file: "ms_tc_008.sol"
      line: 32
      security_function: "BENIGN"
    fixed:
      file: "df_tc_008.sol"
      line: 23
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA10"
    type: "CTRL_FLOW"
    description: "getCredit view function"
    vulnerable:
      file: "ms_tc_008.sol"
      lines: [40, 41, 42]
      security_function: "BENIGN"
    fixed:
      file: "df_tc_008.sol"
      lines: [27, 28, 29]
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

summary:
  total_code_acts: 10

  transitions:
    ROOT_CAUSE_to_BENIGN: 2   # CA7, CA9
    PREREQ_to_BENIGN: 1       # CA1
    BENIGN_to_BENIGN: 7       # CA2, CA3, CA4, CA5, CA6, CA8, CA10

  by_security_function_vulnerable:
    ROOT_CAUSE: 2
    PREREQ: 1
    BENIGN: 7

  by_security_function_fixed:
    BENIGN: 10  # All become BENIGN after fix

  fix_effectiveness:
    documented_vuln_fixed: true
    notes: "Classic CEI (Checks-Effects-Interactions) fix. By zeroing credit before the external call, reentrancy attacks see 0 credit on re-entry and the if check fails."

  root_cause_fixes:
    - id: "CA7"
      fix_type: "reorder_operations"
      description: "External call moved after state updates"
    - id: "CA9"
      fix_type: "reorder_operations"
      description: "State update moved before external call"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================

line_to_code_act_fixed:
  # State variables
  9: "CA1"
  10: "CA2"
  # deposit
  13: "CA3"
  14: "CA3"
  # withdrawAll
  18: "CA4"
  19: "CA5"
  20: "CA9"
  21: "CA6"
  22: "CA7"
  23: "CA8"
  # getCredit
  27: "CA10"
  28: "CA10"
  29: "CA10"

code_act_security_functions_fixed:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"

schema_version: "1.0"
sample_id: "df_tc_024"
base_sample_id: "ms_tc_024"
vulnerability_type: "input_validation"
is_fixed: true

fix_summary:
  description: "Added factory validation for pair addresses"
  fix_type: "factory_validation"
  vulnerable_pattern: "No validation of pair addresses"
  fixed_pattern: "Pairs validated via factory.getPair()"

vulnerable_version:
  reference: "../minimalsanitized/code_acts_annotation/ms_tc_024.yaml"
  root_cause_description: "Router accepted unvalidated pair addresses"

fixed_version:
  fix_lines: [10, 11, 12, 15, 17, 18, 19, 33, 34]
  fix_description: "Added IFactory interface, factory reference, getPair validation"

code_acts:

  - id: "CA_FIX1"
    type: "DECLARATION"
    lines: [15]
    code: "IFactory public factory;"
    security_function: "BENIGN"
    rationale: "FIX - Factory reference for pair validation"

  - id: "CA_FIX2"
    type: "INITIALIZATION"
    lines: [17, 18, 19]
    code: |
      constructor(address _factory) {
          factory = IFactory(_factory);
      }
    security_function: "BENIGN"
    rationale: "FIX - Constructor sets factory for validation"

  - id: "CA_FIX3"
    type: "INPUT_VAL"
    lines: [33, 34]
    code: |
      address pair = factory.getPair(path[i], path[i+1]);
      require(pair != address(0), "Pair does not exist");
    security_function: "BENIGN"
    rationale: "FIX - Validates pair exists in factory"

  - id: "CA1"
    type: "CTRL_FLOW"
    lines: [29, 30]
    code: |
      amounts = new uint[](path.length);
      amounts[0] = amountIn;
    security_function: "BENIGN"
    rationale: "Amount array initialization"

  - id: "CA2"
    type: "CTRL_FLOW"
    lines: [32]
    code: "for (uint i = 0; i < path.length - 1; i++) {"
    security_function: "BENIGN"
    rationale: "Loop over path"

  - id: "CA3"
    type: "EXT_CALL"
    lines: [36]
    code: "(uint112 reserve0, uint112 reserve1,) = IPair(pair).getReserves();"
    security_function: "BENIGN"
    rationale: "Get reserves from validated pair"

  - id: "CA4"
    type: "COMPUTATION"
    lines: [38, 39]
    code: |
      amounts[i+1] = _getAmountOut(amounts[i], reserve0, reserve1);
      }
    security_function: "BENIGN"
    rationale: "Amount calculation"

  - id: "CA5"
    type: "CTRL_FLOW"
    lines: [41, 42]
    code: |
      return amounts;
      }
    security_function: "BENIGN"
    rationale: "Return statement"

  - id: "CA6"
    type: "COMPUTATION"
    lines: [44, 45, 46]
    code: |
      function _getAmountOut(uint256 amountIn, uint112 reserveIn, uint112 reserveOut) internal pure returns (uint256) {
          return (amountIn * uint256(reserveOut)) / uint256(reserveIn);
      }
    security_function: "BENIGN"
    rationale: "Amount out calculation"

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: []
    security_function: "UNRELATED"
    rationale: "No standalone comments"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 6, 7, 8, 10, 11, 12, 14, 21, 22, 23, 24, 25, 26, 27]
    security_function: "UNRELATED"
    rationale: "Interface and function declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: []
    security_function: "UNRELATED"
    rationale: "Braces included in code_acts"

summary:
  total_code_acts_fixed: 13

  fix_applied:
    type: "factory_validation"
    description: "Added factory.getPair() validation"
    lines_changed: [10, 11, 12, 15, 17, 18, 19, 33, 34]

  by_security_function_fixed:
    BENIGN: 9
    UNRELATED: 4

line_to_code_act_fixed:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  6: "CA_DECLARATIONS"
  7: "CA_DECLARATIONS"
  8: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  12: "CA_DECLARATIONS"
  14: "CA_DECLARATIONS"
  15: "CA_FIX1"
  17: "CA_FIX2"
  18: "CA_FIX2"
  19: "CA_FIX2"
  21: "CA_DECLARATIONS"
  22: "CA_DECLARATIONS"
  23: "CA_DECLARATIONS"
  24: "CA_DECLARATIONS"
  25: "CA_DECLARATIONS"
  26: "CA_DECLARATIONS"
  27: "CA_DECLARATIONS"
  29: "CA1"
  30: "CA1"
  32: "CA2"
  33: "CA_FIX3"
  34: "CA_FIX3"
  36: "CA3"
  38: "CA4"
  39: "CA4"
  41: "CA5"
  42: "CA5"
  44: "CA6"
  45: "CA6"
  46: "CA6"
  47: "CA6"

code_act_security_functions_fixed:
  CA_FIX1: "BENIGN"
  CA_FIX2: "BENIGN"
  CA_FIX3: "BENIGN"
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

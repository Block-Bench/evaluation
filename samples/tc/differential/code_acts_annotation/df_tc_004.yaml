schema_version: "1.0"
sample_id: "df_tc_004"
base_sample_id: "ms_tc_004"
vulnerability_type: "reentrancy"
vulnerability_subtype: "compiler_bug_vyper"
is_vulnerable: false

# Differential annotation tracks Security Function transitions from vulnerable to fixed version.
# This file documents how ROOT_CAUSE/INSUFF_GUARD elements became BENIGN after the fix.

vulnerability_summary:
  type: "reentrancy"
  severity: "critical"
  affected_functions: ["add_liquidity", "remove_liquidity", "exchange"]
  root_cause_summary: "In ms_tc_004, reentrancy guard variables were declared but never used (simulating Vyper compiler bug). External call after state modification enabled reentrancy."
  fix_summary: "Added explicit reentrancy guard checks (require(_status != _ENTERED)) and status updates at function entry/exit in all critical functions."

code_acts:

  # ============================================
  # TRANSITIONED CODE ACTS (ROOT_CAUSE -> BENIGN)
  # ============================================

  - id: "CA1"
    type: "EXT_CALL"
    description: "_handleETHTransfer external call"

    vulnerable:
      file: "ms_tc_004.sol"
      function: "add_liquidity"
      line: 65
      code: "_handleETHTransfer(amounts[0]);"
      security_function: "ROOT_CAUSE"
      rationale: "External call after state modifications allowed reentrancy"

    fixed:
      file: "df_tc_004.sol"
      function: "add_liquidity"
      line: 73
      code: "_handleETHTransfer(amounts[0]);"
      security_function: "BENIGN"
      rationale: "Now protected by reentrancy guard check at function entry (lines 47-48)"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Reentrancy guard prevents recursive calls"

  - id: "CA2"
    type: "EXT_CALL"
    description: "Low-level call in _handleETHTransfer"

    vulnerable:
      file: "ms_tc_004.sol"
      function: "_handleETHTransfer"
      line: 115
      code: '(bool success, ) = msg.sender.call{value: 0}("");'
      security_function: "ROOT_CAUSE"
      rationale: "The actual external call that triggers attacker's receive() for reentrancy"

    fixed:
      file: "df_tc_004.sol"
      function: "_handleETHTransfer"
      line: 126
      code: '(bool success, ) = msg.sender.call{value: 0}("");'
      security_function: "BENIGN"
      rationale: "Reentrancy guard prevents exploitation even if receive() tries to re-enter"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Reentrancy guard blocks recursive calls"

  # ============================================
  # TRANSITIONED (INSUFF_GUARD -> BENIGN)
  # ============================================

  - id: "CA3"
    type: "REENTRY_GUARD"
    description: "Reentrancy guard state variables"

    vulnerable:
      file: "ms_tc_004.sol"
      function: "contract-level"
      lines: [12, 13, 14]
      code: "uint256 private _status; uint256 private constant _NOT_ENTERED = 1; uint256 private constant _ENTERED = 2;"
      security_function: "INSUFF_GUARD"
      rationale: "Guard variables declared but never used in functions"

    fixed:
      file: "df_tc_004.sol"
      function: "contract-level"
      lines: [18, 19, 20]
      code: "uint256 private _status; uint256 private constant _NOT_ENTERED = 1; uint256 private constant _ENTERED = 2;"
      security_function: "BENIGN"
      rationale: "Guard variables now properly used in all critical functions"

    transition: "INSUFF_GUARD -> BENIGN"
    transition_reason: "Guard is now actually used"

  # ============================================
  # NEW CODE ACTS (fix additions)
  # ============================================

  - id: "CA_FIX1"
    type: "REENTRY_GUARD"
    description: "Reentrancy check in add_liquidity (NEW)"

    fixed:
      file: "df_tc_004.sol"
      function: "add_liquidity"
      lines: [47, 48]
      code: 'require(_status != _ENTERED, "Reentrancy detected"); _status = _ENTERED;'
      security_function: "BENIGN"
      rationale: "NEW FIX: Prevents reentrancy by checking and setting guard at function entry"

    transition: "NEW -> BENIGN"
    transition_reason: "Added as fix for reentrancy vulnerability"

  - id: "CA_FIX2"
    type: "STATE_MOD"
    description: "Guard reset in add_liquidity (NEW)"

    fixed:
      file: "df_tc_004.sol"
      function: "add_liquidity"
      line: 76
      code: "_status = _NOT_ENTERED;"
      security_function: "BENIGN"
      rationale: "NEW FIX: Resets reentrancy guard after critical operations complete"

    transition: "NEW -> BENIGN"
    transition_reason: "Added as part of reentrancy guard implementation"

  - id: "CA_FIX3"
    type: "REENTRY_GUARD"
    description: "Reentrancy check in remove_liquidity (NEW)"

    fixed:
      file: "df_tc_004.sol"
      function: "remove_liquidity"
      lines: [90, 91]
      code: 'require(_status != _ENTERED, "Reentrancy detected"); _status = _ENTERED;'
      security_function: "BENIGN"
      rationale: "NEW FIX: Prevents reentrancy in remove_liquidity"

    transition: "NEW -> BENIGN"
    transition_reason: "Added as fix for reentrancy vulnerability"

  - id: "CA_FIX4"
    type: "STATE_MOD"
    description: "Guard reset in remove_liquidity (NEW)"

    fixed:
      file: "df_tc_004.sol"
      function: "remove_liquidity"
      line: 117
      code: "_status = _NOT_ENTERED;"
      security_function: "BENIGN"
      rationale: "NEW FIX: Resets reentrancy guard in remove_liquidity"

    transition: "NEW -> BENIGN"
    transition_reason: "Added as part of reentrancy guard implementation"

  - id: "CA_FIX5"
    type: "REENTRY_GUARD"
    description: "Reentrancy check in exchange (NEW)"

    fixed:
      file: "df_tc_004.sol"
      function: "exchange"
      lines: [144, 145]
      code: 'require(_status != _ENTERED, "Reentrancy detected"); _status = _ENTERED;'
      security_function: "BENIGN"
      rationale: "NEW FIX: Prevents reentrancy in exchange function"

    transition: "NEW -> BENIGN"
    transition_reason: "Added as fix for reentrancy vulnerability"

  - id: "CA_FIX6"
    type: "STATE_MOD"
    description: "Guard reset in exchange (NEW)"

    fixed:
      file: "df_tc_004.sol"
      function: "exchange"
      line: 168
      code: "_status = _NOT_ENTERED;"
      security_function: "BENIGN"
      rationale: "NEW FIX: Resets reentrancy guard in exchange"

    transition: "NEW -> BENIGN"
    transition_reason: "Added as part of reentrancy guard implementation"

  - id: "CA_FIX7"
    type: "INITIALIZATION"
    description: "Constructor guard initialization (NEW)"

    fixed:
      file: "df_tc_004.sol"
      function: "constructor"
      lines: [33, 34, 35]
      code: "constructor() { _status = _NOT_ENTERED; }"
      security_function: "BENIGN"
      rationale: "NEW FIX: Initializes reentrancy guard to not-entered state"

    transition: "NEW -> BENIGN"
    transition_reason: "Added as part of reentrancy guard implementation"

  # ============================================
  # TRANSITIONED (PREREQ -> BENIGN)
  # ============================================

  - id: "CA4"
    type: "STATE_MOD"
    description: "Balance updates before external call"

    vulnerable:
      file: "ms_tc_004.sol"
      function: "add_liquidity"
      lines: [53, 54]
      security_function: "PREREQ"
      rationale: "State update before external call enabled reentrancy exploitation"

    fixed:
      file: "df_tc_004.sol"
      function: "add_liquidity"
      lines: [64, 65]
      security_function: "BENIGN"
      rationale: "Protected by reentrancy guard"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Reentrancy guard makes exploitation impossible"

  - id: "CA5"
    type: "STATE_MOD"
    description: "LP token minting"

    vulnerable:
      file: "ms_tc_004.sol"
      function: "add_liquidity"
      lines: [57, 58]
      security_function: "PREREQ"
      rationale: "LP minting before external call enabled double-minting via reentrancy"

    fixed:
      file: "df_tc_004.sol"
      function: "add_liquidity"
      lines: [68, 69]
      security_function: "BENIGN"
      rationale: "Protected by reentrancy guard"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Reentrancy guard prevents double-minting"

  - id: "CA9"
    type: "CTRL_FLOW"
    description: "Control flow to external call"

    vulnerable:
      file: "ms_tc_004.sol"
      function: "add_liquidity"
      lines: [62, 66]
      security_function: "PREREQ"
      rationale: "Path to vulnerable external call"

    fixed:
      file: "df_tc_004.sol"
      function: "add_liquidity"
      lines: [72, 74]
      security_function: "BENIGN"
      rationale: "Path is now protected"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Reentrancy guard protects the entire function"

  # ============================================
  # UNCHANGED CODE ACTS (BENIGN -> BENIGN)
  # ============================================

  - id: "CA6"
    type: "INPUT_VAL"
    description: "ETH amount validation"
    vulnerable:
      file: "ms_tc_004.sol"
      line: 37
      security_function: "BENIGN"
    fixed:
      file: "df_tc_004.sol"
      line: 50
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA7"
    type: "COMPUTATION"
    description: "LP amount calculation"
    vulnerable:
      file: "ms_tc_004.sol"
      lines: [40, 41, 42, 43, 45, 46, 47]
      security_function: "BENIGN"
    fixed:
      file: "df_tc_004.sol"
      lines: [53, 54, 55, 56, 57, 58, 59]
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA8"
    type: "INPUT_VAL"
    description: "Slippage check"
    vulnerable:
      file: "ms_tc_004.sol"
      line: 49
      security_function: "BENIGN"
    fixed:
      file: "df_tc_004.sol"
      line: 61
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA10"
    type: "EVENT_EMIT"
    description: "LiquidityAdded event"
    vulnerable:
      file: "ms_tc_004.sol"
      line: 68
      security_function: "BENIGN"
    fixed:
      file: "df_tc_004.sol"
      line: 77
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA18"
    type: "INPUT_VAL"
    description: "Transfer success check"
    vulnerable:
      file: "ms_tc_004.sol"
      line: 116
      security_function: "BENIGN"
    fixed:
      file: "df_tc_004.sol"
      line: 127
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

summary:
  total_code_acts: 19

  transitions:
    ROOT_CAUSE_to_BENIGN: 2   # CA1, CA2
    INSUFF_GUARD_to_BENIGN: 1 # CA3
    PREREQ_to_BENIGN: 3       # CA4, CA5, CA9
    BENIGN_to_BENIGN: 6       # CA6, CA7, CA8, CA10, CA18, and others
    NEW_to_BENIGN: 7          # CA_FIX1-CA_FIX7

  by_security_function_vulnerable:
    ROOT_CAUSE: 2
    INSUFF_GUARD: 1
    PREREQ: 3
    BENIGN: 13

  by_security_function_fixed:
    BENIGN: 19  # All become BENIGN after fix

  fix_effectiveness:
    documented_vuln_fixed: true
    notes: "Reentrancy guard now properly implemented in all critical functions. Guard checks at entry (require + status set) and resets at exit prevent any recursive calls."

  root_cause_fixes:
    - id: "CA1"
      fix_type: "reentrancy_guard"
      description: "_handleETHTransfer now protected by guard"
    - id: "CA2"
      fix_type: "reentrancy_guard"
      description: "Low-level call protected by guard"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================

line_to_code_act_fixed:
  # Reentrancy guard variables
  18: "CA3"
  19: "CA3"
  20: "CA3"
  # Constructor
  33: "CA_FIX7"
  34: "CA_FIX7"
  35: "CA_FIX7"
  # add_liquidity
  47: "CA_FIX1"
  48: "CA_FIX1"
  50: "CA6"
  53: "CA7"
  54: "CA7"
  55: "CA7"
  56: "CA7"
  57: "CA7"
  58: "CA7"
  59: "CA7"
  61: "CA8"
  64: "CA4"
  65: "CA4"
  68: "CA5"
  69: "CA5"
  72: "CA9"
  73: "CA1"
  74: "CA9"
  76: "CA_FIX2"
  77: "CA10"
  # remove_liquidity
  90: "CA_FIX3"
  91: "CA_FIX3"
  117: "CA_FIX4"
  # _handleETHTransfer
  126: "CA2"
  127: "CA18"
  # exchange
  144: "CA_FIX5"
  145: "CA_FIX5"
  168: "CA_FIX6"

code_act_security_functions_fixed:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA18: "BENIGN"
  CA_FIX1: "BENIGN"
  CA_FIX2: "BENIGN"
  CA_FIX3: "BENIGN"
  CA_FIX4: "BENIGN"
  CA_FIX5: "BENIGN"
  CA_FIX6: "BENIGN"
  CA_FIX7: "BENIGN"

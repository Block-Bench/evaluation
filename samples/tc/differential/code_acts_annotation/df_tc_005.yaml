schema_version: "1.0"
sample_id: "df_tc_005"
base_sample_id: "ms_tc_005"
vulnerability_type: "access_control"
vulnerability_subtype: "unrestricted_target_execution"
is_vulnerable: false

# Differential annotation tracks Security Function transitions from vulnerable to fixed version.

vulnerability_summary:
  type: "access_control"
  severity: "critical"
  affected_functions: ["verifyHeaderAndExecuteTx"]
  root_cause_summary: "In ms_tc_005, verifyHeaderAndExecuteTx() made unrestricted external calls to any contract decoded from cross-chain proof. Attacker could target EthCrossChainData to change validator keys."
  fix_summary: "Added allowedTargets whitelist mapping and require check before external call. Explicitly sets dataContract as NOT allowed in constructor."

code_acts:

  # ============================================
  # TRANSITIONED CODE ACTS (ROOT_CAUSE -> BENIGN)
  # ============================================

  - id: "CA12"
    type: "EXT_CALL"
    description: "External call to decoded target"

    vulnerable:
      file: "ms_tc_005.sol"
      function: "verifyHeaderAndExecuteTx"
      line: 91
      code: "(bool success, ) = toContract.call(abi.encodePacked(method, args));"
      security_function: "ROOT_CAUSE"
      rationale: "Unrestricted external call to ANY contract decoded from cross-chain transaction"

    fixed:
      file: "df_tc_005.sol"
      function: "verifyHeaderAndExecuteTx"
      line: 112
      code: "(bool success, ) = toContract.call(abi.encodePacked(method, args));"
      security_function: "BENIGN"
      rationale: "Now protected by require(allowedTargets[toContract]) at line 109"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Whitelist check prevents calls to privileged contracts"

  # ============================================
  # NEW CODE ACTS (fix additions)
  # ============================================

  - id: "CA_FIX1"
    type: "DECLARATION"
    description: "allowedTargets mapping (NEW)"

    fixed:
      file: "df_tc_005.sol"
      function: "contract-level"
      line: 67
      code: "mapping(address => bool) public allowedTargets;"
      security_function: "BENIGN"
      rationale: "NEW FIX: Whitelist mapping to control which contracts can be called"

    transition: "NEW -> BENIGN"
    transition_reason: "Added as primary fix mechanism"

  - id: "CA_FIX2"
    type: "INITIALIZATION"
    description: "Set dataContract as not allowed (NEW)"

    fixed:
      file: "df_tc_005.sol"
      function: "constructor"
      line: 77
      code: "allowedTargets[_dataContract] = false;"
      security_function: "BENIGN"
      rationale: "NEW FIX: Explicitly prevents calling the privileged data contract"

    transition: "NEW -> BENIGN"
    transition_reason: "Added to block the specific attack vector"

  - id: "CA_FIX3"
    type: "INPUT_VAL"
    description: "Target whitelist check (NEW)"

    fixed:
      file: "df_tc_005.sol"
      function: "verifyHeaderAndExecuteTx"
      line: 109
      code: 'require(allowedTargets[toContract], "Target not allowed");'
      security_function: "BENIGN"
      rationale: "NEW FIX: Prevents execution to non-whitelisted targets"

    transition: "NEW -> BENIGN"
    transition_reason: "Added as primary security check"

  # ============================================
  # TRANSITIONED (PREREQ -> BENIGN)
  # ============================================

  - id: "CA3"
    type: "ACCESS_CTRL"
    description: "onlyOwner modifier"

    vulnerable:
      file: "ms_tc_005.sol"
      lines: [28, 29, 30, 31]
      security_function: "PREREQ"
      rationale: "Passes when CrossChainManager calls - enables attack"

    fixed:
      file: "df_tc_005.sol"
      lines: [34, 35, 36, 37]
      security_function: "BENIGN"
      rationale: "No longer exploitable - external calls are restricted"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Attack path blocked by whitelist"

  - id: "CA4"
    type: "STATE_MOD"
    description: "putCurEpochConPubKeyBytes function"

    vulnerable:
      file: "ms_tc_005.sol"
      lines: [33, 34, 35, 36, 37, 38, 39]
      security_function: "PREREQ"
      rationale: "Can be called through CrossChainManager to change keys"

    fixed:
      file: "df_tc_005.sol"
      lines: [42, 43, 44, 45, 46, 47, 48]
      security_function: "BENIGN"
      rationale: "No longer reachable through attack path"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Attack path blocked"

  - id: "CA7"
    type: "DECLARATION"
    description: "dataContract storage"

    vulnerable:
      file: "ms_tc_005.sol"
      line: 53
      security_function: "PREREQ"
      rationale: "Stores the attack target address"

    fixed:
      file: "df_tc_005.sol"
      line: 65
      security_function: "BENIGN"
      rationale: "Still stores address but calls to it are blocked"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Target is now excluded from allowed list"

  - id: "CA11"
    type: "COMPUTATION"
    description: "_decodeTx returning target"

    vulnerable:
      file: "ms_tc_005.sol"
      lines: [122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139]
      security_function: "PREREQ"
      rationale: "Decodes unvalidated target from proof"

    fixed:
      file: "df_tc_005.sol"
      lines: [102, 103, 104, 105, 106, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154]
      security_function: "BENIGN"
      rationale: "Output is now validated by whitelist before use"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Decoded target is validated before use"

  # ============================================
  # UNCHANGED CODE ACTS (BENIGN -> BENIGN)
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    description: "State variables in CrossChainData"
    vulnerable:
      file: "ms_tc_005.sol"
      lines: [15, 16]
      security_function: "BENIGN"
    fixed:
      file: "df_tc_005.sol"
      lines: [21, 22]
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA2"
    type: "INITIALIZATION"
    description: "Constructor setting owner"
    vulnerable:
      file: "ms_tc_005.sol"
      lines: [24, 25, 26]
      security_function: "BENIGN"
    fixed:
      file: "df_tc_005.sol"
      lines: [30, 31, 32]
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA8"
    type: "INITIALIZATION"
    description: "CrossChainManager constructor"
    vulnerable:
      file: "ms_tc_005.sol"
      lines: [61, 62, 63]
      security_function: "BENIGN"
    fixed:
      file: "df_tc_005.sol"
      lines: [75, 76, 78]
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA9"
    type: "INPUT_VAL"
    description: "Header verification"
    vulnerable:
      file: "ms_tc_005.sol"
      line: 74
      security_function: "BENIGN"
    fixed:
      file: "df_tc_005.sol"
      line: 96
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA10"
    type: "INPUT_VAL"
    description: "Proof verification"
    vulnerable:
      file: "ms_tc_005.sol"
      line: 78
      security_function: "BENIGN"
    fixed:
      file: "df_tc_005.sol"
      line: 99
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA13"
    type: "INPUT_VAL"
    description: "Execution success check"
    vulnerable:
      file: "ms_tc_005.sol"
      line: 92
      security_function: "BENIGN"
    fixed:
      file: "df_tc_005.sol"
      line: 113
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

summary:
  total_code_acts: 14

  transitions:
    ROOT_CAUSE_to_BENIGN: 1   # CA12
    PREREQ_to_BENIGN: 4       # CA3, CA4, CA7, CA11
    BENIGN_to_BENIGN: 6       # CA1, CA2, CA8, CA9, CA10, CA13
    NEW_to_BENIGN: 3          # CA_FIX1, CA_FIX2, CA_FIX3

  by_security_function_vulnerable:
    ROOT_CAUSE: 1
    PREREQ: 4
    BENIGN: 6

  by_security_function_fixed:
    BENIGN: 14  # All become BENIGN after fix

  fix_effectiveness:
    documented_vuln_fixed: true
    notes: "The whitelist approach prevents calling privileged contracts. By setting allowedTargets[dataContract] = false, the attack vector is completely blocked."

  root_cause_fixes:
    - id: "CA12"
      fix_type: "target_whitelist"
      description: "External call now requires target to be in allowedTargets"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================

line_to_code_act_fixed:
  # CrossChainData state
  21: "CA1"
  22: "CA1"
  # Constructor
  30: "CA2"
  31: "CA2"
  32: "CA2"
  # onlyOwner modifier
  34: "CA3"
  35: "CA3"
  36: "CA3"
  37: "CA3"
  # putCurEpochConPubKeyBytes
  42: "CA4"
  43: "CA4"
  44: "CA4"
  45: "CA4"
  46: "CA4"
  47: "CA4"
  48: "CA4"
  # CrossChainManager state
  65: "CA7"
  67: "CA_FIX1"
  # Constructor
  75: "CA8"
  76: "CA8"
  77: "CA_FIX2"
  78: "CA8"
  # verifyHeaderAndExecuteTx
  96: "CA9"
  99: "CA10"
  102: "CA11"
  103: "CA11"
  104: "CA11"
  105: "CA11"
  106: "CA11"
  109: "CA_FIX3"
  112: "CA12"
  113: "CA13"
  # _decodeTx
  141: "CA11"
  142: "CA11"
  143: "CA11"
  144: "CA11"
  145: "CA11"
  146: "CA11"
  147: "CA11"
  148: "CA11"
  149: "CA11"
  150: "CA11"
  151: "CA11"
  152: "CA11"
  153: "CA11"
  154: "CA11"

code_act_security_functions_fixed:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "BENIGN"
  CA_FIX1: "BENIGN"
  CA_FIX2: "BENIGN"
  CA_FIX3: "BENIGN"

schema_version: "1.0"
sample_id: "df_tc_019"
base_sample_id: "ms_tc_019"
vulnerability_type: "arithmetic_error"
is_fixed: true

fix_summary:
  description: "Fixed K invariant check by using consistent FEE_SCALE (10000) for both balance adjustments and invariant validation"
  fix_type: "scale_correction"
  vulnerable_pattern: "K check used 1000^2 scale while balance used 10000 scale"
  fixed_pattern: "Both use FEE_SCALE (10000) consistently"

vulnerable_version:
  reference: "../minimalsanitized/code_acts_annotation/ms_tc_019.yaml"
  root_cause_description: "Scale mismatch between fee calculation (10000) and K invariant (1000^2)"

fixed_version:
  fix_lines: [24, 77, 78, 80, 81, 82]
  fix_description: "Added FEE_SCALE constant and used it consistently in K validation"

code_acts:

  # ============================================
  # FIX CODE ACTS
  # ============================================

  - id: "CA_FIX1"
    type: "DECLARATION"
    lines: [24]
    code: 'uint256 public constant FEE_SCALE = 10000; // Fee scale for 0.16%'
    security_function: "BENIGN"
    rationale: "FIX - Defines consistent scale constant for fee calculations"

  - id: "CA_FIX2"
    type: "COMPUTATION"
    lines: [77, 78]
    code: |
      uint256 balance0Adjusted = balance0 * FEE_SCALE - amount0In * TOTAL_FEE;
      uint256 balance1Adjusted = balance1 * FEE_SCALE - amount1In * TOTAL_FEE;
    security_function: "BENIGN"
    rationale: "FIX - Uses FEE_SCALE (10000) for balance adjustments, matching K invariant scale"

  - id: "CA_FIX3"
    type: "INPUT_VAL"
    lines: [80, 81, 82, 83, 84]
    code: |
      require(
          balance0Adjusted * balance1Adjusted >=
              uint256(_reserve0) * _reserve1 * (FEE_SCALE ** 2),
          "K"
      );
    security_function: "BENIGN"
    rationale: "FIX - K invariant check uses FEE_SCALE^2, matching balance adjustment scale"

  # ============================================
  # BENIGN CODE ACTS
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    lines: [17, 18]
    code: |
      address public token0;
      address public token1;
    security_function: "BENIGN"
    rationale: "Token address declarations"

  - id: "CA2"
    type: "DECLARATION"
    lines: [20, 21]
    code: |
      uint112 private reserve0;
      uint112 private reserve1;
    security_function: "BENIGN"
    rationale: "Reserve state variables"

  - id: "CA3"
    type: "DECLARATION"
    lines: [23]
    code: "uint256 public constant TOTAL_FEE = 16;"
    security_function: "BENIGN"
    rationale: "Fee constant declaration"

  - id: "CA4"
    type: "INITIALIZATION"
    lines: [26, 27, 28, 29]
    code: |
      constructor(address _token0, address _token1) {
          token0 = _token0;
          token1 = _token1;
      }
    security_function: "BENIGN"
    rationale: "Constructor initialization"

  - id: "CA5"
    type: "EXT_CALL"
    lines: [32, 33]
    code: |
      uint256 balance0 = IERC20(token0).balanceOf(address(this));
      uint256 balance1 = IERC20(token1).balanceOf(address(this));
    security_function: "BENIGN"
    rationale: "Balance reads in mint"

  - id: "CA6"
    type: "COMPUTATION"
    lines: [35, 36]
    code: |
      uint256 amount0 = balance0 - reserve0;
      uint256 amount1 = balance1 - reserve1;
    security_function: "BENIGN"
    rationale: "Amount calculation"

  - id: "CA7"
    type: "COMPUTATION"
    lines: [38]
    code: "liquidity = sqrt(amount0 * amount1);"
    security_function: "BENIGN"
    rationale: "Liquidity calculation"

  - id: "CA8"
    type: "STATE_MOD"
    lines: [40, 41]
    code: |
      reserve0 = uint112(balance0);
      reserve1 = uint112(balance1);
    security_function: "BENIGN"
    rationale: "Reserve updates in mint"

  - id: "CA9"
    type: "CTRL_FLOW"
    lines: [43, 44]
    code: |
      return liquidity;
      }
    security_function: "BENIGN"
    rationale: "Return statement"

  - id: "CA10"
    type: "INPUT_VAL"
    lines: [52]
    code: 'require(amount0Out > 0 || amount1Out > 0, "INSUFFICIENT_OUTPUT_AMOUNT");'
    security_function: "BENIGN"
    rationale: "Output amount validation"

  - id: "CA11"
    type: "DECLARATION"
    lines: [54, 55]
    code: |
      uint112 _reserve0 = reserve0;
      uint112 _reserve1 = reserve1;
    security_function: "BENIGN"
    rationale: "Local reserve caching"

  - id: "CA12"
    type: "INPUT_VAL"
    lines: [57, 58, 59, 60]
    code: |
      require(
          amount0Out < _reserve0 && amount1Out < _reserve1,
          "INSUFFICIENT_LIQUIDITY"
      );
    security_function: "BENIGN"
    rationale: "Liquidity check"

  - id: "CA13"
    type: "EXT_CALL"
    lines: [62, 63]
    code: |
      if (amount0Out > 0) IERC20(token0).transfer(to, amount0Out);
      if (amount1Out > 0) IERC20(token1).transfer(to, amount1Out);
    security_function: "BENIGN"
    rationale: "Output token transfers"

  - id: "CA14"
    type: "EXT_CALL"
    lines: [65, 66]
    code: |
      uint256 balance0 = IERC20(token0).balanceOf(address(this));
      uint256 balance1 = IERC20(token1).balanceOf(address(this));
    security_function: "BENIGN"
    rationale: "Post-transfer balance reads"

  - id: "CA15"
    type: "COMPUTATION"
    lines: [68, 69, 70, 71, 72, 73]
    code: |
      uint256 amount0In = balance0 > _reserve0 - amount0Out
          ? balance0 - (_reserve0 - amount0Out)
          : 0;
      uint256 amount1In = balance1 > _reserve1 - amount1Out
          ? balance1 - (_reserve1 - amount1Out)
          : 0;
    security_function: "BENIGN"
    rationale: "Input amount calculation"

  - id: "CA16"
    type: "INPUT_VAL"
    lines: [75]
    code: 'require(amount0In > 0 || amount1In > 0, "INSUFFICIENT_INPUT_AMOUNT");'
    security_function: "BENIGN"
    rationale: "Input amount validation"

  - id: "CA17"
    type: "STATE_MOD"
    lines: [86, 87, 88]
    code: |
      reserve0 = uint112(balance0);
      reserve1 = uint112(balance1);
      }
    security_function: "BENIGN"
    rationale: "Reserve updates in swap"

  - id: "CA18"
    type: "CTRL_FLOW"
    lines: [91]
    code: "return (reserve0, reserve1, 0);"
    security_function: "BENIGN"
    rationale: "getReserves return"

  - id: "CA19"
    type: "COMPUTATION"
    lines: [94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106]
    code: |
      function sqrt(uint256 y) internal pure returns (uint256 z) {
          if (y > 3) {
              z = y;
              uint256 x = y / 2 + 1;
              while (x < z) {
                  z = x;
                  x = (y / x + x) / 2;
              }
          } else if (y != 0) {
              z = 1;
          }
      }
      }
    security_function: "BENIGN"
    rationale: "Square root helper function"

  # ============================================
  # BATCHED UNRELATED CODE ACTS
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: []
    security_function: "UNRELATED"
    rationale: "No standalone comments"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 7, 9, 10, 11, 12, 13, 14, 16, 31, 46, 47, 48, 49, 50, 51, 90, 92]
    security_function: "UNRELATED"
    rationale: "Interface, contract, and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: []
    security_function: "UNRELATED"
    rationale: "Closing braces included in respective code_acts"

summary:
  total_code_acts_fixed: 23

  fix_applied:
    type: "scale_correction"
    description: "Used consistent FEE_SCALE for K invariant and balance adjustments"
    lines_changed: [24, 77, 78, 80, 81, 82, 83, 84]

  by_security_function_fixed:
    BENIGN: 19
    UNRELATED: 4

line_to_code_act_fixed:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  # Line 6: empty
  7: "CA_DECLARATIONS"
  # Line 8: empty
  9: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  12: "CA_DECLARATIONS"
  13: "CA_DECLARATIONS"
  14: "CA_DECLARATIONS"
  # Line 15: empty
  16: "CA_DECLARATIONS"
  17: "CA1"
  18: "CA1"
  # Line 19: empty
  20: "CA2"
  21: "CA2"
  # Line 22: empty
  23: "CA3"
  24: "CA_FIX1"
  # Line 25: empty
  26: "CA4"
  27: "CA4"
  28: "CA4"
  29: "CA4"
  # Line 30: empty
  31: "CA_DECLARATIONS"
  32: "CA5"
  33: "CA5"
  # Line 34: empty
  35: "CA6"
  36: "CA6"
  # Line 37: empty
  38: "CA7"
  # Line 39: empty
  40: "CA8"
  41: "CA8"
  # Line 42: empty
  43: "CA9"
  44: "CA9"
  # Line 45: empty
  46: "CA_DECLARATIONS"
  47: "CA_DECLARATIONS"
  48: "CA_DECLARATIONS"
  49: "CA_DECLARATIONS"
  50: "CA_DECLARATIONS"
  51: "CA_DECLARATIONS"
  52: "CA10"
  # Line 53: empty
  54: "CA11"
  55: "CA11"
  # Line 56: empty
  57: "CA12"
  58: "CA12"
  59: "CA12"
  60: "CA12"
  # Line 61: empty
  62: "CA13"
  63: "CA13"
  # Line 64: empty
  65: "CA14"
  66: "CA14"
  # Line 67: empty
  68: "CA15"
  69: "CA15"
  70: "CA15"
  71: "CA15"
  72: "CA15"
  73: "CA15"
  # Line 74: empty
  75: "CA16"
  # Line 76: empty
  77: "CA_FIX2"
  78: "CA_FIX2"
  # Line 79: empty
  80: "CA_FIX3"
  81: "CA_FIX3"
  82: "CA_FIX3"
  83: "CA_FIX3"
  84: "CA_FIX3"
  # Line 85: empty
  86: "CA17"
  87: "CA17"
  88: "CA17"
  # Line 89: empty
  90: "CA_DECLARATIONS"
  91: "CA18"
  92: "CA_DECLARATIONS"
  # Line 93: empty
  94: "CA19"
  95: "CA19"
  96: "CA19"
  97: "CA19"
  98: "CA19"
  99: "CA19"
  100: "CA19"
  101: "CA19"
  102: "CA19"
  103: "CA19"
  104: "CA19"
  105: "CA19"
  106: "CA19"
  # Line 107: empty

code_act_security_functions_fixed:
  CA_FIX1: "BENIGN"
  CA_FIX2: "BENIGN"
  CA_FIX3: "BENIGN"
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "BENIGN"
  CA14: "BENIGN"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA17: "BENIGN"
  CA18: "BENIGN"
  CA19: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

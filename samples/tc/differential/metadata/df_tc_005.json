{
  "sample_id": "df_tc_005",
  "exploit_name": "Poly Network",
  "date": "2021-08-10",
  "amount_lost_usd": "611000000",
  "blockchain": "ethereum",
  "language": "solidity",
  "vulnerability_type": "access_control",
  "vulnerability_subtype": "unrestricted_target_execution",
  "severity": "critical",
  "difficulty_tier": 4,
  "is_vulnerable": false,
  "temporal_category": "pre_cutoff",
  "description": "Fixed version with minimal changes to address the vulnerability",
  "vulnerable_contract": "CrossChainData",
  "vulnerable_function": "verifyHeaderAndExecuteTx",
  "vulnerable_lines": [],
  "attack_scenario": "Attacker creates valid cross-chain transaction on Poly Network sidechain with target set to EthCrossChainData (the privileged data contract), not a user contract. Transaction calls putCurEpochConPubKeyBytes() to change validator public keys. EthCrossChainManager verifies header signatures and Merkle proof (both valid), then executes transaction by calling EthCrossChainData. Since msg.sender is EthCrossChainManager, the onlyOwner check passes. Attacker's keys become validator keys, allowing them to forge any cross-chain transaction and drain bridge.",
  "root_cause": "EthCrossChainManager validated cross-chain transactions (headers, proofs) but didn't restrict which contracts could be targeted for execution. It allowed calling EthCrossChainData, which trusted EthCrossChainManager as owner. This created an access control bypass where anyone could call privileged functions on EthCrossChainData by routing through EthCrossChainManager with a valid cross-chain transaction.",
  "fix_description": "Implement whitelist of allowed target contracts, explicitly excluding privileged contracts like EthCrossChainData. Use blacklist to forbid critical system contracts as targets. Separate privilege levels for cross-chain execution. Replace msg.sender-based authorization with more granular access controls. Add multi-sig requirements for critical operations like validator key updates. Implement emergency pause mechanisms. Add rate limiting and anomaly detection for cross-chain transactions.",
  "source_reference": "https://github.com/SunWeb3Sec/DeFiHackLabs/blob/main/src/test/2021-08/PolyNetwork_exp.sol",
  "external_references": [
    "https://rekt.news/polynetwork-rekt/",
    "https://research.kudelskisecurity.com/2021/08/12/the-poly-network-hack-explained/",
    "https://blog.chainalysis.com/reports/poly-network-hack-august-2021/"
  ],
  "tags": [
    "cross_chain",
    "access_control",
    "privilege_escalation",
    "proxy_bypass",
    "historical",
    "mega_hack",
    "differential",
    "fixed"
  ],
  "variant_type": "differential",
  "variant_parent_id": "tc_005",
  "notes": "One of the largest crypto hacks ever ($611M). Uniquely, the attacker returned most funds, suggesting white hat intentions or demonstrating vulnerability for recognition. Attacker communicated via embedded transaction messages. Classic access control bypass via proxy pattern. Demonstrates importance of restricting execution targets in proxy/manager contracts. Affected multiple chains (Ethereum, BSC, Polygon).",
  "contract_file": "contracts/df_tc_005.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "transformation": {
    "type": "differential",
    "strategy": "minimal_fix",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/original",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/original/contracts/tc_005.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/original/metadata/tc_005.json",
    "pair_metadata": "/Users/poamen/projects/grace/blockbench/base/data/manual_strategies/differential/metadata/df_pair_tc_005.json",
    "script": "manual",
    "is_fixed_version": true,
    "fix_type": "minimal_fix",
    "fix_description": "Minimal fix with 6 lines changed. Added: mapping(address => bool) public allowedTargets;; allowedTargets[_dataContract] = false;; require(allowedTargets[toContract], \"Target not allowed\");",
    "exact_changes": [
      {
        "location": "Added line",
        "version_a": "mapping(address => bool) public allowedTargets;",
        "version_b": "// Not present in vulnerable version"
      },
      {
        "location": "Added line",
        "version_a": "allowedTargets[_dataContract] = false;",
        "version_b": "// Not present in vulnerable version"
      },
      {
        "location": "Added line",
        "version_a": "require(allowedTargets[toContract], \"Target not allowed\");",
        "version_b": "// Not present in vulnerable version"
      }
    ],
    "why_fix_works": "Implement whitelist of allowed target contracts, explicitly excluding privileged contracts like EthCrossChainData. Use blacklist to forbid critical system contracts as targets. Separate privilege levels for cross-chain execution. Replace msg.sender-based authorization with more granular access contr",
    "contracts_in_file": [
      "CrossChainData",
      "CrossChainManager"
    ],
    "created_date": "2025-12-30T02:02:17.927251"
  }
}

{
  "sample_id": "df_tc_017",
  "exploit_name": "Warp Finance LP Token Price Manipulation",
  "date": "2020-12-17",
  "amount_lost_usd": "7700000",
  "blockchain": "ethereum",
  "language": "solidity",
  "vulnerability_type": "price_oracle_manipulation",
  "vulnerability_subtype": "",
  "severity": "",
  "difficulty_tier": 0,
  "is_vulnerable": false,
  "temporal_category": "pre_cutoff",
  "description": "Fixed version with price deviation check to prevent flash loan LP manipulation",
  "vulnerable_contract": "LendingVault",
  "vulnerable_function": "getLPTokenValue, borrow",
  "vulnerable_lines": [],
  "attack_scenario": "1) Flash loan 5M DAI. 2) Swap DAI -> ETH in Uniswap pool, heavily imbalancing reserves (6M DAI, 100 ETH). 3) LP token value calculation uses manipulated reserves, showing inflated value. 4) Deposit LP tokens as collateral in Warp Finance. 5) Borrow maximum stablecoins based on inflated collateral valuation (2-3x more than true value). 6) Swap back to rebalance pool. 7) Repay flash loan. 8) Keep overborrowed funds. Loss: $7.7M.",
  "root_cause": "LP token value calculated from instantaneous pool reserves without protection against flash loan manipulation. Attacker can inflate LP value within a single transaction.",
  "fix_description": "",
  "source_reference": "",
  "external_references": [],
  "tags": [
    "flash_loan",
    "lp_tokens",
    "uniswap",
    "price_manipulation",
    "oracle",
    "collateral_valuation",
    "defi_lending",
    "differential",
    "fixed"
  ],
  "variant_type": "differential",
  "variant_parent_id": "tc_017",
  "notes": "",
  "contract_file": "contracts/df_tc_017.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "transformation": {
    "type": "differential",
    "strategy": "minimal_fix",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/original",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/original/contracts/tc_017.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/original/metadata/tc_017.json",
    "pair_metadata": "/Users/poamen/projects/grace/blockbench/base/data/manual_strategies/differential/metadata/df_pair_tc_017.json",
    "script": "manual",
    "is_fixed_version": true,
    "fix_type": "price_deviation_protection",
    "fix_description": "Added lastLPValue and lastUpdateBlock state variables, MAX_DEVIATION constant (10%), _checkPriceDeviation() function that rejects transactions when LP value deviates too much from stored value.",
    "exact_changes": [
      {
        "location": "state variables (lines 37-39)",
        "version_a": "uint256 public lastLPValue;\nuint256 public lastUpdateBlock;\nuint256 constant MAX_DEVIATION = 10;",
        "version_b": "// No price tracking"
      },
      {
        "location": "borrow function (line 49)",
        "version_a": "_checkPriceDeviation();",
        "version_b": "// No price check"
      },
      {
        "location": "_checkPriceDeviation function (lines 62-75)",
        "version_a": "require(currentValue >= minAllowed && currentValue <= maxAllowed, \"Price deviation too high\");",
        "version_b": "// Function does not exist"
      }
    ],
    "why_fix_works": "The price deviation check prevents flash loan attacks by rejecting transactions when LP value changes too rapidly, making same-block manipulation unprofitable.",
    "contracts_in_file": [
      "LendingVault"
    ],
    "created_date": "2025-12-30T02:02:17.935161"
  }
}

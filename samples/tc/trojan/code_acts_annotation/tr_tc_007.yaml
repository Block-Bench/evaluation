schema_version: "1.0"
sample_id: "tr_tc_007"
base_sample_id: "ms_tc_007"
vulnerability_type: "arithmetic_error"
is_vulnerable: true

# Trojan annotation documents INJECTED DECOY elements only.
# The base vulnerability is documented in ms_tc_009.yaml.
# DECOYs are suspicious-looking code that is actually safe - tests pattern matching vs understanding.

trojan_strategy: "config_and_metrics_distractors"
injection_count: 4

base_vulnerability:
  type: "arithmetic_error"
  function: "swap, _addLiquidity"
  vulnerable_lines: [139, 140, 141, 142, 172, 174]  # Line numbers in tr_tc_009.sol
  reference: "../../minimalsanitized/code_acts_annotation/ms_tc_007.yaml"

injections:

  # ============================================
  # DECOY 1: setPoolConfigVersion without access control
  # ============================================

  - id: "INJ1"
    type: "ACCESS_CTRL"
    security_function: "DECOY"

    location:
      file: "tr_tc_007.sol"
      function: "setPoolConfigVersion"
      lines: [227, 228, 229, 230, 231]
    suspicious_because:
      - "External function with no access control modifier"
      - "Allows anyone to set poolConfigVersion"
      - "Name suggests pool configuration/admin functionality"
      - "Emits event suggesting important state change"

    safe_because:
      - "poolConfigVersion is only used for tracking/versioning"
      - "No security decisions depend on poolConfigVersion"
      - "Modifying it has no impact on swaps or liquidity"
      - "Purely informational state"

    safety_factors:
      - "Non-security-relevant variable"
      - "No financial impact"
      - "Not used in any require/assert checks"

    pattern_triggered: "access_control"
    proximity: "same_file"
    distraction_risk: "medium"

  # ============================================
  # DECOY 2: Analytics state variables
  # ============================================

  - id: "INJ2"
    type: "DECLARATION"
    security_function: "DECOY"

    location:
      file: "tr_tc_007.sol"
      function: "contract-level"
      lines: [32, 33, 34, 35, 36]
    suspicious_because:
      - "Additional state variables beyond core AMM logic"
      - "Public visibility might suggest security relevance"
      - "Names like 'globalActivityScore' could be misidentified"

    safe_because:
      - "All are purely informational/analytics"
      - "None affect swap calculations or liquidity math"
      - "No security decisions based on these values"

    safety_factors:
      - "Informational only"
      - "No impact on core protocol"

    pattern_triggered: "suspicious_state"
    proximity: "same_file"
    distraction_risk: "low"

  # ============================================
  # DECOY 3: _recordPoolActivity analytics function
  # ============================================

  - id: "INJ3"
    type: "STATE_MOD"
    security_function: "DECOY"

    location:
      file: "tr_tc_007.sol"
      function: "_recordPoolActivity"
      lines: [93, 94, 95, 145, 154, 235, 236, 237, 238, 239, 240, 242, 243, 244, 246, 247]
    suspicious_because:
      - "State modifications in internal function"
      - "Called in swap and addLiquidity functions"
      - "Looks like it could affect pool calculations"
      - "Multiple state updates"

    safe_because:
      - "These variables are analytics/metrics only"
      - "userActivityScore, globalActivityScore have no security impact"
      - "No financial impact from analytics manipulation"
      - "The REAL issue is unchecked arithmetic in _addLiquidity"

    safety_factors:
      - "Non-security-relevant state variables"
      - "Bounded values prevent overflow exploitation"

    pattern_triggered: "state_modification"
    proximity: "same_function"
    distraction_risk: "low"

  # ============================================
  # DECOY 4: Additional analytics helper functions
  # ============================================

  - id: "INJ4"
    type: "COMPUTATION"
    security_function: "DECOY"

    location:
      file: "tr_tc_007.sol"
      function: "_recordTickUsage, _updateScore"
      lines: [249, 250, 251, 253, 254, 255, 256, 257, 258, 259, 260, 261, 262, 264, 265, 266, 268, 269]
    suspicious_because:
      - "Complex computations in tick handling"
      - "Names suggest they track something important"
      - "Tick-related operations could be confused with vulnerable tick math"

    safe_because:
      - "Only compute analytics scores"
      - "Results not used for any security decisions"
      - "No impact on liquidity calculations"

    safety_factors:
      - "Analytics computation only"
      - "No security impact"

    pattern_triggered: "complex_computation"
    proximity: "same_file"
    distraction_risk: "medium"
    note: "tick-related name might confuse pattern matching with vulnerable tick crossing logic"

# ============================================
# BASE VULNERABILITY CODE ACTS (reference only)
# ============================================
# The real vulnerability in tr_tc_009 is the same as ms_tc_009:
# - CA22: _addLiquidity call during tick crossing - lines 139-142
# - CA29: Unchecked subtraction z = x - uint128(-y) - line 172
# - CA30: Unchecked addition z = x + uint128(y) - line 174
#
# See ms_tc_009.yaml for full vulnerability annotation.

summary:
  total_injections: 4

  injection_types:
    ACCESS_CTRL: 1    # INJ1
    DECLARATION: 1    # INJ2
    STATE_MOD: 1      # INJ3
    COMPUTATION: 1    # INJ4

  distraction_risk_breakdown:
    high: 0
    medium: 2    # INJ1, INJ4
    low: 2       # INJ2, INJ3

  proximity_breakdown:
    same_file: 4       # INJ1, INJ2, INJ3, INJ4

  patterns_triggered:
    access_control: 1       # INJ1
    suspicious_state: 1     # INJ2
    state_modification: 1   # INJ3
    complex_computation: 1  # INJ4

  evaluation_notes:
    - "INJ1 tests access control pattern recognition - unprotected but non-critical"
    - "INJ2-4 are pure analytics/metrics distractors"
    - "INJ4 tick-related naming might confuse with real tick vulnerability"
    - "Correct analysis identifies _addLiquidity unchecked arithmetic as ROOT_CAUSE"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================

line_to_code_act:
  # === REAL VULNERABILITY CODE ACTS (from base ms_tc_009) ===
  # CA22: _addLiquidity call - ROOT_CAUSE
  139: "CA22"
  140: "CA22"
  141: "CA22"
  142: "CA22"
  # CA29: Unchecked subtraction - ROOT_CAUSE
  172: "CA29"
  # CA30: Unchecked addition - ROOT_CAUSE
  174: "CA30"
  # CA28: if (y < 0) branch - PREREQ
  171: "CA28"
  # CA2: Pool state variables - PREREQ
  15: "CA2"
  16: "CA2"
  17: "CA2"
  # CA3: liquidityNet mapping - PREREQ
  20: "CA3"
  # === INJECTED DECOY CODE ACTS ===
  # INJ1: setPoolConfigVersion (DECOY)
  227: "INJ1"
  228: "INJ1"
  229: "INJ1"
  230: "INJ1"
  231: "INJ1"
  # INJ2: Analytics state variables (DECOY)
  32: "INJ2"
  33: "INJ2"
  34: "INJ2"
  35: "INJ2"
  36: "INJ2"
  # INJ3: _recordPoolActivity (DECOY)
  93: "INJ3"
  154: "INJ3"
  235: "INJ3"
  236: "INJ3"
  237: "INJ3"
  238: "INJ3"
  239: "INJ3"
  240: "INJ3"
  # Line 241: empty
  242: "INJ3"
  243: "INJ3"
  244: "INJ3"
  # Line 245: empty
  246: "INJ3"
  247: "INJ3"
  # INJ3b: _recordTickUsage calls (DECOY)
  94: "INJ3"
  95: "INJ3"
  145: "INJ3"
  # INJ4: Analytics helpers (DECOY)
  249: "INJ4"
  250: "INJ4"
  251: "INJ4"
  253: "INJ4"
  254: "INJ4"
  255: "INJ4"
  256: "INJ4"
  257: "INJ4"
  258: "INJ4"
  259: "INJ4"
  260: "INJ4"
  261: "INJ4"
  262: "INJ4"
  # Line 263: empty
  264: "INJ4"
  265: "INJ4"
  266: "INJ4"
  # Line 267: empty
  268: "INJ4"
  269: "INJ4"

code_act_security_functions:
  # Real vulnerability code acts
  CA2: "PREREQ"
  CA3: "PREREQ"
  CA22: "ROOT_CAUSE"
  CA28: "PREREQ"
  CA29: "ROOT_CAUSE"
  CA30: "ROOT_CAUSE"
  # Injected decoys
  INJ1: "DECOY"
  INJ2: "DECOY"
  INJ3: "DECOY"
  INJ4: "DECOY"

schema_version: "1.0"
sample_id: "tr_tc_002"
base_sample_id: "ms_tc_002"
vulnerability_type: "governance_attack"
vulnerability_subtype: "flash_loan_voting"
is_vulnerable: true

# Trojan annotation documents INJECTED DECOY elements only.
# The base vulnerability is documented in ms_tc_002.yaml.
# DECOYs are suspicious-looking code that is actually safe - tests pattern matching vs understanding.

trojan_strategy: "suspicious_admin_and_execution_patterns"
injection_count: 4

base_vulnerability:
  type: "governance_attack"
  function: "emergencyCommit"
  vulnerable_lines: [56, 57, 101, 102, 106]  # Line numbers in tr_tc_002.sol
  reference: "../../minimalsanitized/code_acts_annotation/ms_tc_002.yaml"

injections:

  # ============================================
  # DECOY 1: Suspicious "setEmergencyOverride" function
  # ============================================

  - id: "INJ1"
    type: "ACCESS_CTRL"
    security_function: "DECOY"

    location:
      file: "tr_tc_002.sol"
      function: "setEmergencyOverride"
      lines: [115, 116, 117]
    suspicious_because:
      - "Function named 'setEmergencyOverride' suggests critical governance modification"
      - "Accepts threshold parameter suggesting it changes the 66% EMERGENCY_THRESHOLD"
      - "No access control modifier (external visibility, anyone can call)"
      - "Located near critical emergencyCommit function"

    safe_because:
      - "Sets 'deprecatedEmergencyThreshold' - a deprecated, unused variable"
      - "EMERGENCY_THRESHOLD is a constant (line 37) that cannot be modified"
      - "The real threshold check at line 102 uses the constant, not this variable"
      - "Function has no impact on governance execution"

    safety_factors:
      - "Modifies unused deprecated variable"
      - "Real threshold is immutable constant"
      - "No governance impact"

    pattern_triggered: "access_control"
    proximity: "same_file"
    distraction_risk: "high"

  # ============================================
  # DECOY 2: simulateExecution with external call
  # ============================================

  - id: "INJ2"
    type: "EXT_CALL"
    security_function: "DECOY"

    location:
      file: "tr_tc_002.sol"
      function: "simulateExecution"
      lines: [120, 121, 122, 123]
    suspicious_because:
      - "Function makes external call to arbitrary target with arbitrary data"
      - "Located in governance contract with real external call vulnerability"
      - "Similar pattern to the real vulnerable prop.target.call()"
      - "External visibility allows anyone to call"

    safe_because:
      - "Uses staticcall which cannot modify state (view-only)"
      - "Function is marked 'view' - enforces read-only semantics"
      - "Cannot execute any governance actions or transfers"
      - "Pure utility for off-chain simulation tools"

    safety_factors:
      - "staticcall enforces read-only"
      - "view modifier"
      - "No state changes possible"

    pattern_triggered: "arbitrary_external_call"
    proximity: "same_file"
    distraction_risk: "high"

  # ============================================
  # DECOY 3: State modification after external call
  # ============================================

  - id: "INJ3"
    type: "STATE_MOD"
    security_function: "DECOY"

    location:
      file: "tr_tc_002.sol"
      function: "emergencyCommit"
      lines: [111]

    suspicious_because:
      - "Internal function call AFTER external call at line 106"
      - "Classic reentrancy pattern: EXT_CALL then STATE_MOD"
      - "In same function as the real governance vulnerability"
      - "_logGovernanceEvent modifies state (governanceActivityScore)"

    safe_because:
      - "prop.executed set to true at line 104 BEFORE external call"
      - "The require(!prop.executed) check at line 99 prevents re-entry"
      - "governanceActivityScore is a non-critical analytics variable"
      - "Even if reentered, no governance actions can be repeated"

    safety_factors:
      - "Execution guard set before external call"
      - "Non-critical state modification"
      - "Reentrancy prevented by executed flag"

    pattern_triggered: "reentrancy"
    proximity: "same_function"
    distraction_risk: "medium"

  # ============================================
  # DECOY 4: Complex arithmetic in _computeScore
  # ============================================

  - id: "INJ4"
    type: "ARITHMETIC"
    security_function: "DECOY"

    location:
      file: "tr_tc_002.sol"
      function: "_computeScore"
      lines: [146, 147, 149, 150, 151, 152, 153, 155, 156, 157, 159, 160]  # excludes empty lines 148, 154, 158
    suspicious_because:
      - "Complex arithmetic operations with multiple conditions"
      - "Division operation (participation / 2) without explicit zero check"
      - "Used in governance context - could affect vote calculations"
      - "Called from _updateProposalMetrics which runs during propose()"

    safe_because:
      - "Pure internal function - no state impact"
      - "Division by 2 is safe (constant divisor, no zero division)"
      - "Result only affects proposalRiskScore - non-critical analytics"
      - "Bounded output (capped at 1000)"
      - "Not used in any governance decisions (threshold checks, execution)"

    safety_factors:
      - "Pure function"
      - "Non-critical analytics only"
      - "Bounded output"
      - "No governance impact"

    pattern_triggered: "arithmetic"
    proximity: "different_function"
    distraction_risk: "low"

# ============================================
# BASE VULNERABILITY CODE ACTS (reference only)
# ============================================
# The real vulnerability in tr_tc_002 is the same as ms_tc_002:
# - CA1: Instant voting power (line 56) - no holding period
# - CA2: Immediate total power update (line 57) - no snapshot
# - CA4: Vote percentage with no snapshot (line 101)
# - CA5: Threshold check without timelock (line 102)
# - CA6: Arbitrary execution without delay (line 106)
#
# See ms_tc_002.yaml for full vulnerability annotation.

summary:
  total_injections: 4

  injection_types:
    ACCESS_CTRL: 1  # INJ1
    EXT_CALL: 1     # INJ2
    STATE_MOD: 1    # INJ3
    ARITHMETIC: 1   # INJ4

  distraction_risk_breakdown:
    high: 2    # INJ1 (setEmergencyOverride), INJ2 (simulateExecution)
    medium: 1  # INJ3 (state mod after call)
    low: 1     # INJ4 (arithmetic)

  proximity_breakdown:
    same_function: 1   # INJ3
    same_file: 2       # INJ1, INJ2
    different_function: 1  # INJ4

  patterns_triggered:
    access_control: 1      # INJ1
    arbitrary_external_call: 1  # INJ2
    reentrancy: 1          # INJ3
    arithmetic: 1          # INJ4

  evaluation_notes:
    - "INJ1 is highly deceptive: named 'setEmergencyOverride' but modifies deprecated unused variable"
    - "INJ2 tests external call pattern recognition: uses staticcall (view-only), not state-modifying call"
    - "INJ3 tests reentrancy understanding: state mod after call, but protected by executed flag"
    - "INJ4 tests arithmetic pattern: complex but pure function with no governance impact"
    - "A model that flags INJ1/INJ2 demonstrates pattern matching over understanding"
    - "A model that correctly ignores DECOYs and identifies the flash loan voting vulnerability demonstrates causal understanding"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================
# Maps line numbers in tr_tc_002.sol to code acts.
# Includes both real vulnerability code acts AND injected DECOYs.
# Scoring: lookup line -> code_act -> security_function
#
# NOTE: Trojan annotations only map security-relevant code acts + injected DECOYs.
# UNRELATED items (comments, directives, syntax) are not tracked because:
# 1. Trojan evaluates DECOY resistance, not hallucination detection
# 2. Full coverage is handled by minimalsanitized annotations

line_to_code_act:
  # === REAL VULNERABILITY CODE ACTS (from base ms_tc_002) ===
  # deposit() function
  55: "CA3"        # balance tracking (PREREQ)
  56: "CA1"        # voting power grant (ROOT_CAUSE)
  57: "CA2"        # total power update (ROOT_CAUSE)
  # vote() function
  88: "CA11"       # already voted check (BENIGN)
  89: "CA12"       # already executed check (BENIGN)
  91: "CA13"       # vote accumulation (PREREQ)
  92: "CA14"       # mark as voted (BENIGN)
  # emergencyCommit() function
  99: "CA7"        # already executed check (BENIGN)
  101: "CA4"       # vote percentage calculation (ROOT_CAUSE)
  102: "CA5"       # threshold check (ROOT_CAUSE)
  104: "CA8"       # mark executed (BENIGN)
  106: "CA6"       # external call (ROOT_CAUSE)
  107: "CA9"       # success check (BENIGN)
  109: "CA10"      # event emission (BENIGN)
  # propose() function
  68: "CA15"       # proposal count increment (BENIGN)
  70: "CA16"       # proposal init (BENIGN)
  71: "CA16"
  72: "CA16"
  73: "CA16"
  74: "CA16"
  75: "CA16"
  77: "CA17"       # auto-vote (PREREQ)
  78: "CA18"       # mark as voted (BENIGN)
  # === INJECTED DECOY CODE ACTS ===
  # INJ1: setEmergencyOverride (DECOY)
  115: "INJ1"
  116: "INJ1"
  117: "INJ1"
  # INJ2: simulateExecution (DECOY)
  120: "INJ2"
  121: "INJ2"
  122: "INJ2"
  123: "INJ2"
  # INJ3: state mod after external call (DECOY)
  111: "INJ3"
  # INJ4: _computeScore arithmetic (DECOY)
  146: "INJ4"
  147: "INJ4"
  # 148 is empty line
  149: "INJ4"
  150: "INJ4"
  151: "INJ4"
  152: "INJ4"
  153: "INJ4"
  # 154 is empty line
  155: "INJ4"
  156: "INJ4"
  157: "INJ4"
  # 158 is empty line
  159: "INJ4"
  160: "INJ4"

code_act_security_functions:
  # Real vulnerability code acts
  CA1: "ROOT_CAUSE"
  CA2: "ROOT_CAUSE"
  CA3: "PREREQ"
  CA4: "ROOT_CAUSE"
  CA5: "ROOT_CAUSE"
  CA6: "ROOT_CAUSE"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "PREREQ"
  CA14: "BENIGN"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA17: "PREREQ"
  CA18: "BENIGN"
  # Injected decoys
  INJ1: "DECOY"
  INJ2: "DECOY"
  INJ3: "DECOY"
  INJ4: "DECOY"

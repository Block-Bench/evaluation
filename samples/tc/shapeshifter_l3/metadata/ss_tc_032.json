{
  "sample_id": "ss_tc_032",
  "exploit_name": "Wise Lending Rounding Error",
  "timestamp": "2024-01",
  "loss_amount_usd": 460000,
  "blockchain": "ethereum",
  "vulnerability_type": "arithmetic_error",
  "sub_category": "rounding_manipulation",
  "severity": "high",
  "tags": [
    "rounding_error",
    "share_manipulation",
    "integer_division",
    "precision_loss",
    "pool_state_manipulation"
  ],
  "difficulty": "expert",
  "temporal_category": "pre_cutoff",
  "cutoff_date": "2024-01",
  "description": "Wise Lending suffered a $460K exploit through share rounding error manipulation. Attackers set up a pool state with pseudoTotalPool = 2 wei and totalDepositShares = 1 wei, then exploited integer division rounding to receive more tokens on withdrawal than deposited.",
  "vulnerable_lines": [
    40,
    62
  ],
  "vulnerability_details": {
    "root_cause": "Integer division rounding errors with manipulable pool state ratios",
    "attack_vector": "Manipulate pool to extreme share:pool ratio, then exploit rounding in deposit/withdrawal calculations",
    "vulnerable_functions": [
      "_0x7248ad()",
      "_0x0cce35()",
      "_0x8cd0a4()"
    ],
    "key_weakness": [
      "No minimum pool size enforcement",
      "Unbounded share:pool ratio manipulation",
      "Integer division without rounding protection",
      "Missing invariant checks on share value",
      "Insufficient precision in calculations",
      "No limits on rapid deposit/withdrawal cycles"
    ]
  },
  "attack_flow": [
    "Create position NFT and make small initial deposits",
    "Withdraw most shares to manipulate pool state to extreme ratio",
    "Set pseudoTotalPool = 2 wei, totalDepositShares = 1 wei (2:1 ratio)",
    "Transfer manipulated position NFT to exploit contract",
    "Deposit large amount (520 Pendle LP tokens) into Wise Lending",
    "Share calculation rounds down: 520 tokens \u2192 260 shares (should be 520)",
    "Immediately withdraw: 260 shares \u00d7 (2/1 ratio) \u2192 520+ tokens back",
    "Repeat exploit with helper contracts to compound effect",
    "Each iteration extracts value through rounding asymmetry",
    "Extract total profit of $460K through repeated cycles"
  ],
  "mitigation": [
    "Enforce minimum pool size (e.g., 1e18 wei minimum pseudoTotalPool)",
    "Add invariant checks: withdrawAmount must not exceed depositAmount per user",
    "Implement bounds checking on share:pool ratio (e.g., max 1000:1)",
    "Use higher precision calculations (e.g., 1e27 RAY instead of 1e18)",
    "Round in favor of protocol, not users",
    "Implement circuit breakers for unusual share calculations",
    "Add withdrawal delays after deposits to prevent immediate arbitrage",
    "Monitor for rapid deposit/withdrawal cycles",
    "Add virtual shares/pool reserves to prevent manipulation",
    "Implement share value sanity checks"
  ],
  "references": [
    "https://twitter.com/danielvf/status/1746303616778981402",
    "https://etherscan.io/address/0x37e49bf3749513a02fa535f0cbc383796e8107e4",
    "https://etherscan.io/tx/0x04e16a79ff928db2fa88619cdd045cdfc7979a61d836c9c9e585b3d6f6d8bc31"
  ],
  "contract_file": "contracts/ss_tc_032.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "variant_type": "shapeshifter_l3",
  "variant_parent_id": "nc_tc_032",
  "transformation": {
    "type": "shapeshifter",
    "level": "l3",
    "includes": [
      "L1 formatting",
      "L2 hex identifiers",
      "L3 control flow"
    ],
    "identifier_style": "hex",
    "intensity": "medium",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/contracts/nc_tc_032.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/metadata/nc_tc_032.json",
    "script": "strategies/shapeshifter/shapeshifter_tc.py",
    "changes": [
      "Stripped existing line markers",
      "Renamed 34 identifiers using hex style",
      "Applied L1 tight formatting (removed blank lines, K&R braces)",
      "Added fresh sequential line markers"
    ],
    "rename_map": {
      "getPositionLendingShares": "_0x390062",
      "withdrawExactShares": "_0x0cce35",
      "withdrawExactAmount": "_0x8cd0a4",
      "totalDepositShares": "_0x7d6277",
      "depositExactAmount": "_0x7248ad",
      "userLendingShares": "_0x477183",
      "totalBorrowShares": "_0x347a3f",
      "userBorrowShares": "_0x2c833f",
      "collateralFactor": "_0xd80623",
      "pseudoTotalPool": "_0x1045d1",
      "lendingPoolData": "_0x0f4194",
      "_withdrawAmount": "_0x2ff8d2",
      "withdrawAmount": "_0x6ff151",
      "mintPosition": "_0x771f54",
      "nftIdCounter": "_0x0d961f",
      "transferFrom": "_0x65ce0c",
      "getTotalPool": "_0xd6cb4d",
      "positionNFTs": "_0x70dd97",
      "shareBurned": "_0xe5feba",
      "shareAmount": "_0x8e6f03",
      "_poolToken": "_0x0353ce",
      "balanceOf": "_0x51bedd",
      "account": "_0xd860ea",
      "ownerOf": "_0xae3550",
      "_shares": "_0x8e4527",
      "approve": "_0x4f9b02",
      "_amount": "_0x6e3d9a",
      "spender": "_0xac561e",
      "tokenId": "_0x3454e7",
      "amount": "_0x2f7c62",
      "_nftId": "_0xc285d4",
      "nftId": "_0x3184cf",
      "pool": "_0xb7cc25",
      "to": "_0xb01af6"
    },
    "coverage_percent": 77.27,
    "identifiers_transformed": 34,
    "created_date": "2025-12-31T19:59:41.216908"
  },
  "vulnerable_contract": "IsolatedLending",
  "vulnerable_function": "_0x7248ad",
  "sanitized_from": "ms_tc_032",
  "is_vulnerable": true
}
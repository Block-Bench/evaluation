{
  "sample_id": "ss_tc_042",
  "exploit_name": "Penpie",
  "timestamp": "2024-09",
  "loss_amount_usd": 27000000,
  "blockchain": "ethereum",
  "vulnerability_type": "reentrancy",
  "sub_category": "fake_market_registration",
  "severity": "critical",
  "tags": [
    "yield_optimization",
    "reentrancy",
    "fake_market",
    "reward_manipulation",
    "cei_violation"
  ],
  "difficulty": "expert",
  "temporal_category": "pre_cutoff",
  "cutoff_date": "2024-09",
  "description": "Penpie, a Pendle yield optimizer, was exploited for $27M when attackers registered a fake Pendle market and exploited reentrancy in reward claiming. The fake market's claimRewards() callback reentered Penpie to manipulate balances, allowing withdrawal of real assets far exceeding deposits.",
  "vulnerable_lines": [
    26,
    43
  ],
  "vulnerability_details": {
    "root_cause": "Reentrancy vulnerability in claimRewards() combined with insufficient market validation on registration",
    "attack_vector": "Register fake Pendle market, exploit reentrancy during reward claim to inflate balances, withdraw real assets",
    "vulnerable_functions": [
      "_0x7d6277()",
      "_0x7248ad()",
      "_0x1045d1()"
    ],
    "key_weakness": [
      "Missing reentrancy guards",
      "External calls before state updates (CEI violated)",
      "No validation markets from official factory",
      "Trusts arbitrary market contracts",
      "No monitoring for suspicious registrations",
      "Missing access controls on registration"
    ]
  },
  "attack_flow": [
    "Create fake Pendle market contract implementing IPendleMarket",
    "Fake market's getRewardTokens() returns real Pendle LPTs",
    "Fake market's claimRewards() triggers reentrancy attack",
    "Call registerMarket(fakeMarketAddress) on Penpie",
    "Penpie accepts without validating market origin",
    "Deposit small amount into fake market via Penpie",
    "Call Penpie.claimRewards(fakeMarket, attacker)",
    "Penpie calls fakeMarket.claimRewards(attacker)",
    "Fake market reenters Penpie.deposit() during callback",
    "Reentrancy manipulates userBalances before state update",
    "Internal balance inflated to large amount",
    "Call withdraw() with inflated balance",
    "Penpie transfers real Pendle LPTs based on manipulated balance",
    "Convert Pendle LPTs to ETH via DEX",
    "Total profit: $27M"
  ],
  "mitigation": [
    "Add reentrancy guards (OpenZeppelin ReentrancyGuard)",
    "Follow checks-effects-interactions pattern strictly",
    "Update state before making external calls",
    "Verify markets created by official Pendle factory only",
    "Whitelist approved market contracts",
    "Add market registration approval process",
    "Implement circuit breakers for unusual activity",
    "Monitor for suspicious reward claim patterns",
    "Add maximum withdrawal limits",
    "Require time delay between deposit and withdrawal"
  ],
  "references": [
    "https://twitter.com/rotcivegaf",
    "https://etherscan.io/address/0x16296859C15289731521F199F0a5f762dF6347d0"
  ],
  "contract_file": "contracts/ss_tc_042.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "variant_type": "shapeshifter_l3",
  "variant_parent_id": "nc_tc_042",
  "transformation": {
    "type": "shapeshifter",
    "level": "l3",
    "includes": [
      "L1 formatting",
      "L2 hex identifiers",
      "L3 control flow"
    ],
    "identifier_style": "hex",
    "intensity": "medium",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/contracts/nc_tc_042.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/metadata/nc_tc_042.json",
    "script": "strategies/shapeshifter/shapeshifter_tc.py",
    "changes": [
      "Stripped existing line markers",
      "Renamed 19 identifiers using hex style",
      "Applied L1 tight formatting (removed blank lines, K&R braces)",
      "Added fresh sequential line markers"
    ],
    "rename_map": {
      "rewardIndexesCurrent": "_0x390062",
      "registeredMarkets": "_0x0cce35",
      "getRewardTokens": "_0x8cd0a4",
      "registerMarket": "_0x7d6277",
      "claimRewards": "_0x7248ad",
      "transferFrom": "_0x477183",
      "userBalances": "_0x347a3f",
      "totalStaked": "_0x2c833f",
      "balanceOf": "_0xd80623",
      "withdraw": "_0x1045d1",
      "account": "_0x0f4194",
      "approve": "_0x2ff8d2",
      "rewards": "_0x6ff151",
      "deposit": "_0x771f54",
      "spender": "_0x0d961f",
      "amount": "_0x65ce0c",
      "market": "_0xd6cb4d",
      "user": "_0x70dd97",
      "to": "_0xe5feba"
    },
    "coverage_percent": 65.52,
    "identifiers_transformed": 19,
    "created_date": "2025-12-31T19:59:41.243813"
  },
  "vulnerable_contract": "VeTokenStaking",
  "vulnerable_function": "_0x7d6277",
  "sanitized_from": "ms_tc_042",
  "is_vulnerable": true
}
#!/usr/bin/env python3
"""
Aggregate detection metrics grouped by vulnerability type across all DS tiers.
"""
import json
from pathlib import Path
from collections import defaultdict
import argparse

def main():
    parser = argparse.ArgumentParser(description='Aggregate metrics by vulnerability type')
    parser.add_argument('--output', '-o', default='results/detection_evaluation/ds_aggregated',
                        help='Output directory')
    args = parser.parse_args()
    
    base = Path('results/detection_evaluation/llm-judge')
    output_dir = Path(args.output)
    output_dir.mkdir(parents=True, exist_ok=True)
    
    judges = ['codestral', 'gemini-3-flash', 'mimo-v2-flash']
    detectors = ['claude-opus-4-5', 'gemini-3-pro', 'deepseek-v3-2', 'gpt-5.2', 
                 'llama-4-maverick', 'qwen3-coder-plus', 'grok-4-fast']
    tiers = ['tier1', 'tier2', 'tier3', 'tier4']
    
    # Aggregate by vulnerability type
    vuln_stats = defaultdict(lambda: {
        'total_samples': 0,
        'total_found': 0,
        'by_detector': defaultdict(lambda: {'samples': 0, 'found': 0}),
        'by_tier': defaultdict(lambda: {'samples': 0, 'found': 0}),
        'by_judge': defaultdict(lambda: {'samples': 0, 'found': 0}),
    })
    
    # Also collect detector-level stats
    detector_stats = defaultdict(lambda: {
        'total_samples': 0,
        'total_found': 0,
        'by_vuln': defaultdict(lambda: {'samples': 0, 'found': 0}),
    })
    
    for judge in judges:
        for detector in detectors:
            for tier in tiers:
                summary_file = base / judge / detector / 'ds' / tier / '_tier_summary.json'
                if not summary_file.exists():
                    continue
                
                with open(summary_file) as f:
                    data = json.load(f)
                
                by_vuln = data.get('by_vulnerability_type', {})
                
                for vuln_type, stats in by_vuln.items():
                    samples = stats.get('total_samples', 0)
                    found = stats.get('target_found_count', 0)
                    
                    vuln_stats[vuln_type]['total_samples'] += samples
                    vuln_stats[vuln_type]['total_found'] += found
                    vuln_stats[vuln_type]['by_detector'][detector]['samples'] += samples
                    vuln_stats[vuln_type]['by_detector'][detector]['found'] += found
                    vuln_stats[vuln_type]['by_tier'][tier]['samples'] += samples
                    vuln_stats[vuln_type]['by_tier'][tier]['found'] += found
                    vuln_stats[vuln_type]['by_judge'][judge]['samples'] += samples
                    vuln_stats[vuln_type]['by_judge'][judge]['found'] += found
                    
                    detector_stats[detector]['total_samples'] += samples
                    detector_stats[detector]['total_found'] += found
                    detector_stats[detector]['by_vuln'][vuln_type]['samples'] += samples
                    detector_stats[detector]['by_vuln'][vuln_type]['found'] += found
    
    # Calculate rates and prepare output
    vuln_results = {}
    for vuln_type, stats in vuln_stats.items():
        total = stats['total_samples']
        found = stats['total_found']
        
        vuln_results[vuln_type] = {
            'total_samples': total,
            'total_found': found,
            'detection_rate': found / total if total > 0 else 0,
            'by_detector': {},
            'by_tier': {},
            'by_judge': {},
        }
        
        for det, d in stats['by_detector'].items():
            rate = d['found'] / d['samples'] if d['samples'] > 0 else 0
            vuln_results[vuln_type]['by_detector'][det] = {
                'samples': d['samples'], 'found': d['found'], 'rate': rate
            }
        
        for tier, d in stats['by_tier'].items():
            rate = d['found'] / d['samples'] if d['samples'] > 0 else 0
            vuln_results[vuln_type]['by_tier'][tier] = {
                'samples': d['samples'], 'found': d['found'], 'rate': rate
            }
        
        for judge, d in stats['by_judge'].items():
            rate = d['found'] / d['samples'] if d['samples'] > 0 else 0
            vuln_results[vuln_type]['by_judge'][judge] = {
                'samples': d['samples'], 'found': d['found'], 'rate': rate
            }
    
    # Detector results
    detector_results = {}
    for det, stats in detector_stats.items():
        total = stats['total_samples']
        found = stats['total_found']
        
        detector_results[det] = {
            'total_samples': total,
            'total_found': found,
            'detection_rate': found / total if total > 0 else 0,
            'by_vulnerability': {},
        }
        
        for vuln, d in stats['by_vuln'].items():
            rate = d['found'] / d['samples'] if d['samples'] > 0 else 0
            detector_results[det]['by_vulnerability'][vuln] = {
                'samples': d['samples'], 'found': d['found'], 'rate': rate
            }
    
    # Save results
    with open(output_dir / 'by_vulnerability_type.json', 'w') as f:
        json.dump(vuln_results, f, indent=2)
    
    with open(output_dir / 'by_detector.json', 'w') as f:
        json.dump(detector_results, f, indent=2)
    
    # Print summary
    print("=" * 80)
    print("DETECTION RATES BY VULNERABILITY TYPE (across all judges, detectors, tiers)")
    print("=" * 80)
    
    sorted_vulns = sorted(vuln_results.items(), key=lambda x: -x[1]['detection_rate'])
    print(f"\n{'Vulnerability Type':<25} {'Samples':>10} {'Found':>10} {'Rate':>10}")
    print("-" * 60)
    for vuln, data in sorted_vulns:
        print(f"{vuln:<25} {data['total_samples']:>10} {data['total_found']:>10} {data['detection_rate']*100:>9.1f}%")
    
    # Breakdown by detector for each vulnerability
    print("\n" + "=" * 80)
    print("DETECTION RATES BY VULNERABILITY TYPE AND DETECTOR")
    print("=" * 80)
    
    for vuln, data in sorted_vulns:
        print(f"\n### {vuln} (overall: {data['detection_rate']*100:.1f}%) ###")
        by_det = sorted(data['by_detector'].items(), key=lambda x: -x[1]['rate'])
        for det, d in by_det:
            print(f"  {det:<20}: {d['rate']*100:>5.1f}% ({d['found']}/{d['samples']})")
    
    print(f"\nResults saved to: {output_dir}")


if __name__ == '__main__':
    main()

schema_version: "1.0"
sample_id: "ms_tc_016"
vulnerability_type: "validation_bypass"
vulnerable_lines: [67]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    lines: [15]
    code: "address public handler;"
    security_function: "BENIGN"
    rationale: "Handler address for bridge deposits. Correctly stored."

  - id: "CA2"
    type: "DECLARATION"
    lines: [23]
    code: "uint64 public depositNonce;"
    security_function: "BENIGN"
    rationale: "Deposit nonce for tracking. Correctly implemented."

  - id: "CA3"
    type: "INITIALIZATION"
    lines: [25, 26, 27]
    code: |
      constructor(address _handler) {
          handler = _handler;
      }
    security_function: "BENIGN"
    rationale: "Constructor sets handler. Correctly implemented."

  - id: "CA4"
    type: "STATE_MOD"
    lines: [37]
    code: "depositNonce += 1;"
    security_function: "BENIGN"
    rationale: "Nonce increment. Correctly tracks deposits."

  - id: "CA5"
    type: "EXT_CALL"
    lines: [39]
    code: "QBridgeHandler(handler).deposit(resourceID, msg.sender, data);"
    security_function: "BENIGN"
    rationale: "Forwards deposit to handler. Correct bridge behavior - the vulnerability is inside the handler."

  - id: "CA6"
    type: "EVENT_EMIT"
    lines: [41]
    code: "emit Deposit(destinationDomainID, resourceID, depositNonce);"
    security_function: "BENIGN"
    rationale: "Event emission. Correctly logs deposit."

  - id: "CA7"
    type: "DECLARATION"
    lines: [46]
    code: "mapping(bytes32 => address) public resourceIDToTokenContractAddress;"
    security_function: "BENIGN"
    rationale: "Mapping declaration. The flaw is failure to validate lookup results, not the mapping's existence."

  - id: "CA8"
    type: "DECLARATION"
    lines: [47]
    code: "mapping(address => bool) public contractWhitelist;"
    security_function: "BENIGN"
    rationale: "Unused whitelist mapping. Dead state cannot be a prerequisite."

  - id: "CA9"
    type: "CTRL_FLOW"
    lines: [57]
    code: "address tokenContract = resourceIDToTokenContractAddress[resourceID];"
    security_function: "BENIGN"
    rationale: "Mechanical mapping read. The vulnerability is the absence of validation after this read, not the read itself."

  - id: "CA10"
    type: "COMPUTATION"
    lines: [62, 63]
    code: |
      uint256 amount;
      (amount) = abi.decode(data, (uint256));
    security_function: "BENIGN"
    rationale: "Decodes amount from data. Correctly implemented."

  - id: "CA11"
    type: "EXT_CALL"
    lines: [67]
    code: "IERC20(tokenContract).transferFrom(depositer, address(this), amount);"
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - Missing validation: tokenContract is used without checking != address(0). For unregistered resourceIDs, this calls address(0) which doesn't revert, allowing deposits without transferring tokens."

  - id: "CA12"
    type: "ACCESS_CTRL"
    lines: [76, 77, 80]
    code: |
      function setResource(bytes32 resourceID, address tokenAddress) external {
          resourceIDToTokenContractAddress[resourceID] = tokenAddress;
          // Note: Should also add to whitelist
      }
    security_function: "SECONDARY_VULN"
    rationale: "SECONDARY_VULN - setResource has no access control. Anyone can set resource mappings. However, main vulnerability is that deposit doesn't validate tokenContract != address(0)."

  # ============================================
  # BATCHED UNRELATED CODE ACTS (for scoring)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [29, 30, 31, 49, 50, 51, 59, 60, 65, 66, 69, 70, 73, 74, 75, 79]
    security_function: "UNRELATED"
    rationale: "Inline comments and NatSpec documentation"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 6, 7, 8, 9, 10, 11, 12, 14, 17, 18, 19, 20, 21, 32, 33, 34, 35, 36, 43, 45, 52, 53, 54, 55, 56, 71, 80, 81]
    security_function: "UNRELATED"
    rationale: "Interface, contract, event, and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [42, 68]
    security_function: "UNRELATED"
    rationale: "Closing braces"

summary:
  total_code_acts: 16
  total_lines_covered: 57  # excludes 17 empty lines

  by_security_function:
    ROOT_CAUSE: 1      # CA11
    SECONDARY_VULN: 1  # CA12
    PREREQ: 0
    BENIGN: 10         # CA1-CA10
    UNRELATED: 4       # batched

  root_causes:
    - id: "CA11"
      line: 67
      type: "EXT_CALL"
      description: "Missing validation before external call - tokenContract used without checking != address(0)"

  secondary_vulns:
    - id: "CA12"
      lines: [76, 77, 80]
      type: "ACCESS_CTRL"
      description: "setResource lacks access control - independent misconfiguration risk"

line_to_code_act:
  # Directives (UNRELATED)
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  # IERC20 interface (UNRELATED)
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  6: "CA_DECLARATIONS"
  7: "CA_DECLARATIONS"
  8: "CA_DECLARATIONS"
  9: "CA_DECLARATIONS"
  # Line 10: empty
  11: "CA_DECLARATIONS"
  12: "CA_DECLARATIONS"
  # Line 13: empty
  # QBridge contract
  14: "CA_DECLARATIONS"
  15: "CA1"
  # Line 16: empty
  17: "CA_DECLARATIONS"
  18: "CA_DECLARATIONS"
  19: "CA_DECLARATIONS"
  20: "CA_DECLARATIONS"
  21: "CA_DECLARATIONS"
  # Line 22: empty
  23: "CA2"
  # Line 24: empty
  25: "CA3"
  26: "CA3"
  27: "CA3"
  # Line 28: empty
  29: "CA_COMMENTS"
  30: "CA_COMMENTS"
  31: "CA_COMMENTS"
  32: "CA_DECLARATIONS"
  33: "CA_DECLARATIONS"
  34: "CA_DECLARATIONS"
  35: "CA_DECLARATIONS"
  36: "CA_DECLARATIONS"
  37: "CA4"
  # Line 38: empty
  39: "CA5"
  # Line 40: empty
  41: "CA6"
  42: "CA_SYNTAX"
  43: "CA_DECLARATIONS"
  # Line 44: empty
  # QBridgeHandler contract
  45: "CA_DECLARATIONS"
  46: "CA7"
  47: "CA8"
  # Line 48: empty
  49: "CA_COMMENTS"
  50: "CA_COMMENTS"
  51: "CA_COMMENTS"
  52: "CA_DECLARATIONS"
  53: "CA_DECLARATIONS"
  54: "CA_DECLARATIONS"
  55: "CA_DECLARATIONS"
  56: "CA_DECLARATIONS"
  57: "CA9"
  # Line 58: empty
  # Line 59: empty
  # Line 60: empty
  # Line 61: empty
  62: "CA10"
  63: "CA10"
  # Line 64: empty
  # Line 65: empty
  # Line 66: empty
  67: "CA11"
  # Line 68: empty
  # Line 69: empty
  # Line 70: empty
  71: "CA_DECLARATIONS"
  # Line 72: empty
  73: "CA_COMMENTS"
  74: "CA_COMMENTS"
  75: "CA_COMMENTS"
  76: "CA12"
  77: "CA12"
  # Line 78: empty
  # Line 79: empty
  80: "CA12"  # Closing brace of function declared in CA12
  81: "CA_DECLARATIONS"

code_act_security_functions:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "ROOT_CAUSE"
  CA12: "SECONDARY_VULN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

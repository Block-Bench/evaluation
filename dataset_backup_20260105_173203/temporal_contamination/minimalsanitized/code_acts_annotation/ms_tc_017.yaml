schema_version: "1.0"
sample_id: "ms_tc_017"
vulnerability_type: "price_oracle_manipulation"
vulnerable_lines: [73]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    lines: [26, 27, 28, 29]
    code: |
      struct Position {
          uint256 lpTokenAmount;
          uint256 borrowed;
      }
    security_function: "BENIGN"
    rationale: "Position struct declaration. Data container, not a prerequisite."

  - id: "CA2"
    type: "DECLARATION"
    lines: [31]
    code: "mapping(address => Position) public positions;"
    security_function: "BENIGN"
    rationale: "Position mapping declaration. Data container, not a prerequisite."

  - id: "CA3"
    type: "DECLARATION"
    lines: [33, 34, 35]
    code: |
      address public lpToken;
      address public stablecoin;
      uint256 public constant COLLATERAL_RATIO = 150;
    security_function: "BENIGN"
    rationale: "Configuration variables. Correctly set."

  - id: "CA4"
    type: "EXT_CALL"
    lines: [46]
    code: "IERC20(lpToken).transferFrom(msg.sender, address(this), amount);"
    security_function: "BENIGN"
    rationale: "LP token deposit. Correctly implemented."

  - id: "CA5"
    type: "STATE_MOD"
    lines: [47]
    code: "positions[msg.sender].lpTokenAmount += amount;"
    security_function: "BENIGN"
    rationale: "Position update on deposit. Correctly implemented."

  - id: "CA6"
    type: "COMPUTATION"
    lines: [54, 55, 56]
    code: |
      uint256 collateralValue = getLPTokenValue(
          positions[msg.sender].lpTokenAmount
      );
    security_function: "BENIGN"
    rationale: "Collateral value calculation. Consumes tainted value from manipulable reserves - downstream consequence, not prerequisite."

  - id: "CA7"
    type: "COMPUTATION"
    lines: [57]
    code: "uint256 maxBorrow = (collateralValue * 100) / COLLATERAL_RATIO;"
    security_function: "BENIGN"
    rationale: "Max borrow calculation. Standard lending mechanics consuming already-tainted value."

  - id: "CA8"
    type: "INPUT_VAL"
    lines: [59, 60, 61, 62]
    code: |
      require(
          positions[msg.sender].borrowed + amount <= maxBorrow,
          "Insufficient collateral"
      );
    security_function: "BENIGN"
    rationale: "Borrow check. Standard validation consuming already-tainted maxBorrow value."

  - id: "CA9"
    type: "STATE_MOD"
    lines: [64]
    code: "positions[msg.sender].borrowed += amount;"
    security_function: "BENIGN"
    rationale: "Borrow amount update. Correctly implemented."

  - id: "CA10"
    type: "EXT_CALL"
    lines: [65]
    code: "IERC20(stablecoin).transfer(msg.sender, amount);"
    security_function: "BENIGN"
    rationale: "Stablecoin transfer to borrower. State updated before call."

  - id: "CA11"
    type: "INPUT_VAL"
    lines: [69]
    code: "if (lpAmount == 0) return 0;"
    security_function: "BENIGN"
    rationale: "Zero amount check. Correctly handles edge case."

  - id: "CA12"
    type: "EXT_CALL"
    lines: [71]
    code: "IUniswapV2Pair pair = IUniswapV2Pair(lpToken);"
    security_function: "BENIGN"
    rationale: "Cast to pair interface. Correctly implemented."

  - id: "CA13"
    type: "EXT_CALL"
    lines: [73]
    code: "(uint112 reserve0, uint112 reserve1, ) = pair.getReserves();"
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - Uses spot reserves from Uniswap pair. Attacker can manipulate reserves via flash loan, inflate LP value, borrow more than actual collateral is worth, then let reserves normalize. Classic flash loan oracle manipulation."

  - id: "CA14"
    type: "EXT_CALL"
    lines: [74]
    code: "uint256 totalSupply = pair.totalSupply();"
    security_function: "BENIGN"
    rationale: "Total supply access. Mechanical read - any LP pricing would need this."

  - id: "CA15"
    type: "COMPUTATION"
    lines: [78, 79]
    code: |
      uint256 amount0 = (uint256(reserve0) * lpAmount) / totalSupply;
      uint256 amount1 = (uint256(reserve1) * lpAmount) / totalSupply;
    security_function: "BENIGN"
    rationale: "Reserve share calculation. Part of the same valuation formula as ROOT_CAUSE - uses manipulated reserves."

  - id: "CA16"
    type: "COMPUTATION"
    lines: [83, 86]
    code: |
      uint256 value0 = amount0;
      uint256 totalValue = amount0 + amount1;
    security_function: "BENIGN"
    rationale: "Value aggregation. Part of the same valuation formula as ROOT_CAUSE."

  - id: "CA17"
    type: "INPUT_VAL"
    lines: [95]
    code: 'require(positions[msg.sender].borrowed >= amount, "Repay exceeds debt");'
    security_function: "BENIGN"
    rationale: "Repay validation. Correctly checks debt."

  - id: "CA18"
    type: "EXT_CALL"
    lines: [97]
    code: "IERC20(stablecoin).transferFrom(msg.sender, address(this), amount);"
    security_function: "BENIGN"
    rationale: "Stablecoin repayment transfer."

  - id: "CA19"
    type: "STATE_MOD"
    lines: [98]
    code: "positions[msg.sender].borrowed -= amount;"
    security_function: "BENIGN"
    rationale: "Debt reduction. Correctly implemented."

  - id: "CA20"
    type: "INPUT_VAL"
    lines: [105, 106, 107, 108]
    code: |
      require(
          positions[msg.sender].lpTokenAmount >= amount,
          "Insufficient balance"
      );
    security_function: "BENIGN"
    rationale: "Withdrawal balance check."

  - id: "CA21"
    type: "COMPUTATION"
    lines: [111, 112, 113]
    code: |
      uint256 remainingLP = positions[msg.sender].lpTokenAmount - amount;
      uint256 remainingValue = getLPTokenValue(remainingLP);
      uint256 maxBorrow = (remainingValue * 100) / COLLATERAL_RATIO;
    security_function: "BENIGN"
    rationale: "Withdrawal health check. Not used in the exploit path - attack completes at borrow time."

  - id: "CA22"
    type: "INPUT_VAL"
    lines: [115, 116, 117, 118]
    code: |
      require(
          positions[msg.sender].borrowed <= maxBorrow,
          "Withdrawal would liquidate position"
      );
    security_function: "BENIGN"
    rationale: "Withdrawal health check. Prevents under-collateralization."

  - id: "CA23"
    type: "STATE_MOD"
    lines: [120]
    code: "positions[msg.sender].lpTokenAmount -= amount;"
    security_function: "BENIGN"
    rationale: "LP token withdrawal state update."

  - id: "CA24"
    type: "EXT_CALL"
    lines: [121]
    code: "IERC20(lpToken).transfer(msg.sender, amount);"
    security_function: "BENIGN"
    rationale: "LP token withdrawal transfer."

  # ============================================
  # BATCHED UNRELATED CODE ACTS (for scoring)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [42, 43, 44, 50, 51, 52, 76, 77, 81, 82, 84, 85, 91, 92, 93, 101, 102, 103, 110]
    security_function: "UNRELATED"
    rationale: "Inline comments and NatSpec documentation"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 6, 7, 8, 9, 10, 11, 13, 14, 16, 17, 18, 19, 20, 21, 22, 23, 25, 37, 38, 39, 40, 45, 53, 66, 68, 88, 89, 94, 99, 104, 122, 123]
    security_function: "UNRELATED"
    rationale: "Interface, contract, struct, constructor, and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [12, 48]
    security_function: "UNRELATED"
    rationale: "Closing braces"

summary:
  total_code_acts: 28
  total_lines_covered: 96  # excludes 29 empty lines

  by_security_function:
    ROOT_CAUSE: 1      # CA13
    PREREQ: 0
    BENIGN: 23         # CA1-CA12, CA14-CA24
    UNRELATED: 4       # batched

  root_causes:
    - id: "CA13"
      line: 73
      type: "EXT_CALL"
      description: "Uses spot reserves from Uniswap pair as price oracle for LP token valuation - allows flash loan manipulation"

line_to_code_act:
  # Directives (UNRELATED)
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  # IUniswapV2Pair interface (UNRELATED)
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  6: "CA_DECLARATIONS"
  7: "CA_DECLARATIONS"
  8: "CA_DECLARATIONS"
  # Line 9: empty
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  # Line 12: empty
  # IERC20 interface (UNRELATED)
  13: "CA_DECLARATIONS"
  14: "CA_DECLARATIONS"
  # Line 15: empty
  16: "CA_DECLARATIONS"
  # Line 17: empty
  18: "CA_DECLARATIONS"
  19: "CA_DECLARATIONS"
  20: "CA_DECLARATIONS"
  21: "CA_DECLARATIONS"
  22: "CA_DECLARATIONS"
  23: "CA_DECLARATIONS"
  # Line 24: empty
  # WarpVault contract
  25: "CA_DECLARATIONS"
  26: "CA1"
  27: "CA1"
  28: "CA1"
  29: "CA1"
  # Line 30: empty
  31: "CA2"
  # Line 32: empty
  33: "CA3"
  34: "CA3"
  35: "CA3"
  # Line 36: empty
  37: "CA_DECLARATIONS"
  38: "CA_DECLARATIONS"
  39: "CA_DECLARATIONS"
  40: "CA_DECLARATIONS"
  # Line 41: empty
  42: "CA_COMMENTS"
  43: "CA_COMMENTS"
  44: "CA_COMMENTS"
  45: "CA_DECLARATIONS"
  46: "CA4"
  47: "CA5"
  48: "CA_SYNTAX"
  # Line 49: empty
  50: "CA_COMMENTS"
  51: "CA_COMMENTS"
  52: "CA_COMMENTS"
  53: "CA_DECLARATIONS"
  54: "CA6"
  55: "CA6"
  56: "CA6"
  57: "CA7"
  # Line 58: empty
  59: "CA8"
  60: "CA8"
  61: "CA8"
  62: "CA8"
  # Line 63: empty
  64: "CA9"
  65: "CA10"
  66: "CA_DECLARATIONS"
  # Line 67: empty
  68: "CA_DECLARATIONS"
  69: "CA11"
  # Line 70: empty
  71: "CA12"
  # Line 72: empty
  73: "CA13"
  74: "CA14"
  # Line 75: empty
  76: "CA_COMMENTS"
  # Line 77: empty
  78: "CA15"
  79: "CA15"
  # Line 80: empty
  81: "CA_COMMENTS"
  82: "CA_COMMENTS"
  83: "CA16"
  # Line 84: empty
  85: "CA_COMMENTS"
  86: "CA16"
  # Line 87: empty
  88: "CA_DECLARATIONS"
  89: "CA_DECLARATIONS"
  # Line 90: empty
  91: "CA_COMMENTS"
  92: "CA_COMMENTS"
  93: "CA_COMMENTS"
  94: "CA_DECLARATIONS"
  95: "CA17"
  # Line 96: empty
  97: "CA18"
  98: "CA19"
  99: "CA_DECLARATIONS"
  # Line 100: empty
  101: "CA_COMMENTS"
  102: "CA_COMMENTS"
  103: "CA_COMMENTS"
  104: "CA_DECLARATIONS"
  105: "CA20"
  106: "CA20"
  107: "CA20"
  108: "CA20"
  # Line 109: empty
  110: "CA_COMMENTS"
  111: "CA21"
  112: "CA21"
  113: "CA21"
  # Line 114: empty
  115: "CA22"
  116: "CA22"
  117: "CA22"
  118: "CA22"
  # Line 119: empty
  120: "CA23"
  121: "CA24"
  122: "CA_DECLARATIONS"
  123: "CA_DECLARATIONS"

code_act_security_functions:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "ROOT_CAUSE"
  CA14: "BENIGN"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA17: "BENIGN"
  CA18: "BENIGN"
  CA19: "BENIGN"
  CA20: "BENIGN"
  CA21: "BENIGN"
  CA22: "BENIGN"
  CA23: "BENIGN"
  CA24: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

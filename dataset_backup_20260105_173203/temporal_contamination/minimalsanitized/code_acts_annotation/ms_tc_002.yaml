schema_version: "1.0"
sample_id: "ms_tc_002"
vulnerability_type: "governance_attack"
vulnerability_subtype: "flash_loan_voting"
vulnerable_lines: [55, 102]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  - id: "CA1"
    type: "STATE_MOD"
    lines: [55]
    code: "votingPower[msg.sender] += amount;"
    security_function: "ROOT_CAUSE"
    rationale: "Grants voting power instantly upon deposit with no time delay or holding period. This enables flash loan attacks where an attacker can borrow massive funds, deposit, vote, execute, and repay within a single transaction."

  - id: "CA2"
    type: "STATE_MOD"
    lines: [56]
    code: "totalVotingPower += amount;"
    security_function: "PREREQ"
    rationale: "Updates total voting power immediately. Part of the same deposit mechanism as CA1. Prerequisite because it enables the percentage calculation to include attacker's funds, but the primary flaw is instant voting power grant (CA1)."

  - id: "CA3"
    type: "STATE_MOD"
    lines: [54]
    code: "depositedBalance[msg.sender] += amount;"
    security_function: "PREREQ"
    rationale: "Tracks deposited balance. Prerequisite because it enables the deposit flow, but the vulnerability is the instant voting power, not the balance tracking."

  - id: "CA4"
    type: "COMPUTATION"
    lines: [101]
    code: "uint256 votePercentage = (prop.forVotes * 100) / totalVotingPower;"
    security_function: "PREREQ"
    rationale: "Calculates vote percentage using current values. The calculation itself is correct; the vulnerability is that upstream deposit grants instant voting power (CA1). Prerequisite because it uses manipulated inputs but isn't inherently flawed."

  - id: "CA5"
    type: "INPUT_VAL"
    lines: [102]
    code: 'require(votePercentage >= EMERGENCY_THRESHOLD, "Insufficient votes");'
    security_function: "ROOT_CAUSE"
    rationale: "Threshold check with no timelock or minimum holding period. Once 66% is reached (trivially with flash loan), proposal can execute immediately. No time delay for community review."

  - id: "CA6"
    type: "EXT_CALL"
    lines: [107]
    code: "(bool success, ) = prop.target.call(prop.data);"
    security_function: "PREREQ"
    rationale: "Executes the approved proposal. The call itself is correctly implemented; the flaw is in how authorization was obtained (instant voting power). Prerequisite because it realizes the attack impact but isn't the causal origin."

  - id: "CA7"
    type: "INPUT_VAL"
    lines: [98]
    code: 'require(!prop.executed, "Already executed");'
    security_function: "BENIGN"
    rationale: "Prevents double execution. Correctly implemented."

  - id: "CA8"
    type: "STATE_MOD"
    lines: [104]
    code: "prop.executed = true;"
    security_function: "BENIGN"
    rationale: "Marks proposal as executed before external call. Follows CEI pattern for reentrancy prevention."

  - id: "CA9"
    type: "INPUT_VAL"
    lines: [108]
    code: 'require(success, "Execution failed");'
    security_function: "BENIGN"
    rationale: "Checks external call success. Correctly implemented."

  - id: "CA10"
    type: "EVENT_EMIT"
    lines: [110]
    code: "emit ProposalExecuted(proposalId);"
    security_function: "BENIGN"
    rationale: "Event emission for logging."

  - id: "CA11"
    type: "INPUT_VAL"
    lines: [87]
    code: 'require(!hasVoted[proposalId][msg.sender], "Already voted");'
    security_function: "BENIGN"
    rationale: "Prevents double voting. Correctly implemented."

  - id: "CA12"
    type: "INPUT_VAL"
    lines: [88]
    code: 'require(!proposals[proposalId].executed, "Already executed");'
    security_function: "BENIGN"
    rationale: "Prevents voting on executed proposals. Correctly implemented."

  - id: "CA13"
    type: "STATE_MOD"
    lines: [90]
    code: "proposals[proposalId].forVotes += votingPower[msg.sender];"
    security_function: "PREREQ"
    rationale: "Adds voter's power to proposal. Prerequisite because it accumulates votes, but the issue is instant power granting, not the vote counting mechanism."

  - id: "CA14"
    type: "STATE_MOD"
    lines: [91]
    code: "hasVoted[proposalId][msg.sender] = true;"
    security_function: "BENIGN"
    rationale: "Marks voter as having voted. Correctly implemented."

  - id: "CA15"
    type: "STATE_MOD"
    lines: [65]
    code: "proposalCount++;"
    security_function: "BENIGN"
    rationale: "Increments proposal counter. Correctly implemented."

  - id: "CA16"
    type: "STATE_MOD"
    lines: [68, 69, 70, 71, 72]
    code: |
      prop.proposer = msg.sender;
      prop.target = _target;
      prop.data = _calldata;
      prop.startTime = block.timestamp;
      prop.executed = false;
    security_function: "BENIGN"
    rationale: "Initializes proposal struct. Correctly implemented."

  - id: "CA17"
    type: "STATE_MOD"
    lines: [75]
    code: "prop.forVotes = votingPower[msg.sender];"
    security_function: "PREREQ"
    rationale: "Auto-votes with proposer's voting power. Prerequisite because combined with instant voting power, this immediately gives attacker a head start toward 66%."

  - id: "CA18"
    type: "STATE_MOD"
    lines: [76]
    code: "hasVoted[proposalCount][msg.sender] = true;"
    security_function: "BENIGN"
    rationale: "Marks proposer as having voted. Correctly implemented."

  # ============================================
  # BATCHED UNRELATED CODE ACTS (for scoring)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [13, 17, 33, 44, 45, 46, 47, 48, 49, 50, 52, 53, 74, 82, 83, 84, 85, 100, 106]
    security_function: "UNRELATED"
    rationale: "Inline comments and NatSpec documentation"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 6, 7, 8, 9, 10, 12, 14, 15, 18, 19, 20, 21, 22, 23, 24, 25, 27, 28, 29, 31, 34, 51, 59, 60, 61, 62, 63, 64, 67, 79, 80, 86, 96, 97]
    security_function: "UNRELATED"
    rationale: "Interface, contract, struct, mapping, constant, function signature declarations"

  - id: "CA_EVENT_DEFS"
    type: "EVENT_DEF"
    lines: [36, 37, 38, 39, 40, 41, 42]
    security_function: "UNRELATED"
    rationale: "Event declarations"

  - id: "CA_EVENT_EMITS"
    type: "EVENT_EMIT"
    lines: [78, 93]
    security_function: "UNRELATED"
    rationale: "Non-security-relevant event emissions"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [57, 94, 111, 112]
    security_function: "UNRELATED"
    rationale: "Closing braces and structural tokens"

summary:
  total_code_acts: 24
  total_lines_covered: 92  # excludes 21 empty lines (3, 11, 16, 26, 30, 32, 35, 43, 58, 66, 73, 77, 81, 89, 92, 95, 99, 103, 105, 109, 113)

  by_security_function:
    ROOT_CAUSE: 2  # CA1, CA5
    PREREQ: 6      # CA2, CA3, CA4, CA6, CA13, CA17
    BENIGN: 10     # CA7, CA8, CA9, CA10, CA11, CA12, CA14, CA15, CA16, CA18
    UNRELATED: 6   # batched

  by_code_act_type:
    STATE_MOD: 9
    INPUT_VAL: 4
    COMPUTATION: 1
    EXT_CALL: 1
    EVENT_EMIT: 2
    DIRECTIVE: 1
    COMMENT: 1
    DECLARATION: 1
    EVENT_DEF: 1
    SYNTAX: 1

  root_causes:
    - id: "CA1"
      line: 55
      type: "STATE_MOD"
      description: "Instant voting power grant - no holding period"
    - id: "CA5"
      line: 102
      type: "INPUT_VAL"
      description: "Threshold check with no timelock"

  prerequisites:
    - id: "CA2"
      line: 56
      type: "STATE_MOD"
      description: "Immediate total power update - part of deposit mechanism"
    - id: "CA3"
      line: 54
      type: "STATE_MOD"
      description: "Balance tracking enables deposit flow"
    - id: "CA4"
      line: 101
      type: "COMPUTATION"
      description: "Vote percentage calculation using current values"
    - id: "CA6"
      line: 107
      type: "EXT_CALL"
      description: "Proposal execution - realizes attack impact"
    - id: "CA13"
      line: 90
      type: "STATE_MOD"
      description: "Vote accumulation mechanism"
    - id: "CA17"
      line: 75
      type: "STATE_MOD"
      description: "Auto-vote with proposer's power"

  vulnerable_lines_mapping:
    55: "CA1 - ROOT_CAUSE - instant voting power"
    102: "CA5 - ROOT_CAUSE - threshold check without timelock"

  # For scoring: lookup line -> code_act -> security_function
line_to_code_act:
  # Directives (UNRELATED)
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Interface/Contract/Struct declarations (UNRELATED)
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  6: "CA_DECLARATIONS"
  7: "CA_DECLARATIONS"
  8: "CA_DECLARATIONS"
  9: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  12: "CA_DECLARATIONS"
  14: "CA_DECLARATIONS"
  15: "CA_DECLARATIONS"
  18: "CA_DECLARATIONS"
  19: "CA_DECLARATIONS"
  20: "CA_DECLARATIONS"
  21: "CA_DECLARATIONS"
  22: "CA_DECLARATIONS"
  23: "CA_DECLARATIONS"
  24: "CA_DECLARATIONS"
  25: "CA_DECLARATIONS"
  27: "CA_DECLARATIONS"
  28: "CA_DECLARATIONS"
  29: "CA_DECLARATIONS"
  31: "CA_DECLARATIONS"
  34: "CA_DECLARATIONS"
  # Comments (UNRELATED)
  13: "CA_COMMENTS"
  17: "CA_COMMENTS"
  33: "CA_COMMENTS"
  44: "CA_COMMENTS"
  45: "CA_COMMENTS"
  46: "CA_COMMENTS"
  47: "CA_COMMENTS"
  48: "CA_COMMENTS"
  49: "CA_COMMENTS"
  50: "CA_COMMENTS"
  52: "CA_COMMENTS"
  53: "CA_COMMENTS"
  74: "CA_COMMENTS"
  82: "CA_COMMENTS"
  83: "CA_COMMENTS"
  84: "CA_COMMENTS"
  85: "CA_COMMENTS"
  100: "CA_COMMENTS"
  106: "CA_COMMENTS"
  # Event definitions (UNRELATED)
  36: "CA_EVENT_DEFS"
  37: "CA_EVENT_DEFS"
  38: "CA_EVENT_DEFS"
  39: "CA_EVENT_DEFS"
  40: "CA_EVENT_DEFS"
  41: "CA_EVENT_DEFS"
  42: "CA_EVENT_DEFS"
  # Function signatures (UNRELATED)
  51: "CA_DECLARATIONS"
  59: "CA_DECLARATIONS"
  60: "CA_DECLARATIONS"
  61: "CA_DECLARATIONS"
  62: "CA_DECLARATIONS"
  63: "CA_DECLARATIONS"
  64: "CA_DECLARATIONS"
  67: "CA_DECLARATIONS"
  79: "CA_DECLARATIONS"
  80: "CA_DECLARATIONS"
  86: "CA_DECLARATIONS"
  96: "CA_DECLARATIONS"
  97: "CA_DECLARATIONS"
  # Syntax (UNRELATED)
  57: "CA_SYNTAX"
  94: "CA_SYNTAX"
  111: "CA_SYNTAX"
  112: "CA_SYNTAX"
  # Event emissions (UNRELATED)
  78: "CA_EVENT_EMITS"
  93: "CA_EVENT_EMITS"
  # === SECURITY-RELEVANT CODE ACTS ===
  # deposit() function
  54: "CA3"
  55: "CA1"
  56: "CA2"
  # propose() function
  65: "CA15"
  68: "CA16"
  69: "CA16"
  70: "CA16"
  71: "CA16"
  72: "CA16"
  75: "CA17"
  76: "CA18"
  # vote() function
  87: "CA11"
  88: "CA12"
  90: "CA13"
  91: "CA14"
  # emergencyCommit() function
  98: "CA7"
  101: "CA4"
  102: "CA5"
  104: "CA8"
  107: "CA6"
  108: "CA9"
  110: "CA10"

code_act_security_functions:
  CA1: "ROOT_CAUSE"
  CA2: "PREREQ"
  CA3: "PREREQ"
  CA4: "PREREQ"
  CA5: "ROOT_CAUSE"
  CA6: "PREREQ"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "PREREQ"
  CA14: "BENIGN"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA17: "PREREQ"
  CA18: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_EVENT_DEFS: "UNRELATED"
  CA_EVENT_EMITS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

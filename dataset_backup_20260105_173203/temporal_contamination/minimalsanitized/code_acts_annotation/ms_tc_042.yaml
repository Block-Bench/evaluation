schema_version: "1.0"
sample_id: "ms_tc_042"
vulnerability_type: "reentrancy"
vulnerable_lines: [45]

code_acts:

  - id: "CA1"
    type: "EXT_CALL"
    lines: [45]
    code: "uint256[] memory rewards = IPendleMarket(market).claimRewards(user);"
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - External call to user-controlled market address without reentrancy guard. Attacker's fake market reenters deposit() during callback, manipulating userBalances before state updates."

  - id: "CA2"
    type: "STATE_MOD"
    lines: [74, 77, 78]
    code: |
      function registerMarket(address market) external {
          registeredMarkets[market] = true;
      }
    security_function: "PREREQ"
    rationale: "PREREQ - Market registration accepts any address without validation. This enables the attacker to register a malicious fake market, which is necessary to exploit the reentrancy in CA1. The direct vulnerability is the CEI violation (CA1), this is the enabling condition."

  - id: "CA3"
    type: "DECLARATION"
    lines: [39, 50, 51, 52, 53]
    code: |
      function claimRewards(address market, address user) external {
          for (uint256 i = 0; i < rewards.length; i++) {
              // Process rewards
          }
      }
    security_function: "BENIGN"
    rationale: "Function body showing CEI violation context. The vulnerability is modeled in CA1 (external call) and CA2 (unvalidated registration) - this is supporting context."

  - id: "CA4"
    type: "STATE_MOD"
    lines: [33, 34, 35, 36, 37]
    code: |
      function deposit(address market, uint256 amount) external {
          IERC20(market).transferFrom(msg.sender, address(this), amount);
          userBalances[market][msg.sender] += amount;
          totalStaked[market] += amount;
      }
    security_function: "BENIGN"
    rationale: "Standard deposit function (though reentered during attack)."

  - id: "CA5"
    type: "STATE_MOD"
    lines: [58, 59, 60, 61, 62, 64, 65, 67, 68]
    code: |
      function withdraw(address market, uint256 amount) external {
          require(userBalances[market][msg.sender] >= amount, "Insufficient balance");
          userBalances[market][msg.sender] -= amount;
          totalStaked[market] -= amount;
          IERC20(market).transfer(msg.sender, amount);
      }
    security_function: "BENIGN"
    rationale: "Standard withdraw function used to extract inflated balance."

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [30, 31, 32, 44, 49, 55, 56, 57]
    security_function: "UNRELATED"
    rationale: "Comments and NatSpec"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 7, 8, 9, 10, 11, 13, 15, 16, 18, 19, 21, 23, 24, 26, 27, 28, 69, 71, 72, 79]
    security_function: "UNRELATED"
    rationale: "Interface and contract declarations"

summary:
  total_code_acts: 8
  total_lines_covered: 55

  by_security_function:
    ROOT_CAUSE: 1      # CA1
    PREREQ: 1          # CA2
    BENIGN: 3          # CA3-CA5
    UNRELATED: 3

  root_causes:
    - id: "CA1"
      lines: [45]
      description: "External call to user-controlled market without reentrancy guard (CEI violation)"

  prerequisites:
    - id: "CA2"
      lines: [74, 77, 78]
      description: "Market registration accepts any address - enables attacker to register malicious market"

line_to_code_act:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  # Line 6: empty
  7: "CA_DECLARATIONS"
  8: "CA_DECLARATIONS"
  9: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  # Line 12: empty
  13: "CA_DECLARATIONS"
  # Line 14: empty
  15: "CA_DECLARATIONS"
  16: "CA_DECLARATIONS"
  # Line 17: empty
  18: "CA_DECLARATIONS"
  19: "CA_DECLARATIONS"
  # Line 20: empty
  21: "CA_DECLARATIONS"
  # Line 22: empty
  23: "CA_DECLARATIONS"
  24: "CA_DECLARATIONS"
  # Line 25: empty
  26: "CA_DECLARATIONS"
  27: "CA_DECLARATIONS"
  28: "CA_DECLARATIONS"
  # Line 29: empty
  30: "CA_COMMENTS"
  31: "CA_COMMENTS"
  32: "CA_COMMENTS"
  33: "CA4"
  34: "CA4"
  35: "CA4"
  36: "CA4"
  37: "CA4"
  # Line 38: empty
  39: "CA3"
  # Line 40: empty
  # Line 41: empty
  # Line 42: empty
  # Line 43: empty
  44: "CA_COMMENTS"
  45: "CA1"
  # Line 46: empty
  # Line 47: empty
  # Line 48: empty
  49: "CA_COMMENTS"
  50: "CA3"
  51: "CA3"
  52: "CA3"
  53: "CA3"
  # Line 54: empty
  55: "CA_COMMENTS"
  56: "CA_COMMENTS"
  57: "CA_COMMENTS"
  58: "CA5"
  59: "CA5"
  60: "CA5"
  61: "CA5"
  62: "CA5"
  # Line 63: empty
  64: "CA5"
  65: "CA5"
  # Line 66: empty
  67: "CA5"
  68: "CA5"
  69: "CA_DECLARATIONS"
  # Line 70: empty
  71: "CA_DECLARATIONS"
  72: "CA_DECLARATIONS"
  # Line 73: empty
  74: "CA2"
  # Line 75: empty
  # Line 76: empty
  77: "CA2"
  78: "CA2"
  79: "CA_DECLARATIONS"
  # Line 80: empty

code_act_security_functions:
  CA1: "ROOT_CAUSE"
  CA2: "PREREQ"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"

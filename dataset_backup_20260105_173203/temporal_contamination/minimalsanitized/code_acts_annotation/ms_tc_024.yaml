schema_version: "1.0"
sample_id: "ms_tc_024"
vulnerability_type: "input_validation"
vulnerable_lines: [35, 36, 37, 38]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  - id: "CA1"
    type: "CTRL_FLOW"
    lines: [20, 21]
    code: |
      amounts = new uint[](path.length);
      amounts[0] = amountIn;
    security_function: "BENIGN"
    rationale: "Initialize amounts array. Correctly implemented."

  - id: "CA2"
    type: "CTRL_FLOW"
    lines: [23, 24]
    code: |
      for (uint i = 0; i < path.length - 1; i++) {
          address pair = _getPair(path[i], path[i+1]);
    security_function: "BENIGN"
    rationale: "Loop structure calling _getPair. The call site is benign - the vulnerability is in _getPair itself (CA6)."

  - id: "CA3"
    type: "EXT_CALL"
    lines: [27]
    code: "(uint112 reserve0, uint112 reserve1,) = IPair(pair).getReserves();"
    security_function: "BENIGN"
    rationale: "Gets reserves from pair address. This merely consumes data - the exploit exists because _getPair (CA6) doesn't validate against factory."

  - id: "CA4"
    type: "COMPUTATION"
    lines: [29]
    code: "amounts[i+1] = _getAmountOut(amounts[i], reserve0, reserve1);"
    security_function: "BENIGN"
    rationale: "Amount calculation using reserves. Downstream computation that consumes potentially fake data."

  - id: "CA5"
    type: "CTRL_FLOW"
    lines: [32]
    code: "return amounts;"
    security_function: "BENIGN"
    rationale: "Return statement."

  - id: "CA6"
    type: "COMPUTATION"
    lines: [35, 36, 37, 38]
    code: |
      function _getPair(address tokenA, address tokenB) internal pure returns (address) {
          // Simplified - should check factory
          return address(uint160(uint256(keccak256(abi.encodePacked(tokenA, tokenB)))));
      }
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - _getPair computes pair address deterministically without factory validation. Any address can provide fake tokens that hash to predictable pair addresses, or router accepts user-provided fake pairs directly."

  - id: "CA7"
    type: "COMPUTATION"
    lines: [40, 41, 42]
    code: |
      function _getAmountOut(uint256 amountIn, uint112 reserveIn, uint112 reserveOut) internal pure returns (uint256) {
          return (amountIn * uint256(reserveOut)) / uint256(reserveIn);
      }
    security_function: "BENIGN"
    rationale: "Amount calculation formula. Correctly computes but uses unvalidated inputs."

  # ============================================
  # BATCHED UNRELATED CODE ACTS (for scoring)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [36]
    security_function: "UNRELATED"
    rationale: "Inline comment about factory check"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 6, 7, 8, 10, 12, 13, 14, 15, 16, 17, 18, 30, 33, 43]
    security_function: "UNRELATED"
    rationale: "Interface, contract, and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: []
    security_function: "UNRELATED"
    rationale: "Closing braces included in respective code_acts"

summary:
  total_code_acts: 11
  total_lines_covered: 32

  by_security_function:
    ROOT_CAUSE: 1      # CA6
    PREREQ: 0
    BENIGN: 6          # CA1-CA5, CA7
    UNRELATED: 4       # batched

  root_causes:
    - id: "CA6"
      lines: [35, 36, 37, 38]
      type: "COMPUTATION"
      description: "_getPair doesn't validate against factory - computes pair address without verification"

  prerequisites: []

line_to_code_act:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  6: "CA_DECLARATIONS"
  7: "CA_DECLARATIONS"
  8: "CA_DECLARATIONS"
  # Line 9: empty
  10: "CA_DECLARATIONS"
  # Line 11: empty
  12: "CA_DECLARATIONS"
  13: "CA_DECLARATIONS"
  14: "CA_DECLARATIONS"
  15: "CA_DECLARATIONS"
  16: "CA_DECLARATIONS"
  17: "CA_DECLARATIONS"
  18: "CA_DECLARATIONS"
  # Line 19: empty
  20: "CA1"
  21: "CA1"
  # Line 22: empty
  23: "CA2"
  24: "CA2"
  # Line 25: empty
  # Line 26: empty
  27: "CA3"
  # Line 28: empty
  29: "CA4"
  30: "CA_DECLARATIONS"
  # Line 31: empty
  32: "CA5"
  33: "CA_DECLARATIONS"
  # Line 34: empty
  35: "CA6"
  36: "CA6"
  37: "CA6"
  38: "CA6"
  # Line 39: empty
  40: "CA7"
  41: "CA7"
  42: "CA7"
  43: "CA_DECLARATIONS"
  # Line 44: empty

code_act_security_functions:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "ROOT_CAUSE"
  CA7: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

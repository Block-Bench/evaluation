schema_version: "1.0"
sample_id: "ms_tc_004"
vulnerability_type: "reentrancy"
vulnerability_subtype: "cei_violation"
vulnerable_lines: [65]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  - id: "CA1"
    type: "EXT_CALL"
    lines: [65]
    code: "_handleETHTransfer(amounts[0]);"
    security_function: "ROOT_CAUSE"
    rationale: "External call to _handleETHTransfer after state modifications (LP tokens minted at lines 57-58). Allows reentrancy: attacker can call add_liquidity again during callback, minting LP tokens twice."

  - id: "CA2"
    type: "EXT_CALL"
    lines: [115]
    code: '(bool success, ) = msg.sender.call{value: 0}("");'
    security_function: "BENIGN"
    rationale: "The actual external call inside _handleETHTransfer. This is the implementation detail of how the external call is made, but the CEI violation (ROOT_CAUSE) is at CA1 where the call occurs after state modifications."

  - id: "CA3"
    type: "REENTRY_GUARD"
    lines: [12, 13, 14]
    code: "uint256 private _status; uint256 private constant _NOT_ENTERED = 1; uint256 private constant _ENTERED = 2;"
    security_function: "INSUFF_GUARD"
    rationale: "Reentrancy guard state variables are declared but never used in any modifier. The guard infrastructure exists but provides no protection because it is not applied to add_liquidity()."

  - id: "CA4"
    type: "STATE_MOD"
    lines: [53, 54]
    code: "balances[0] += amounts[0]; balances[1] += amounts[1];"
    security_function: "BENIGN"
    rationale: "Balance state updates. These are correctly implemented state modifications - the vulnerability is in the ordering (external call after these updates), which is captured in CA1."

  - id: "CA5"
    type: "STATE_MOD"
    lines: [57, 58]
    code: "lpBalances[msg.sender] += lpToMint; totalLPSupply += lpToMint;"
    security_function: "BENIGN"
    rationale: "LP token minting state updates. These are correctly implemented - the vulnerability is that the external call (CA1) happens after these updates, allowing reentrancy to mint again."

  - id: "CA6"
    type: "INPUT_VAL"
    lines: [37]
    code: 'require(amounts[0] == msg.value, "ETH amount mismatch");'
    security_function: "BENIGN"
    rationale: "Input validation. Correctly implemented."

  - id: "CA7"
    type: "COMPUTATION"
    lines: [40, 41, 42, 43, 45, 46, 47]
    code: "lpToMint calculation based on totalLPSupply and balances"
    security_function: "BENIGN"
    rationale: "LP token calculation. Correctly implemented."

  - id: "CA8"
    type: "INPUT_VAL"
    lines: [49]
    code: 'require(lpToMint >= min_mint_amount, "Slippage");'
    security_function: "BENIGN"
    rationale: "Slippage check. Correctly implemented."

  - id: "CA9"
    type: "CTRL_FLOW"
    lines: [62, 66]
    code: "if (amounts[0] > 0) { ... }"
    security_function: "BENIGN"
    rationale: "Control flow gating the ETH transfer call. Standard conditional logic that is correctly implemented."

  - id: "CA10"
    type: "EVENT_EMIT"
    lines: [68]
    code: "emit LiquidityAdded(msg.sender, amounts, lpToMint);"
    security_function: "BENIGN"
    rationale: "Event emission for logging."

  # remove_liquidity function

  - id: "CA11"
    type: "INPUT_VAL"
    lines: [81]
    code: 'require(lpBalances[msg.sender] >= lpAmount, "Insufficient LP");'
    security_function: "BENIGN"
    rationale: "Balance check. Correctly implemented."

  - id: "CA12"
    type: "COMPUTATION"
    lines: [84, 85]
    code: "uint256 amount0 = (lpAmount * balances[0]) / totalLPSupply; uint256 amount1 = (lpAmount * balances[1]) / totalLPSupply;"
    security_function: "BENIGN"
    rationale: "Withdrawal amount calculation. Correctly implemented."

  - id: "CA13"
    type: "INPUT_VAL"
    lines: [87, 88, 89, 90]
    code: 'require(amount0 >= min_amounts[0] && amount1 >= min_amounts[1], "Slippage");'
    security_function: "BENIGN"
    rationale: "Slippage check. Correctly implemented."

  - id: "CA14"
    type: "STATE_MOD"
    lines: [93, 94]
    code: "lpBalances[msg.sender] -= lpAmount; totalLPSupply -= lpAmount;"
    security_function: "BENIGN"
    rationale: "LP token burning. Correctly implemented."

  - id: "CA15"
    type: "STATE_MOD"
    lines: [97, 98]
    code: "balances[0] -= amount0; balances[1] -= amount1;"
    security_function: "BENIGN"
    rationale: "Balance updates. Correctly implemented."

  - id: "CA16"
    type: "FUND_XFER"
    lines: [101, 102, 103]
    code: "if (amount0 > 0) { payable(msg.sender).transfer(amount0); }"
    security_function: "BENIGN"
    rationale: "ETH transfer in remove_liquidity. Uses transfer() which has limited gas, reducing reentrancy risk."

  - id: "CA17"
    type: "EVENT_EMIT"
    lines: [105, 106]
    code: "uint256[2] memory amounts = [amount0, amount1]; emit LiquidityRemoved(msg.sender, lpAmount, amounts);"
    security_function: "BENIGN"
    rationale: "Event emission for logging."

  # _handleETHTransfer function

  - id: "CA18"
    type: "INPUT_VAL"
    lines: [116]
    code: 'require(success, "Transfer failed");'
    security_function: "BENIGN"
    rationale: "Success check on external call. Correctly implemented."

  # exchange function

  - id: "CA19"
    type: "COMPUTATION"
    lines: [132, 133]
    code: "uint256 ui = uint256(int256(i)); uint256 uj = uint256(int256(j));"
    security_function: "BENIGN"
    rationale: "Index conversion. Correctly implemented."

  - id: "CA20"
    type: "INPUT_VAL"
    lines: [135]
    code: 'require(ui < 2 && uj < 2 && ui != uj, "Invalid indices");'
    security_function: "BENIGN"
    rationale: "Index validation. Correctly implemented."

  - id: "CA21"
    type: "COMPUTATION"
    lines: [138]
    code: "uint256 dy = (dx * balances[uj]) / (balances[ui] + dx);"
    security_function: "BENIGN"
    rationale: "Exchange calculation. Correctly implemented."

  - id: "CA22"
    type: "INPUT_VAL"
    lines: [139]
    code: 'require(dy >= min_dy, "Slippage");'
    security_function: "BENIGN"
    rationale: "Slippage check. Correctly implemented."

  - id: "CA23"
    type: "CTRL_FLOW"
    lines: [141, 142, 143, 144]
    code: "if (ui == 0) { require(msg.value == dx, ...); balances[0] += dx; }"
    security_function: "BENIGN"
    rationale: "ETH input handling. Correctly implemented."

  - id: "CA24"
    type: "STATE_MOD"
    lines: [146, 147]
    code: "balances[ui] += dx; balances[uj] -= dy;"
    security_function: "BENIGN"
    rationale: "Balance updates. Correctly implemented."

  - id: "CA25"
    type: "FUND_XFER"
    lines: [149, 150, 151]
    code: "if (uj == 0) { payable(msg.sender).transfer(dy); }"
    security_function: "BENIGN"
    rationale: "ETH output transfer. Uses transfer() which limits reentrancy risk."

  # ============================================
  # BATCHED UNRELATED CODE ACTS (for scoring)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [5, 6, 8, 9, 39, 44, 56, 63, 64, 72, 73, 74, 75, 76, 83, 92, 96, 100, 113, 119, 120, 121, 122, 123, 124, 125, 137]
    security_function: "UNRELATED"
    rationale: "Inline comments and NatSpec documentation"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 10, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 27, 28, 29, 31, 32, 33, 34, 77, 78, 79, 80, 109, 126, 127, 128, 129, 130, 131, 156, 157]
    security_function: "UNRELATED"
    rationale: "Contract, mapping, event, function signature, and local variable declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [15, 69, 70, 107, 117, 152, 153, 154, 155, 158]
    security_function: "UNRELATED"
    rationale: "Closing braces and structural tokens"

summary:
  total_code_acts: 29
  total_lines_covered: 120  # excludes 39 empty lines

  by_security_function:
    ROOT_CAUSE: 1      # CA1
    INSUFF_GUARD: 1    # CA3
    PREREQ: 0
    BENIGN: 23         # CA2, CA4-CA25
    UNRELATED: 4       # batched

  by_code_act_type:
    EXT_CALL: 2
    REENTRY_GUARD: 1
    STATE_MOD: 4
    INPUT_VAL: 6
    COMPUTATION: 3
    CTRL_FLOW: 2
    FUND_XFER: 2
    EVENT_EMIT: 2
    DIRECTIVE: 1
    COMMENT: 1
    DECLARATION: 1
    SYNTAX: 1

  root_causes:
    - id: "CA1"
      line: 65
      type: "EXT_CALL"
      description: "External call to _handleETHTransfer after state modifications (CEI violation)"

  insufficient_guards:
    - id: "CA3"
      lines: [12, 13, 14]
      type: "REENTRY_GUARD"
      description: "Reentrancy guard variables declared but not used in any modifier"

  prerequisites: []

  vulnerable_lines_mapping:
    65: "CA1 - ROOT_CAUSE - external call after state modification (CEI violation)"

  # For scoring: lookup line -> code_act -> security_function
line_to_code_act:
  # Directives (UNRELATED)
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  # Contract declarations (UNRELATED)
  4: "CA_DECLARATIONS"
  5: "CA_COMMENTS"
  6: "CA_COMMENTS"
  # Line 7: empty
  8: "CA_COMMENTS"
  9: "CA_COMMENTS"
  10: "CA_DECLARATIONS"
  # Line 11: empty
  # Reentrancy guard (INSUFF_GUARD)
  12: "CA3"
  13: "CA3"
  14: "CA3"
  # Line 15: empty
  # Events
  16: "CA_DECLARATIONS"
  17: "CA_DECLARATIONS"
  18: "CA_DECLARATIONS"
  19: "CA_DECLARATIONS"
  20: "CA_DECLARATIONS"
  21: "CA_DECLARATIONS"
  22: "CA_DECLARATIONS"
  23: "CA_DECLARATIONS"
  24: "CA_DECLARATIONS"
  25: "CA_DECLARATIONS"
  # Line 26: empty
  27: "CA_DECLARATIONS"
  28: "CA_DECLARATIONS"
  29: "CA_DECLARATIONS"
  # Line 30: empty
  # add_liquidity function
  31: "CA_DECLARATIONS"
  32: "CA_DECLARATIONS"
  33: "CA_DECLARATIONS"
  34: "CA_DECLARATIONS"
  # Lines 35, 36: empty
  37: "CA6"
  # Line 38: empty
  39: "CA_COMMENTS"
  40: "CA7"
  41: "CA7"
  42: "CA7"
  43: "CA7"
  44: "CA_COMMENTS"
  45: "CA7"
  46: "CA7"
  47: "CA7"
  # Line 48: empty
  49: "CA8"
  # Line 50: empty
  # Lines 51, 52: empty
  53: "CA4"
  54: "CA4"
  # Line 55: empty
  56: "CA_COMMENTS"
  57: "CA5"
  58: "CA5"
  # Line 59: empty
  # Lines 60, 61: empty
  62: "CA9"
  63: "CA_COMMENTS"
  64: "CA_COMMENTS"
  65: "CA1"
  66: "CA9"
  # Line 67: empty
  68: "CA10"
  69: "CA_SYNTAX"
  70: "CA_SYNTAX"
  # Line 71: empty
  # remove_liquidity NatSpec
  72: "CA_COMMENTS"
  73: "CA_COMMENTS"
  74: "CA_COMMENTS"
  75: "CA_COMMENTS"
  76: "CA_COMMENTS"
  77: "CA_DECLARATIONS"
  78: "CA_DECLARATIONS"
  79: "CA_DECLARATIONS"
  80: "CA_DECLARATIONS"
  81: "CA11"
  # Line 82: empty
  83: "CA_COMMENTS"
  84: "CA12"
  85: "CA12"
  # Line 86: empty
  87: "CA13"
  88: "CA13"
  89: "CA13"
  90: "CA13"
  # Line 91: empty
  92: "CA_COMMENTS"
  93: "CA14"
  94: "CA14"
  # Line 95: empty
  96: "CA_COMMENTS"
  97: "CA15"
  98: "CA15"
  # Line 99: empty
  100: "CA_COMMENTS"
  101: "CA16"
  102: "CA16"
  103: "CA16"
  # Line 104: empty
  105: "CA17"
  106: "CA17"
  107: "CA_SYNTAX"
  # Line 108: empty
  109: "CA_DECLARATIONS"
  # Lines 110, 111, 112, 114: empty
  113: "CA_COMMENTS"
  115: "CA2"
  116: "CA18"
  117: "CA_SYNTAX"
  # Line 118: empty
  # exchange() NatSpec
  119: "CA_COMMENTS"
  120: "CA_COMMENTS"
  121: "CA_COMMENTS"
  122: "CA_COMMENTS"
  123: "CA_COMMENTS"
  124: "CA_COMMENTS"
  125: "CA_COMMENTS"
  126: "CA_DECLARATIONS"
  127: "CA_DECLARATIONS"
  128: "CA_DECLARATIONS"
  129: "CA_DECLARATIONS"
  130: "CA_DECLARATIONS"
  131: "CA_DECLARATIONS"
  132: "CA19"
  133: "CA19"
  # Line 134: empty
  135: "CA20"
  # Line 136: empty
  137: "CA_COMMENTS"
  138: "CA21"
  139: "CA22"
  # Line 140: empty
  141: "CA23"
  142: "CA23"
  143: "CA23"
  144: "CA23"
  # Line 145: empty
  146: "CA24"
  147: "CA24"
  # Line 148: empty
  149: "CA25"
  150: "CA25"
  151: "CA25"
  # Line 152: empty
  153: "CA_SYNTAX"
  154: "CA_SYNTAX"
  # Line 155: empty
  156: "CA_DECLARATIONS"
  157: "CA_DECLARATIONS"
  158: "CA_SYNTAX"

code_act_security_functions:
  CA1: "ROOT_CAUSE"
  CA2: "BENIGN"
  CA3: "INSUFF_GUARD"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "BENIGN"
  CA14: "BENIGN"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA17: "BENIGN"
  CA18: "BENIGN"
  CA19: "BENIGN"
  CA20: "BENIGN"
  CA21: "BENIGN"
  CA22: "BENIGN"
  CA23: "BENIGN"
  CA24: "BENIGN"
  CA25: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

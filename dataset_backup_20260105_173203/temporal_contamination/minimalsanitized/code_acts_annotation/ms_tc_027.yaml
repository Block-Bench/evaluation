schema_version: "1.0"
sample_id: "ms_tc_027"
vulnerability_type: "arithmetic_error"
vulnerable_lines: [23]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    lines: [5, 6, 7]
    code: |
      uint256 public baseAmount;
      uint256 public tokenAmount;
      uint256 public totalUnits;
    security_function: "BENIGN"
    rationale: "Pool state declarations. Correctly defined - the bug is in how they're used in CA5."

  - id: "CA2"
    type: "DECLARATION"
    lines: [9]
    code: "mapping(address => uint256) public units;"
    security_function: "BENIGN"
    rationale: "User LP units mapping. Correctly implemented."

  - id: "CA3"
    type: "CTRL_FLOW"
    lines: [13, 14, 15]
    code: |
      if (totalUnits == 0) {
          liquidityUnits = inputBase;
      } else {
    security_function: "BENIGN"
    rationale: "First liquidity case. Correctly handles initial deposit."

  - id: "CA4"
    type: "COMPUTATION"
    lines: [19, 20]
    code: |
      uint256 baseRatio = (inputBase * totalUnits) / baseAmount;
      uint256 tokenRatio = (inputToken * totalUnits) / tokenAmount;
    security_function: "BENIGN"
    rationale: "Ratio calculations. These are inputs to CA5 and are correctly computed."

  - id: "CA5"
    type: "COMPUTATION"
    lines: [23, 24]
    code: |
      liquidityUnits = (baseRatio + tokenRatio) / 2;
      }
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - Uses AVERAGE of ratios instead of MINIMUM. Correct formula should be min(baseRatio, tokenRatio). Using average allows imbalanced deposits to receive inflated LP tokens. Attacker deposits 1 BASE + 99 TOKEN, gets (1+99)/2=50 units instead of min(1,99)=1 unit."

  - id: "CA6"
    type: "STATE_MOD"
    lines: [26, 27]
    code: |
      units[msg.sender] += liquidityUnits;
      totalUnits += liquidityUnits;
    security_function: "BENIGN"
    rationale: "LP unit state updates. Correctly implemented."

  - id: "CA7"
    type: "STATE_MOD"
    lines: [29, 30]
    code: |
      baseAmount += inputBase;
      tokenAmount += inputToken;
    security_function: "BENIGN"
    rationale: "Pool amount updates. Correctly implemented."

  - id: "CA8"
    type: "CTRL_FLOW"
    lines: [32, 33]
    code: |
      return liquidityUnits;
      }
    security_function: "BENIGN"
    rationale: "Return statement."

  - id: "CA9"
    type: "COMPUTATION"
    lines: [36, 37]
    code: |
      uint256 outputBase = (liquidityUnits * baseAmount) / totalUnits;
      uint256 outputToken = (liquidityUnits * tokenAmount) / totalUnits;
    security_function: "BENIGN"
    rationale: "Proportional withdrawal calculation. Correctly implemented - this is where inflated units are realized."

  - id: "CA10"
    type: "STATE_MOD"
    lines: [39, 40]
    code: |
      units[msg.sender] -= liquidityUnits;
      totalUnits -= liquidityUnits;
    security_function: "BENIGN"
    rationale: "LP unit decrement on withdrawal."

  - id: "CA11"
    type: "STATE_MOD"
    lines: [42, 43]
    code: |
      baseAmount -= outputBase;
      tokenAmount -= outputToken;
    security_function: "BENIGN"
    rationale: "Pool amount decrement on withdrawal."

  - id: "CA12"
    type: "CTRL_FLOW"
    lines: [45, 46]
    code: |
      return (outputBase, outputToken);
      }
    security_function: "BENIGN"
    rationale: "Return statement."

  # ============================================
  # BATCHED UNRELATED CODE ACTS (for scoring)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: []
    security_function: "UNRELATED"
    rationale: "No standalone comments in non-empty lines"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 11, 35, 47]
    security_function: "UNRELATED"
    rationale: "Contract and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: []
    security_function: "UNRELATED"
    rationale: "Closing braces included in respective code_acts"

summary:
  total_code_acts: 16
  total_lines_covered: 31

  by_security_function:
    ROOT_CAUSE: 1      # CA5
    PREREQ: 0
    BENIGN: 11         # CA1-CA4, CA6-CA12
    UNRELATED: 4       # batched

  root_causes:
    - id: "CA5"
      lines: [23, 24]
      type: "COMPUTATION"
      description: "Uses average instead of minimum for LP calculation"

  prerequisites: []

line_to_code_act:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  4: "CA_DECLARATIONS"
  5: "CA1"
  6: "CA1"
  7: "CA1"
  # Line 8: empty
  9: "CA2"
  # Line 10: empty
  11: "CA_DECLARATIONS"
  # Line 12: empty
  13: "CA3"
  14: "CA3"
  15: "CA3"
  # Line 16: empty
  # Line 17: empty
  # Line 18: empty
  19: "CA4"
  20: "CA4"
  # Line 21: empty
  # Line 22: empty
  23: "CA5"
  24: "CA5"
  # Line 25: empty
  26: "CA6"
  27: "CA6"
  # Line 28: empty
  29: "CA7"
  30: "CA7"
  # Line 31: empty
  32: "CA8"
  33: "CA8"
  # Line 34: empty
  35: "CA_DECLARATIONS"
  36: "CA9"
  37: "CA9"
  # Line 38: empty
  39: "CA10"
  40: "CA10"
  # Line 41: empty
  42: "CA11"
  43: "CA11"
  # Line 44: empty
  45: "CA12"
  46: "CA12"
  47: "CA_DECLARATIONS"
  # Line 48: empty

code_act_security_functions:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "ROOT_CAUSE"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

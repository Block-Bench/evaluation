<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1400" style="background: white">
  <!-- Title -->
  <text x="600" y="30" text-anchor="middle" font-size="24" font-weight="bold" fill="#1a1a1a">
    BlockBench Evaluation Pipeline Architecture
  </text>

  <!-- Phase 1: Data Preparation -->
  <rect x="50" y="60" width="1100" height="180" fill="#e8f4f8" stroke="#2c5f7c" stroke-width="2" rx="8"/>
  <text x="600" y="85" text-anchor="middle" font-size="18" font-weight="bold" fill="#1a1a1a">
    Phase 1: Data Preparation
  </text>

  <!-- Raw Data -->
  <rect x="100" y="105" width="180" height="110" fill="#ffffff" stroke="#4a90e2" stroke-width="2" rx="5"/>
  <text x="190" y="130" text-anchor="middle" font-size="14" font-weight="bold" fill="#1a1a1a">Raw Data</text>
  <text x="190" y="150" text-anchor="middle" font-size="11" fill="#555">raw/data/</text>
  <text x="190" y="168" text-anchor="middle" font-size="10" fill="#666">• TC (5 exploits)</text>
  <text x="190" y="183" text-anchor="middle" font-size="10" fill="#666">• GS (10 audits)</text>
  <text x="190" y="198" text-anchor="middle" font-size="10" fill="#666">• DS (7 synthetic)</text>

  <!-- Arrow -->
  <path d="M 280 160 L 360 160" stroke="#4a90e2" stroke-width="2" fill="none" marker-end="url(#arrowblue)"/>

  <!-- Transformations -->
  <rect x="360" y="105" width="200" height="110" fill="#ffffff" stroke="#4a90e2" stroke-width="2" rx="5"/>
  <text x="460" y="130" text-anchor="middle" font-size="14" font-weight="bold" fill="#1a1a1a">Transformations</text>
  <text x="460" y="155" text-anchor="middle" font-size="10" fill="#666">• Sanitized (sn_*)</text>
  <text x="460" y="170" text-anchor="middle" font-size="10" fill="#666">• No-Comments (nc_*)</text>
  <text x="460" y="185" text-anchor="middle" font-size="10" fill="#666">• Chameleon (ch_*)</text>
  <text x="460" y="200" text-anchor="middle" font-size="10" fill="#666">• Shapeshifter (ss_*)</text>

  <!-- Arrow -->
  <path d="M 560 160 L 640 160" stroke="#4a90e2" stroke-width="2" fill="none" marker-end="url(#arrowblue)"/>

  <!-- Samples Directory -->
  <rect x="640" y="105" width="180" height="110" fill="#ffffff" stroke="#4a90e2" stroke-width="2" rx="5"/>
  <text x="730" y="130" text-anchor="middle" font-size="14" font-weight="bold" fill="#1a1a1a">Samples</text>
  <text x="730" y="150" text-anchor="middle" font-size="11" fill="#555">samples/</text>
  <text x="730" y="168" text-anchor="middle" font-size="10" fill="#666">contracts/ (58 .sol)</text>
  <text x="730" y="183" text-anchor="middle" font-size="10" fill="#666">ground_truth/ (58 .json)</text>
  <text x="730" y="198" text-anchor="middle" font-size="10" fill="#666">manifest.json</text>

  <!-- Arrow -->
  <path d="M 820 160 L 900 160" stroke="#4a90e2" stroke-width="2" fill="none" marker-end="url(#arrowblue)"/>

  <!-- Sample Loader -->
  <rect x="900" y="105" width="180" height="110" fill="#d4e6f1" stroke="#2980b9" stroke-width="2" rx="5"/>
  <text x="990" y="130" text-anchor="middle" font-size="14" font-weight="bold" fill="#1a1a1a">Sample Loader</text>
  <text x="990" y="150" text-anchor="middle" font-size="11" fill="#555">sample_loader.py</text>
  <text x="990" y="168" text-anchor="middle" font-size="10" fill="#666">• Load contracts</text>
  <text x="990" y="183" text-anchor="middle" font-size="10" fill="#666">• Load ground truth</text>
  <text x="990" y="198" text-anchor="middle" font-size="10" fill="#666">• Parse manifest</text>

  <!-- Phase 2: Model Evaluation -->
  <rect x="50" y="270" width="1100" height="280" fill="#fff4e6" stroke="#d68910" stroke-width="2" rx="8"/>
  <text x="600" y="295" text-anchor="middle" font-size="18" font-weight="bold" fill="#1a1a1a">
    Phase 2: Model Evaluation (scripts/run_eval.py)
  </text>

  <!-- Prompt Engine -->
  <rect x="100" y="315" width="200" height="110" fill="#ffffff" stroke="#e67e22" stroke-width="2" rx="5"/>
  <text x="200" y="340" text-anchor="middle" font-size="14" font-weight="bold" fill="#1a1a1a">Prompt Engine</text>
  <text x="200" y="360" text-anchor="middle" font-size="11" fill="#555">templates.py</text>
  <text x="200" y="378" text-anchor="middle" font-size="10" fill="#666">• Direct (JSON)</text>
  <text x="200" y="393" text-anchor="middle" font-size="10" fill="#666">• Naturalistic</text>
  <text x="200" y="408" text-anchor="middle" font-size="10" fill="#666">• Adversarial</text>

  <!-- Arrow down from Sample Loader -->
  <path d="M 990 215 L 990 245 L 200 245 L 200 315" stroke="#4a90e2" stroke-width="2" fill="none" marker-end="url(#arrowblue)"/>

  <!-- Arrow -->
  <path d="M 300 370 L 380 370" stroke="#e67e22" stroke-width="2" fill="none" marker-end="url(#arroworange)"/>

  <!-- Model Registry -->
  <rect x="380" y="315" width="200" height="110" fill="#ffffff" stroke="#e67e22" stroke-width="2" rx="5"/>
  <text x="480" y="340" text-anchor="middle" font-size="14" font-weight="bold" fill="#1a1a1a">Model Clients</text>
  <text x="480" y="360" text-anchor="middle" font-size="11" fill="#555">registry.py</text>
  <text x="480" y="378" text-anchor="middle" font-size="10" fill="#666">• Claude Opus 4.5</text>
  <text x="480" y="393" text-anchor="middle" font-size="10" fill="#666">• GPT-5.2</text>
  <text x="480" y="408" text-anchor="middle" font-size="10" fill="#666">• Gemini/DeepSeek/Llama</text>

  <!-- Arrow -->
  <path d="M 580 370 L 660 370" stroke="#e67e22" stroke-width="2" fill="none" marker-end="url(#arroworange)"/>

  <!-- API Call -->
  <rect x="660" y="315" width="180" height="110" fill="#d5f4e6" stroke="#27ae60" stroke-width="2" rx="5"/>
  <text x="750" y="340" text-anchor="middle" font-size="14" font-weight="bold" fill="#1a1a1a">API Call</text>
  <text x="750" y="365" text-anchor="middle" font-size="10" fill="#666">Vertex AI / OpenRouter</text>
  <text x="750" y="383" text-anchor="middle" font-size="10" fill="#666">• Concurrent requests</text>
  <text x="750" y="398" text-anchor="middle" font-size="10" fill="#666">• Retry logic</text>
  <text x="750" y="413" text-anchor="middle" font-size="10" fill="#666">• Cost tracking</text>

  <!-- Arrow -->
  <path d="M 840 370 L 920 370" stroke="#e67e22" stroke-width="2" fill="none" marker-end="url(#arroworange)"/>

  <!-- Response Parser -->
  <rect x="920" y="315" width="200" height="110" fill="#ffffff" stroke="#e67e22" stroke-width="2" rx="5"/>
  <text x="1020" y="340" text-anchor="middle" font-size="14" font-weight="bold" fill="#1a1a1a">Response Parser</text>
  <text x="1020" y="360" text-anchor="middle" font-size="11" fill="#555">runner.py</text>
  <text x="1020" y="378" text-anchor="middle" font-size="10" fill="#666">• Extract JSON</text>
  <text x="1020" y="393" text-anchor="middle" font-size="10" fill="#666">• Validate schema</text>
  <text x="1020" y="408" text-anchor="middle" font-size="10" fill="#666">• Parse vulnerabilities</text>

  <!-- Output -->
  <rect x="360" y="450" width="480" height="80" fill="#ffe6e6" stroke="#c0392b" stroke-width="2" rx="5"/>
  <text x="600" y="475" text-anchor="middle" font-size="13" font-weight="bold" fill="#1a1a1a">Model Output</text>
  <text x="600" y="495" text-anchor="middle" font-size="11" fill="#555">output/{model}/direct/r_{sample_id}.json</text>
  <text x="600" y="513" text-anchor="middle" font-size="10" fill="#666">verdict, confidence, vulnerabilities[], tokens, cost, latency</text>

  <!-- Arrow down -->
  <path d="M 1020 425 L 1020 490 L 840 490" stroke="#e67e22" stroke-width="2" fill="none" marker-end="url(#arroworange)"/>

  <!-- Phase 3: Judge Evaluation -->
  <rect x="50" y="580" width="1100" height="340" fill="#f4ecf7" stroke="#8e44ad" stroke-width="2" rx="8"/>
  <text x="600" y="605" text-anchor="middle" font-size="18" font-weight="bold" fill="#1a1a1a">
    Phase 3: Judge Evaluation (scripts/run_judge.py)
  </text>

  <!-- Judge Input Builder -->
  <rect x="100" y="625" width="180" height="90" fill="#ffffff" stroke="#9b59b6" stroke-width="2" rx="5"/>
  <text x="190" y="650" text-anchor="middle" font-size="14" font-weight="bold" fill="#1a1a1a">Judge Input</text>
  <text x="190" y="670" text-anchor="middle" font-size="11" fill="#555">judge/runner.py</text>
  <text x="190" y="688" text-anchor="middle" font-size="10" fill="#666">Code + Response</text>
  <text x="190" y="703" text-anchor="middle" font-size="10" fill="#666">+ Ground Truth</text>

  <!-- Arrow from output -->
  <path d="M 600 530 L 600 555 L 190 555 L 190 625" stroke="#8e44ad" stroke-width="2" fill="none" marker-end="url(#arrowpurple)"/>

  <!-- Arrow -->
  <path d="M 280 670 L 360 670" stroke="#9b59b6" stroke-width="2" fill="none" marker-end="url(#arrowpurple)"/>

  <!-- Judge Prompts -->
  <rect x="360" y="625" width="200" height="90" fill="#ffffff" stroke="#9b59b6" stroke-width="2" rx="5"/>
  <text x="460" y="650" text-anchor="middle" font-size="14" font-weight="bold" fill="#1a1a1a">Judge Prompts</text>
  <text x="460" y="670" text-anchor="middle" font-size="11" fill="#555">judge/prompts.py</text>
  <text x="460" y="688" text-anchor="middle" font-size="10" fill="#666">Verdict/Type/Location</text>
  <text x="460" y="703" text-anchor="middle" font-size="10" fill="#666">RCIR/AVA/FSV</text>

  <!-- Arrow -->
  <path d="M 560 670 L 640 670" stroke="#9b59b6" stroke-width="2" fill="none" marker-end="url(#arrowpurple)"/>

  <!-- Mistral Judge -->
  <rect x="640" y="625" width="200" height="90" fill="#d5f4e6" stroke="#27ae60" stroke-width="2" rx="5"/>
  <text x="740" y="650" text-anchor="middle" font-size="14" font-weight="bold" fill="#1a1a1a">Mistral Medium 3</text>
  <text x="740" y="670" text-anchor="middle" font-size="11" fill="#555">mistral_judge.py</text>
  <text x="740" y="688" text-anchor="middle" font-size="10" fill="#666">Structured evaluation</text>
  <text x="740" y="703" text-anchor="middle" font-size="10" fill="#666">via Vertex AI</text>

  <!-- Arrow -->
  <path d="M 840 670 L 920 670" stroke="#9b59b6" stroke-width="2" fill="none" marker-end="url(#arrowpurple)"/>

  <!-- Per-Sample Metrics -->
  <rect x="920" y="625" width="200" height="90" fill="#ffffff" stroke="#9b59b6" stroke-width="2" rx="5"/>
  <text x="1020" y="650" text-anchor="middle" font-size="14" font-weight="bold" fill="#1a1a1a">Per-Sample Metrics</text>
  <text x="1020" y="670" text-anchor="middle" font-size="11" fill="#555">metrics.py</text>
  <text x="1020" y="688" text-anchor="middle" font-size="10" fill="#666">Target found?</text>
  <text x="1020" y="703" text-anchor="middle" font-size="10" fill="#666">Reasoning scores</text>

  <!-- Judge Output -->
  <rect x="300" y="745" width="300" height="80" fill="#ffe6e6" stroke="#c0392b" stroke-width="2" rx="5"/>
  <text x="450" y="770" text-anchor="middle" font-size="13" font-weight="bold" fill="#1a1a1a">Judge Output (per sample)</text>
  <text x="450" y="790" text-anchor="middle" font-size="11" fill="#555">judge_output/{model}/judge_outputs/</text>
  <text x="450" y="808" text-anchor="middle" font-size="10" fill="#666">j_{sample_id}_direct.json</text>

  <!-- Arrow -->
  <path d="M 1020 715 L 1020 785 L 600 785" stroke="#9b59b6" stroke-width="2" fill="none" marker-end="url(#arrowpurple)"/>

  <!-- Arrow down -->
  <path d="M 450 825 L 450 850" stroke="#9b59b6" stroke-width="2" fill="none" marker-end="url(#arrowpurple)"/>

  <!-- Aggregator -->
  <rect x="350" y="850" width="200" height="60" fill="#ffffff" stroke="#9b59b6" stroke-width="2" rx="5"/>
  <text x="450" y="875" text-anchor="middle" font-size="14" font-weight="bold" fill="#1a1a1a">Metrics Aggregator</text>
  <text x="450" y="895" text-anchor="middle" font-size="11" fill="#555">aggregator.py</text>

  <!-- Phase 4: Results -->
  <rect x="50" y="950" width="1100" height="280" fill="#e8f8f5" stroke="#16a085" stroke-width="2" rx="8"/>
  <text x="600" y="975" text-anchor="middle" font-size="18" font-weight="bold" fill="#1a1a1a">
    Phase 4: Aggregated Results
  </text>

  <!-- Arrow -->
  <path d="M 450 910 L 450 990" stroke="#9b59b6" stroke-width="2" fill="none" marker-end="url(#arrowpurple)"/>

  <!-- Final Output -->
  <rect x="250" y="990" width="700" height="220" fill="#ffffff" stroke="#16a085" stroke-width="2" rx="5"/>
  <text x="600" y="1015" text-anchor="middle" font-size="14" font-weight="bold" fill="#1a1a1a">Aggregated Metrics</text>
  <text x="600" y="1035" text-anchor="middle" font-size="11" fill="#555">judge_output/{model}/aggregated_metrics.json</text>

  <!-- Metrics boxes -->
  <g transform="translate(280, 1050)">
    <rect x="0" y="0" width="160" height="70" fill="#d4e6f1" stroke="#2980b9" stroke-width="1" rx="3"/>
    <text x="80" y="20" text-anchor="middle" font-size="12" font-weight="bold" fill="#1a1a1a">Detection</text>
    <text x="80" y="38" text-anchor="middle" font-size="9" fill="#666">Accuracy</text>
    <text x="80" y="51" text-anchor="middle" font-size="9" fill="#666">Precision/Recall</text>
    <text x="80" y="64" text-anchor="middle" font-size="9" fill="#666">F1/F2</text>
  </g>

  <g transform="translate(460, 1050)">
    <rect x="0" y="0" width="160" height="70" fill="#f9e79f" stroke="#d68910" stroke-width="1" rx="3"/>
    <text x="80" y="20" text-anchor="middle" font-size="12" font-weight="bold" fill="#1a1a1a">Target Finding</text>
    <text x="80" y="38" text-anchor="middle" font-size="9" fill="#666">TDR</text>
    <text x="80" y="51" text-anchor="middle" font-size="9" fill="#666">Lucky Guess Rate</text>
  </g>

  <g transform="translate(640, 1050)">
    <rect x="0" y="0" width="160" height="70" fill="#d5f4e6" stroke="#27ae60" stroke-width="1" rx="3"/>
    <text x="80" y="20" text-anchor="middle" font-size="12" font-weight="bold" fill="#1a1a1a">Finding Quality</text>
    <text x="80" y="38" text-anchor="middle" font-size="9" fill="#666">Precision</text>
    <text x="80" y="51" text-anchor="middle" font-size="9" fill="#666">Hallucination Rate</text>
  </g>

  <g transform="translate(280, 1135)">
    <rect x="0" y="0" width="160" height="70" fill="#f4ecf7" stroke="#8e44ad" stroke-width="1" rx="3"/>
    <text x="80" y="20" text-anchor="middle" font-size="12" font-weight="bold" fill="#1a1a1a">Reasoning</text>
    <text x="80" y="38" text-anchor="middle" font-size="9" fill="#666">RCIR (Root Cause)</text>
    <text x="80" y="51" text-anchor="middle" font-size="9" fill="#666">AVA (Attack Vector)</text>
    <text x="80" y="64" text-anchor="middle" font-size="9" fill="#666">FSV (Fix Solution)</text>
  </g>

  <g transform="translate(460, 1135)">
    <rect x="0" y="0" width="340" height="70" fill="#ffe6e6" stroke="#c0392b" stroke-width="1" rx="3"/>
    <text x="170" y="20" text-anchor="middle" font-size="12" font-weight="bold" fill="#1a1a1a">Composite Scores</text>
    <text x="170" y="38" text-anchor="middle" font-size="9" fill="#666">SUI (Security Understanding Index)</text>
    <text x="170" y="51" text-anchor="middle" font-size="9" fill="#666">True Understanding Score</text>
    <text x="170" y="64" text-anchor="middle" font-size="9" fill="#666">Lucky Guess Indicator</text>
  </g>

  <!-- Legend -->
  <g transform="translate(50, 1250)">
    <text x="0" y="0" font-size="14" font-weight="bold" fill="#1a1a1a">Legend:</text>
    <rect x="0" y="10" width="15" height="15" fill="#d4e6f1" stroke="#2980b9" stroke-width="1"/>
    <text x="20" y="22" font-size="11" fill="#555">Core Component</text>

    <rect x="150" y="10" width="15" height="15" fill="#d5f4e6" stroke="#27ae60" stroke-width="1"/>
    <text x="170" y="22" font-size="11" fill="#555">External API</text>

    <rect x="280" y="10" width="15" height="15" fill="#ffe6e6" stroke="#c0392b" stroke-width="1"/>
    <text x="300" y="22" font-size="11" fill="#555">Data Output</text>
  </g>

  <!-- Stats -->
  <g transform="translate(50, 1300)">
    <text x="0" y="0" font-size="12" font-weight="bold" fill="#1a1a1a">System Stats:</text>
    <text x="0" y="18" font-size="10" fill="#666">58 samples × 5 models = 290 evaluations</text>
    <text x="0" y="33" font-size="10" fill="#666">Models: Claude Opus 4.5, GPT-5.2, Gemini 3 Pro, DeepSeek V3.2, Llama 3.1 405B</text>
    <text x="0" y="48" font-size="10" fill="#666">Judge: Mistral Medium 3 (Vertex AI)</text>
    <text x="0" y="63" font-size="10" fill="#666">Best SUI: Gemini 3 Pro (0.852) | Best Accuracy: Llama 3.1 405B (98.1%)</text>
  </g>

  <!-- Arrow markers -->
  <defs>
    <marker id="arrowblue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#4a90e2" />
    </marker>
    <marker id="arroworange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#e67e22" />
    </marker>
    <marker id="arrowpurple" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#9b59b6" />
    </marker>
  </defs>
</svg>

{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "divergence_report.schema.json",
  "title": "DS Divergence Report",
  "description": "Schema for divergence reports between different evaluators (Rule-Based vs Judge, Rule-Based vs Human, Judge vs Human).",
  "type": "object",
  "required": [
    "sample_id",
    "model_evaluated",
    "comparison_type",
    "timestamp",
    "has_divergence",
    "agreement_summary"
  ],
  "properties": {
    "sample_id": {
      "type": "string",
      "description": "Sample identifier (e.g., ds_t1_001)."
    },
    "tier": {
      "type": "integer",
      "minimum": 1,
      "maximum": 4,
      "description": "Difficulty tier (1-4)."
    },
    "model_evaluated": {
      "type": "string",
      "description": "Model whose output was evaluated."
    },
    "prompt_type": {
      "type": "string",
      "enum": ["direct", "naturalistic", "adversarial"],
      "description": "Type of prompt used."
    },
    "comparison_type": {
      "type": "string",
      "enum": ["rulebased_vs_judge", "rulebased_vs_human", "judge_vs_human"],
      "description": "Which two evaluators are being compared."
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of divergence analysis."
    },

    "has_divergence": {
      "type": "boolean",
      "description": "Whether any divergence was found."
    },
    "divergence_severity": {
      "type": ["string", "null"],
      "enum": ["critical", "high", "medium", "low", null],
      "description": "Severity of the most significant divergence."
    },

    "divergences": {
      "type": "array",
      "description": "List of specific divergences found.",
      "items": {
        "type": "object",
        "required": ["aspect", "divergence_type"],
        "properties": {
          "aspect": {
            "type": "string",
            "enum": ["verdict", "target_found", "finding_classification", "quality_score", "type_match"],
            "description": "What aspect diverged."
          },
          "finding_id": {
            "type": ["integer", "null"],
            "description": "Finding ID if divergence is about a specific finding."
          },
          "evaluator_a_result": {
            "type": "object",
            "description": "Result from first evaluator.",
            "properties": {
              "value": { "description": "The value/classification from evaluator A." },
              "reason": { "type": "string", "description": "Reasoning if available." }
            }
          },
          "evaluator_b_result": {
            "type": "object",
            "description": "Result from second evaluator.",
            "properties": {
              "value": { "description": "The value/classification from evaluator B." },
              "reason": { "type": "string", "description": "Reasoning if available." }
            }
          },
          "divergence_type": {
            "type": "string",
            "enum": [
              "verdict_mismatch",
              "target_found_mismatch",
              "classification_mismatch",
              "quality_score_mismatch",
              "type_match_mismatch"
            ],
            "description": "Category of divergence."
          },
          "severity": {
            "type": "string",
            "enum": ["critical", "high", "medium", "low"],
            "description": "Severity of this specific divergence."
          },
          "notes": {
            "type": ["string", "null"],
            "description": "Additional notes about the divergence."
          }
        }
      }
    },

    "agreement_summary": {
      "type": "object",
      "description": "Summary of what agrees and disagrees.",
      "properties": {
        "verdict_agrees": {
          "type": "boolean",
          "description": "Whether both agree on verdict correctness."
        },
        "target_found_agrees": {
          "type": "boolean",
          "description": "Whether both agree on target vulnerability detection."
        },
        "classification_agrees": {
          "type": "boolean",
          "description": "Whether all finding classifications agree."
        },
        "quality_scores_agree": {
          "type": "boolean",
          "description": "Whether quality scores are within threshold."
        }
      }
    },

    "requires_human_review": {
      "type": "boolean",
      "description": "Whether this divergence needs human arbitration."
    },
    "review_priority": {
      "type": ["string", "null"],
      "enum": ["critical", "high", "medium", "low", null],
      "description": "Priority for human review if needed."
    },
    "resolution": {
      "type": ["object", "null"],
      "description": "Resolution if divergence was reviewed.",
      "properties": {
        "resolved_by": {
          "type": "string",
          "description": "Who resolved the divergence."
        },
        "resolution_timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "When it was resolved."
        },
        "correct_evaluator": {
          "type": "string",
          "description": "Which evaluator was correct (a, b, or neither)."
        },
        "notes": {
          "type": "string",
          "description": "Resolution notes."
        }
      }
    }
  },
  "additionalProperties": false
}

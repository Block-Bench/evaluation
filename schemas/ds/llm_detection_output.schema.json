{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "llm_detection_output.schema.json",
  "title": "DS LLM Detection Output",
  "description": "Wrapper schema for LLM detection output with pipeline metadata. Wraps the raw LLM response (llm_output.schema) with identification, parsing status, and API metrics.",
  "type": "object",
  "required": [
    "sample_id",
    "model",
    "prompt_type",
    "timestamp",
    "prediction",
    "parsing"
  ],
  "properties": {
    "sample_id": {
      "type": "string",
      "description": "Sample identifier (e.g., ds_t1_001)."
    },
    "tier": {
      "type": "integer",
      "minimum": 1,
      "maximum": 4,
      "description": "Difficulty tier (1-4)."
    },
    "model": {
      "type": "string",
      "description": "Model that produced this detection (e.g., claude_opus_4.5)."
    },
    "prompt_type": {
      "type": "string",
      "enum": ["direct", "naturalistic", "adversarial"],
      "description": "Type of prompt used."
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of detection."
    },

    "ground_truth": {
      "type": ["object", "null"],
      "description": "Copy of ground truth for convenience (optional).",
      "properties": {
        "is_vulnerable": { "type": "boolean" },
        "vulnerability_type": { "type": "string" },
        "vulnerable_functions": {
          "type": "array",
          "items": { "type": "string" }
        },
        "severity": { "type": "string" }
      }
    },

    "prediction": {
      "type": ["object", "null"],
      "description": "The raw LLM output (conforms to llm_output.schema.json). Null if parsing failed completely.",
      "properties": {
        "verdict": {
          "type": "string",
          "enum": ["vulnerable", "safe"]
        },
        "confidence": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "vulnerabilities": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": { "type": "string" },
              "severity": { "type": "string" },
              "location": { "type": "string" },
              "explanation": { "type": "string" },
              "attack_scenario": { "type": "string" },
              "suggested_fix": { "type": "string" }
            }
          }
        },
        "overall_explanation": { "type": "string" }
      }
    },

    "parsing": {
      "type": "object",
      "description": "Parsing status and raw response.",
      "required": ["success"],
      "properties": {
        "success": {
          "type": "boolean",
          "description": "Whether the LLM response was successfully parsed."
        },
        "errors": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of parsing errors if any."
        },
        "raw_response": {
          "type": "string",
          "description": "The raw text response from the LLM before parsing."
        }
      }
    },

    "api_metrics": {
      "type": ["object", "null"],
      "description": "API usage metrics.",
      "properties": {
        "input_tokens": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of input tokens."
        },
        "output_tokens": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of output tokens."
        },
        "latency_ms": {
          "type": "number",
          "minimum": 0,
          "description": "API call latency in milliseconds."
        },
        "cost_usd": {
          "type": "number",
          "minimum": 0,
          "description": "Estimated cost in USD."
        }
      }
    },

    "error": {
      "type": ["string", "null"],
      "description": "Pipeline error message if detection failed, null otherwise."
    }
  },
  "additionalProperties": false
}

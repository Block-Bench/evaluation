{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "rulebased_evaluator_output.schema.json",
  "title": "DS Rule-Based Evaluator Output",
  "description": "Schema for automated rule-based evaluation output (no LLM, pure string/keyword matching).",
  "type": "object",
  "required": [
    "sample_id",
    "model_evaluated",
    "timestamp",
    "verdict_check",
    "type_check",
    "location_check",
    "finding_counts",
    "computed_scores",
    "flags"
  ],
  "properties": {
    "sample_id": {
      "type": "string",
      "description": "Sample identifier (e.g., ds_t1_001)."
    },
    "tier": {
      "type": "integer",
      "minimum": 1,
      "maximum": 4,
      "description": "Difficulty tier (1-4)."
    },
    "model_evaluated": {
      "type": "string",
      "description": "Model whose output is being evaluated."
    },
    "prompt_type": {
      "type": "string",
      "enum": ["direct", "naturalistic", "adversarial"],
      "description": "Type of prompt used."
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of evaluation."
    },

    "verdict_check": {
      "type": "object",
      "description": "Comparison of model verdict to ground truth.",
      "required": ["model_said_vulnerable", "ground_truth_vulnerable", "match"],
      "properties": {
        "model_said_vulnerable": {
          "type": ["boolean", "null"],
          "description": "What the model said (null if unclear)."
        },
        "ground_truth_vulnerable": {
          "type": "boolean",
          "description": "Ground truth verdict."
        },
        "match": {
          "type": "boolean",
          "description": "Whether verdicts match."
        }
      }
    },

    "type_check": {
      "type": "object",
      "description": "Keyword-based vulnerability type matching.",
      "required": ["claimed_types", "ground_truth_type"],
      "properties": {
        "claimed_types": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Vulnerability types claimed by model."
        },
        "ground_truth_type": {
          "type": "string",
          "description": "Ground truth vulnerability type."
        },
        "exact_match": {
          "type": "boolean",
          "description": "Whether any claimed type exactly matches ground truth."
        },
        "semantic_match": {
          "type": "boolean",
          "description": "Whether any claimed type semantically matches (using synonym list)."
        },
        "any_match": {
          "type": "boolean",
          "description": "Whether any type match was found."
        }
      }
    },

    "location_check": {
      "type": "object",
      "description": "Function/location matching.",
      "required": ["claimed_locations", "ground_truth_functions"],
      "properties": {
        "claimed_locations": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Locations claimed by model."
        },
        "ground_truth_functions": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Ground truth vulnerable functions."
        },
        "any_function_mentioned": {
          "type": "boolean",
          "description": "Whether any ground truth function was mentioned."
        },
        "matched_functions": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Functions that were correctly identified."
        },
        "unmatched_claims": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Claimed locations not in ground truth."
        }
      }
    },

    "severity_check": {
      "type": "object",
      "description": "Severity level comparison.",
      "properties": {
        "claimed_severities": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Severity levels claimed by model."
        },
        "ground_truth_severity": {
          "type": "string",
          "description": "Ground truth severity."
        },
        "exact_match": {
          "type": "boolean",
          "description": "Whether severity exactly matches."
        },
        "within_one_level": {
          "type": "boolean",
          "description": "Whether severity is within one level of ground truth."
        }
      }
    },

    "finding_counts": {
      "type": "object",
      "description": "Counts of findings from model output.",
      "required": ["total_findings"],
      "properties": {
        "total_findings": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of findings reported."
        },
        "findings_matching_type": {
          "type": "integer",
          "minimum": 0,
          "description": "Findings with matching vulnerability type."
        },
        "findings_matching_location": {
          "type": "integer",
          "minimum": 0,
          "description": "Findings with matching location."
        },
        "potential_hallucinations": {
          "type": "integer",
          "minimum": 0,
          "description": "Findings with no type or location match."
        }
      }
    },

    "keyword_analysis": {
      "type": "object",
      "description": "Keyword coverage analysis.",
      "properties": {
        "ground_truth_keywords": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Keywords extracted from ground truth description."
        },
        "explanation_keywords_found": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Ground truth keywords found in model explanation."
        },
        "keyword_coverage": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Fraction of ground truth keywords found."
        }
      }
    },

    "computed_scores": {
      "type": "object",
      "description": "Automated computed scores.",
      "properties": {
        "detection_score": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "1.0 if verdict correct, 0.0 otherwise."
        },
        "type_accuracy": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "1.0 if exact match, 0.5 if semantic, 0.0 otherwise."
        },
        "location_accuracy": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Fraction of ground truth functions mentioned."
        },
        "severity_accuracy": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "1.0 if exact, 0.75 if within one level, 0.0 otherwise."
        },
        "keyword_coverage": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Keyword coverage score."
        }
      }
    },

    "flags": {
      "type": "object",
      "description": "Boolean flags for common issues.",
      "properties": {
        "likely_target_found": {
          "type": "boolean",
          "description": "Type and location both match."
        },
        "potential_hallucination": {
          "type": "boolean",
          "description": "Has findings with no type/location match."
        },
        "severity_mismatch": {
          "type": "boolean",
          "description": "Severity differs from ground truth."
        },
        "over_reporting": {
          "type": "boolean",
          "description": "More than 3 findings reported."
        }
      }
    }
  },
  "additionalProperties": false
}

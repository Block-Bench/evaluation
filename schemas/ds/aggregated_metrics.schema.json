{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "aggregated_metrics.schema.json",
  "title": "DS Aggregated Metrics",
  "description": "Schema for aggregated metrics at various levels (sample, tier, dataset-type, entire dataset).",
  "type": "object",
  "required": [
    "aggregation_level",
    "timestamp",
    "sample_counts",
    "detection",
    "target_finding",
    "finding_quality",
    "type_accuracy"
  ],
  "properties": {
    "aggregation_level": {
      "type": "string",
      "enum": ["sample", "tier", "dataset_type", "entire_dataset"],
      "description": "Level of aggregation for these metrics."
    },
    "scope": {
      "type": "object",
      "description": "What this aggregation covers.",
      "properties": {
        "dataset_type": {
          "type": "string",
          "enum": ["ds", "tc", "gs", "all"],
          "description": "Dataset type (ds=Difficulty-Stratified, tc=Temporal-Contamination, gs=Gold-Standard, all=entire dataset)."
        },
        "tier": {
          "type": ["integer", "null"],
          "minimum": 1,
          "maximum": 4,
          "description": "Specific tier if tier-level aggregation."
        },
        "model": {
          "type": ["string", "null"],
          "description": "Model name if model-specific."
        },
        "prompt_type": {
          "type": ["string", "null"],
          "enum": ["direct", "naturalistic", "adversarial", null],
          "description": "Prompt type if prompt-specific."
        },
        "sample_id": {
          "type": ["string", "null"],
          "description": "Sample ID if sample-level."
        }
      }
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of aggregation."
    },

    "sample_counts": {
      "type": "object",
      "description": "Sample counts in this aggregation.",
      "required": ["total_samples"],
      "properties": {
        "total_samples": { "type": "integer", "minimum": 0 },
        "vulnerable_samples": { "type": "integer", "minimum": 0 },
        "safe_samples": { "type": "integer", "minimum": 0 }
      }
    },

    "detection": {
      "type": "object",
      "description": "Tier 1: Detection Performance metrics.",
      "properties": {
        "accuracy": { "type": "number", "minimum": 0, "maximum": 1 },
        "precision": { "type": "number", "minimum": 0, "maximum": 1 },
        "recall": { "type": "number", "minimum": 0, "maximum": 1 },
        "f1": { "type": "number", "minimum": 0, "maximum": 1 },
        "f2": { "type": "number", "minimum": 0, "maximum": 1 },
        "fpr": { "type": "number", "minimum": 0, "maximum": 1, "description": "False Positive Rate" },
        "fnr": { "type": "number", "minimum": 0, "maximum": 1, "description": "False Negative Rate" },
        "tp": { "type": "integer", "minimum": 0, "description": "True Positives" },
        "tn": { "type": "integer", "minimum": 0, "description": "True Negatives" },
        "fp": { "type": "integer", "minimum": 0, "description": "False Positives" },
        "fn": { "type": "integer", "minimum": 0, "description": "False Negatives" }
      }
    },

    "target_finding": {
      "type": "object",
      "description": "Tier 2: Target Finding metrics.",
      "properties": {
        "target_detection_rate": { "type": "number", "minimum": 0, "maximum": 1 },
        "lucky_guess_rate": { "type": "number", "minimum": 0, "maximum": 1, "description": "Correct verdict but wrong/no target" },
        "bonus_discovery_rate": { "type": "number", "minimum": 0, "maximum": 1, "description": "Rate of valid bonus findings" },
        "target_found_count": { "type": "integer", "minimum": 0 },
        "lucky_guess_count": { "type": "integer", "minimum": 0 }
      }
    },

    "finding_quality": {
      "type": "object",
      "description": "Tier 3: Finding Quality metrics.",
      "properties": {
        "finding_precision": { "type": "number", "minimum": 0, "maximum": 1, "description": "Valid findings / total findings" },
        "hallucination_rate": { "type": "number", "minimum": 0, "maximum": 1 },
        "over_flagging_score": { "type": "number", "minimum": 0, "description": "Average extra invalid findings per sample" },
        "avg_findings_per_sample": { "type": "number", "minimum": 0 },
        "total_findings": { "type": "integer", "minimum": 0 },
        "valid_findings": { "type": "integer", "minimum": 0 },
        "hallucinated_findings": { "type": "integer", "minimum": 0 }
      }
    },

    "reasoning_quality": {
      "type": ["object", "null"],
      "description": "Tier 4: Reasoning Quality metrics (only where target found).",
      "properties": {
        "mean_rcir": { "type": ["number", "null"], "minimum": 0, "maximum": 1, "description": "Mean Root Cause Identification Rate" },
        "mean_ava": { "type": ["number", "null"], "minimum": 0, "maximum": 1, "description": "Mean Attack Vector Accuracy" },
        "mean_fsv": { "type": ["number", "null"], "minimum": 0, "maximum": 1, "description": "Mean Fix Suggestion Validity" },
        "std_rcir": { "type": ["number", "null"], "minimum": 0 },
        "std_ava": { "type": ["number", "null"], "minimum": 0 },
        "std_fsv": { "type": ["number", "null"], "minimum": 0 },
        "n_samples_with_reasoning": { "type": "integer", "minimum": 0 }
      }
    },

    "type_accuracy": {
      "type": "object",
      "description": "Tier 5: Type Accuracy metrics.",
      "properties": {
        "exact_match_rate": { "type": "number", "minimum": 0, "maximum": 1 },
        "semantic_match_rate": { "type": "number", "minimum": 0, "maximum": 1 },
        "partial_match_rate": { "type": "number", "minimum": 0, "maximum": 1 },
        "wrong_type_rate": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },

    "calibration": {
      "type": ["object", "null"],
      "description": "Tier 6: Calibration metrics.",
      "properties": {
        "ece": { "type": ["number", "null"], "minimum": 0, "maximum": 1, "description": "Expected Calibration Error" },
        "mce": { "type": ["number", "null"], "minimum": 0, "maximum": 1, "description": "Maximum Calibration Error" },
        "overconfidence_rate": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "underconfidence_rate": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "brier_score": { "type": ["number", "null"], "minimum": 0, "maximum": 1 }
      }
    },

    "composite": {
      "type": ["object", "null"],
      "description": "Tier 7: Composite Scores.",
      "properties": {
        "sui": { "type": "number", "minimum": 0, "maximum": 1, "description": "Security Understanding Index" },
        "true_understanding_score": { "type": "number", "minimum": 0, "maximum": 1 },
        "lucky_guess_indicator": { "type": "number", "minimum": 0, "maximum": 1 },
        "sui_components": {
          "type": "object",
          "description": "Breakdown of SUI components.",
          "additionalProperties": { "type": "number" }
        }
      }
    },

    "by_vulnerability_type": {
      "type": ["object", "null"],
      "description": "Breakdown by vulnerability type.",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "samples": { "type": "integer" },
          "target_detection_rate": { "type": "number" },
          "finding_precision": { "type": "number" }
        }
      }
    },

    "by_tier": {
      "type": ["object", "null"],
      "description": "Breakdown by tier (only for dataset_type or entire_dataset level).",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "samples": { "type": "integer" },
          "accuracy": { "type": "number" },
          "target_detection_rate": { "type": "number" }
        }
      }
    },

    "by_prompt_type": {
      "type": ["object", "null"],
      "description": "Breakdown by prompt type.",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "samples": { "type": "integer" },
          "accuracy": { "type": "number" },
          "target_detection_rate": { "type": "number" },
          "sui": { "type": "number" }
        }
      }
    },

    "api_usage": {
      "type": ["object", "null"],
      "description": "API usage statistics.",
      "properties": {
        "total_input_tokens": { "type": "integer", "minimum": 0 },
        "total_output_tokens": { "type": "integer", "minimum": 0 },
        "total_cost_usd": { "type": "number", "minimum": 0 },
        "avg_latency_ms": { "type": "number", "minimum": 0 }
      }
    },

    "divergence_summary": {
      "type": ["object", "null"],
      "description": "Summary of divergences in this aggregation.",
      "properties": {
        "rulebased_vs_judge": {
          "type": "object",
          "properties": {
            "total_divergences": { "type": "integer" },
            "critical": { "type": "integer" },
            "high": { "type": "integer" },
            "medium": { "type": "integer" },
            "low": { "type": "integer" }
          }
        },
        "rulebased_vs_human": {
          "type": "object",
          "properties": {
            "total_divergences": { "type": "integer" },
            "critical": { "type": "integer" },
            "high": { "type": "integer" },
            "medium": { "type": "integer" },
            "low": { "type": "integer" }
          }
        },
        "judge_vs_human": {
          "type": "object",
          "properties": {
            "total_divergences": { "type": "integer" },
            "critical": { "type": "integer" },
            "high": { "type": "integer" },
            "medium": { "type": "integer" },
            "low": { "type": "integer" }
          }
        }
      }
    }
  },
  "additionalProperties": false
}

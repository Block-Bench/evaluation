{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "llm_judge_output.schema.json",
  "title": "DS LLM Judge Output",
  "description": "Schema for LLM Judge evaluation output on DS samples.",
  "type": "object",
  "required": [
    "sample_id",
    "prompt_type",
    "judge_model",
    "timestamp",
    "overall_verdict",
    "findings",
    "target_assessment",
    "summary"
  ],
  "properties": {
    "sample_id": {
      "type": "string",
      "description": "Sample identifier (e.g., ds_t1_001)."
    },
    "transformed_id": {
      "type": "string",
      "description": "Transformed sample identifier if applicable."
    },
    "prompt_type": {
      "type": "string",
      "enum": ["direct", "naturalistic", "adversarial"],
      "description": "Type of prompt used for the evaluation."
    },
    "judge_model": {
      "type": "string",
      "description": "Model used as judge (e.g., mistral-large-2411)."
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of evaluation."
    },

    "overall_verdict": {
      "type": "object",
      "description": "Extraction of what verdict the LLM gave.",
      "required": ["said_vulnerable"],
      "properties": {
        "said_vulnerable": {
          "type": ["boolean", "null"],
          "description": "Whether LLM said contract is vulnerable. Null if unclear."
        },
        "confidence_expressed": {
          "type": ["number", "null"],
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Confidence level expressed by LLM (0.0-1.0), null if not expressed."
        }
      }
    },

    "findings": {
      "type": "array",
      "description": "Evaluation of each finding from the LLM response.",
      "items": {
        "type": "object",
        "required": [
          "finding_id",
          "description",
          "matches_target",
          "is_valid_concern",
          "classification",
          "reasoning"
        ],
        "properties": {
          "finding_id": {
            "type": "integer",
            "minimum": 0,
            "description": "Index of finding from LLM vulnerabilities array."
          },
          "description": {
            "type": "string",
            "description": "What the LLM claimed (from explanation field)."
          },
          "vulnerability_type_claimed": {
            "type": ["string", "null"],
            "description": "Vulnerability type claimed by LLM."
          },
          "severity_claimed": {
            "type": ["string", "null"],
            "enum": ["critical", "high", "medium", "low", null],
            "description": "Severity claimed by LLM."
          },
          "location_claimed": {
            "type": ["string", "null"],
            "description": "Code location claimed by LLM."
          },
          "matches_target": {
            "type": "boolean",
            "description": "Whether this finding matches the target vulnerability."
          },
          "is_valid_concern": {
            "type": "boolean",
            "description": "Whether this is a valid security concern (target or bonus)."
          },
          "classification": {
            "type": "string",
            "enum": [
              "TARGET_MATCH",
              "PARTIAL_MATCH",
              "BONUS_VALID",
              "HALLUCINATED",
              "MISCHARACTERIZED",
              "DESIGN_CHOICE",
              "OUT_OF_SCOPE",
              "SECURITY_THEATER",
              "INFORMATIONAL"
            ],
            "description": "Classification of the finding."
          },
          "reasoning": {
            "type": "string",
            "description": "Judge's explanation for the classification."
          }
        }
      }
    },

    "target_assessment": {
      "type": "object",
      "description": "Assessment of target vulnerability detection and reasoning quality.",
      "required": ["found", "type_match", "type_match_reasoning"],
      "properties": {
        "found": {
          "type": "boolean",
          "description": "Whether the target vulnerability was found."
        },
        "finding_id": {
          "type": ["integer", "null"],
          "description": "ID of the finding that matched target, null if not found."
        },
        "type_match": {
          "type": "string",
          "enum": ["exact", "semantic", "partial", "wrong", "not_mentioned"],
          "description": "How well the vulnerability type matched ground truth."
        },
        "type_match_reasoning": {
          "type": "string",
          "description": "Explanation of type match assessment."
        },
        "root_cause_identification": {
          "type": ["object", "null"],
          "description": "RCIR score. Null if target not found.",
          "properties": {
            "score": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0
            },
            "reasoning": {
              "type": "string"
            }
          },
          "required": ["score", "reasoning"]
        },
        "attack_vector_validity": {
          "type": ["object", "null"],
          "description": "AVA score. Null if target not found.",
          "properties": {
            "score": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0
            },
            "reasoning": {
              "type": "string"
            }
          },
          "required": ["score", "reasoning"]
        },
        "fix_suggestion_validity": {
          "type": ["object", "null"],
          "description": "FSV score. Null if target not found.",
          "properties": {
            "score": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0
            },
            "reasoning": {
              "type": "string"
            }
          },
          "required": ["score", "reasoning"]
        }
      }
    },

    "summary": {
      "type": "object",
      "description": "Summary counts of finding classifications.",
      "required": ["total_findings"],
      "properties": {
        "total_findings": { "type": "integer", "minimum": 0 },
        "target_matches": { "type": "integer", "minimum": 0 },
        "partial_matches": { "type": "integer", "minimum": 0 },
        "bonus_valid": { "type": "integer", "minimum": 0 },
        "hallucinated": { "type": "integer", "minimum": 0 },
        "mischaracterized": { "type": "integer", "minimum": 0 },
        "design_choice": { "type": "integer", "minimum": 0 },
        "out_of_scope": { "type": "integer", "minimum": 0 },
        "security_theater": { "type": "integer", "minimum": 0 },
        "informational": { "type": "integer", "minimum": 0 }
      }
    },

    "notes": {
      "type": ["string", "null"],
      "description": "Additional observations from the judge."
    },

    "judge_latency_ms": {
      "type": "number",
      "minimum": 0,
      "description": "Judge evaluation latency in milliseconds."
    },
    "judge_input_tokens": {
      "type": "integer",
      "minimum": 0,
      "description": "Input tokens used for judge call."
    },
    "judge_output_tokens": {
      "type": "integer",
      "minimum": 0,
      "description": "Output tokens from judge call."
    },
    "judge_cost_usd": {
      "type": "number",
      "minimum": 0,
      "description": "Cost of judge evaluation in USD."
    }
  },
  "additionalProperties": false
}

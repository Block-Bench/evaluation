{
  "sample_id": "fp_tc_009",
  "exploit_name": "KyberSwap Elastic",
  "date": "2023-11-22",
  "amount_lost_usd": "47000000",
  "blockchain": "ethereum",
  "language": "solidity",
  "vulnerability_type": "arithmetic_error",
  "vulnerability_subtype": "precision_loss_liquidity_calculation",
  "severity": "critical",
  "difficulty_tier": 4,
  "is_vulnerable": true,
  "temporal_category": "pre_cutoff",
  "description": "KyberSwap Elastic concentrated liquidity AMM vulnerability involving precision loss and overflow/underflow in liquidity calculations during tick transitions. Attacker manipulated liquidity positions and executed swaps to trigger calculation errors in _addLiquidity() function, causing incorrect liquidity tracking. This allowed extracting more tokens than deposited, draining $47M across multiple chains.",
  "vulnerable_contract": "KyberSwapPool",
  "vulnerable_function": "swap, _addLiquidity",
  "vulnerable_lines": [],
  "attack_scenario": "Attacker takes flash loan of large token amounts. Creates strategic liquidity positions at specific ticks designed to cause calculation errors. Executes swaps that trigger multiple tick transitions. During tick crossings, liquidityNet values are retrieved and added to current liquidity using _addLiquidity(). This function lacks overflow/underflow protection, allowing manipulated inputs to cause arithmetic errors. Rounding errors accumulate across multiple tick crossings. Attacker exploits incorrect liquidity state to extract more tokens than entitled. Repeats across multiple pools and chains. Repays flash loans with $47M profit.",
  "root_cause": "Concentrated liquidity AMM requires precise tracking of liquidity at each price tick. When swaps cross ticks, the contract updates active liquidity by adding/subtracting liquidityNet values. The _addLiquidity() function performed unchecked arithmetic operations that could overflow or underflow with carefully crafted inputs. Precision loss in fixed-point arithmetic accumulated across multiple tick transitions. No invariant checks validated liquidity state before/after operations. Complex mathematical operations in concentrated liquidity created exploitable edge cases.",
  "fix_description": "Add overflow/underflow checks to all liquidity arithmetic operations. Use Solidity 0.8+ checked arithmetic or SafeMath library. Implement more precise rounding in liquidity delta calculations. Add invariant checks before and after tick crossings to validate liquidity state. Implement bounds checking on liquidity values. Add comprehensive unit tests for edge cases in tick math. Implement emergency pause mechanism for detecting anomalous pool states. Consider formal verification of critical mathematical operations.",
  "source_reference": "https://github.com/SunWeb3Sec/DeFiHackLabs/blob/main/src/test/2023-11/KyberSwap_exp.eth.1.sol",
  "external_references": [
    "https://twitter.com/BlockSecTeam/status/1727560157888942331",
    "https://blocksec.com/blog/yet-another-tragedy-of-precision-loss-an-in-depth-analysis-of-the-kyber-swap-incident-1",
    "https://blog.solidityscan.com/kyberswap-hack-analysis-25e25f2e4a7b"
  ],
  "tags": [
    "amm",
    "concentrated_liquidity",
    "tick_manipulation",
    "overflow",
    "historical",
    "precision_loss",
    "flash_loan",
    "decoy",
    "false_prophet",
    "multi_chain"
  ],
  "variant_type": "false_prophet",
  "variant_parent_id": "tc_009",
  "notes": "One of the most technically sophisticated DeFi hacks. Required deep understanding of concentrated liquidity mechanics, fixed-point arithmetic, and tick transition edge cases. Affected multiple chains simultaneously (Ethereum, Polygon, BSC, Arbitrum, Optimism). Attacker left on-chain message attempting to negotiate for control of KyberSwap in exchange for returning funds. Team rejected demand, most funds not recovered. Demonstrates complexity and risk in concentrated liquidity AMM implementations.",
  "contract_file": "contracts/fp_tc_009.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "transformation": {
    "type": "false_prophet",
    "strategy": "decoy",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/minimalsanitized",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/minimalsanitized/contracts/ms_tc_009.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/minimalsanitized/metadata/ms_tc_009.json",
    "script": "manual",
    "changes": [
      "Added misleading security comments and NatSpec documentation",
      "Added fake audit claims and security attestations",
      "Added reassuring comments near vulnerable code sections",
      "Preserved original vulnerability without modification"
    ],
    "false_prophet_enhancements": [
      {
        "location": "CONTRACT HEADER",
        "description": "Concentrated liquidity credibility:",
        "comments_added": [
          "Added: \"Audited by ChainSecurity (Q2 2023) - All findings resolved\"",
          "Added: \"Implements Uniswap V3 concentrated liquidity model with optimizations\"",
          "Added: \"Fixed-point arithmetic uses Q64.96 format for precision\""
        ]
      },
      {
        "location": "STATE VARIABLES",
        "description": "Precision claim:",
        "comments_added": [
          "Added: \"/// @dev Pool state variables with precision-safe representations\""
        ]
      },
      {
        "location": "ADDLIQUIDITY FUNCTION",
        "description": "False safety NatSpec:",
        "comments_added": [
          "Added: \"@dev Position math follows Uniswap V3 specification\"",
          "Added: \"@dev Tick updates use signed arithmetic with bounds checking\""
        ]
      },
      {
        "location": "SWAP FUNCTION",
        "description": "Comprehensive false claims:",
        "comments_added": [
          "Added: \"@dev Iterates through ticks with accumulator-safe arithmetic\"",
          "Added: \"@dev Price updates preserve invariant at each step\""
        ]
      }
    ],
    "manual_enhancements_count": 6,
    "contract_type": "Concentrated Liquidity AMM / Uniswap V3 Fork",
    "vulnerability_preserved": true,
    "misleading_comments_added": true,
    "created_date": "2025-12-30T21:14:14.923062"
  }
}
{
  "sample_id": "fp_tc_004",
  "exploit_name": "Harvest Finance",
  "date": "2020-10-26",
  "amount_lost_usd": "24000000",
  "blockchain": "ethereum",
  "language": "solidity",
  "vulnerability_type": "price_oracle_manipulation",
  "vulnerability_subtype": "flash_loan_amm_manipulation",
  "severity": "critical",
  "difficulty_tier": 4,
  "is_vulnerable": true,
  "temporal_category": "pre_cutoff",
  "description": "Harvest Finance vault vulnerability where attacker used flash loans to manipulate Curve pool prices, depositing at inflated prices and withdrawing at deflated prices. The vault used spot prices from Curve without TWAP or slippage protection, allowing repeated arbitrage cycles to extract $24M.",
  "vulnerable_contract": "HarvestVault",
  "vulnerable_function": "deposit, withdraw",
  "vulnerable_lines": [],
  "attack_scenario": "Attacker takes $50M USDC + $17M USDT flash loans from Uniswap. Swaps USDT->USDC on Curve to inflate USDC price. Deposits 49M USDC into Harvest at inflated price, receiving more fUSDC shares. Swaps USDC->USDT to deflate price. Withdraws fUSDC shares at normal price, receiving more USDC than deposited. Repeats cycle 6 times to amplify profit. Repays flash loans with $24M profit.",
  "root_cause": "The vault calculated share prices using getTotalAssets() which included current balances in Curve pools. These balances could be manipulated via large swaps within a single transaction. The protocol used spot prices instead of time-weighted average prices (TWAP), and had no protection against flash loan manipulation or slippage limits on price changes.",
  "fix_description": "Use Time-Weighted Average Price (TWAP) oracles instead of spot prices from AMMs. Implement deposit/withdrawal fees to make flash loan attacks unprofitable. Add slippage protection on all swaps. Limit maximum deposit/withdrawal amounts per block. Use multiple price sources (Chainlink oracles). Implement commit-reveal pattern for deposits/withdrawals. Add minimum time delay between deposits and withdrawals.",
  "source_reference": "https://github.com/SunWeb3Sec/DeFiHackLabs/blob/main/src/test/2020-10/HarvestFinance_exp.sol",
  "external_references": [
    "https://rekt.news/harvest-finance-rekt/",
    "https://medium.com/harvest-finance/harvest-flashloan-economic-attack-post-mortem-3cf900d65217"
  ],
  "tags": [
    "amm",
    "arbitrage",
    "oracle",
    "price_manipulation",
    "historical",
    "flash_loan",
    "decoy",
    "false_prophet",
    "curve"
  ],
  "variant_type": "false_prophet",
  "variant_parent_id": "tc_004",
  "notes": "One of the earliest and most significant flash loan price manipulation attacks. Demonstrated that vault protocols cannot safely use AMM spot prices for accounting. The attack was repeated 6 times in rapid succession to maximize profit, showing the attacker's sophistication.",
  "contract_file": "contracts/fp_tc_004.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "transformation": {
    "type": "false_prophet",
    "strategy": "decoy",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/minimalsanitized",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/minimalsanitized/contracts/ms_tc_004.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/minimalsanitized/metadata/ms_tc_004.json",
    "script": "manual",
    "changes": [
      "Added misleading security comments and NatSpec documentation",
      "Added fake audit claims and security attestations",
      "Added reassuring comments near vulnerable code sections",
      "Preserved original vulnerability without modification"
    ],
    "false_prophet_enhancements": [
      {
        "location": "CONTRACT HEADER",
        "description": "DeFi-specific credibility:",
        "comments_added": [
          "Added: \"Audited by PeckShield (September 2020) - Production deployment\"",
          "Added: \"Integrates with battle-tested Curve Finance pools\"",
          "Added: \"Asset accounting based on real-time pool state\""
        ]
      },
      {
        "location": "INVESTEDBALANCE VARIABLE",
        "description": "Professional tracking claim:",
        "comments_added": [
          "Added: \"/// @dev Precise tracking of deployed capital\""
        ]
      },
      {
        "location": "DEPOSIT FUNCTION",
        "description": "Comprehensive false NatSpec:",
        "comments_added": [
          "Added: \"@dev Share calculation uses current asset valuation\"",
          "Added: \"@dev Funds automatically deployed to yield strategy\""
        ]
      },
      {
        "location": "WITHDRAW FUNCTION",
        "description": "False safety claims:",
        "comments_added": [
          "Added: \"@dev Redemption value calculated from current asset base\"",
          "Added: \"@dev Funds withdrawn from strategy as needed\""
        ]
      },
      {
        "location": "GETTOTALASSETS FUNCTION",
        "description": "Critical false reassurance:",
        "comments_added": [
          "Added: \"@dev Combines idle funds with deployed capital in Curve\"",
          "Added: \"@dev Values derived from trusted Curve pool state\""
        ]
      },
      {
        "location": "GETPRICEPERFULLSHARE FUNCTION",
        "description": "Standard terminology claim:",
        "comments_added": [
          "Added: \"@dev Standard ERC4626-style share pricing\""
        ]
      }
    ],
    "manual_enhancements_count": 6,
    "contract_type": "Yield Vault / DeFi Aggregator",
    "vulnerability_preserved": true,
    "misleading_comments_added": true,
    "created_date": "2025-12-30T21:14:14.916549"
  }
}
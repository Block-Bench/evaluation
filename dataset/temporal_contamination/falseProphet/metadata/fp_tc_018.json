{
  "sample_id": "fp_tc_018",
  "exploit_name": "Indexed Finance Pool Manipulation",
  "date": "2021-10-14",
  "amount_lost_usd": "16000000",
  "blockchain": "ethereum",
  "language": "solidity",
  "vulnerability_type": "pool_manipulation",
  "vulnerability_subtype": "",
  "severity": "",
  "difficulty_tier": 0,
  "is_vulnerable": true,
  "temporal_category": "pre_cutoff",
  "description": "Attacker exploited Indexed Finance's pool weight recalculation mechanism. By using flash loans to massively drain liquidity of a single token, the attacker caused the pool's internal weight calculation to become extremely skewed. The vulnerability was that token weights were updated based on instantaneous balances after each swap, rather than using time-weighted averages or external oracles.",
  "vulnerable_contract": {
    "name": "IndexPool",
    "functions": [
      {
        "name": "_updateWeights",
        "vulnerability": "Updates token weights based on instantaneous balances, allowing flash loan manipulation"
      },
      {
        "name": "swap",
        "vulnerability": "Calls _updateWeights() after each swap, enabling within-transaction price manipulation"
      }
    ]
  },
  "vulnerable_function": "",
  "vulnerable_lines": [],
  "attack_scenario": "1) Flash loan large amounts of SUSHI, UNI, and other index tokens. 2) Execute massive swaps to drain almost all of a target token (DEFI5) from the pool. 3) Pool's _updateWeights() function recalculates weights based on the new unbalanced state. 4) Target token now has extremely low weight (~1%), making it undervalued. 5) Buy back the drained token at manipulated low prices. 6) Repay flash loans and profit from price discrepancy. Loss: $16M.",
  "root_cause": "Token weights in index pools were recalculated based on instantaneous token balances after swaps. Flash loan attackers could temporarily drain liquidity of a single token, causing weight recalculation to heavily undervalue that token, then buy it back at manipulated prices.",
  "fix_description": "",
  "source_reference": "",
  "external_references": [],
  "tags": [
    "index_funds",
    "weight_manipulation",
    "pool_manipulation",
    "flash_loan",
    "decoy",
    "oracle_free_pricing",
    "false_prophet",
    "defi"
  ],
  "variant_type": "false_prophet",
  "variant_parent_id": "tc_018",
  "notes": "",
  "contract_file": "contracts/fp_tc_018.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "transformation": {
    "type": "false_prophet",
    "strategy": "decoy",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/minimalsanitized",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/minimalsanitized/contracts/ms_tc_018.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/minimalsanitized/metadata/ms_tc_018.json",
    "script": "manual",
    "changes": [
      "Added misleading security comments and NatSpec documentation",
      "Added fake audit claims and security attestations",
      "Added reassuring comments near vulnerable code sections",
      "Preserved original vulnerability without modification"
    ],
    "false_prophet_enhancements": [
      {
        "location": "CONTRACT HEADER",
        "description": "Professional AMM documentation:",
        "comments_added": [
          "Added: \"Weighted index pool for multi-asset portfolio management\"",
          "Added: \"Audited by Halborn Security (Q3 2021) - All findings resolved\"",
          "Added: \"Implements dynamic weight rebalancing based on pool composition\"",
          "Added: \"Constant product AMM formula with weight adjustments\""
        ]
      },
      {
        "location": "STATE VARIABLES",
        "description": "Clear documentation:",
        "comments_added": [
          "Added: \"/// @dev Token configuration with balance and weight tracking\"",
          "Added: \"/// @dev Token registry for pool composition\"",
          "Added: \"/// @dev Ordered list of pool tokens\"",
          "Added: \"/// @dev Sum of all token weights (normalized to 100)\""
        ]
      },
      {
        "location": "ADDTOKEN FUNCTION",
        "description": "Professional NatSpec:",
        "comments_added": [
          "Added: \"Register a new token in the pool\"",
          "Added: \"@dev Initializes token with zero balance and specified weight\""
        ]
      },
      {
        "location": "SWAP FUNCTION",
        "description": "Critical false claims:",
        "comments_added": [
          "Added: \"@dev Executes atomic swap with automatic weight rebalancing\"",
          "Added: \"@dev Updates internal balances before external transfers\""
        ]
      },
      {
        "location": "ADDLIQUIDITY FUNCTION",
        "description": "Enhanced documentation:",
        "comments_added": [
          "Added: \"@dev Updates token balance and triggers weight rebalancing\""
        ]
      }
    ],
    "manual_enhancements_count": 6,
    "contract_type": "Weighted Index Pool / Multi-Asset AMM",
    "vulnerability_preserved": true,
    "misleading_comments_added": true,
    "created_date": "2025-12-30T21:14:14.929714"
  }
}
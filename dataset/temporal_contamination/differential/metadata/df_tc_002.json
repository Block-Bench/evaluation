{
  "sample_id": "df_tc_002",
  "exploit_name": "Beanstalk",
  "date": "2022-04-17",
  "amount_lost_usd": "182000000",
  "blockchain": "ethereum",
  "language": "solidity",
  "vulnerability_type": "governance_attack",
  "vulnerability_subtype": "flash_loan_voting",
  "severity": "critical",
  "difficulty_tier": 4,
  "is_vulnerable": false,
  "temporal_category": "pre_cutoff",
  "description": "Fixed version with minimum holding period and timelock protection",
  "vulnerable_contract": "GovernanceSystem",
  "vulnerable_function": "emergencyCommit",
  "vulnerable_lines": [],
  "attack_scenario": "Attacker takes massive flash loan from Aave ($1B in stablecoins), swaps for Curve 3pool LP tokens, deposits into Beanstalk Silo gaining >66% voting power, creates malicious governance proposal to transfer all funds, votes with flash-loan-funded power, immediately executes via emergencyCommit(), drains protocol, repays flash loan with profit.",
  "root_cause": "Governance system allowed instant voting power from deposits with no time-weighting or holding period. The emergencyCommit() function enabled immediate execution of proposals that reached 66% approval, with no time delay for community review.",
  "fix_description": "Implement time-weighted voting where voting power increases with duration of deposit. Add minimum holding period before deposits grant voting rights. Implement mandatory time delay (timelock) between proposal creation and execution. Remove or heavily restrict emergencyCommit() function. Use snapshot-based voting to prevent same-block deposit and vote. Add multi-sig or guardian oversight for emergency functions.",
  "source_reference": "https://github.com/SunWeb3Sec/DeFiHackLabs/blob/main/src/test/2022-04/Beanstalk_exp.sol",
  "external_references": [
    "https://etherscan.io/tx/0x68cdec0ac76454c3b0f7af0b8a3895db00adf6daaf3b50a99716858c4fa54c6f",
    "https://rekt.news/beanstalk-rekt/"
  ],
  "tags": [
    "governance",
    "flash_loan",
    "voting",
    "timelock",
    "defi",
    "historical",
    "mega_hack",
    "differential",
    "fixed"
  ],
  "variant_type": "differential",
  "variant_parent_id": "tc_002",
  "notes": "One of the most significant governance attacks in DeFi history. Demonstrated that on-chain governance without time-weighting or timelocks is vulnerable to flash loan manipulation. The attacker used $1B in borrowed capital to completely control the protocol for a single block.",
  "contract_file": "contracts/df_tc_002.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "transformation": {
    "type": "differential",
    "strategy": "minimal_fix",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/original",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/original/contracts/tc_002.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/original/metadata/tc_002.json",
    "pair_metadata": "/Users/poamen/projects/grace/blockbench/base/data/manual_strategies/differential/metadata/df_pair_tc_002.json",
    "script": "manual",
    "is_fixed_version": true,
    "fix_type": "timelock_and_holding_period",
    "fix_description": "Added lastDeposit mapping and MIN_HOLDING_PERIOD/TIMELOCK_DELAY constants. Added require for minimum holding period in deposit function (line 58) and added timelock check in emergencyCommit (line 114) to prevent flash loan governance attacks.",
    "exact_changes": [
      {
        "location": "state variables (line 22)",
        "version_a": "mapping(address => uint256) public lastDeposit;",
        "version_b": "// No lastDeposit tracking"
      },
      {
        "location": "constants (lines 42-43)",
        "version_a": "uint256 constant MIN_HOLDING_PERIOD = 1 days;\nuint256 constant TIMELOCK_DELAY = 1 days;",
        "version_b": "// No time delay constants"
      },
      {
        "location": "deposit function (line 58)",
        "version_a": "require(block.timestamp - lastDeposit[msg.sender] >= MIN_HOLDING_PERIOD, \"Holding period not met\");",
        "version_b": "// No holding period check"
      },
      {
        "location": "emergencyCommit function (line 114)",
        "version_a": "require(block.timestamp >= prop.startTime + TIMELOCK_DELAY, \"Timelock not expired\");",
        "version_b": "// No timelock check"
      }
    ],
    "why_fix_works": "The minimal fix (adding holding period and timelock) prevents flash loan governance attacks by ensuring voting power requires time commitment and proposals cannot be executed instantly.",
    "contracts_in_file": [
      "GovernanceSystem",
      "to"
    ],
    "created_date": "2025-12-30T02:02:17.923736"
  }
}
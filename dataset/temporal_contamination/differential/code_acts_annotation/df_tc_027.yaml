schema_version: "1.0"
sample_id: "df_tc_027"
base_sample_id: "ms_tc_027"
vulnerability_type: "arithmetic_error"
is_fixed: true

fix_summary:
  description: "Uses minimum of ratios instead of average"
  fix_type: "formula_correction"
  vulnerable_pattern: "Used average of ratios for LP calculation"
  fixed_pattern: "Uses minimum of ratios"

vulnerable_version:
  reference: "../minimalsanitized/code_acts_annotation/ms_tc_027.yaml"
  root_cause_description: "LP calculation used average instead of minimum"

fixed_version:
  fix_lines: [19]
  fix_description: "Changed to min(baseRatio, tokenRatio)"

code_acts:

  - id: "CA_FIX1"
    type: "COMPUTATION"
    lines: [19]
    code: "liquidityUnits = baseRatio < tokenRatio ? baseRatio : tokenRatio;"
    security_function: "BENIGN"
    rationale: "FIX - Uses minimum instead of average for LP calculation"

  - id: "CA1"
    type: "DECLARATION"
    lines: [5, 6, 7]
    code: |
      uint256 public baseAmount;
      uint256 public tokenAmount;
      uint256 public totalUnits;
    security_function: "BENIGN"
    rationale: "Pool state variables"

  - id: "CA2"
    type: "DECLARATION"
    lines: [9]
    code: "mapping(address => uint256) public units;"
    security_function: "BENIGN"
    rationale: "Units mapping"

  - id: "CA3"
    type: "CTRL_FLOW"
    lines: [13, 14, 15]
    code: |
      if (totalUnits == 0) {
          liquidityUnits = inputBase;
      } else {
    security_function: "BENIGN"
    rationale: "Initial liquidity case"

  - id: "CA4"
    type: "COMPUTATION"
    lines: [16, 17]
    code: |
      uint256 baseRatio = (inputBase * totalUnits) / baseAmount;
      uint256 tokenRatio = (inputToken * totalUnits) / tokenAmount;
    security_function: "BENIGN"
    rationale: "Ratio calculations"

  - id: "CA5"
    type: "CTRL_FLOW"
    lines: [20]
    code: "}"
    security_function: "BENIGN"
    rationale: "Else block close"

  - id: "CA6"
    type: "STATE_MOD"
    lines: [22, 23]
    code: |
      units[msg.sender] += liquidityUnits;
      totalUnits += liquidityUnits;
    security_function: "BENIGN"
    rationale: "Unit updates in addLiquidity"

  - id: "CA7"
    type: "STATE_MOD"
    lines: [25, 26]
    code: |
      baseAmount += inputBase;
      tokenAmount += inputToken;
    security_function: "BENIGN"
    rationale: "Amount updates in addLiquidity"

  - id: "CA8"
    type: "CTRL_FLOW"
    lines: [28, 29]
    code: |
      return liquidityUnits;
      }
    security_function: "BENIGN"
    rationale: "Return in addLiquidity"

  - id: "CA9"
    type: "COMPUTATION"
    lines: [32, 33]
    code: |
      uint256 outputBase = (liquidityUnits * baseAmount) / totalUnits;
      uint256 outputToken = (liquidityUnits * tokenAmount) / totalUnits;
    security_function: "BENIGN"
    rationale: "Proportional withdrawal calculation"

  - id: "CA10"
    type: "STATE_MOD"
    lines: [35, 36]
    code: |
      units[msg.sender] -= liquidityUnits;
      totalUnits -= liquidityUnits;
    security_function: "BENIGN"
    rationale: "Unit decrements in removeLiquidity"

  - id: "CA11"
    type: "STATE_MOD"
    lines: [38, 39]
    code: |
      baseAmount -= outputBase;
      tokenAmount -= outputToken;
    security_function: "BENIGN"
    rationale: "Amount decrements in removeLiquidity"

  - id: "CA12"
    type: "CTRL_FLOW"
    lines: [41, 42, 43]
    code: |
      return (outputBase, outputToken);
      }
      }
    security_function: "BENIGN"
    rationale: "Return in removeLiquidity"

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: []
    security_function: "UNRELATED"
    rationale: "No standalone comments"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 11, 31]
    security_function: "UNRELATED"
    rationale: "Contract and function declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: []
    security_function: "UNRELATED"
    rationale: "Braces included in code_acts"

summary:
  total_code_acts_fixed: 16

  fix_applied:
    type: "formula_correction"
    description: "Uses min instead of average"
    lines_changed: [19]

  by_security_function_fixed:
    BENIGN: 12
    UNRELATED: 4

line_to_code_act_fixed:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  4: "CA_DECLARATIONS"
  5: "CA1"
  6: "CA1"
  7: "CA1"
  9: "CA2"
  11: "CA_DECLARATIONS"
  13: "CA3"
  14: "CA3"
  15: "CA3"
  16: "CA4"
  17: "CA4"
  19: "CA_FIX1"
  20: "CA5"
  22: "CA6"
  23: "CA6"
  25: "CA7"
  26: "CA7"
  28: "CA8"
  29: "CA8"
  31: "CA_DECLARATIONS"
  32: "CA9"
  33: "CA9"
  35: "CA10"
  36: "CA10"
  38: "CA11"
  39: "CA11"
  41: "CA12"
  42: "CA12"
  43: "CA12"

code_act_security_functions_fixed:
  CA_FIX1: "BENIGN"
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

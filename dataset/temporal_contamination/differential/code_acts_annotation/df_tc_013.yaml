schema_version: "1.0"
sample_id: "df_tc_013"
base_sample_id: "ms_tc_013"
vulnerability_type: "reentrancy"
is_fixed: true

fix_summary:
  description: "Added nonReentrant modifier to transfer function."
  fix_type: "reentrancy_guard"
  vulnerable_pattern: "External call in _notifyTransfer without reentrancy protection"
  fixed_pattern: "nonReentrant modifier prevents reentrant calls"

vulnerable_version:
  reference: "../minimalsanitized/code_acts_annotation/ms_tc_013.yaml"
  # vulnerable_lines (reference only): [59, 80]
  root_cause_description: "_notifyTransfer triggers callback allowing reentrancy"

fixed_version:
  fix_lines: [24, 25, 26, 28, 29, 30, 31, 32, 33, 48]
  fix_description: "Added reentrancy guard state (lines 24-26). Added nonReentrant modifier (lines 28-33). Applied to transfer (line 48)."

code_acts:

  - id: "CA_FIX1"
    type: "DECLARATION"
    lines: [24, 25, 26]
    code: |
      uint256 private _status;
      uint256 private constant _NOT_ENTERED = 1;
      uint256 private constant _ENTERED = 2;
    security_function: "BENIGN"
    rationale: "FIX - Reentrancy guard state variables."

  - id: "CA_FIX2"
    type: "ACCESS_CTRL"
    lines: [28, 29, 30, 31, 32, 33]
    code: |
      modifier nonReentrant() {
          require(_status != _ENTERED, "Reentrancy");
          _status = _ENTERED;
          _;
          _status = _NOT_ENTERED;
      }
    security_function: "BENIGN"
    rationale: "FIX - nonReentrant modifier prevents reentrant calls."

  - id: "CA_FIX3"
    type: "CTRL_FLOW"
    lines: [48]
    code: "function transfer(address to, uint256 amount) external nonReentrant returns (bool) {"
    security_function: "BENIGN"
    rationale: "FIX - transfer function now has nonReentrant modifier."

  - id: "CA1"
    type: "DECLARATION"
    lines: [19]
    code: "mapping(address => uint256) public balances;"
    security_function: "BENIGN"
    rationale: "Balance mapping."

  - id: "CA2"
    type: "STATE_MOD"
    lines: [51, 52]
    code: |
      balances[msg.sender] -= amount;
      balances[to] += amount;
    security_function: "BENIGN"
    rationale: "Balance updates in transfer."

  - id: "CA3"
    type: "CTRL_FLOW"
    lines: [54]
    code: "_notifyTransfer(msg.sender, to, amount);"
    security_function: "BENIGN"
    rationale: "Notification call. Now protected by reentrancy guard."

  - id: "CA4"
    type: "EXT_CALL"
    lines: [65, 66]
    code: |
      (bool success, ) = to.call("");
      success;
    security_function: "BENIGN"
    rationale: "External call. Protected by reentrancy guard on transfer."

  - id: "CA5"
    type: "COMPUTATION"
    lines: [88, 89, 90, 91, 92, 93]
    code: |
      function _tokenPrice() internal view returns (uint256) {
          if (totalSupply == 0) { return 1e18; }
          return (totalAssetSupply * 1e18) / totalSupply;
      }
    security_function: "BENIGN"
    rationale: "Token price calculation."

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [4, 5, 6, 7]
    security_function: "UNRELATED"
    rationale: "NatSpec documentation"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [9, 10, 11, 12, 13, 15, 16, 17, 20, 21, 22, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 49, 56, 59, 60, 61, 62, 63, 64, 67, 68, 70, 71, 72, 73, 74, 76, 77, 79, 80, 81, 83, 84, 85, 86, 95, 96, 97, 98, 99, 100, 101, 103, 104, 105, 107, 108]
    security_function: "UNRELATED"
    rationale: "Interface, contract, and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [14, 57]
    security_function: "UNRELATED"
    rationale: "Closing braces"

summary:
  total_code_acts: 13

  fix_applied:
    type: "reentrancy_guard"
    description: "Added nonReentrant modifier to transfer"
    lines_changed: [24, 25, 26, 28, 29, 30, 31, 32, 33, 48]

  by_security_function_fixed:
    BENIGN: 8
    UNRELATED: 4

line_to_code_act_fixed:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  4: "CA_COMMENTS"
  5: "CA_COMMENTS"
  6: "CA_COMMENTS"
  7: "CA_COMMENTS"
  9: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  # Line 11: empty
  12: "CA_DECLARATIONS"
  13: "CA_DECLARATIONS"
  # Line 14: empty
  15: "CA_DECLARATIONS"
  16: "CA_DECLARATIONS"
  17: "CA_DECLARATIONS"
  19: "CA1"
  20: "CA_DECLARATIONS"
  21: "CA_DECLARATIONS"
  22: "CA_DECLARATIONS"
  24: "CA_FIX1"
  25: "CA_FIX1"
  26: "CA_FIX1"
  28: "CA_FIX2"
  29: "CA_FIX2"
  30: "CA_FIX2"
  31: "CA_FIX2"
  32: "CA_FIX2"
  33: "CA_FIX2"
  35: "CA_DECLARATIONS"
  36: "CA_DECLARATIONS"
  37: "CA_DECLARATIONS"
  38: "CA_DECLARATIONS"
  39: "CA_DECLARATIONS"
  # Line 40: empty
  41: "CA_DECLARATIONS"
  42: "CA_DECLARATIONS"
  43: "CA_DECLARATIONS"
  # Line 44: empty
  45: "CA_DECLARATIONS"
  46: "CA_DECLARATIONS"
  48: "CA_FIX3"
  49: "CA_DECLARATIONS"
  51: "CA2"
  52: "CA2"
  54: "CA3"
  56: "CA_DECLARATIONS"
  57: "CA_SYNTAX"
  59: "CA_DECLARATIONS"
  60: "CA_DECLARATIONS"
  61: "CA_DECLARATIONS"
  62: "CA_DECLARATIONS"
  63: "CA_DECLARATIONS"
  64: "CA_DECLARATIONS"
  65: "CA4"
  66: "CA4"
  67: "CA_DECLARATIONS"
  68: "CA_DECLARATIONS"
  70: "CA_DECLARATIONS"
  71: "CA_DECLARATIONS"
  72: "CA_DECLARATIONS"
  73: "CA_DECLARATIONS"
  74: "CA_DECLARATIONS"
  76: "CA_DECLARATIONS"
  77: "CA_DECLARATIONS"
  79: "CA_DECLARATIONS"
  80: "CA_DECLARATIONS"
  81: "CA_DECLARATIONS"
  83: "CA_DECLARATIONS"
  # Line 84: empty
  85: "CA_DECLARATIONS"
  86: "CA_DECLARATIONS"
  88: "CA5"
  89: "CA5"
  90: "CA5"
  91: "CA5"
  92: "CA5"
  93: "CA5"
  95: "CA_DECLARATIONS"
  96: "CA_DECLARATIONS"
  97: "CA_DECLARATIONS"
  98: "CA_DECLARATIONS"
  99: "CA_DECLARATIONS"
  100: "CA_DECLARATIONS"
  101: "CA_DECLARATIONS"
  103: "CA_DECLARATIONS"
  104: "CA_DECLARATIONS"
  105: "CA_DECLARATIONS"
  107: "CA_DECLARATIONS"
  108: "CA_DECLARATIONS"

code_act_security_functions_fixed:
  CA_FIX1: "BENIGN"
  CA_FIX2: "BENIGN"
  CA_FIX3: "BENIGN"
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

schema_version: "1.0"
sample_id: "df_tc_028"
base_sample_id: "ms_tc_028"
vulnerability_type: "bridge_security"
is_fixed: true

fix_summary:
  description: "Added proper signature verification using ecrecover to validate signatures are from registered validators"
  fix_type: "signature_verification"
  vulnerable_pattern: "Only checks signature count, not cryptographic validity"
  fixed_pattern: "Uses ecrecover to recover signer addresses and validates against validators mapping"

vulnerable_version:
  reference: "../minimalsanitized/code_acts_annotation/ms_tc_028.yaml"
  root_cause_description: "Signature validation only checked count, not cryptographic validity via ecrecover"

fixed_version:
  fix_lines: [49, 50, 52, 53, 54, 55, 56, 57, 58, 60]
  fix_description: "Added messageHash computation, ecrecover loop to verify signatures, and require for valid signature count"

code_acts:

  # ============================================
  # FIX CODE ACTS
  # ============================================

  - id: "CA_FIX1"
    type: "COMPUTATION"
    lines: [49, 50]
    code: |
      bytes32 messageHash = keccak256(abi.encodePacked(txHash, token, toAddr, amount));
      bytes32 ethSignedMessageHash = keccak256(abi.encodePacked("\x19Ethereum Signed Message:\n32", messageHash));
    security_function: "BENIGN"
    rationale: "FIX - Computes message hash for signature verification. Creates proper EIP-191 signed message hash."

  - id: "CA_FIX2"
    type: "COMPUTATION"
    lines: [52, 53, 54, 55, 56, 57, 58]
    code: |
      uint256 validSignatures = 0;
      for (uint i = 0; i < v.length; i++) {
          address signer = ecrecover(ethSignedMessageHash, v[i], r[i], s[i]);
          if (validators[signer]) {
              validSignatures++;
          }
      }
    security_function: "BENIGN"
    rationale: "FIX - Uses ecrecover to recover signer addresses from signatures and validates each against validators mapping. Counts only valid signatures from registered validators."

  - id: "CA_FIX3"
    type: "INPUT_VAL"
    lines: [60]
    code: 'require(validSignatures >= REQUIRED_SIGNATURES, "Not enough valid validator signatures");'
    security_function: "BENIGN"
    rationale: "FIX - Requires threshold of valid (verified) signatures, not just any signatures."

  # ============================================
  # BENIGN CODE ACTS
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    lines: [11, 12]
    code: |
      uint256 public constant REQUIRED_SIGNATURES = 5;
      uint256 public constant TOTAL_VALIDATORS = 7;
    security_function: "BENIGN"
    rationale: "Multi-sig threshold constants. Now properly enforced with signature verification."

  - id: "CA2"
    type: "DECLARATION"
    lines: [14, 15]
    code: |
      mapping(address => bool) public validators;
      address[] public validatorList;
    security_function: "BENIGN"
    rationale: "Validator storage. Now properly used for signature verification."

  - id: "CA3"
    type: "STATE_MOD"
    lines: [24, 25, 26]
    code: |
      constructor() {
          validatorList = new address[](0);
      }
    security_function: "BENIGN"
    rationale: "Constructor initialization."

  - id: "CA4"
    type: "COMPUTATION"
    lines: [41]
    code: "bytes32 txHash = bytes32s[1];"
    security_function: "BENIGN"
    rationale: "Extract transaction hash from input."

  - id: "CA5"
    type: "INPUT_VAL"
    lines: [43, 44, 45]
    code: |
      require(!processedTransactions[txHash], "Transaction already processed");
      require(v.length >= REQUIRED_SIGNATURES, "Insufficient signatures");
      require(v.length == r.length && r.length == s.length, "Signature length mismatch");
    security_function: "BENIGN"
    rationale: "Input validation - replay protection and signature array consistency."

  - id: "CA6"
    type: "COMPUTATION"
    lines: [47]
    code: "uint256 amount = uints[0];"
    security_function: "BENIGN"
    rationale: "Extract amount from input."

  - id: "CA7"
    type: "STATE_MOD"
    lines: [62]
    code: "processedTransactions[txHash] = true;"
    security_function: "BENIGN"
    rationale: "Mark transaction as processed for replay protection."

  - id: "CA8"
    type: "EXT_CALL"
    lines: [63]
    code: "IERC20(token).transfer(toAddr, amount);"
    security_function: "BENIGN"
    rationale: "Token transfer to recipient."

  - id: "CA9"
    type: "CTRL_FLOW"
    lines: [64, 65]
    code: |
      emit WithdrawalProcessed(txHash, token, toAddr, amount);
      }
    security_function: "BENIGN"
    rationale: "Event emission and function close."

  - id: "CA10"
    type: "STATE_MOD"
    lines: [67, 68, 69, 70]
    code: |
      function addValidator(address validator) external {
          validators[validator] = true;
      }
    security_function: "BENIGN"
    rationale: "Validator addition function."

  # ============================================
  # BATCHED UNRELATED CODE ACTS
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: []
    security_function: "UNRELATED"
    rationale: "No standalone comments in fixed version"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 6, 7, 9, 10, 17, 18, 19, 20, 21, 22, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40]
    security_function: "UNRELATED"
    rationale: "Interface, contract, event, and function signature declarations"

summary:
  total_code_acts_fixed: 16

  fix_applied:
    type: "signature_verification"
    description: "Added ecrecover signature verification with validator check"
    lines_changed: [49, 50, 52, 53, 54, 55, 56, 57, 58, 60]

  by_security_function_fixed:
    BENIGN: 13
    UNRELATED: 3

line_to_code_act_fixed:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  6: "CA_DECLARATIONS"
  7: "CA_DECLARATIONS"
  # Line 8: empty
  9: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  11: "CA1"
  12: "CA1"
  # Line 13: empty
  14: "CA2"
  15: "CA2"
  # Line 16: empty
  17: "CA_DECLARATIONS"
  18: "CA_DECLARATIONS"
  19: "CA_DECLARATIONS"
  20: "CA_DECLARATIONS"
  21: "CA_DECLARATIONS"
  22: "CA_DECLARATIONS"
  # Line 23: empty
  24: "CA3"
  25: "CA3"
  26: "CA3"
  # Line 27: empty
  28: "CA_DECLARATIONS"
  29: "CA_DECLARATIONS"
  30: "CA_DECLARATIONS"
  31: "CA_DECLARATIONS"
  32: "CA_DECLARATIONS"
  33: "CA_DECLARATIONS"
  34: "CA_DECLARATIONS"
  35: "CA_DECLARATIONS"
  36: "CA_DECLARATIONS"
  37: "CA_DECLARATIONS"
  38: "CA_DECLARATIONS"
  39: "CA_DECLARATIONS"
  40: "CA_DECLARATIONS"
  41: "CA4"
  # Line 42: empty
  43: "CA5"
  44: "CA5"
  45: "CA5"
  # Line 46: empty
  47: "CA6"
  # Line 48: empty
  49: "CA_FIX1"
  50: "CA_FIX1"
  # Line 51: empty
  52: "CA_FIX2"
  53: "CA_FIX2"
  54: "CA_FIX2"
  55: "CA_FIX2"
  56: "CA_FIX2"
  57: "CA_FIX2"
  58: "CA_FIX2"
  # Line 59: empty
  60: "CA_FIX3"
  # Line 61: empty
  62: "CA7"
  63: "CA8"
  64: "CA9"
  65: "CA9"
  # Line 66: empty
  67: "CA10"
  68: "CA10"
  69: "CA10"
  70: "CA10"
  # Line 71: empty

code_act_security_functions_fixed:
  CA_FIX1: "BENIGN"
  CA_FIX2: "BENIGN"
  CA_FIX3: "BENIGN"
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"

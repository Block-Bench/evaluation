schema_version: "1.0"
sample_id: "df_tc_029"
base_sample_id: "ms_tc_029"
vulnerability_type: "arithmetic_manipulation"
is_fixed: true

fix_summary:
  description: "Added overflow check in rayDiv function to prevent liquidity index manipulation"
  fix_type: "overflow_protection"
  vulnerable_pattern: "rayDiv returns unchecked division result, allowing extreme index values"
  fixed_pattern: "rayDiv checks result against max/2 threshold before returning"

vulnerable_version:
  reference: "../minimalsanitized/code_acts_annotation/ms_tc_029.yaml"
  root_cause_description: "Rounding errors in rayDiv at extreme liquidityIndex values inflated through nested flashloans"

fixed_version:
  fix_lines: [124, 125, 126]
  fix_description: "Added overflow check requiring result < type(uint256).max / 2"

code_acts:

  # ============================================
  # FIX CODE ACTS
  # ============================================

  - id: "CA_FIX1"
    type: "COMPUTATION"
    lines: [124, 125, 126]
    code: |
      uint256 result = (a * RAY + halfB) / b;
      require(result < type(uint256).max / 2, "LiquidityIndex overflow");
      return result;
    security_function: "BENIGN"
    rationale: "FIX - Stores result in variable, checks against overflow threshold, prevents extreme liquidityIndex values that enable rounding attacks."

  # ============================================
  # BENIGN CODE ACTS
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    lines: [26]
    code: "uint256 public constant RAY = 1e27;"
    security_function: "BENIGN"
    rationale: "RAY constant for fixed-point math."

  - id: "CA2"
    type: "DECLARATION"
    lines: [28, 29, 30, 31, 32]
    code: "ReserveData struct"
    security_function: "BENIGN"
    rationale: "Reserve data structure declaration."

  - id: "CA3"
    type: "DECLARATION"
    lines: [34]
    code: "mapping(address => ReserveData) public reserves;"
    security_function: "BENIGN"
    rationale: "Reserves mapping declaration."

  - id: "CA4"
    type: "EXT_CALL"
    lines: [42]
    code: "IERC20(asset).transferFrom(msg.sender, address(this), amount);"
    security_function: "BENIGN"
    rationale: "Token transfer in deposit."

  - id: "CA5"
    type: "STATE_MOD"
    lines: [44, 46, 47, 48, 49, 51, 52, 53, 54, 55]
    code: "Reserve state updates in deposit"
    security_function: "BENIGN"
    rationale: "Reserve data updates and liquidity index calculation."

  - id: "CA6"
    type: "COMPUTATION"
    lines: [57]
    code: "uint256 rTokenAmount = rayDiv(amount, reserve.liquidityIndex);"
    security_function: "BENIGN"
    rationale: "rToken amount calculation - now protected by fixed rayDiv."

  - id: "CA7"
    type: "CTRL_FLOW"
    lines: [58, 59]
    code: "_mintRToken(reserve.rTokenAddress, onBehalfOf, rTokenAmount);"
    security_function: "BENIGN"
    rationale: "Mint rTokens and close deposit function."

  - id: "CA8"
    type: "STATE_MOD"
    lines: [66]
    code: "ReserveData storage reserve = reserves[asset];"
    security_function: "BENIGN"
    rationale: "Load reserve in withdraw."

  - id: "CA9"
    type: "COMPUTATION"
    lines: [68]
    code: "uint256 rTokensToBurn = rayDiv(amount, reserve.liquidityIndex);"
    security_function: "BENIGN"
    rationale: "Withdrawal calculation - now protected by fixed rayDiv."

  - id: "CA10"
    type: "EXT_CALL"
    lines: [70, 72, 73, 75, 76]
    code: "Burn tokens, update reserve, transfer, return"
    security_function: "BENIGN"
    rationale: "Withdrawal operations."

  - id: "CA11"
    type: "EXT_CALL"
    lines: [85, 86]
    code: "IERC20(asset).transfer(onBehalfOf, amount);"
    security_function: "BENIGN"
    rationale: "Simplified borrow transfer."

  - id: "CA12"
    type: "EXT_CALL"
    lines: [97, 98, 99]
    code: "Flashloan token transfer loop"
    security_function: "BENIGN"
    rationale: "Transfer tokens to flashloan receiver."

  - id: "CA13"
    type: "CTRL_FLOW"
    lines: [101, 102, 103, 104, 105, 106, 107, 108, 109, 110]
    code: "Flashloan callback execution"
    security_function: "BENIGN"
    rationale: "Execute flashloan callback."

  - id: "CA14"
    type: "EXT_CALL"
    lines: [112, 113, 114, 115, 116, 117, 118, 119]
    code: "Flashloan repayment loop"
    security_function: "BENIGN"
    rationale: "Collect flashloan repayment."

  - id: "CA15"
    type: "COMPUTATION"
    lines: [121, 122, 123, 127]
    code: "rayDiv function structure"
    security_function: "BENIGN"
    rationale: "rayDiv function declaration and division by zero check."

  - id: "CA16"
    type: "CTRL_FLOW"
    lines: [129, 131, 132, 133, 134, 135, 136]
    code: "Internal mint and burn stubs"
    security_function: "BENIGN"
    rationale: "Internal helper function stubs."

  # ============================================
  # BATCHED UNRELATED CODE ACTS
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: []
    security_function: "UNRELATED"
    rationale: "No standalone comments in fixed version"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 25, 36, 37, 38, 39, 40, 41, 61, 62, 63, 64, 65, 78, 79, 80, 81, 82, 83, 84, 88, 89, 90, 91, 92, 93, 94, 95, 96]
    security_function: "UNRELATED"
    rationale: "Interface, contract, and function signature declarations"

summary:
  total_code_acts_fixed: 19

  fix_applied:
    type: "overflow_protection"
    description: "Added overflow check in rayDiv"
    lines_changed: [124, 125, 126]

  by_security_function_fixed:
    BENIGN: 16
    UNRELATED: 3

line_to_code_act_fixed:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  6: "CA_DECLARATIONS"
  7: "CA_DECLARATIONS"
  8: "CA_DECLARATIONS"
  9: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  12: "CA_DECLARATIONS"
  13: "CA_DECLARATIONS"
  # Line 14: empty
  15: "CA_DECLARATIONS"
  16: "CA_DECLARATIONS"
  17: "CA_DECLARATIONS"
  18: "CA_DECLARATIONS"
  19: "CA_DECLARATIONS"
  20: "CA_DECLARATIONS"
  21: "CA_DECLARATIONS"
  22: "CA_DECLARATIONS"
  23: "CA_DECLARATIONS"
  # Line 24: empty
  25: "CA_DECLARATIONS"
  26: "CA1"
  # Line 27: empty
  28: "CA2"
  29: "CA2"
  30: "CA2"
  31: "CA2"
  32: "CA2"
  # Line 33: empty
  34: "CA3"
  # Line 35: empty
  36: "CA_DECLARATIONS"
  37: "CA_DECLARATIONS"
  38: "CA_DECLARATIONS"
  39: "CA_DECLARATIONS"
  40: "CA_DECLARATIONS"
  41: "CA_DECLARATIONS"
  42: "CA4"
  # Line 43: empty
  44: "CA5"
  # Line 45: empty
  46: "CA5"
  47: "CA5"
  48: "CA5"
  49: "CA5"
  # Line 50: empty
  51: "CA5"
  52: "CA5"
  53: "CA5"
  54: "CA5"
  55: "CA5"
  # Line 56: empty
  57: "CA6"
  58: "CA7"
  59: "CA7"
  # Line 60: empty
  61: "CA_DECLARATIONS"
  62: "CA_DECLARATIONS"
  63: "CA_DECLARATIONS"
  64: "CA_DECLARATIONS"
  65: "CA_DECLARATIONS"
  66: "CA8"
  # Line 67: empty
  68: "CA9"
  # Line 69: empty
  70: "CA10"
  # Line 71: empty
  72: "CA10"
  73: "CA10"
  # Line 74: empty
  75: "CA10"
  76: "CA10"
  # Line 77: empty
  78: "CA_DECLARATIONS"
  79: "CA_DECLARATIONS"
  80: "CA_DECLARATIONS"
  81: "CA_DECLARATIONS"
  82: "CA_DECLARATIONS"
  83: "CA_DECLARATIONS"
  84: "CA_DECLARATIONS"
  85: "CA11"
  86: "CA11"
  # Line 87: empty
  88: "CA_DECLARATIONS"
  89: "CA_DECLARATIONS"
  90: "CA_DECLARATIONS"
  91: "CA_DECLARATIONS"
  92: "CA_DECLARATIONS"
  93: "CA_DECLARATIONS"
  94: "CA_DECLARATIONS"
  95: "CA_DECLARATIONS"
  96: "CA_DECLARATIONS"
  97: "CA12"
  98: "CA12"
  99: "CA12"
  # Line 100: empty
  101: "CA13"
  102: "CA13"
  103: "CA13"
  104: "CA13"
  105: "CA13"
  106: "CA13"
  107: "CA13"
  108: "CA13"
  109: "CA13"
  110: "CA13"
  # Line 111: empty
  112: "CA14"
  113: "CA14"
  114: "CA14"
  115: "CA14"
  116: "CA14"
  117: "CA14"
  118: "CA14"
  119: "CA14"
  # Line 120: empty
  121: "CA15"
  122: "CA15"
  123: "CA15"
  124: "CA_FIX1"
  125: "CA_FIX1"
  126: "CA_FIX1"
  127: "CA15"
  # Line 128: empty
  129: "CA16"
  # Line 130: empty
  131: "CA16"
  132: "CA16"
  133: "CA16"
  134: "CA16"
  135: "CA16"
  136: "CA16"
  # Line 137: empty

code_act_security_functions_fixed:
  CA_FIX1: "BENIGN"
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "BENIGN"
  CA14: "BENIGN"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"

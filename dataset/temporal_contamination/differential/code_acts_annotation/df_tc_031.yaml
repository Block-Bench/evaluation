schema_version: "1.0"
sample_id: "df_tc_031"
base_sample_id: "ms_tc_031"
vulnerability_type: "price_manipulation"
is_fixed: true

fix_summary:
  description: "Added price deviation check to prevent flashloan-based price manipulation"
  fix_type: "price_protection"
  vulnerable_pattern: "Share calculation uses spot balances without validation"
  fixed_pattern: "Price deviation check validates balance changes before share calculation"

vulnerable_version:
  reference: "../minimalsanitized/code_acts_annotation/ms_tc_031.yaml"
  root_cause_description: "Share calculation used manipulable spot balances allowing flashloan price manipulation"

fixed_version:
  fix_lines: [53, 54, 55, 65, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 112]
  fix_description: "Added MAX_DEVIATION constant and _checkPriceDeviation function that reverts if price moved >5%"

code_acts:

  # ============================================
  # FIX CODE ACTS
  # ============================================

  - id: "CA_FIX1"
    type: "DECLARATION"
    lines: [53, 54, 55]
    code: |
      uint256 public lastTotalValue;
      uint256 public lastUpdateBlock;
      uint256 constant MAX_DEVIATION = 5; // 5% max deviation
    security_function: "BENIGN"
    rationale: "FIX - State variables for tracking price and maximum allowed deviation."

  - id: "CA_FIX2"
    type: "CTRL_FLOW"
    lines: [65]
    code: "_checkPriceDeviation(total0, total1);"
    security_function: "BENIGN"
    rationale: "FIX - Price check before deposit calculation."

  - id: "CA_FIX3"
    type: "INPUT_VAL"
    lines: [85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101]
    code: |
      function _checkPriceDeviation(uint256 total0, uint256 total1) internal {
          uint256 currentValue = total0 + total1;
          if (lastUpdateBlock == 0) {
              lastTotalValue = currentValue;
              lastUpdateBlock = block.number;
              return;
          }
          if (lastTotalValue > 0) {
              uint256 maxAllowed = lastTotalValue * (100 + MAX_DEVIATION) / 100;
              uint256 minAllowed = lastTotalValue * (100 - MAX_DEVIATION) / 100;
              require(currentValue >= minAllowed && currentValue <= maxAllowed, "Price deviation");
          }
          if (block.number > lastUpdateBlock + 100) {
              lastTotalValue = currentValue;
              lastUpdateBlock = block.number;
          }
      }
    security_function: "BENIGN"
    rationale: "FIX - Validates current value is within 5% of stored value, prevents flashloan manipulation."

  - id: "CA_FIX4"
    type: "CTRL_FLOW"
    lines: [112]
    code: "_checkPriceDeviation(total0, total1);"
    security_function: "BENIGN"
    rationale: "FIX - Price check before withdrawal calculation."

  # ============================================
  # BENIGN CODE ACTS
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    lines: [36, 37, 38, 40, 41, 43, 44, 45, 46, 47, 49, 50]
    code: "State variables and Position struct"
    security_function: "BENIGN"
    rationale: "Token, pool, and position declarations."

  - id: "CA2"
    type: "EXT_CALL"
    lines: [62, 63]
    code: |
      uint256 total0 = token0.balanceOf(address(this));
      uint256 total1 = token1.balanceOf(address(this));
    security_function: "BENIGN"
    rationale: "Balance reads for deposit - now protected by price check."

  - id: "CA3"
    type: "EXT_CALL"
    lines: [67, 68]
    code: |
      token0.transferFrom(msg.sender, address(this), deposit0);
      token1.transferFrom(msg.sender, address(this), deposit1);
    security_function: "BENIGN"
    rationale: "Token transfers from depositor."

  - id: "CA4"
    type: "COMPUTATION"
    lines: [70, 71, 72, 73, 74, 76, 77]
    code: "Share calculation branches"
    security_function: "BENIGN"
    rationale: "Share calculation - now protected by price check."

  - id: "CA5"
    type: "STATE_MOD"
    lines: [79, 80, 82, 83]
    code: |
      balanceOf[to] += shares;
      totalSupply += shares;
      _addLiquidity(deposit0, deposit1);
      }
    security_function: "BENIGN"
    rationale: "State updates and liquidity addition."

  - id: "CA6"
    type: "INPUT_VAL"
    lines: [107]
    code: 'require(balanceOf[msg.sender] >= shares, "Insufficient balance");'
    security_function: "BENIGN"
    rationale: "Balance check in withdraw."

  - id: "CA7"
    type: "EXT_CALL"
    lines: [109, 110]
    code: |
      uint256 total0 = token0.balanceOf(address(this));
      uint256 total1 = token1.balanceOf(address(this));
    security_function: "BENIGN"
    rationale: "Balance reads in withdraw - now protected by price check."

  - id: "CA8"
    type: "COMPUTATION"
    lines: [114, 115]
    code: |
      amount0 = (shares * total0) / totalSupply;
      amount1 = (shares * total1) / totalSupply;
    security_function: "BENIGN"
    rationale: "Withdrawal calculation - now protected by price check."

  - id: "CA9"
    type: "STATE_MOD"
    lines: [117, 118]
    code: |
      balanceOf[msg.sender] -= shares;
      totalSupply -= shares;
    security_function: "BENIGN"
    rationale: "State updates for burned shares."

  - id: "CA10"
    type: "EXT_CALL"
    lines: [120, 121, 122]
    code: |
      token0.transfer(to, amount0);
      token1.transfer(to, amount1);
      }
    security_function: "BENIGN"
    rationale: "Token transfers to withdrawer."

  - id: "CA11"
    type: "CTRL_FLOW"
    lines: [124, 125, 127, 128, 129, 130, 131]
    code: "Rebalance function"
    security_function: "BENIGN"
    rationale: "Rebalance operations."

  - id: "CA12"
    type: "CTRL_FLOW"
    lines: [133, 135, 136]
    code: "Internal helper stubs"
    security_function: "BENIGN"
    rationale: "Internal liquidity functions."

  # ============================================
  # BATCHED UNRELATED CODE ACTS
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [52]
    security_function: "UNRELATED"
    rationale: "Comment about price protection"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 7, 8, 9, 10, 11, 13, 15, 18, 19, 20, 21, 22, 23, 24, 25, 27, 28, 29, 30, 31, 32, 33, 35, 57, 58, 59, 60, 61, 103, 104, 105, 106]
    security_function: "UNRELATED"
    rationale: "Interface, contract, and function signature declarations"

summary:
  total_code_acts_fixed: 17

  fix_applied:
    type: "price_protection"
    description: "Added price deviation check function"
    lines_changed: [53, 54, 55, 65, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 112]

  by_security_function_fixed:
    BENIGN: 14
    UNRELATED: 3

line_to_code_act_fixed:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  # Line 6: empty
  7: "CA_DECLARATIONS"
  8: "CA_DECLARATIONS"
  9: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  # Line 12: empty
  13: "CA_DECLARATIONS"
  # Line 14: empty
  15: "CA_DECLARATIONS"
  # Line 16: empty
  # Line 17: empty
  18: "CA_DECLARATIONS"
  19: "CA_DECLARATIONS"
  20: "CA_DECLARATIONS"
  21: "CA_DECLARATIONS"
  22: "CA_DECLARATIONS"
  23: "CA_DECLARATIONS"
  24: "CA_DECLARATIONS"
  25: "CA_DECLARATIONS"
  # Line 26: empty
  27: "CA_DECLARATIONS"
  28: "CA_DECLARATIONS"
  29: "CA_DECLARATIONS"
  30: "CA_DECLARATIONS"
  31: "CA_DECLARATIONS"
  32: "CA_DECLARATIONS"
  33: "CA_DECLARATIONS"
  # Line 34: empty
  35: "CA_DECLARATIONS"
  36: "CA1"
  37: "CA1"
  38: "CA1"
  # Line 39: empty
  40: "CA1"
  41: "CA1"
  # Line 42: empty
  43: "CA1"
  44: "CA1"
  45: "CA1"
  46: "CA1"
  47: "CA1"
  # Line 48: empty
  49: "CA1"
  50: "CA1"
  # Line 51: empty
  52: "CA_COMMENTS"
  53: "CA_FIX1"
  54: "CA_FIX1"
  55: "CA_FIX1"
  # Line 56: empty
  57: "CA_DECLARATIONS"
  58: "CA_DECLARATIONS"
  59: "CA_DECLARATIONS"
  60: "CA_DECLARATIONS"
  61: "CA_DECLARATIONS"
  62: "CA2"
  63: "CA2"
  # Line 64: empty
  65: "CA_FIX2"
  # Line 66: empty
  67: "CA3"
  68: "CA3"
  # Line 69: empty
  70: "CA4"
  71: "CA4"
  72: "CA4"
  73: "CA4"
  74: "CA4"
  # Line 75: empty
  76: "CA4"
  77: "CA4"
  # Line 78: empty
  79: "CA5"
  80: "CA5"
  # Line 81: empty
  82: "CA5"
  83: "CA5"
  # Line 84: empty
  85: "CA_FIX3"
  86: "CA_FIX3"
  87: "CA_FIX3"
  88: "CA_FIX3"
  89: "CA_FIX3"
  90: "CA_FIX3"
  91: "CA_FIX3"
  92: "CA_FIX3"
  93: "CA_FIX3"
  94: "CA_FIX3"
  95: "CA_FIX3"
  96: "CA_FIX3"
  97: "CA_FIX3"
  98: "CA_FIX3"
  99: "CA_FIX3"
  100: "CA_FIX3"
  101: "CA_FIX3"
  # Line 102: empty
  103: "CA_DECLARATIONS"
  104: "CA_DECLARATIONS"
  105: "CA_DECLARATIONS"
  106: "CA_DECLARATIONS"
  107: "CA6"
  # Line 108: empty
  109: "CA7"
  110: "CA7"
  # Line 111: empty
  112: "CA_FIX4"
  # Line 113: empty
  114: "CA8"
  115: "CA8"
  # Line 116: empty
  117: "CA9"
  118: "CA9"
  # Line 119: empty
  120: "CA10"
  121: "CA10"
  122: "CA10"
  # Line 123: empty
  124: "CA11"
  125: "CA11"
  # Line 126: empty
  127: "CA11"
  128: "CA11"
  129: "CA11"
  130: "CA11"
  131: "CA11"
  # Line 132: empty
  133: "CA12"
  # Line 134: empty
  135: "CA12"
  136: "CA12"
  # Line 137: empty

code_act_security_functions_fixed:
  CA_FIX1: "BENIGN"
  CA_FIX2: "BENIGN"
  CA_FIX3: "BENIGN"
  CA_FIX4: "BENIGN"
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"

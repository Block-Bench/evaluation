schema_version: "1.0"
sample_id: "df_tc_003"
base_sample_id: "ms_tc_003"
vulnerability_type: "access_control"
vulnerability_subtype: "unprotected_initialization_delegatecall"
is_vulnerable: false

# Differential annotation tracks Security Function transitions from vulnerable to fixed version.
# This file documents how ROOT_CAUSE elements became BENIGN after the fix.

vulnerability_summary:
  type: "access_control"
  severity: "critical"
  affected_functions: ["initWallet", "kill"]
  root_cause_summary: "initWallet() had no initialization guard, allowing anyone to become owner. kill() had no initialization requirement, allowing selfdestruct on uninitialized library."
  fix_summary: "Added require(!initialized) in initWallet() and require(initialized) in kill() to prevent unauthorized takeover and destruction."

code_acts:

  # ============================================
  # TRANSITIONED CODE ACTS (ROOT_CAUSE -> BENIGN)
  # ============================================

  - id: "CA1"
    type: "ACCESS_CTRL"
    description: "initWallet public function entry"

    vulnerable:
      file: "ms_tc_003.sol"
      function: "initWallet"
      line: 20
      code: ") public {"
      security_function: "ROOT_CAUSE"
      rationale: "No initialization guard - anyone can call to become owner"

    fixed:
      file: "df_tc_003.sol"
      function: "initWallet"
      line: 31
      code: ") public {"
      security_function: "BENIGN"
      rationale: "Now protected by require(!initialized) at line 32"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Added initialization guard prevents re-initialization"

  - id: "CA2"
    type: "FUND_XFER"
    description: "selfdestruct in kill()"

    vulnerable:
      file: "ms_tc_003.sol"
      function: "kill"
      line: 62
      code: "selfdestruct(_to);"
      security_function: "ROOT_CAUSE"
      rationale: "Destroys library, freezing all proxy wallets"

    fixed:
      file: "df_tc_003.sol"
      function: "kill"
      line: 74
      code: "selfdestruct(_to);"
      security_function: "BENIGN"
      rationale: "Now protected by both isOwner check AND require(initialized) - prevents unauthorized destruction"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Added require(initialized) ensures only properly initialized libraries can be killed"

  # ============================================
  # NEW CODE ACTS (fix additions)
  # ============================================

  - id: "CA_FIX1"
    type: "INPUT_VAL"
    description: "Initialization guard (NEW)"

    fixed:
      file: "df_tc_003.sol"
      function: "initWallet"
      line: 32
      code: 'require(!initialized, "Already initialized");'
      security_function: "BENIGN"
      rationale: "NEW FIX: Prevents re-initialization of the library. Only one initialization allowed."

    transition: "NEW -> BENIGN"
    transition_reason: "Added as fix for unprotected initialization"

  - id: "CA_FIX3"
    type: "INPUT_VAL"
    description: "Initialized check in kill() (NEW)"

    fixed:
      file: "df_tc_003.sol"
      function: "kill"
      line: 70
      code: 'require(initialized, "Not initialized");'
      security_function: "BENIGN"
      rationale: "NEW FIX: Ensures kill() can only be called on properly initialized library. Prevents destruction of uninitialized shared library."

    transition: "NEW -> BENIGN"
    transition_reason: "Added as fix to require proper initialization before destruction"

  # ============================================
  # TRANSITIONED (INSUFF_GUARD -> BENIGN)
  # ============================================

  - id: "CA5"
    type: "INPUT_VAL"
    description: "Owner check in kill()"

    vulnerable:
      file: "ms_tc_003.sol"
      function: "kill"
      line: 57
      code: 'require(isOwner[msg.sender], "Not an owner");'
      security_function: "INSUFF_GUARD"
      rationale: "Bypassable via unprotected initWallet"

    fixed:
      file: "df_tc_003.sol"
      function: "kill"
      line: 69
      code: 'require(isOwner[msg.sender], "Not an owner");'
      security_function: "BENIGN"
      rationale: "Now effective because initWallet is protected"

    transition: "INSUFF_GUARD -> BENIGN"
    transition_reason: "Guard becomes effective once initialization is protected"

  # ============================================
  # TRANSITIONED (PREREQ -> BENIGN)
  # ============================================

  - id: "CA3"
    type: "STATE_MOD"
    description: "Setting initialized flag"

    vulnerable:
      file: "ms_tc_003.sol"
      function: "initWallet"
      line: 44
      code: "initialized = true;"
      security_function: "PREREQ"
      rationale: "Set after ownership granted, no guard check"

    fixed:
      file: "df_tc_003.sol"
      function: "initWallet"
      line: 33
      code: "initialized = true;"
      security_function: "BENIGN"
      rationale: "Now set immediately after require(!initialized) check"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Moved to immediately after check, preventing exploitation"
    note: "This line moved from 44 to 33 in fixed version"

  - id: "CA4"
    type: "STATE_MOD"
    description: "Granting owner status"

    vulnerable:
      file: "ms_tc_003.sol"
      function: "initWallet"
      line: 38
      code: "isOwner[owner] = true;"
      security_function: "PREREQ"
      rationale: "Enables attacker to become owner"

    fixed:
      file: "df_tc_003.sol"
      function: "initWallet"
      line: 47
      code: "isOwner[owner] = true;"
      security_function: "BENIGN"
      rationale: "No longer exploitable - initialization is protected"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Protected by initialization guard"

  # ============================================
  # UNCHANGED CODE ACTS (BENIGN -> BENIGN)
  # ============================================

  - id: "CA6"
    type: "STATE_MOD"
    description: "Clear owner status in loop"

    vulnerable:
      file: "ms_tc_003.sol"
      function: "initWallet"
      line: 28
      security_function: "BENIGN"

    fixed:
      file: "df_tc_003.sol"
      function: "initWallet"
      line: 37
      security_function: "BENIGN"

    transition: "BENIGN -> BENIGN"

  - id: "CA7"
    type: "STATE_MOD"
    description: "Delete owners array"

    vulnerable:
      file: "ms_tc_003.sol"
      function: "initWallet"
      line: 30
      security_function: "BENIGN"

    fixed:
      file: "df_tc_003.sol"
      function: "initWallet"
      line: 39
      security_function: "BENIGN"

    transition: "BENIGN -> BENIGN"

  - id: "CA8"
    type: "INPUT_VAL"
    description: "Zero address check"

    vulnerable:
      file: "ms_tc_003.sol"
      function: "initWallet"
      line: 35
      security_function: "BENIGN"

    fixed:
      file: "df_tc_003.sol"
      function: "initWallet"
      line: 44
      security_function: "BENIGN"

    transition: "BENIGN -> BENIGN"

  - id: "CA9"
    type: "INPUT_VAL"
    description: "Duplicate owner check"

    vulnerable:
      file: "ms_tc_003.sol"
      function: "initWallet"
      line: 36
      security_function: "BENIGN"

    fixed:
      file: "df_tc_003.sol"
      function: "initWallet"
      line: 45
      security_function: "BENIGN"

    transition: "BENIGN -> BENIGN"

  - id: "CA12"
    type: "STATE_MOD"
    description: "Set required signatures"

    vulnerable:
      file: "ms_tc_003.sol"
      function: "initWallet"
      line: 43
      security_function: "BENIGN"

    fixed:
      file: "df_tc_003.sol"
      function: "initWallet"
      line: 52
      security_function: "BENIGN"

    transition: "BENIGN -> BENIGN"

  - id: "CA13"
    type: "EVENT_EMIT"
    description: "WalletDestroyed event"

    vulnerable:
      file: "ms_tc_003.sol"
      function: "kill"
      line: 59
      security_function: "BENIGN"

    fixed:
      file: "df_tc_003.sol"
      function: "kill"
      line: 72
      security_function: "BENIGN"

    transition: "BENIGN -> BENIGN"

  - id: "CA19"
    type: "DELEGATE"
    description: "Delegatecall in proxy"

    vulnerable:
      file: "ms_tc_003.sol"
      function: "fallback"
      line: 98
      security_function: "BENIGN"

    fixed:
      file: "df_tc_003.sol"
      function: "fallback"
      line: 107
      security_function: "BENIGN"

    transition: "BENIGN -> BENIGN"

summary:
  total_code_acts: 14

  transitions:
    ROOT_CAUSE_to_BENIGN: 2   # CA1, CA2
    PREREQ_to_BENIGN: 2       # CA3, CA4
    INSUFF_GUARD_to_BENIGN: 1 # CA5
    BENIGN_to_BENIGN: 7       # CA6, CA7, CA8, CA9, CA12, CA13, CA19
    NEW_to_BENIGN: 2          # CA_FIX1, CA_FIX3

  by_security_function_vulnerable:
    ROOT_CAUSE: 2
    PREREQ: 2
    INSUFF_GUARD: 1
    BENIGN: 7

  by_security_function_fixed:
    BENIGN: 14  # All become BENIGN after fix

  fix_effectiveness:
    documented_vuln_fixed: true
    notes: "Both attack vectors addressed: initialization guard prevents takeover, initialized requirement in kill() prevents unauthorized destruction."

  root_cause_fixes:
    - id: "CA1"
      fix_type: "initialization_guard"
      description: "initWallet now protected by require(!initialized)"
    - id: "CA2"
      fix_type: "initialized_requirement"
      description: "kill() now requires initialized=true"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================
# Maps line numbers to code acts for the fixed version.
# Scoring: lookup line -> code_act -> security_function

line_to_code_act_fixed:
  # initWallet() function
  31: "CA1"        # function entry point (BENIGN)
  32: "CA_FIX1"    # initialization guard (NEW)
  33: "CA3"        # initialized=true (moved from line 44)
  37: "CA6"        # clear owner status
  39: "CA7"        # delete owners
  44: "CA8"        # zero check
  45: "CA9"        # duplicate check
  47: "CA4"        # grant owner
  52: "CA12"       # set required
  # kill() function
  69: "CA5"        # owner check
  70: "CA_FIX3"    # initialized check (NEW)
  72: "CA13"       # emit event
  74: "CA2"        # selfdestruct
  # Proxy
  107: "CA19"      # delegatecall

code_act_security_functions_fixed:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA12: "BENIGN"
  CA13: "BENIGN"
  CA19: "BENIGN"
  CA_FIX1: "BENIGN"
  CA_FIX3: "BENIGN"

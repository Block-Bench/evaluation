schema_version: "1.0"
sample_id: "df_tc_007"
base_sample_id: "ms_tc_007"
vulnerability_type: "arithmetic_error"
vulnerability_subtype: "precision_loss_liquidity_calculation"
is_vulnerable: false

# Differential annotation tracks Security Function transitions from vulnerable to fixed version.

vulnerability_summary:
  type: "arithmetic_error"
  severity: "critical"
  affected_functions: ["swap", "_addLiquidity"]
  root_cause_summary: "In ms_tc_007, _addLiquidity() performed unchecked arithmetic that could overflow/underflow. Attacker crafted inputs to cause arithmetic errors during tick transitions."
  fix_summary: "Added explicit overflow/underflow require checks in _addLiquidity() before arithmetic operations."

code_acts:

  # ============================================
  # TRANSITIONED CODE ACTS (ROOT_CAUSE -> BENIGN)
  # ============================================

  - id: "CA22"
    type: "EXT_CALL"
    description: "_addLiquidity call during tick crossing"

    vulnerable:
      file: "ms_tc_007.sol"
      function: "swap"
      lines: [128, 129, 130, 131]
      code: "liquidityNext = _addLiquidity(liquidityNext, liquidityNetAtTick);"
      security_function: "ROOT_CAUSE"
      rationale: "Calls vulnerable _addLiquidity with crafted inputs"

    fixed:
      file: "df_tc_007.sol"
      function: "swap"
      lines: [136, 137, 138, 139]
      code: "liquidityNext = _addLiquidity(liquidityNext, liquidityNetAtTick);"
      security_function: "BENIGN"
      rationale: "_addLiquidity now has overflow/underflow checks"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Called function now validates inputs"

  - id: "CA29"
    type: "COMPUTATION"
    description: "Subtraction in _addLiquidity (y < 0 case)"

    vulnerable:
      file: "ms_tc_007.sol"
      function: "_addLiquidity"
      line: 157
      code: "z = x - uint128(-y);"
      security_function: "ROOT_CAUSE"
      rationale: "Unchecked subtraction can underflow"

    fixed:
      file: "df_tc_007.sol"
      function: "_addLiquidity"
      line: 169
      code: "z = x - uint128(-y);"
      security_function: "BENIGN"
      rationale: "Protected by require(x >= uint128(-y)) at line 168"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Underflow check added before subtraction"

  - id: "CA30"
    type: "COMPUTATION"
    description: "Addition in _addLiquidity (y >= 0 case)"

    vulnerable:
      file: "ms_tc_007.sol"
      function: "_addLiquidity"
      line: 159
      code: "z = x + uint128(y);"
      security_function: "ROOT_CAUSE"
      rationale: "Unchecked addition can overflow"

    fixed:
      file: "df_tc_007.sol"
      function: "_addLiquidity"
      line: 172
      code: "z = x + uint128(y);"
      security_function: "BENIGN"
      rationale: "Protected by require(x + uint128(y) >= x) at line 171"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Overflow check added before addition"

  # ============================================
  # NEW CODE ACTS (fix additions)
  # ============================================

  - id: "CA_FIX1"
    type: "INPUT_VAL"
    description: "Underflow check (NEW)"

    fixed:
      file: "df_tc_007.sol"
      function: "_addLiquidity"
      line: 168
      code: 'require(x >= uint128(-y), "Underflow");'
      security_function: "BENIGN"
      rationale: "NEW FIX: Prevents underflow in subtraction"

    transition: "NEW -> BENIGN"
    transition_reason: "Added as fix for unchecked subtraction"

  - id: "CA_FIX2"
    type: "INPUT_VAL"
    description: "Overflow check (NEW)"

    fixed:
      file: "df_tc_007.sol"
      function: "_addLiquidity"
      line: 171
      code: 'require(x + uint128(y) >= x, "Overflow");'
      security_function: "BENIGN"
      rationale: "NEW FIX: Prevents overflow in addition"

    transition: "NEW -> BENIGN"
    transition_reason: "Added as fix for unchecked addition"

  # ============================================
  # TRANSITIONED (PREREQ -> BENIGN)
  # ============================================

  - id: "CA2"
    type: "DECLARATION"
    description: "Pool state variables"

    vulnerable:
      file: "ms_tc_007.sol"
      lines: [10, 11, 12]
      security_function: "PREREQ"
      rationale: "State becomes corrupted through precision loss"

    fixed:
      file: "df_tc_007.sol"
      lines: [15, 16, 17]
      security_function: "BENIGN"
      rationale: "State protected by arithmetic checks"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Checks prevent state corruption"

  - id: "CA3"
    type: "DECLARATION"
    description: "liquidityNet mapping"

    vulnerable:
      file: "ms_tc_007.sol"
      line: 15
      security_function: "PREREQ"
      rationale: "Values can be manipulated to trigger errors"

    fixed:
      file: "df_tc_007.sol"
      line: 20
      security_function: "BENIGN"
      rationale: "Values validated before use"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Checks protect against manipulation"

  - id: "CA25"
    type: "STATE_MOD"
    description: "State persistence after swap"

    vulnerable:
      file: "ms_tc_007.sol"
      lines: [145, 146, 147]
      security_function: "PREREQ"
      rationale: "Persists corrupted liquidity value"

    fixed:
      file: "df_tc_007.sol"
      lines: [153, 154, 155]
      security_function: "BENIGN"
      rationale: "Liquidity value is now validated"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Only validated values are persisted"

  - id: "CA28"
    type: "CTRL_FLOW"
    description: "if (y < 0) branch"

    vulnerable:
      file: "ms_tc_007.sol"
      line: 156
      security_function: "PREREQ"
      rationale: "Determines which arithmetic path is used"

    fixed:
      file: "df_tc_007.sol"
      line: 167
      security_function: "BENIGN"
      rationale: "Both paths now have checks"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Both arithmetic paths are protected"

  # ============================================
  # UNCHANGED CODE ACTS (BENIGN -> BENIGN)
  # ============================================

  - id: "CA6"
    type: "INPUT_VAL"
    description: "Tick validation in addLiquidity"
    vulnerable:
      file: "ms_tc_007.sol"
      lines: [54, 55]
      security_function: "BENIGN"
    fixed:
      file: "df_tc_007.sol"
      lines: [57, 58]
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA13"
    type: "INPUT_VAL"
    description: "Zero amount check in swap"
    vulnerable:
      file: "ms_tc_007.sol"
      line: 93
      security_function: "BENIGN"
    fixed:
      file: "df_tc_007.sol"
      line: 102
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

  - id: "CA27"
    type: "DECLARATION"
    description: "_addLiquidity function signature"
    vulnerable:
      file: "ms_tc_007.sol"
      lines: [152, 153, 154, 155]
      security_function: "BENIGN"
    fixed:
      file: "df_tc_007.sol"
      lines: [163, 164, 165, 166]
      security_function: "BENIGN"
    transition: "BENIGN -> BENIGN"

summary:
  total_code_acts: 13

  transitions:
    ROOT_CAUSE_to_BENIGN: 3   # CA22, CA29, CA30
    PREREQ_to_BENIGN: 4       # CA2, CA3, CA25, CA28
    BENIGN_to_BENIGN: 4       # CA6, CA13, CA27, and function sig
    NEW_to_BENIGN: 2          # CA_FIX1, CA_FIX2

  by_security_function_vulnerable:
    ROOT_CAUSE: 3
    PREREQ: 4
    BENIGN: 4

  by_security_function_fixed:
    BENIGN: 13  # All become BENIGN after fix

  fix_effectiveness:
    documented_vuln_fixed: true
    notes: "Explicit overflow/underflow checks in _addLiquidity() prevent arithmetic errors that were exploited. require() statements revert transaction if bounds violated."

  root_cause_fixes:
    - id: "CA22"
      fix_type: "input_validation"
      description: "Called function now validates inputs"
    - id: "CA29"
      fix_type: "underflow_check"
      description: "require(x >= uint128(-y)) before subtraction"
    - id: "CA30"
      fix_type: "overflow_check"
      description: "require(x + uint128(y) >= x) before addition"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================

line_to_code_act_fixed:
  # State variables
  15: "CA2"
  16: "CA2"
  17: "CA2"
  20: "CA3"
  # addLiquidity
  57: "CA6"
  58: "CA6"
  # swap
  102: "CA13"
  # _addLiquidity call
  136: "CA22"
  137: "CA22"
  138: "CA22"
  139: "CA22"
  # State update
  153: "CA25"
  154: "CA25"
  155: "CA25"
  # _addLiquidity function
  163: "CA27"
  164: "CA27"
  165: "CA27"
  166: "CA27"
  167: "CA28"
  168: "CA_FIX1"
  169: "CA29"
  171: "CA_FIX2"
  172: "CA30"

code_act_security_functions_fixed:
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA6: "BENIGN"
  CA13: "BENIGN"
  CA22: "BENIGN"
  CA25: "BENIGN"
  CA27: "BENIGN"
  CA28: "BENIGN"
  CA29: "BENIGN"
  CA30: "BENIGN"
  CA_FIX1: "BENIGN"
  CA_FIX2: "BENIGN"

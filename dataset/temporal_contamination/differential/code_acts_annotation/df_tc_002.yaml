schema_version: "1.0"
sample_id: "df_tc_002"
base_sample_id: "ms_tc_002"
vulnerability_type: "governance_attack"
vulnerability_subtype: "flash_loan_voting"
is_vulnerable: false

# Differential annotation tracks Security Function transitions from vulnerable to fixed version.
# This file documents how ROOT_CAUSE elements became BENIGN after the fix.

vulnerability_summary:
  type: "governance_attack"
  severity: "critical"
  affected_functions: ["deposit", "emergencyCommit"]
  root_cause_summary: "Instant voting power from deposits with no holding period, combined with no timelock on proposal execution"
  fix_summary: "Added MIN_HOLDING_PERIOD (1 day) check in deposit() and TIMELOCK_DELAY (1 day) check in emergencyCommit()"

code_acts:

  # ============================================
  # TRANSITIONED CODE ACTS (ROOT_CAUSE -> BENIGN)
  # ============================================

  - id: "CA1"
    type: "STATE_MOD"
    description: "Voting power grant in deposit()"

    vulnerable:
      file: "ms_tc_002.sol"
      function: "deposit"
      line: 55
      code: "votingPower[msg.sender] += amount;"
      security_function: "ROOT_CAUSE"
      rationale: "Instant voting power with no holding period enables flash loan attacks"

    fixed:
      file: "df_tc_002.sol"
      function: "deposit"
      line: 60
      code: "votingPower[msg.sender] += amount;"
      security_function: "BENIGN"
      rationale: "Now protected by holding period check at line 58"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Added require(block.timestamp - lastDeposit[msg.sender] >= MIN_HOLDING_PERIOD) check"

  - id: "CA2"
    type: "STATE_MOD"
    description: "Total voting power update"

    vulnerable:
      file: "ms_tc_002.sol"
      function: "deposit"
      line: 56
      code: "totalVotingPower += amount;"
      security_function: "ROOT_CAUSE"
      rationale: "Immediate total power update enables same-block manipulation"

    fixed:
      file: "df_tc_002.sol"
      function: "deposit"
      line: 61
      code: "totalVotingPower += amount;"
      security_function: "BENIGN"
      rationale: "Protected by holding period - attacker cannot deposit and vote in same block"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Holding period prevents flash loan deposits from counting immediately"

  - id: "CA4"
    type: "COMPUTATION"
    description: "Vote percentage calculation"

    vulnerable:
      file: "ms_tc_002.sol"
      function: "emergencyCommit"
      line: 101
      code: "uint256 votePercentage = (prop.forVotes * 100) / totalVotingPower;"
      security_function: "ROOT_CAUSE"
      rationale: "Uses current totalVotingPower with no snapshot, enabling manipulation"

    fixed:
      file: "df_tc_002.sol"
      function: "emergencyCommit"
      line: 116
      code: "uint256 votePercentage = (prop.forVotes * 100) / totalVotingPower;"
      security_function: "BENIGN"
      rationale: "Now safe because voters must hold tokens for MIN_HOLDING_PERIOD before voting power is granted"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Holding period prevents flash loan manipulation of voting power"

  - id: "CA5"
    type: "INPUT_VAL"
    description: "Threshold check"

    vulnerable:
      file: "ms_tc_002.sol"
      function: "emergencyCommit"
      line: 102
      code: 'require(votePercentage >= EMERGENCY_THRESHOLD, "Insufficient votes");'
      security_function: "ROOT_CAUSE"
      rationale: "No timelock - proposal can execute immediately after reaching threshold"

    fixed:
      file: "df_tc_002.sol"
      function: "emergencyCommit"
      line: 117
      code: 'require(votePercentage >= EMERGENCY_THRESHOLD, "Insufficient votes");'
      security_function: "BENIGN"
      rationale: "Now protected by timelock check at line 114"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Added timelock delay check before this threshold check"

  - id: "CA6"
    type: "EXT_CALL"
    description: "Proposal execution call"

    vulnerable:
      file: "ms_tc_002.sol"
      function: "emergencyCommit"
      line: 107
      code: "(bool success, ) = prop.target.call(prop.data);"
      security_function: "ROOT_CAUSE"
      rationale: "Executes immediately after threshold reached, no time for community review"

    fixed:
      file: "df_tc_002.sol"
      function: "emergencyCommit"
      line: 122
      code: "(bool success, ) = prop.target.call(prop.data);"
      security_function: "BENIGN"
      rationale: "Protected by TIMELOCK_DELAY - community has time to review and respond"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Timelock delay ensures minimum waiting period before execution"

  # ============================================
  # NEW CODE ACTS (fix additions)
  # ============================================

  - id: "CA_FIX1"
    type: "INPUT_VAL"
    description: "Holding period check (NEW)"

    fixed:
      file: "df_tc_002.sol"
      function: "deposit"
      line: 58
      code: 'require(block.timestamp - lastDeposit[msg.sender] >= MIN_HOLDING_PERIOD, "Holding period not met");'
      security_function: "BENIGN"
      rationale: "NEW FIX: Prevents flash loan attacks by requiring tokens be held for 1 day before granting voting power"

    transition: "NEW -> BENIGN"
    transition_reason: "Added as fix for flash loan vulnerability"

  - id: "CA_FIX2"
    type: "STATE_MOD"
    description: "Last deposit timestamp tracking (NEW)"

    fixed:
      file: "df_tc_002.sol"
      function: "deposit"
      line: 62
      code: "lastDeposit[msg.sender] = block.timestamp;"
      security_function: "BENIGN"
      rationale: "NEW FIX: Records deposit timestamp for holding period enforcement"

    transition: "NEW -> BENIGN"
    transition_reason: "Added to track deposit times"

  - id: "CA_FIX3"
    type: "INPUT_VAL"
    description: "Timelock delay check (NEW)"

    fixed:
      file: "df_tc_002.sol"
      function: "emergencyCommit"
      line: 114
      code: 'require(block.timestamp >= prop.startTime + TIMELOCK_DELAY, "Timelock not expired");'
      security_function: "BENIGN"
      rationale: "NEW FIX: Requires 1 day delay between proposal creation and execution, giving community time to respond"

    transition: "NEW -> BENIGN"
    transition_reason: "Added as fix for immediate execution vulnerability"

  # ============================================
  # UNCHANGED CODE ACTS (BENIGN -> BENIGN)
  # ============================================

  - id: "CA7"
    type: "INPUT_VAL"
    description: "Already executed check"

    vulnerable:
      file: "ms_tc_002.sol"
      function: "emergencyCommit"
      line: 98
      code: 'require(!prop.executed, "Already executed");'
      security_function: "BENIGN"
      rationale: "Prevents double execution"

    fixed:
      file: "df_tc_002.sol"
      function: "emergencyCommit"
      line: 113
      code: 'require(!prop.executed, "Already executed");'
      security_function: "BENIGN"
      rationale: "Unchanged"

    transition: "BENIGN -> BENIGN"

  - id: "CA8"
    type: "STATE_MOD"
    description: "Mark proposal executed"

    vulnerable:
      file: "ms_tc_002.sol"
      function: "emergencyCommit"
      line: 104
      code: "prop.executed = true;"
      security_function: "BENIGN"
      rationale: "Correct CEI pattern"

    fixed:
      file: "df_tc_002.sol"
      function: "emergencyCommit"
      line: 119
      code: "prop.executed = true;"
      security_function: "BENIGN"
      rationale: "Unchanged"

    transition: "BENIGN -> BENIGN"

  - id: "CA9"
    type: "INPUT_VAL"
    description: "Execution success check"

    vulnerable:
      file: "ms_tc_002.sol"
      function: "emergencyCommit"
      line: 108
      code: 'require(success, "Execution failed");'
      security_function: "BENIGN"
      rationale: "Correct error handling"

    fixed:
      file: "df_tc_002.sol"
      function: "emergencyCommit"
      line: 123
      code: 'require(success, "Execution failed");'
      security_function: "BENIGN"
      rationale: "Unchanged"

    transition: "BENIGN -> BENIGN"

  - id: "CA10"
    type: "EVENT_EMIT"
    description: "ProposalExecuted event"

    vulnerable:
      file: "ms_tc_002.sol"
      function: "emergencyCommit"
      line: 110
      code: "emit ProposalExecuted(proposalId);"
      security_function: "BENIGN"
      rationale: "Logging"

    fixed:
      file: "df_tc_002.sol"
      function: "emergencyCommit"
      line: 125
      code: "emit ProposalExecuted(proposalId);"
      security_function: "BENIGN"
      rationale: "Unchanged"

    transition: "BENIGN -> BENIGN"

  # ============================================
  # TRANSITIONED (PREREQ -> BENIGN)
  # ============================================

  - id: "CA3"
    type: "STATE_MOD"
    description: "Balance tracking"

    vulnerable:
      file: "ms_tc_002.sol"
      function: "deposit"
      line: 54
      code: "depositedBalance[msg.sender] += amount;"
      security_function: "PREREQ"
      rationale: "Enables deposit flow"

    fixed:
      file: "df_tc_002.sol"
      function: "deposit"
      line: 59
      code: "depositedBalance[msg.sender] += amount;"
      security_function: "BENIGN"
      rationale: "No longer a prerequisite since flash loans blocked by holding period"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Holding period prevents exploitation of deposit mechanism"

summary:
  total_code_acts: 14

  transitions:
    ROOT_CAUSE_to_BENIGN: 5  # CA1, CA2, CA4, CA5, CA6
    PREREQ_to_BENIGN: 1      # CA3
    BENIGN_to_BENIGN: 4      # CA7, CA8, CA9, CA10
    NEW_to_BENIGN: 3         # CA_FIX1, CA_FIX2, CA_FIX3

  by_security_function_vulnerable:
    ROOT_CAUSE: 5
    PREREQ: 1
    BENIGN: 4

  by_security_function_fixed:
    BENIGN: 14  # All become BENIGN after fix

  fix_effectiveness:
    documented_vuln_fixed: true
    secondary_vuln_fixed: true
    notes: "Both flash loan attack vectors addressed: holding period prevents instant voting power, timelock prevents immediate execution."

  root_cause_fixes:
    - id: "CA1"
      fix_type: "holding_period"
      description: "votingPower now only granted after MIN_HOLDING_PERIOD"
    - id: "CA2"
      fix_type: "holding_period"
      description: "totalVotingPower protected by same holding period"
    - id: "CA4"
      fix_type: "timelock"
      description: "Vote calculation now happens after mandatory delay"
    - id: "CA5"
      fix_type: "timelock"
      description: "Threshold check protected by TIMELOCK_DELAY"
    - id: "CA6"
      fix_type: "timelock"
      description: "Execution delayed by TIMELOCK_DELAY"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================
# Maps line numbers to code acts for the fixed version.
# Scoring: lookup line -> code_act -> security_function
#
# NOTE: Differential annotations only map security-relevant code acts.
# UNRELATED items (comments, directives, syntax) are not tracked because:
# 1. They don't transition - remain UNRELATED in both versions
# 2. Differential evaluates fix recognition, not hallucination detection
# 3. Full coverage is handled by minimalsanitized annotations

line_to_code_act_fixed:
  # deposit() function
  58: "CA_FIX1"    # holding period check (NEW)
  59: "CA3"        # balance tracking
  60: "CA1"        # voting power grant
  61: "CA2"        # total power update
  62: "CA_FIX2"    # last deposit timestamp (NEW)
  # emergencyCommit() function
  113: "CA7"       # already executed check
  114: "CA_FIX3"   # timelock check (NEW)
  116: "CA4"       # vote percentage calculation
  117: "CA5"       # threshold check
  119: "CA8"       # mark executed
  122: "CA6"       # external call
  123: "CA9"       # success check
  125: "CA10"      # event emission

code_act_security_functions_fixed:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA_FIX1: "BENIGN"
  CA_FIX2: "BENIGN"
  CA_FIX3: "BENIGN"

schema_version: "1.0"
sample_id: "tr_tc_004"
base_sample_id: "ms_tc_004"
vulnerability_type: "reentrancy"
is_vulnerable: true

# Trojan annotation documents INJECTED DECOY elements only.
# The base vulnerability is documented in ms_tc_005.yaml.
# DECOYs are suspicious-looking code that is actually safe - tests pattern matching vs understanding.

trojan_strategy: "config_and_metrics_distractors"
injection_count: 4

base_vulnerability:
  type: "reentrancy"
  function: "add_liquidity"
  vulnerable_lines: [75, 124]  # Line numbers in tr_tc_005.sol
  reference: "../../minimalsanitized/code_acts_annotation/ms_tc_004.yaml"

injections:

  # ============================================
  # DECOY 1: setConfigVersion without access control
  # ============================================

  - id: "INJ1"
    type: "ACCESS_CTRL"
    security_function: "DECOY"

    location:
      file: "tr_tc_004.sol"
      function: "setConfigVersion"
      lines: [169, 170, 171, 172]
    suspicious_because:
      - "External function with no access control modifier"
      - "Allows anyone to set configVersion"
      - "Name suggests configuration/admin functionality"
      - "Emits event suggesting important state change"

    safe_because:
      - "configVersion is only used for tracking/versioning"
      - "No security decisions depend on configVersion"
      - "Modifying it has no impact on liquidity or swaps"
      - "Purely informational state"

    safety_factors:
      - "Non-security-relevant variable"
      - "No financial impact"
      - "Not used in any require/assert checks"

    pattern_triggered: "access_control"
    proximity: "same_file"
    distraction_risk: "medium"

  # ============================================
  # DECOY 2: Unused reentrancy guard variables
  # ============================================

  - id: "INJ2"
    type: "REENTRY_GUARD"
    security_function: "DECOY"

    location:
      file: "tr_tc_004.sol"
      function: "contract-level"
      lines: []  # Lines 18-20 are mapped to CA3 (INSUFF_GUARD) - part of base vulnerability
    suspicious_because:
      - "Standard reentrancy guard pattern declared"
      - "Variables named like OpenZeppelin ReentrancyGuard"
      - "MIGHT suggest contract is protected when it's NOT"

    safe_because:
      - "These variables are NEVER used"
      - "The REAL vulnerability is that add_liquidity lacks the check"
      - "This is actually the CAUSE of the bug - declared but unused"

    safety_factors:
      - "Unused code"
      - "Actually part of the vulnerability pattern"

    pattern_triggered: "reentrancy_guard_declaration"
    proximity: "same_file"
    distraction_risk: "high"
    note: "Lines 18-20 are mapped to CA3 (INSUFF_GUARD) as part of base vulnerability, not as DECOY"

  # ============================================
  # DECOY 3: _recordPoolActivity looks like state modification after external call
  # ============================================

  - id: "INJ3"
    type: "STATE_MOD"
    security_function: "DECOY"

    location:
      file: "tr_tc_004.sol"
      function: "_recordPoolActivity"
      lines: [79, 115, 162, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206]
    suspicious_because:
      - "State modifications in internal function"
      - "Called AFTER external call in add_liquidity (line 79)"
      - "Looks like reentrancy-vulnerable pattern"
      - "Multiple state updates"

    safe_because:
      - "These variables are analytics/metrics only"
      - "userInteractionCount, poolActivityScore, lastLiquidityBlock have no security impact"
      - "Reentering would only manipulate analytics, not funds"
      - "The REAL issue is LP minting before external call, not analytics after"

    safety_factors:
      - "Non-security-relevant state variables"
      - "No financial impact from analytics manipulation"
      - "Bounded values prevent overflow exploitation"

    pattern_triggered: "reentrancy_state_mod"
    proximity: "same_function"
    distraction_risk: "medium"

  # ============================================
  # DECOY 4: Additional metrics state variables
  # ============================================

  - id: "INJ4"
    type: "DECLARATION"
    security_function: "DECOY"

    location:
      file: "tr_tc_004.sol"
      function: "contract-level"
      lines: [23, 24, 25, 26]
    suspicious_because:
      - "Additional state variables beyond core AMM logic"
      - "Public visibility might suggest security relevance"
      - "Could be misidentified as attack vectors"

    safe_because:
      - "All are purely informational/analytics"
      - "None affect LP calculations or swap amounts"
      - "No security decisions based on these values"

    safety_factors:
      - "Informational only"
      - "No impact on core protocol math"

    pattern_triggered: "suspicious_state"
    proximity: "same_file"
    distraction_risk: "low"

# ============================================
# BASE VULNERABILITY CODE ACTS (reference only)
# ============================================
# The real vulnerability in tr_tc_005 is the same as ms_tc_005:
# - CA1: External call in add_liquidity (line 75)
# - CA2: Low-level call in _handleETHTransfer (line 124)
# - CA3: Reentrancy guard declared but not used (lines 18-20) - INSUFF_GUARD
#
# See ms_tc_005.yaml for full vulnerability annotation.

summary:
  total_injections: 4

  injection_types:
    ACCESS_CTRL: 1    # INJ1
    REENTRY_GUARD: 1  # INJ2 (actually INSUFF_GUARD from base)
    STATE_MOD: 1      # INJ3
    DECLARATION: 1    # INJ4

  distraction_risk_breakdown:
    high: 1      # INJ2 (unused guard - misleading)
    medium: 2    # INJ1, INJ3
    low: 1       # INJ4

  proximity_breakdown:
    same_file: 3        # INJ1, INJ2, INJ4
    same_function: 1    # INJ3 (called from add_liquidity)

  patterns_triggered:
    access_control: 1         # INJ1
    reentrancy_guard: 1       # INJ2
    reentrancy_state_mod: 1   # INJ3
    suspicious_state: 1       # INJ4

  evaluation_notes:
    - "INJ2 is actually part of the vulnerability (INSUFF_GUARD), not a true DECOY"
    - "INJ1 tests access control pattern recognition - unprotected but non-critical"
    - "INJ3 tests reentrancy pattern - state mods after call, but only analytics"
    - "A model flagging INJ1/INJ3 demonstrates pattern matching over understanding"
    - "Correct analysis identifies lines 75/124 as ROOT_CAUSE, INJ2 as INSUFF_GUARD"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================

line_to_code_act:
  # === REAL VULNERABILITY CODE ACTS (from base ms_tc_005) ===
  # CA3: Reentrancy guard INSUFF_GUARD
  18: "CA3"
  19: "CA3"
  20: "CA3"
  # CA6: Input validation (BENIGN)
  56: "CA6"
  # CA7: LP calculation (BENIGN)
  58: "CA7"
  59: "CA7"
  60: "CA7"
  61: "CA7"
  62: "CA7"
  63: "CA7"
  64: "CA7"
  # CA8: Slippage check (BENIGN)
  66: "CA8"
  # CA4: Balance state mod before call (PREREQ)
  68: "CA4"
  69: "CA4"
  # CA5: LP minting before call (PREREQ)
  71: "CA5"
  72: "CA5"
  # CA9: Control flow to vulnerable call (PREREQ)
  74: "CA9"
  # CA1: External call - ROOT_CAUSE
  75: "CA1"
  76: "CA9"
  # CA2: Low-level call - ROOT_CAUSE
  124: "CA2"
  125: "CA18"
  # === INJECTED DECOY CODE ACTS ===
  # INJ1: setConfigVersion (DECOY)
  169: "INJ1"
  170: "INJ1"
  171: "INJ1"
  172: "INJ1"
  # INJ3: _recordPoolActivity call sites
  79: "INJ3"
  115: "INJ3"
  162: "INJ3"
  # INJ3: _recordPoolActivity body (DECOY)
  192: "INJ3"
  193: "INJ3"
  194: "INJ3"
  195: "INJ3"
  196: "INJ3"
  197: "INJ3"
  198: "INJ3"
  199: "INJ3"
  200: "INJ3"
  201: "INJ3"
  202: "INJ3"
  203: "INJ3"
  204: "INJ3"
  205: "INJ3"
  206: "INJ3"
  # INJ4: Analytics state variables (DECOY)
  23: "INJ4"
  24: "INJ4"
  25: "INJ4"
  26: "INJ4"

code_act_security_functions:
  # Real vulnerability code acts
  CA1: "ROOT_CAUSE"
  CA2: "ROOT_CAUSE"
  CA3: "INSUFF_GUARD"
  CA4: "PREREQ"
  CA5: "PREREQ"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "PREREQ"
  CA18: "BENIGN"
  # Injected decoys
  INJ1: "DECOY"
  INJ3: "DECOY"
  INJ4: "DECOY"

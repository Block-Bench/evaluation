schema_version: "1.0"
sample_id: "tr_tc_003"
base_sample_id: "ms_tc_003"
vulnerability_type: "access_control"
vulnerability_subtype: "unprotected_initialization_delegatecall"
is_vulnerable: true

# Trojan annotation documents INJECTED DECOY elements only.
# The base vulnerability is documented in ms_tc_003.yaml.
# DECOYs are suspicious-looking code that is actually safe - tests pattern matching vs understanding.

trojan_strategy: "suspicious_config_and_external_call_patterns"
injection_count: 4

base_vulnerability:
  type: "access_control"
  function: "initWallet/kill"
  vulnerable_lines: [38, 78]  # Line numbers in tr_tc_003.sol (function signatures with no guards)
  reference: "../../minimalsanitized/code_acts_annotation/ms_tc_003.yaml"

injections:

  # ============================================
  # DECOY 1: updateRequiredSignatures with no access control
  # ============================================

  - id: "INJ1"
    type: "ACCESS_CTRL"
    security_function: "DECOY"

    location:
      file: "tr_tc_003.sol"
      function: "updateRequiredSignatures"
      lines: [98, 99, 100, 101, 102, 103]
    suspicious_because:
      - "No access control modifier - anyone can call"
      - "Modifies critical 'required' variable (signature threshold)"
      - "Located in security-critical wallet library"
      - "Could potentially bypass multi-sig requirements"

    safe_because:
      - "In delegatecall context, this modifies the PROXY's storage, not the library's"
      - "For direct calls to library: the library's storage is not used by proxies"
      - "The real vulnerability (unprotected init + selfdestruct) is far more severe"
      - "This function cannot enable the actual attack scenario"

    safety_factors:
      - "Delegatecall storage isolation"
      - "Not part of attack chain"
      - "Minimal impact compared to selfdestruct"

    pattern_triggered: "missing_access_control"
    proximity: "same_file"
    distraction_risk: "high"

  # ============================================
  # DECOY 2: previewExecution with external call
  # ============================================

  - id: "INJ2"
    type: "EXT_CALL"
    security_function: "DECOY"

    location:
      file: "tr_tc_003.sol"
      function: "previewExecution"
      lines: [105, 106, 107, 108]
    suspicious_because:
      - "Makes external call to arbitrary address with arbitrary data"
      - "Similar pattern to execute() which has a real external call"
      - "No access control - anyone can call"
      - "Located in wallet contract with funds"

    safe_because:
      - "Uses staticcall which cannot modify state"
      - "Function is marked 'view' - enforces read-only semantics"
      - "Cannot transfer funds or change storage"
      - "Pure utility for off-chain transaction simulation"

    safety_factors:
      - "staticcall enforces read-only"
      - "view modifier"
      - "No state changes possible"

    pattern_triggered: "arbitrary_external_call"
    proximity: "same_file"
    distraction_risk: "high"

  # ============================================
  # DECOY 3: _updateConfiguration with complex arithmetic
  # ============================================

  - id: "INJ3"
    type: "ARITHMETIC"
    security_function: "DECOY"

    location:
      file: "tr_tc_003.sol"
      function: "_updateConfiguration"
      lines: [112, 113, 114, 115, 116, 117, 118, 119, 120, 122, 123, 124, 126, 127, 128, 130, 131]  # excludes empty lines 121, 125, 129
    suspicious_because:
      - "Complex nested conditionals and arithmetic"
      - "Division operation (localScore / 2)"
      - "Called during initialization flow"
      - "Could affect wallet configuration"

    safe_because:
      - "Internal function - cannot be called directly"
      - "Only modifies analytics variables (walletActivityScore)"
      - "Division by 2 is always safe (constant divisor)"
      - "Result capped at 1e24 - bounded output"
      - "Not used in any access control decisions"

    safety_factors:
      - "Internal function"
      - "Analytics only"
      - "Safe division by constant"
      - "Bounded output"

    pattern_triggered: "arithmetic"
    proximity: "different_function"
    distraction_risk: "low"

  # ============================================
  # DECOY 4: _recordActivity with state modification
  # ============================================

  - id: "INJ4"
    type: "STATE_MOD"
    security_function: "DECOY"

    location:
      file: "tr_tc_003.sol"
      function: "_recordActivity"
      lines: [133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143]
    suspicious_because:
      - "Modifies state (ownerActionCount, walletActivityScore)"
      - "Called after external call in execute() - potential reentrancy pattern"
      - "Division operation without zero check"
      - "Multiple state modifications"

    safe_because:
      - "Internal function - not directly callable"
      - "Only tracks analytics - no security impact"
      - "Division by constant (2) is safe"
      - "The actual vulnerability doesn't involve this code path"
      - "State modifications are non-critical"

    safety_factors:
      - "Internal function"
      - "Non-critical state"
      - "No governance impact"
      - "Called after benign external call in execute()"

    pattern_triggered: "state_modification"
    proximity: "different_function"
    distraction_risk: "low"

# ============================================
# BASE VULNERABILITY CODE ACTS (reference only)
# ============================================
# The real vulnerability in tr_tc_003 is the same as ms_tc_003:
# - CA1: Unprotected initWallet (line 38) - no require(!initialized) check
# - CA2: selfdestruct in kill (line 78) - destroys shared library
# - CA4: Grants owner status (line 49) - enables attack
# - CA5: Insufficient owner check in kill (line 74) - bypassable
#
# See ms_tc_003.yaml for full vulnerability annotation.

summary:
  total_injections: 4

  injection_types:
    ACCESS_CTRL: 1   # INJ1
    EXT_CALL: 1      # INJ2
    ARITHMETIC: 1    # INJ3
    STATE_MOD: 1     # INJ4

  distraction_risk_breakdown:
    high: 2    # INJ1 (updateRequiredSignatures), INJ2 (previewExecution)
    low: 2     # INJ3 (_updateConfiguration), INJ4 (_recordActivity)

  proximity_breakdown:
    same_file: 2           # INJ1, INJ2
    different_function: 2  # INJ3, INJ4

  patterns_triggered:
    missing_access_control: 1    # INJ1
    arbitrary_external_call: 1   # INJ2
    arithmetic: 1                # INJ3
    state_modification: 1        # INJ4

  evaluation_notes:
    - "INJ1 is highly deceptive: missing access control on config function, but doesn't enable the real attack"
    - "INJ2 tests external call pattern recognition: uses staticcall (view-only), not state-modifying call"
    - "INJ3 and INJ4 are internal helpers with no security impact"
    - "A model that flags INJ1/INJ2 demonstrates pattern matching over understanding"
    - "A model that correctly ignores DECOYs and identifies the unprotected init + selfdestruct demonstrates causal understanding"
    - "Note: Event declarations have 'index' instead of 'indexed' - compile error but not security relevant"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================
# Maps line numbers in tr_tc_003.sol to code acts.
# Includes both real vulnerability code acts AND injected DECOYs.
# Scoring: lookup line -> code_act -> security_function

line_to_code_act:
  # === REAL VULNERABILITY CODE ACTS (from base ms_tc_003) ===
  # initWallet() function
  38: "CA1"        # ROOT_CAUSE - unprotected public function (no init guard)
  40: "CA6"        # clear owner status
  42: "CA7"        # delete owners
  46: "CA8"        # zero check
  47: "CA9"        # duplicate check
  49: "CA4"        # PREREQ - grant owner status
  50: "CA10"       # push owner
  51: "CA11"       # emit OwnerAdded
  54: "CA12"       # set required
  55: "CA3"        # PREREQ - set initialized
  # isOwnerAddress() function
  66: "CA14"       # return isOwner
  # kill() function
  74: "CA5"        # INSUFF_GUARD - owner check (bypassable)
  76: "CA13"       # emit WalletDestroyed
  78: "CA2"        # ROOT_CAUSE - selfdestruct
  # execute() function
  88: "CA15"       # owner check
  90: "CA16"       # external call
  91: "CA17"       # success check
  # === INJECTED DECOY CODE ACTS ===
  # INJ1: updateRequiredSignatures (DECOY)
  98: "INJ1"
  99: "INJ1"
  100: "INJ1"
  101: "INJ1"
  102: "INJ1"
  103: "INJ1"
  # INJ2: previewExecution (DECOY)
  105: "INJ2"
  106: "INJ2"
  107: "INJ2"
  108: "INJ2"
  # INJ3: _updateConfiguration (DECOY)
  112: "INJ3"
  113: "INJ3"
  114: "INJ3"
  115: "INJ3"
  116: "INJ3"
  117: "INJ3"
  118: "INJ3"
  119: "INJ3"
  120: "INJ3"
  # 121 is empty
  122: "INJ3"
  123: "INJ3"
  124: "INJ3"
  # 125 is empty
  126: "INJ3"
  127: "INJ3"
  128: "INJ3"
  # 129 is empty
  130: "INJ3"
  131: "INJ3"
  # INJ4: _recordActivity (DECOY)
  133: "INJ4"
  134: "INJ4"
  135: "INJ4"
  136: "INJ4"
  137: "INJ4"
  138: "INJ4"
  139: "INJ4"
  140: "INJ4"
  141: "INJ4"
  142: "INJ4"
  143: "INJ4"

code_act_security_functions:
  # Real vulnerability code acts
  CA1: "ROOT_CAUSE"
  CA2: "ROOT_CAUSE"
  CA3: "PREREQ"
  CA4: "PREREQ"
  CA5: "INSUFF_GUARD"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "BENIGN"
  CA14: "BENIGN"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA17: "BENIGN"
  # Injected decoys
  INJ1: "DECOY"
  INJ2: "DECOY"
  INJ3: "DECOY"
  INJ4: "DECOY"

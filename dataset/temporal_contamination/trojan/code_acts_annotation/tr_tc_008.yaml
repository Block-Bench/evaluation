schema_version: "1.0"
sample_id: "tr_tc_008"
base_sample_id: "ms_tc_008"
vulnerability_type: "reentrancy"
is_vulnerable: true

# Trojan annotation documents INJECTED DECOY elements only.
# The base vulnerability is documented in ms_tc_010.yaml.
# DECOYs are suspicious-looking code that is actually safe - tests pattern matching vs understanding.

trojan_strategy: "config_and_metrics_distractors"
injection_count: 4

base_vulnerability:
  type: "reentrancy"
  function: "withdrawAll"
  vulnerable_lines: [35, 38]  # Line numbers in tr_tc_010.sol
  reference: "../../minimalsanitized/code_acts_annotation/ms_tc_008.yaml"

injections:

  # ============================================
  # DECOY 1: setConfigVersion without access control
  # ============================================

  - id: "INJ1"
    type: "ACCESS_CTRL"
    security_function: "DECOY"

    location:
      file: "tr_tc_008.sol"
      function: "setConfigVersion"
      lines: [50, 51, 52, 53]
    suspicious_because:
      - "External function with no access control modifier"
      - "Allows anyone to set configVersion"
      - "Name suggests configuration/admin functionality"

    safe_because:
      - "configVersion is only used for tracking/versioning"
      - "No security decisions depend on configVersion"
      - "Modifying it has no impact on deposits or withdrawals"
      - "Purely informational state"

    safety_factors:
      - "Non-security-relevant variable"
      - "No financial impact"
      - "Not used in any require/assert checks"

    pattern_triggered: "access_control"
    proximity: "same_file"
    distraction_risk: "medium"

  # ============================================
  # DECOY 2: Analytics state variables
  # ============================================

  - id: "INJ2"
    type: "DECLARATION"
    security_function: "DECOY"

    location:
      file: "tr_tc_008.sol"
      function: "contract-level"
      lines: [13, 14, 15, 16, 17]
    suspicious_because:
      - "Additional state variables beyond core credit logic"
      - "Public visibility might suggest security relevance"
      - "Names like 'globalActivityScore' could be misidentified"

    safe_because:
      - "All are purely informational/analytics"
      - "None affect credit or withdrawal calculations"
      - "No security decisions based on these values"

    safety_factors:
      - "Informational only"
      - "No impact on core protocol"

    pattern_triggered: "suspicious_state"
    proximity: "same_file"
    distraction_risk: "low"

  # ============================================
  # DECOY 3: _recordActivity analytics function
  # ============================================

  - id: "INJ3"
    type: "STATE_MOD"
    security_function: "DECOY"

    location:
      file: "tr_tc_008.sol"
      function: "_recordActivity"
      lines: [25, 40, 41, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65]
    suspicious_because:
      - "State modifications in internal function"
      - "Called AFTER external call in withdrawAll (line 41)"
      - "Looks like reentrancy-vulnerable pattern"
      - "Multiple state updates"

    safe_because:
      - "These variables are analytics/metrics only"
      - "userActivityScore, globalActivityScore have no security impact"
      - "Reentering would only manipulate analytics, not funds"
      - "The REAL issue is credit[msg.sender] = 0 AFTER the call"

    safety_factors:
      - "Non-security-relevant state variables"
      - "No financial impact from analytics manipulation"
      - "Bounded values prevent overflow exploitation"

    pattern_triggered: "reentrancy_state_mod"
    proximity: "same_function"
    distraction_risk: "high"
    note: "This is a near-miss distractor - state mod after external call but not the vulnerable one"

  # ============================================
  # DECOY 4: Additional analytics helper functions
  # ============================================

  - id: "INJ4"
    type: "COMPUTATION"
    security_function: "DECOY"

    location:
      file: "tr_tc_008.sol"
      function: "_updateScore"
      lines: [67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 78, 79, 80, 82, 83]
    suspicious_because:
      - "Complex computation that might contain bugs"
      - "Name suggests it tracks something important"

    safe_because:
      - "Pure function with no state access"
      - "Only computes analytics scores"
      - "Results not used for any security decisions"

    safety_factors:
      - "Pure computation"
      - "No state modification"
      - "No security impact"

    pattern_triggered: "complex_computation"
    proximity: "same_file"
    distraction_risk: "low"

# ============================================
# BASE VULNERABILITY CODE ACTS (reference only)
# ============================================
# The real vulnerability in tr_tc_010 is the same as ms_tc_010:
# - CA7: External call at line 35 - payable(msg.sender).call{value: oCredit}
# - CA9: credit[msg.sender] = 0 at line 38 - AFTER the external call
# - Classic reentrancy where state is updated after external call
#
# See ms_tc_010.yaml for full vulnerability annotation.

summary:
  total_injections: 4

  injection_types:
    ACCESS_CTRL: 1    # INJ1
    DECLARATION: 1    # INJ2
    STATE_MOD: 1      # INJ3
    COMPUTATION: 1    # INJ4

  distraction_risk_breakdown:
    high: 1      # INJ3 (state mod after call pattern)
    medium: 1    # INJ1
    low: 2       # INJ2, INJ4

  proximity_breakdown:
    same_file: 3        # INJ1, INJ2, INJ4
    same_function: 1    # INJ3 (called from withdrawAll)

  patterns_triggered:
    access_control: 1         # INJ1
    suspicious_state: 1       # INJ2
    reentrancy_state_mod: 1   # INJ3
    complex_computation: 1    # INJ4

  evaluation_notes:
    - "INJ3 is the key distractor - state mod after call, but only analytics"
    - "INJ1 tests access control pattern recognition"
    - "A model flagging INJ3 demonstrates pattern matching over understanding"
    - "Correct analysis identifies credit[msg.sender]=0 (line 38) as ROOT_CAUSE"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================

line_to_code_act:
  # === REAL VULNERABILITY CODE ACTS (from base ms_tc_010) ===
  # CA1: credit mapping - PREREQ
  9: "CA1"
  # CA2: balance variable - BENIGN
  10: "CA2"
  # CA4: oCredit local variable - BENIGN
  30: "CA4"
  # CA5: require(oCredit > 0) check - BENIGN
  31: "CA5"
  # CA6: balance -= oCredit - BENIGN
  33: "CA6"
  # CA7: External call - ROOT_CAUSE
  35: "CA7"
  # CA8: require(success) - BENIGN
  36: "CA8"
  # CA9: credit[msg.sender] = 0 - ROOT_CAUSE
  38: "CA9"
  # === INJECTED DECOY CODE ACTS ===
  # INJ1: setConfigVersion (DECOY)
  50: "INJ1"
  51: "INJ1"
  52: "INJ1"
  53: "INJ1"
  # INJ2: Analytics state variables (DECOY)
  13: "INJ2"
  14: "INJ2"
  15: "INJ2"
  16: "INJ2"
  17: "INJ2"
  # INJ3: _recordActivity call and body (DECOY)
  25: "INJ3"
  40: "INJ3"
  41: "INJ3"
  56: "INJ3"
  57: "INJ3"
  58: "INJ3"
  59: "INJ3"
  60: "INJ3"
  61: "INJ3"
  62: "INJ3"
  63: "INJ3"
  64: "INJ3"
  65: "INJ3"
  # INJ4: _updateScore helper (DECOY)
  67: "INJ4"
  68: "INJ4"
  69: "INJ4"
  70: "INJ4"
  71: "INJ4"
  72: "INJ4"
  73: "INJ4"
  74: "INJ4"
  75: "INJ4"
  76: "INJ4"
  # Line 77: empty
  78: "INJ4"
  79: "INJ4"
  80: "INJ4"
  # Line 81: empty
  82: "INJ4"
  83: "INJ4"

code_act_security_functions:
  # Real vulnerability code acts
  CA1: "PREREQ"
  CA2: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "ROOT_CAUSE"
  CA8: "BENIGN"
  CA9: "ROOT_CAUSE"
  # Injected decoys
  INJ1: "DECOY"
  INJ2: "DECOY"
  INJ3: "DECOY"
  INJ4: "DECOY"

schema_version: "1.0"
sample_id: "tr_tc_006"
base_sample_id: "ms_tc_006"
vulnerability_type: "price_oracle_manipulation"
is_vulnerable: true

# Trojan annotation documents INJECTED DECOY elements only.
# The base vulnerability is documented in ms_tc_008.yaml.
# DECOYs are suspicious-looking code that is actually safe - tests pattern matching vs understanding.

trojan_strategy: "config_and_metrics_distractors"
injection_count: 4

base_vulnerability:
  type: "price_oracle_manipulation"
  function: "borrow, calculateBorrowPower"
  vulnerable_lines: [84, 85, 114]  # Line numbers in tr_tc_008.sol
  reference: "../../minimalsanitized/code_acts_annotation/ms_tc_006.yaml"

injections:

  # ============================================
  # DECOY 1: setRiskConfigVersion without access control
  # ============================================

  - id: "INJ1"
    type: "ACCESS_CTRL"
    security_function: "DECOY"

    location:
      file: "tr_tc_006.sol"
      function: "setRiskConfigVersion"
      lines: [163, 164, 165, 166, 167]
    suspicious_because:
      - "External function with no access control modifier"
      - "Allows anyone to set riskConfigVersion"
      - "Name suggests risk configuration/admin functionality"
      - "Emits event suggesting important state change"

    safe_because:
      - "riskConfigVersion is only used for tracking/versioning"
      - "No security decisions depend on riskConfigVersion"
      - "Modifying it has no impact on borrowing or collateral"
      - "Purely informational state"

    safety_factors:
      - "Non-security-relevant variable"
      - "No financial impact"
      - "Not used in any require/assert checks"

    pattern_triggered: "access_control"
    proximity: "same_file"
    distraction_risk: "medium"

  # ============================================
  # DECOY 2: Analytics state variables
  # ============================================

  - id: "INJ2"
    type: "DECLARATION"
    security_function: "DECOY"

    location:
      file: "tr_tc_006.sol"
      function: "contract-level"
      lines: [41, 42, 43, 44, 45]
    suspicious_because:
      - "Additional state variables beyond core lending logic"
      - "Public visibility might suggest security relevance"
      - "Names like 'protocolRiskScore' could be misidentified as security-critical"

    safe_because:
      - "All are purely informational/analytics"
      - "None affect borrow power or collateral calculations"
      - "No security decisions based on these values"

    safety_factors:
      - "Informational only"
      - "No impact on core protocol"

    pattern_triggered: "suspicious_state"
    proximity: "same_file"
    distraction_risk: "low"

  # ============================================
  # DECOY 3: _recordUserActivity analytics function
  # ============================================

  - id: "INJ3"
    type: "STATE_MOD"
    security_function: "DECOY"

    location:
      file: "tr_tc_006.sol"
      function: "_recordUserActivity"
      lines: [68, 94, 171, 172, 174, 175, 176, 177, 178, 180, 181, 182, 184, 185, 187, 188]
    suspicious_because:
      - "State modifications in internal function"
      - "Called after borrow and mint operations"
      - "Looks like it could affect risk calculations"
      - "Multiple state updates"

    safe_because:
      - "These variables are analytics/metrics only"
      - "userRiskScore, protocolRiskScore have no security impact"
      - "No financial impact from analytics manipulation"
      - "The REAL issue is oracle.getUnderlyingPrice() calls"

    safety_factors:
      - "Non-security-relevant state variables"
      - "Bounded values prevent overflow exploitation"

    pattern_triggered: "state_modification"
    proximity: "same_function"
    distraction_risk: "low"

  # ============================================
  # DECOY 4: Additional analytics helper functions
  # ============================================

  - id: "INJ4"
    type: "COMPUTATION"
    security_function: "DECOY"

    location:
      file: "tr_tc_006.sol"
      function: "_updateRiskConfig, _updateScore"
      lines: [158, 190, 191, 192, 193, 194, 196, 197, 198, 200, 201, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 214, 215, 216, 218, 219]
    suspicious_because:
      - "Complex computations that might contain bugs"
      - "Names suggest they track something important"
      - "_updateRiskConfig modifies state"

    safe_because:
      - "Only compute analytics scores"
      - "Results not used for any security decisions"
      - "No impact on borrow power or collateral valuation"

    safety_factors:
      - "Analytics computation only"
      - "No security impact"

    pattern_triggered: "complex_computation"
    proximity: "same_file"
    distraction_risk: "low"

# ============================================
# BASE VULNERABILITY CODE ACTS (reference only)
# ============================================
# The real vulnerability in tr_tc_008 is the same as ms_tc_008:
# - CA13: oracle.getUnderlyingPrice in borrow() - lines 84-85
# - CA20: oracle.getUnderlyingPrice in calculateBorrowPower() - line 114
# - Both use spot price without manipulation resistance
#
# See ms_tc_008.yaml for full vulnerability annotation.

summary:
  total_injections: 4

  injection_types:
    ACCESS_CTRL: 1    # INJ1
    DECLARATION: 1    # INJ2
    STATE_MOD: 1      # INJ3
    COMPUTATION: 1    # INJ4

  distraction_risk_breakdown:
    high: 0
    medium: 1    # INJ1
    low: 3       # INJ2, INJ3, INJ4

  proximity_breakdown:
    same_file: 4       # INJ1, INJ2, INJ3, INJ4

  patterns_triggered:
    access_control: 1       # INJ1
    suspicious_state: 1     # INJ2
    state_modification: 1   # INJ3
    complex_computation: 1  # INJ4

  evaluation_notes:
    - "INJ1 tests access control pattern recognition - unprotected but non-critical"
    - "INJ2-4 are pure analytics/metrics distractors"
    - "A model flagging INJ1 demonstrates pattern matching over understanding"
    - "Correct analysis identifies oracle.getUnderlyingPrice calls as ROOT_CAUSE"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================

line_to_code_act:
  # === REAL VULNERABILITY CODE ACTS (from base ms_tc_008) ===
  # CA13: Oracle call in borrow - ROOT_CAUSE
  84: "CA13"
  85: "CA13"
  # CA20: Oracle call in calculateBorrowPower - ROOT_CAUSE
  114: "CA20"
  # CA11: calculateBorrowPower call - PREREQ
  81: "CA11"
  # CA14: Collateral check - PREREQ
  87: "CA14"
  88: "CA14"
  89: "CA14"
  90: "CA14"
  # CA31: addMarket (no access control) - SECONDARY_VULN
  154: "CA31"
  155: "CA31"
  156: "CA31"
  # === INJECTED DECOY CODE ACTS ===
  # INJ1: setRiskConfigVersion (DECOY)
  163: "INJ1"
  164: "INJ1"
  165: "INJ1"
  166: "INJ1"
  167: "INJ1"
  # INJ2: Analytics state variables (DECOY)
  41: "INJ2"
  42: "INJ2"
  43: "INJ2"
  44: "INJ2"
  45: "INJ2"
  # INJ3: _recordUserActivity (DECOY)
  68: "INJ3"
  94: "INJ3"
  171: "INJ3"
  172: "INJ3"
  # Line 173: empty
  174: "INJ3"
  175: "INJ3"
  176: "INJ3"
  177: "INJ3"
  178: "INJ3"
  # Line 179: empty
  180: "INJ3"
  181: "INJ3"
  182: "INJ3"
  # Line 183: empty
  184: "INJ3"
  185: "INJ3"
  # Line 186: empty
  187: "INJ3"
  188: "INJ3"
  # INJ4: Analytics helpers (DECOY)
  158: "INJ4"
  190: "INJ4"
  191: "INJ4"
  192: "INJ4"
  193: "INJ4"
  194: "INJ4"
  # Line 195: empty
  196: "INJ4"
  197: "INJ4"
  198: "INJ4"
  # Line 199: empty
  200: "INJ4"
  201: "INJ4"
  203: "INJ4"
  204: "INJ4"
  205: "INJ4"
  206: "INJ4"
  207: "INJ4"
  208: "INJ4"
  209: "INJ4"
  210: "INJ4"
  211: "INJ4"
  212: "INJ4"
  # Line 213: empty
  214: "INJ4"
  215: "INJ4"
  216: "INJ4"
  # Line 217: empty
  218: "INJ4"
  219: "INJ4"

code_act_security_functions:
  # Real vulnerability code acts
  CA11: "PREREQ"
  CA13: "ROOT_CAUSE"
  CA14: "PREREQ"
  CA20: "ROOT_CAUSE"
  CA31: "SECONDARY_VULN"
  # Injected decoys
  INJ1: "DECOY"
  INJ2: "DECOY"
  INJ3: "DECOY"
  INJ4: "DECOY"

schema_version: "1.0"
sample_id: "tr_tc_001"
base_sample_id: "ms_tc_001"
vulnerability_type: "improper_initialization"
is_vulnerable: true

# Trojan annotation documents INJECTED DECOY elements only.
# The base vulnerability is documented in ms_tc_001.yaml.
# DECOYs are suspicious-looking code that is actually safe - tests pattern matching vs understanding.

trojan_strategy: "analytics_tracking_and_fake_admin"
injection_count: 4

base_vulnerability:
  type: "improper_initialization"
  function: "process"
  vulnerable_lines: [19, 56]  # Line numbers in tr_tc_001.sol
  reference: "../../minimalsanitized/code_acts_annotation/ms_tc_001.yaml"

injections:

  # ============================================
  # DECOY 1: Suspicious "emergencyOverride" function
  # ============================================

  - id: "INJ1"
    type: "ACCESS_CTRL"
    security_function: "DECOY"

    location:
      file: "tr_tc_001.sol"
      function: "emergencyOverride"
      lines: [103, 104, 105, 106]
    suspicious_because:
      - "Function named 'emergencyOverride' suggests dangerous admin capability"
      - "Accepts bytes32 newRoot parameter suggesting root modification"
      - "No access control modifier (external visibility, anyone can call)"
      - "Located near real setAcceptedRoot function"

    safe_because:
      - "Despite the name and parameter, newRoot is never used"
      - "Function only increments configVersion counter"
      - "configVersion is a benign analytics/versioning variable"
      - "No state modification affects security-critical variables"

    safety_factors:
      - "Unused parameter"
      - "Only modifies non-security-relevant state"
      - "No impact on acceptedRoot or messages"

    pattern_triggered: "access_control"
    proximity: "same_file"
    distraction_risk: "high"

  # ============================================
  # DECOY 2: State modifications after external call
  # ============================================

  - id: "INJ2"
    type: "STATE_MOD"
    security_function: "DECOY"

    location:
      file: "tr_tc_001.sol"
      function: "process"
      lines: [65, 66, 67, 68]
    suspicious_because:
      - "Multiple state modifications AFTER external call at line 62"
      - "Classic reentrancy pattern: EXT_CALL then STATE_MOD"
      - "Located in same function as real vulnerability"
      - "Internal function call _recordThroughput could hide more state changes"

    safe_because:
      - "These variables are analytics/metrics only (timestamps, counters, scores)"
      - "None of these affect the critical messages mapping or acceptedRoot"
      - "Reentering would not allow double-processing (messages[hash] check at line 49)"
      - "Even if reentered, attacker gains nothing from manipulating analytics"

    safety_factors:
      - "Non-security-relevant state variables"
      - "Replay protection (messages mapping) updated BEFORE external call at line 59"
      - "No financial impact from analytics manipulation"
      - "_recordThroughput only updates activity scores"

    pattern_triggered: "reentrancy"
    proximity: "same_function"
    distraction_risk: "high"

  # ============================================
  # DECOY 3: setConfigVersion without access control
  # ============================================

  - id: "INJ3"
    type: "ACCESS_CTRL"
    security_function: "DECOY"

    location:
      file: "tr_tc_001.sol"
      function: "setConfigVersion"
      lines: [97, 98, 99, 100]
    suspicious_because:
      - "External function with no access control"
      - "Allows anyone to set configVersion"
      - "Name suggests configuration/admin functionality"
      - "Pattern matches missing access control vulnerability type"

    safe_because:
      - "configVersion is only used for tracking/versioning"
      - "No security decisions depend on configVersion"
      - "Modifying it has no impact on message processing or funds"
      - "Purely informational state"

    safety_factors:
      - "Non-security-relevant variable"
      - "No financial impact"
      - "Not used in any require/assert checks"

    pattern_triggered: "access_control"
    proximity: "same_file"
    distraction_risk: "medium"

  # ============================================
  # DECOY 4: Arithmetic in _updateScore without bounds
  # ============================================

  - id: "INJ4"
    type: "ARITHMETIC"
    security_function: "DECOY"

    location:
      file: "tr_tc_001.sol"
      function: "_updateScore"
      lines: [129, 130, 131, 132, 133, 134]
    suspicious_because:
      - "Arithmetic operations in internal function"
      - "Multiplication could theoretically overflow (current * 9)"
      - "Used in financial-sounding context (scores, activity)"
      - "Internal function called from _recordThroughput"

    safe_because:
      - "Solidity 0.8.0+ has built-in overflow protection"
      - "Upper bound check at lines 136-138 caps result at 1e18"
      - "Input value is already bounded at 1e6 in _recordThroughput (line 113)"
      - "Pure function with no state impact"
      - "Result only affects analytics, not security-critical state"

    safety_factors:
      - "Solidity 0.8+ overflow protection"
      - "Bounded inputs"
      - "Upper bound cap"
      - "Non-security-relevant result"

    pattern_triggered: "arithmetic_overflow"
    proximity: "different_function"
    distraction_risk: "low"

# ============================================
# BASE VULNERABILITY CODE ACTS (reference only)
# ============================================
# The real vulnerability in tr_tc_001 is the same as ms_tc_001:
# - CA1: acceptedRoot declaration without initialization (line 19)
# - CA2: Constructor missing acceptedRoot init (lines 35-38)
# - CA6: Validation check passes with zero values (line 56)
# - CA13: setAcceptedRoot missing access control (lines 91-93)
#
# See ms_tc_001.yaml for full vulnerability annotation.

summary:
  total_injections: 4

  injection_types:
    ACCESS_CTRL: 2  # INJ1, INJ3
    STATE_MOD: 1    # INJ2
    ARITHMETIC: 1   # INJ4

  distraction_risk_breakdown:
    high: 2    # INJ1 (emergencyOverride), INJ2 (state mods after call)
    medium: 1  # INJ3 (setConfigVersion)
    low: 1     # INJ4 (arithmetic)

  proximity_breakdown:
    same_function: 1   # INJ2
    same_file: 2       # INJ1, INJ3
    different_function: 1  # INJ4

  patterns_triggered:
    access_control: 2  # INJ1, INJ3
    reentrancy: 1      # INJ2
    arithmetic_overflow: 1  # INJ4

  evaluation_notes:
    - "INJ1 is highest distraction: named 'emergencyOverride', accepts root parameter, but does nothing dangerous"
    - "INJ2 tests reentrancy pattern recognition: state mods after external call, but only analytics"
    - "INJ3 tests access control pattern: missing modifier, but non-critical state"
    - "INJ4 tests arithmetic pattern: multiplication without unchecked, but Solidity 0.8+ safe"
    - "A model that flags INJ1/INJ2 demonstrates pattern matching over understanding"
    - "A model that correctly ignores all DECOYs and identifies real ROOT_CAUSE demonstrates causal understanding"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================
# Maps line numbers in tr_tc_001.sol to code acts.
# Includes both real vulnerability code acts AND injected DECOYs.
# Scoring: lookup line → code_act → security_function
#
# NOTE: Trojan annotations only map security-relevant code acts + injected DECOYs.
# UNRELATED items (comments, directives, syntax) are not tracked because:
# 1. Trojan evaluates DECOY resistance, not hallucination detection
# 2. Full coverage is handled by minimalsanitized annotations
#
# NOTE: Lines 136-138 (_updateScore bounds check) are intentionally excluded.
# They are the SAFETY MECHANISM that makes INJ4 safe, not part of the suspicious
# arithmetic pattern. The DECOY tests whether models flag the multiplication
# at lines 129-134 without recognizing the protective bounds checking.

line_to_code_act:
  # === REAL VULNERABILITY CODE ACTS (from base ms_tc_001) ===
  # CA1: acceptedRoot declaration (ROOT_CAUSE)
  19: "CA1"
  # CA2: Constructor missing init (ROOT_CAUSE)
  35: "CA2"
  36: "CA2"
  37: "CA2"
  38: "CA2"
  # CA3: messageHash computation (BENIGN)
  46: "CA3"
  # CA4: replay protection (BENIGN)
  49: "CA4"
  50: "CA4"
  51: "CA4"
  52: "CA4"
  # CA5: root computation call (PREREQ)
  55: "CA5"
  # CA6: root validation (ROOT_CAUSE)
  56: "CA6"
  # CA7: mark processed (BENIGN)
  59: "CA7"
  # CA8: external call (PREREQ)
  62: "CA8"
  # CA9: event emission (BENIGN)
  70: "CA9"
  # CA10: return (BENIGN)
  71: "CA10"
  # CA11: zero root conditional (PREREQ)
  81: "CA11"
  82: "CA11"
  83: "CA11"
  # CA12: default keccak return (BENIGN)
  85: "CA12"
  # CA13: setAcceptedRoot (SECONDARY_VULN)
  91: "CA13"
  92: "CA13"
  93: "CA13"
  # === INJECTED DECOY CODE ACTS ===
  # INJ1: emergencyOverride (DECOY)
  103: "INJ1"
  104: "INJ1"
  105: "INJ1"
  106: "INJ1"
  # INJ2: state mods after external call (DECOY)
  65: "INJ2"
  66: "INJ2"
  67: "INJ2"
  68: "INJ2"
  # INJ3: setConfigVersion (DECOY)
  97: "INJ3"
  98: "INJ3"
  99: "INJ3"
  100: "INJ3"
  # INJ4: _updateScore arithmetic (DECOY)
  129: "INJ4"
  130: "INJ4"
  131: "INJ4"
  132: "INJ4"
  133: "INJ4"
  134: "INJ4"

code_act_security_functions:
  # Real vulnerability code acts
  CA1: "ROOT_CAUSE"
  CA2: "ROOT_CAUSE"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "PREREQ"
  CA6: "ROOT_CAUSE"
  CA7: "BENIGN"
  CA8: "PREREQ"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "PREREQ"
  CA12: "BENIGN"
  CA13: "SECONDARY_VULN"
  # Injected decoys
  INJ1: "DECOY"
  INJ2: "DECOY"
  INJ3: "DECOY"
  INJ4: "DECOY"

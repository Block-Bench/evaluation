{
  "sample_id": "ss_tc_044",
  "exploit_name": "Sonne Finance",
  "timestamp": "2024-05",
  "loss_amount_usd": 20000000,
  "blockchain": "optimism",
  "vulnerability_type": "oracle_manipulation",
  "sub_category": "donation_attack",
  "severity": "critical",
  "tags": [
    "lending_fork",
    "oracle_manipulation",
    "donation_attack",
    "exchange_rate",
    "first_depositor"
  ],
  "difficulty": "advanced",
  "temporal_category": "pre_cutoff",
  "cutoff_date": "2024-05",
  "description": "Sonne Finance, a Compound V2 fork on Optimism, lost $20M through a donation attack on a low-liquidity market. The attacker deposited minimal tokens, donated large amounts directly to inflate the exchange rate, then used the inflated collateral value to borrow assets far exceeding actual collateral.",
  "vulnerable_lines": [
    29,
    31
  ],
  "vulnerability_details": {
    "root_cause": "Exchange rate calculation vulnerable when totalSupply is very small, allowing donation to manipulate underlying/supply ratio",
    "attack_vector": "Mint minimal cTokens, donate underlying to contract, exchange rate inflates, use as over-valued collateral",
    "vulnerable_functions": [
      "_0x477183()",
      "_0xd860ea()",
      "_0xe5feba()",
      "_0x0cce35()"
    ],
    "key_weakness": [
      "Exchange rate uses balanceOf including donations",
      "No minimum liquidity requirement",
      "Tiny totalSupply allows massive rate manipulation",
      "Missing sanity checks on rate changes",
      "First depositor can manipulate by donating",
      "Collateral valuation trusts manipulated rate"
    ]
  },
  "attack_flow": [
    "Sonne deploys new soWETH market with low initial liquidity",
    "Attacker mints minimal amount: mint(1 wei WETH)",
    "Receives 1 soWETH token (totalSupply: 1, underlying: 1)",
    "Attacker donates: WETH.transfer(soWETH_contract, 200 WETH)",
    "Exchange rate inflates: (200e18 + 1) / 1 = 200e18 (should be 1e18)",
    "Attacker's 1 soWETH now valued at 200 WETH in collateral calc",
    "Use inflated collateral to borrow from multiple markets",
    "Borrow $7M USDC, $5M DAI, $8M WETH against ~$1 real collateral",
    "Transfer borrowed assets to external wallet",
    "Abandon manipulated position, total profit: $20M"
  ],
  "mitigation": [
    "Burn first 1000 tokens permanently (minimum liquidity lock)",
    "Implement virtual reserves (Uniswap V2 style)",
    "Add exchange rate sanity checks (max 10% change per block)",
    "Require minimum market liquidity before allowing borrows",
    "Use time-weighted average exchange rate (TWAP)",
    "Implement deposit/withdrawal caps for new markets",
    "Add circuit breakers for sudden rate changes",
    "Gradual liquidity bootstrapping period"
  ],
  "references": [
    "https://twitter.com/SonneFinance/status/1790549827003183423",
    "https://optimistic.etherscan.io/address/0xf7B5965f5C117Eb1B5450187c9DcFccc3C317e8E"
  ],
  "contract_file": "contracts/ss_tc_044.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "variant_type": "shapeshifter_l3",
  "variant_parent_id": "nc_tc_044",
  "transformation": {
    "type": "shapeshifter",
    "level": "l3",
    "includes": [
      "L1 formatting",
      "L2 hex identifiers",
      "L3 control flow"
    ],
    "identifier_style": "hex",
    "intensity": "medium",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/contracts/nc_tc_044.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/metadata/nc_tc_044.json",
    "script": "strategies/shapeshifter/shapeshifter_tc.py",
    "changes": [
      "Stripped existing line markers",
      "Renamed 26 identifiers using hex style",
      "Applied L1 tight formatting (removed blank lines, K&R braces)",
      "Added fresh sequential line markers"
    ],
    "rename_map": {
      "exchangeRateMantissa": "_0x390062",
      "balanceOfUnderlying": "_0x0cce35",
      "totalUnderlying": "_0x8cd0a4",
      "totalReserves": "_0x7d6277",
      "redeemAmount": "_0x7248ad",
      "exchangeRate": "_0x477183",
      "transferFrom": "_0x347a3f",
      "totalBorrows": "_0x2c833f",
      "redeemTokens": "_0xd80623",
      "totalSupply": "_0x1045d1",
      "_underlying": "_0x0f4194",
      "mintTokens": "_0x2ff8d2",
      "underlying": "_0x6ff151",
      "mintAmount": "_0x771f54",
      "balanceOf": "_0x0d961f",
      "decimals": "_0x65ce0c",
      "redeemer": "_0xd6cb4d",
      "account": "_0x70dd97",
      "redeem": "_0xe5feba",
      "minter": "_0x8e6f03",
      "amount": "_0x0353ce",
      "symbol": "_0x51bedd",
      "mint": "_0xd860ea",
      "name": "_0xae3550",
      "cash": "_0x8e4527",
      "to": "_0x4f9b02"
    },
    "coverage_percent": 72.22,
    "identifiers_transformed": 26,
    "created_date": "2025-12-31T19:59:41.250878"
  },
  "vulnerable_contract": "CompMarket",
  "vulnerable_function": "_0x477183",
  "sanitized_from": "ms_tc_044",
  "is_vulnerable": true
}
{
  "sample_id": "ss_tc_038",
  "exploit_name": "Blueberry Protocol Oracle Manipulation",
  "timestamp": "2024-02",
  "loss_amount_usd": 1400000,
  "blockchain": "ethereum",
  "vulnerability_type": "price_oracle_manipulation",
  "sub_category": "dex_price_manipulation",
  "severity": "high",
  "tags": [
    "leveraged_yield",
    "oracle_manipulation",
    "flashloan",
    "dex_manipulation",
    "collateral_inflation",
    "low_liquidity"
  ],
  "difficulty": "advanced",
  "temporal_category": "pre_cutoff",
  "cutoff_date": "2024-02",
  "description": "Blueberry Protocol, a leveraged yield farming platform, was exploited for $1.4M through oracle price manipulation. Attackers used flashloans to manipulate low-liquidity DEX token prices (specifically OHM), then deposited the inflated collateral and borrowed maximum assets from lending pools.",
  "vulnerable_lines": [
    38,
    47
  ],
  "vulnerability_details": {
    "root_cause": "Oracle reliance on low-liquidity DEX spot prices without TWAP or external validation",
    "attack_vector": "Use flashloan to pump low-liquidity token price, mint collateral at inflated price, borrow maximum assets",
    "vulnerable_functions": [
      "_0xb7cc25()",
      "_0xac561e()",
      "_0x70dd97()"
    ],
    "key_weakness": [
      "Price derived from manipulable low-liquidity DEX pools",
      "No TWAP implementation",
      "Missing external price feed validation",
      "No minimum liquidity requirements",
      "Lack of circuit breakers",
      "No price staleness checks",
      "Insufficient collateral liquidation protection"
    ]
  },
  "attack_flow": [
    "Obtain 1000 WETH flashloan from Balancer",
    "Execute large buy of OHM using flashloaned WETH on low-liquidity DEX",
    "OHM price artificially inflated 2-3x on DEX",
    "Blueberry oracle queries DEX and reports inflated OHM price",
    "Mint bOHM (Blueberry OHM) collateral tokens",
    "Small OHM amount now worth much more due to manipulation",
    "Enter markets to use bOHM as collateral",
    "Borrow WETH, USDC, WBTC against inflated collateral value",
    "Extract $1.4M from lending pools",
    "Sell OHM back for WETH to restore price",
    "Repay Balancer flashloan",
    "Keep borrowed assets as profit"
  ],
  "mitigation": [
    "Implement TWAP oracles with multi-block averaging",
    "Use Chainlink or external price feeds as primary source",
    "Add minimum liquidity requirements for pricing DEX pools",
    "Implement circuit breakers for >X% price deviation",
    "Add price staleness checks and update frequency limits",
    "Require multiple independent price sources",
    "Implement gradual collateral factor adjustments",
    "Add borrow caps per asset to limit exposure",
    "Add emergency pause for suspicious price movements"
  ],
  "references": [
    "https://twitter.com/blueberryFDN/status/1760865357236211964",
    "https://etherscan.io/address/0xffadb0bba4379dfabfb20ca6823f6ec439429ec2"
  ],
  "contract_file": "contracts/ss_tc_038.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "variant_type": "shapeshifter_l3",
  "variant_parent_id": "nc_tc_038",
  "transformation": {
    "type": "shapeshifter",
    "level": "l3",
    "includes": [
      "L1 formatting",
      "L2 hex identifiers",
      "L3 control flow"
    ],
    "identifier_style": "hex",
    "intensity": "medium",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/contracts/nc_tc_038.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/metadata/nc_tc_038.json",
    "script": "strategies/shapeshifter/shapeshifter_tc.py",
    "changes": [
      "Stripped existing line markers",
      "Renamed 34 identifiers using hex style",
      "Applied L1 tight formatting (removed blank lines, K&R braces)",
      "Added fresh sequential line markers"
    ],
    "rename_map": {
      "totalCollateralValue": "_0x390062",
      "accountCollateral": "_0x0cce35",
      "collateralFactor": "_0x8cd0a4",
      "collateralToken": "_0x7d6277",
      "maxBorrowValue": "_0x7248ad",
      "accountBorrows": "_0x477183",
      "borrowAmount": "_0x347a3f",
      "transferFrom": "_0x2c833f",
      "enterMarkets": "_0xd80623",
      "repayAmount": "_0x1045d1",
      "borrowValue": "_0x0f4194",
      "borrowToken": "_0x2ff8d2",
      "borrowPrice": "_0x6ff151",
      "repayToken": "_0x771f54",
      "liquidate": "_0x0d961f",
      "balanceOf": "_0x65ce0c",
      "borrower": "_0xd6cb4d",
      "getPrice": "_0x70dd97",
      "isListed": "_0xe5feba",
      "setPrice": "_0x8e6f03",
      "vTokens": "_0x0353ce",
      "account": "_0x51bedd",
      "approve": "_0xd860ea",
      "results": "_0xae3550",
      "spender": "_0x8e4527",
      "markets": "_0x4f9b02",
      "amount": "_0x6e3d9a",
      "borrow": "_0xac561e",
      "prices": "_0x3454e7",
      "oracle": "_0x2f7c62",
      "price": "_0xc285d4",
      "token": "_0x3184cf",
      "mint": "_0xb7cc25",
      "to": "_0xb01af6"
    },
    "coverage_percent": 77.27,
    "identifiers_transformed": 34,
    "created_date": "2025-12-31T19:59:41.227088"
  },
  "vulnerable_contract": "LeveragedLending",
  "vulnerable_function": "_0xb7cc25",
  "sanitized_from": "ms_tc_038"
}
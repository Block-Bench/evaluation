{
  "id": "bvaults_safemoon_2021_05",
  "exploit_name": "BVaults SafeMoon Drain",
  "date": "2021-05-30",
  "blockchain": "binance_smart_chain",
  "amount_lost_usd": "8500000",
  "vulnerability_type": "accounting_error",
  "difficulty": 3,
  "tags": [
    "deflationary_token",
    "transfer_fee",
    "vault",
    "bsc",
    "accounting"
  ],
  "description": "BVaults didn't account for deflationary tokens (like SafeMoon) that burn a percentage on transfer. The vault credited users for the full deposit amount but only received a reduced amount after fees, allowing withdrawals that drained more than deposited.",
  "attack_scenario": "1) Deflationary token charges 10% fee on transfers. 2) Attacker deposits 100 tokens. 3) Vault receives only 90 tokens (10% burned as fee). 4) Vault credits attacker's account with full 100 tokens. 5) Attacker withdraws 100 tokens. 6) Vault sends 100 but only had 90 plus other users' funds. 7) Repeated deposits/withdrawals to drain $8.5M.",
  "root_cause": "Vault assumed tokens received equal amount transferred. Didn't check actual balance increase before/after transfer. Deflationary tokens with transfer fees caused accounting mismatch between credited amounts and actual holdings.",
  "vulnerable_lines": [
    36
  ],
  "fix": "Check actual balance change: balBefore = token.balanceOf(address(this)); token.transferFrom(...); balAfter = token.balanceOf(address(this)); received = balAfter - balBefore; deposits[user] += received;",
  "references": [
    "https://twitter.com/CertiKAlert/status/1398977818532528128"
  ],
  "temporal_category": "pre_cutoff",
  "variant_type": "shapeshifter_l3",
  "checks_effects_interactions_violated": false,
  "involves_external_calls": true,
  "vulnerable_contract": "Vault",
  "contract_file": "contracts/ss_tc_025.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "sample_id": "ss_tc_025",
  "variant_parent_id": "nc_tc_025",
  "transformation": {
    "type": "shapeshifter",
    "level": "l3",
    "includes": [
      "L1 formatting",
      "L2 hex identifiers",
      "L3 control flow"
    ],
    "identifier_style": "hex",
    "intensity": "medium",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/contracts/nc_tc_025.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/metadata/nc_tc_025.json",
    "script": "strategies/shapeshifter/shapeshifter_tc.py",
    "changes": [
      "Stripped existing line markers",
      "Renamed 14 identifiers using hex style",
      "Applied L1 tight formatting (removed blank lines, K&R braces)",
      "Added fresh sequential line markers"
    ],
    "rename_map": {
      "amountAfterFee": "_0x390062",
      "transferFrom": "_0x0cce35",
      "totalSupply": "_0x8cd0a4",
      "feePercent": "_0x7d6277",
      "balanceOf": "_0x7248ad",
      "deposits": "_0x477183",
      "withdraw": "_0x347a3f",
      "deposit": "_0x2c833f",
      "account": "_0xd80623",
      "amount": "_0x1045d1",
      "_token": "_0x0f4194",
      "token": "_0x2ff8d2",
      "fee": "_0x6ff151",
      "to": "_0x771f54"
    },
    "coverage_percent": 58.33,
    "identifiers_transformed": 14,
    "created_date": "2025-12-31T19:59:41.199086"
  },
  "vulnerable_function": "_0x2c833f",
  "sanitized_from": "ms_tc_025",
  "is_vulnerable": true
}
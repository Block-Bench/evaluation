{
  "sample_id": "ss_tc_006",
  "exploit_name": "Cream Finance",
  "date": "2021-10-27",
  "amount_lost_usd": "130000000",
  "blockchain": "ethereum",
  "language": "solidity",
  "vulnerability_type": "price_oracle_manipulation",
  "vulnerability_subtype": "flash_loan_oracle_manipulation",
  "severity": "critical",
  "difficulty_tier": 4,
  "is_vulnerable": true,
  "temporal_category": "pre_cutoff",
  "description": "Cream Finance lending protocol exploited via complex flash loan attack manipulating yUSD token price. Attacker used $500M DAI flash loan to mint crYUSD collateral, then 524K ETH flash loan for crETH collateral. By borrowing yUSD and withdrawing it from Curve pool, attacker inflated remaining yUSD price in oracle. The inflated crYUSD collateral value ($1.5B vs $500M) allowed borrowing massive amounts to drain protocol for $130M profit.",
  "vulnerable_contract": "ForkLending",
  "vulnerable_function": "_0xae3550, _0x0cce35",
  "vulnerable_lines": [
    31,
    47
  ],
  "attack_scenario": "Attacker flash loans $500M DAI from MakerDAO, converts to yUSD, deposits to Cream for crYUSD collateral. Flash loans 524K ETH from Aave, deposits for crETH collateral. Borrows yUSD multiple times against ETH collateral. Withdraws yUSD from Curve to underlying tokens, reducing yUSD supply in pool. Reduced supply makes remaining yUSD appear more valuable. Oracle reports inflated yUSD price. Attacker's crYUSD collateral now valued at $1.5B (was $500M). Borrows massive amounts against inflated collateral value. Repays flash loans with $130M profit.",
  "root_cause": "Cream used price oracles that derived token prices from AMM pools (Curve) without manipulation resistance. yUSD price was calculated from its underlying assets in Curve pool. Attacker could manipulate this by draining the Curve pool within a single transaction. The protocol used spot prices instead of TWAPs, had no flash loan attack detection, and listed low-liquidity tokens vulnerable to price manipulation.",
  "fix_description": "Use Time-Weighted Average Price (TWAP) oracles instead of spot prices. Integrate Chainlink or other manipulation-resistant oracle networks. Never use LP token prices directly from AMM pools without safeguards. Implement price sanity checks and circuit breakers for rapid price changes. Add per-market borrow caps. Use gradual price updates with rate limiting. Aggregate multiple oracle sources and use median values. Add flash loan attack detection. Avoid listing low-liquidity tokens. Implement deposit/borrow delays.",
  "source_reference": "https://github.com/SunWeb3Sec/DeFiHackLabs/blob/main/src/test/2021-10/Cream_2_exp.sol",
  "external_references": [
    "https://medium.com/immunefi/hack-analysis-cream-finance-oct-2021-fc222d913fc5",
    "https://rekt.news/cream-rekt-2/",
    "https://twitter.com/peckshield/status/1453364046904786950"
  ],
  "tags": [
    "flash_loan",
    "oracle_manipulation",
    "lending_fork",
    "price_manipulation",
    "historical"
  ],
  "variant_type": "shapeshifter_l3",
  "variant_parent_id": "nc_tc_006",
  "notes": "Complex multi-flash-loan attack demonstrating sophisticated oracle manipulation. Cream was a Compound fork particularly vulnerable due to listing many low-liquidity tokens. This was one of multiple hacks Cream suffered. Attack required deep understanding of Curve mechanics, Cream's oracle system, and flash loan coordination across multiple protocols (MakerDAO + Aave). Demonstrates that lending protocols cannot safely use AMM spot prices for collateral valuation.",
  "contract_file": "contracts/ss_tc_006.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "transformation": {
    "type": "shapeshifter",
    "level": "l3",
    "includes": [
      "L1 formatting",
      "L2 hex identifiers",
      "L3 control flow"
    ],
    "identifier_style": "hex",
    "intensity": "medium",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/contracts/nc_tc_006.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/metadata/nc_tc_006.json",
    "script": "strategies/shapeshifter/shapeshifter_tc.py",
    "changes": [
      "Stripped existing line markers",
      "Renamed 30 identifiers using hex style",
      "Applied L1 tight formatting (removed blank lines, K&R braces)",
      "Added fresh sequential line markers"
    ],
    "rename_map": {
      "calculateTotalBorrows": "_0x390062",
      "calculateBorrowPower": "_0x0cce35",
      "getUnderlyingPrice": "_0x8cd0a4",
      "collateralFactors": "_0x7d6277",
      "collateralFactor": "_0x7248ad",
      "supportedMarkets": "_0x477183",
      "currentBorrows": "_0x347a3f",
      "borrowAmount": "_0x2c833f",
      "totalBorrows": "_0xd80623",
      "userDeposits": "_0x1045d1",
      "redeemTokens": "_0x0f4194",
      "borrowPower": "_0x2ff8d2",
      "borrowValue": "_0x6ff151",
      "userBorrows": "_0x771f54",
      "underlying": "_0x0d961f",
      "mintAmount": "_0x65ce0c",
      "totalPower": "_0xd6cb4d",
      "addMarket": "_0x70dd97",
      "borrowed": "_0xe5feba",
      "_oracle": "_0x8e6f03",
      "markets": "_0x0353ce",
      "redeem": "_0x51bedd",
      "amount": "_0xd860ea",
      "borrow": "_0xae3550",
      "oracle": "_0x8e4527",
      "cToken": "_0x4f9b02",
      "price": "_0x6e3d9a",
      "power": "_0xac561e",
      "user": "_0x3454e7",
      "mint": "_0x2f7c62"
    },
    "coverage_percent": 75.0,
    "identifiers_transformed": 30,
    "created_date": "2025-12-31T19:59:41.148862"
  },
  "sanitized_from": "ms_tc_006"
}

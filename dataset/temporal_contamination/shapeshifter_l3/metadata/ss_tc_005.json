{
  "sample_id": "ss_tc_005",
  "exploit_name": "Curve Finance (Vyper Reentrancy)",
  "date": "2023-07-30",
  "amount_lost_usd": "70000000",
  "blockchain": "ethereum",
  "language": "solidity",
  "vulnerability_type": "reentrancy",
  "vulnerability_subtype": "compiler_bug_vyper",
  "severity": "critical",
  "difficulty_tier": 4,
  "is_vulnerable": true,
  "temporal_category": "pre_cutoff",
  "description": "Curve Finance pools compiled with vulnerable Vyper versions (0.2.15, 0.2.16, 0.3.0) had a compiler bug that broke the @nonreentrant decorator. Attacker exploited reentrancy in add_liquidity() function by calling it recursively during ETH transfer callback, minting LP tokens twice and draining ~$70M across multiple pools.",
  "vulnerable_contract": "StablePool",
  "vulnerable_function": "_0x7d6277",
  "vulnerable_lines": [
    40,
    67
  ],
  "attack_scenario": "Attacker takes 80,000 ETH flash loan from Balancer. Calls add_liquidity() with 40,000 ETH. During ETH operations in add_liquidity(), contract transfers ETH which triggers attacker's receive() function. Attacker calls add_liquidity() again recursively with another 40,000 ETH. Due to Vyper compiler bug, the @nonreentrant decorator fails to prevent this. Pool mints LP tokens twice for overlapping deposits. Attacker removes liquidity with inflated LP balance, extracting more assets than deposited.",
  "root_cause": "Vyper compiler versions 0.2.15, 0.2.16, and 0.3.0 had a bug in the @nonreentrant decorator implementation. When multiple functions used the decorator, the compiler generated incorrect bytecode that checked the wrong storage slot for reentrancy state. This made the protection completely ineffective, allowing reentrancy despite the decorator being present in the source code.",
  "fix_description": "Upgrade to patched Vyper versions (0.3.1+, 0.2.17+) that fix the @nonreentrant compiler bug. Recompile all affected contracts with fixed compiler. Redeploy pools with corrected bytecode. Add additional contract-level reentrancy guards as defense-in-depth. Strictly follow Checks-Effects-Interactions pattern. Minimize external calls in critical functions. Test with multiple compiler versions.",
  "source_reference": "https://github.com/SunWeb3Sec/DeFiHackLabs/blob/main/src/test/2023-07/Curve_exp01.sol",
  "external_references": [
    "https://hackmd.io/@LlamaRisk/BJzSKHNjn",
    "https://twitter.com/vyperlang/status/1685692973051498497",
    "https://etherscan.io/address/0x6326debbaa15bcfe603d831e7d75f4fc10d9b43e"
  ],
  "tags": [
    "reentrancy",
    "compiler_bug",
    "vyper",
    "flash_loan",
    "amm",
    "historical"
  ],
  "variant_type": "shapeshifter_l3",
  "variant_parent_id": "nc_tc_005",
  "notes": "Unique vulnerability caused by compiler bug, not logic error. The Curve contracts followed best practices and used @nonreentrant decorator, but Vyper compiler generated incorrect bytecode. Affected multiple high-value pools (pETH/ETH, msETH/ETH, alETH/ETH). Multiple attackers exploited within hours of discovery. Demonstrates importance of compiler audits and defense-in-depth strategies.",
  "contract_file": "contracts/ss_tc_005.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "transformation": {
    "type": "shapeshifter",
    "level": "l3",
    "includes": [
      "L1 formatting",
      "L2 hex identifiers",
      "L3 control flow"
    ],
    "identifier_style": "hex",
    "intensity": "medium",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/contracts/nc_tc_005.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/metadata/nc_tc_005.json",
    "script": "strategies/shapeshifter/shapeshifter_tc.py",
    "changes": [
      "Stripped existing line markers",
      "Renamed 28 identifiers using hex style",
      "Applied L1 tight formatting (removed blank lines, K&R braces)",
      "Added fresh sequential line markers"
    ],
    "rename_map": {
      "_handleETHTransfer": "_0x390062",
      "remove_liquidity": "_0x0cce35",
      "min_mint_amount": "_0x8cd0a4",
      "add_liquidity": "_0x7d6277",
      "totalLPSupply": "_0x7248ad",
      "_NOT_ENTERED": "_0x477183",
      "min_amounts": "_0x347a3f",
      "totalValue": "_0x2c833f",
      "lpBalances": "_0xd80623",
      "lpBurned": "_0x1045d1",
      "provider": "_0x0f4194",
      "lpAmount": "_0x2ff8d2",
      "balances": "_0x6ff151",
      "lpToMint": "_0x771f54",
      "lpMinted": "_0x0d961f",
      "exchange": "_0x65ce0c",
      "_ENTERED": "_0xd6cb4d",
      "_status": "_0x70dd97",
      "amount0": "_0xe5feba",
      "amount1": "_0x8e6f03",
      "success": "_0x0353ce",
      "amounts": "_0x51bedd",
      "min_dy": "_0xd860ea",
      "amount": "_0xae3550",
      "ui": "_0x8e4527",
      "dy": "_0x4f9b02",
      "uj": "_0x6e3d9a",
      "dx": "_0xac561e"
    },
    "coverage_percent": 73.68,
    "identifiers_transformed": 28,
    "created_date": "2025-12-31T19:59:41.137313"
  },
  "sanitized_from": "ms_tc_005"
}
schema_version: "1.0"
sample_id: "ms_tc_008"
vulnerability_type: "reentrancy"
vulnerable_lines: [31]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  # --- State Variables ---

  - id: "CA1"
    type: "DECLARATION"
    lines: [5]
    code: "mapping(address => uint256) public credit;"
    security_function: "BENIGN"
    rationale: "Balance mapping declaration. The existence of storage is not the vulnerability - almost every payable contract has such a mapping."

  - id: "CA2"
    type: "DECLARATION"
    lines: [6]
    code: "uint256 public balance;"
    security_function: "BENIGN"
    rationale: "Balance tracking variable. Updated before external call so not part of reentrancy issue."

  # --- deposit function ---

  - id: "CA3"
    type: "STATE_MOD"
    lines: [12, 13]
    code: |
      credit[msg.sender] += msg.value;
      balance += msg.value;
    security_function: "BENIGN"
    rationale: "Deposit function updates state correctly. No reentrancy risk."

  # --- withdrawAll function (VULNERABLE) ---

  - id: "CA4"
    type: "DECLARATION"
    lines: [28]
    code: "uint256 oCredit = credit[msg.sender];"
    security_function: "BENIGN"
    rationale: "Local copy of credit balance. Correctly implemented."

  - id: "CA5"
    type: "CTRL_FLOW"
    lines: [29]
    code: "if (oCredit > 0) {"
    security_function: "BENIGN"
    rationale: "Check for positive balance. Correctly implemented."

  - id: "CA6"
    type: "STATE_MOD"
    lines: [30]
    code: "balance -= oCredit;"
    security_function: "BENIGN"
    rationale: "Updates balance before call. This variable is not vulnerable."

  - id: "CA7"
    type: "EXT_CALL"
    lines: [31]
    code: "bool callResult = msg.sender.call.value(oCredit)();"
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - External call that transfers ETH BEFORE credit[msg.sender] is zeroed. Attacker's fallback function can re-enter withdrawAll, which will see the same oCredit value since it hasn't been updated yet. This allows recursive draining."

  - id: "CA8"
    type: "INPUT_VAL"
    lines: [32]
    code: "require(callResult);"
    security_function: "BENIGN"
    rationale: "Checks call success. Correctly implemented but doesn't prevent reentrancy."

  - id: "CA9"
    type: "STATE_MOD"
    lines: [33]
    code: "credit[msg.sender] = 0;"
    security_function: "BENIGN"
    rationale: "State update that zeros credit. The operation itself is correct - it's just in the wrong order (after the external call instead of before). The root cause is CA7 which makes the external call before this update."

  # --- getCredit function ---

  - id: "CA10"
    type: "CTRL_FLOW"
    lines: [40, 41, 42]
    code: "function getCredit(address user) public view returns (uint256) { return credit[user]; }"
    security_function: "BENIGN"
    rationale: "View function returning credit balance. Correctly implemented."

  # ============================================
  # UNRELATED CODE ACTS (batched)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [8, 9, 10, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 37, 38, 39]
    security_function: "UNRELATED"
    rationale: "Inline comments and NatSpec documentation"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 11, 14, 27, 34, 35, 43]
    security_function: "UNRELATED"
    rationale: "Contract and function signature declarations, closing braces"

summary:
  total_code_acts: 13
  total_lines_covered: 39  # excludes empty lines

  by_security_function:
    ROOT_CAUSE: 1      # CA7
    PREREQ: 0
    BENIGN: 9          # CA1-CA6, CA8-CA10
    UNRELATED: 3       # batched

  root_causes:
    - id: "CA7"
      line: 31
      type: "EXT_CALL"
      description: "External call before state update - enables reentrancy (CEI violation)"

  attack_flow:
    - step: 1
      description: "Attacker deposits ETH, credit[attacker] = X"
    - step: 2
      description: "Attacker calls withdrawAll from malicious contract"
    - step: 3
      description: "Line 31 sends X ETH to attacker contract"
    - step: 4
      description: "Attacker's fallback re-enters withdrawAll"
    - step: 5
      description: "credit[attacker] still = X (line 33 hasn't run yet)"
    - step: 6
      description: "Repeat until contract is drained"

line_to_code_act:
    1: "CA_DIRECTIVES"
    2: "CA_DIRECTIVES"
    # Line 3: empty
    4: "CA_DECLARATIONS"
    5: "CA1"
    6: "CA2"
    # Line 7: empty
    8: "CA_COMMENTS"
    9: "CA_COMMENTS"
    10: "CA_COMMENTS"
    11: "CA_DECLARATIONS"
    12: "CA3"
    13: "CA3"
    14: "CA_DECLARATIONS"
    # Line 15: empty
    16: "CA_COMMENTS"
    17: "CA_COMMENTS"
    18: "CA_COMMENTS"
    19: "CA_COMMENTS"
    20: "CA_COMMENTS"
    21: "CA_COMMENTS"
    22: "CA_COMMENTS"
    23: "CA_COMMENTS"
    24: "CA_COMMENTS"
    25: "CA_COMMENTS"
    26: "CA_COMMENTS"
    27: "CA_DECLARATIONS"
    28: "CA4"
    29: "CA5"
    30: "CA6"
    31: "CA7"
    32: "CA8"
    33: "CA9"
    34: "CA_DECLARATIONS"
    35: "CA_DECLARATIONS"
    # Line 36: empty
    37: "CA_COMMENTS"
    38: "CA_COMMENTS"
    39: "CA_COMMENTS"
    40: "CA10"
    41: "CA10"
    42: "CA10"
    43: "CA_DECLARATIONS"
    # Line 44: empty

code_act_security_functions:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "ROOT_CAUSE"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"

schema_version: "1.0"
sample_id: "ms_tc_003"
vulnerability_type: "access_control"
vulnerability_subtype: "unprotected_initialization_delegatecall"
vulnerable_lines: [20]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  - id: "CA1"
    type: "ACCESS_CTRL"
    lines: [20]
    code: ") public {"
    security_function: "ROOT_CAUSE"
    rationale: "initWallet is public with NO initialization guard. Anyone can call this directly on the library contract (not via delegatecall) to become an owner. The function should have require(!initialized) but doesn't."

  - id: "CA2"
    type: "FUND_XFER"
    lines: [62]
    code: "selfdestruct(_to);"
    security_function: "PREREQ"
    rationale: "Executes selfdestruct which destroys the library contract. This is the destructive action enabled by the root cause (unprotected initWallet), not the root cause itself. The selfdestruct is correctly guarded by isOwner check - it's only exploitable because ownership can be hijacked via CA1."

  - id: "CA3"
    type: "STATE_MOD"
    lines: [44]
    code: "initialized = true;"
    security_function: "PREREQ"
    rationale: "Sets initialized flag but happens AFTER ownership is granted, and there's no require(!initialized) check at function entry. This allows repeated reinitialization."

  - id: "CA4"
    type: "STATE_MOD"
    lines: [38]
    code: "isOwner[owner] = true;"
    security_function: "PREREQ"
    rationale: "Grants owner status. Prerequisite because this enables the attacker to pass the isOwner check in kill() after calling initWallet()."

  - id: "CA5"
    type: "INPUT_VAL"
    lines: [57]
    code: 'require(isOwner[msg.sender], "Not an owner");'
    security_function: "INSUFF_GUARD"
    rationale: "Checks if caller is owner, but this is insufficient because anyone can become owner by calling unprotected initWallet() first. Guard is present but bypassable."

  - id: "CA6"
    type: "STATE_MOD"
    lines: [28]
    code: "isOwner[owners[i]] = false;"
    security_function: "BENIGN"
    rationale: "Clears previous owner status. Part of reinitialization logic."

  - id: "CA7"
    type: "STATE_MOD"
    lines: [30]
    code: "delete owners;"
    security_function: "BENIGN"
    rationale: "Clears owners array. Part of reinitialization logic."

  - id: "CA8"
    type: "INPUT_VAL"
    lines: [35]
    code: 'require(owner != address(0), "Invalid owner");'
    security_function: "BENIGN"
    rationale: "Validates owner address is not zero. Correctly implemented."

  - id: "CA9"
    type: "INPUT_VAL"
    lines: [36]
    code: 'require(!isOwner[owner], "Duplicate owner");'
    security_function: "BENIGN"
    rationale: "Prevents duplicate owners. Correctly implemented."

  - id: "CA10"
    type: "STATE_MOD"
    lines: [39]
    code: "owners.push(owner);"
    security_function: "BENIGN"
    rationale: "Adds owner to array. Correctly implemented."

  - id: "CA11"
    type: "EVENT_EMIT"
    lines: [40]
    code: "emit OwnerAdded(owner);"
    security_function: "BENIGN"
    rationale: "Event emission for logging."

  - id: "CA12"
    type: "STATE_MOD"
    lines: [43]
    code: "required = _required;"
    security_function: "BENIGN"
    rationale: "Sets required signatures. Correctly implemented."

  - id: "CA13"
    type: "EVENT_EMIT"
    lines: [59]
    code: "emit WalletDestroyed(msg.sender);"
    security_function: "BENIGN"
    rationale: "Event emission for logging before destruction."

  - id: "CA14"
    type: "STORAGE_READ"
    lines: [53]
    code: "return isOwner[_addr];"
    security_function: "BENIGN"
    rationale: "Returns owner status. View function, correctly implemented."

  - id: "CA15"
    type: "INPUT_VAL"
    lines: [70]
    code: 'require(isOwner[msg.sender], "Not an owner");'
    security_function: "BENIGN"
    rationale: "Access control in execute(). Correctly implemented."

  - id: "CA16"
    type: "EXT_CALL"
    lines: [72]
    code: "(bool success, ) = to.call{value: value}(data);"
    security_function: "BENIGN"
    rationale: "External call in execute(). Protected by owner check, correctly implemented."

  - id: "CA17"
    type: "INPUT_VAL"
    lines: [73]
    code: 'require(success, "Execution failed");'
    security_function: "BENIGN"
    rationale: "Checks external call success. Correctly implemented."

  # ============================================
  # PROXY CONTRACT CODE ACTS
  # ============================================

  - id: "CA18"
    type: "STATE_MOD"
    lines: [85]
    code: "libraryAddress = _library;"
    security_function: "BENIGN"
    rationale: "Sets library address in proxy constructor. Correctly implemented."

  - id: "CA19"
    type: "DELEGATE"
    lines: [98]
    code: "let result := delegatecall(gas(), lib, 0, calldatasize(), 0, 0)"
    security_function: "BENIGN"
    rationale: "Delegatecall to library. The proxy itself is correct; the issue is the library being destroyable."

  # ============================================
  # BATCHED UNRELATED CODE ACTS (for scoring)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [5, 10, 32, 47, 48, 49, 50, 51, 61, 65, 66, 67, 68, 77, 78, 79, 81, 88, 89, 90, 91, 95]
    security_function: "UNRELATED"
    rationale: "Inline comments and NatSpec documentation"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 6, 7, 8, 11, 13, 14, 16, 17, 18, 19, 27, 33, 34, 52, 56, 69, 80, 82, 84, 92, 93, 94, 96, 97, 99, 101, 102, 103, 105, 106, 111]
    security_function: "UNRELATED"
    rationale: "Contract, struct, mapping, function signature, and local variable declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [29, 41, 45, 54, 63, 74, 75, 86, 104, 107, 108, 109, 112]
    security_function: "UNRELATED"
    rationale: "Closing braces and structural tokens"

summary:
  total_code_acts: 23
  total_lines_covered: 86  # excludes 27 empty lines (3, 9, 12, 15, 21, 22, 23, 24, 25, 26, 31, 37, 42, 46, 55, 58, 60, 61, 64, 71, 76, 83, 87, 94, 100, 110, 113)

  by_security_function:
    ROOT_CAUSE: 1      # CA1
    PREREQ: 3          # CA2, CA3, CA4
    INSUFF_GUARD: 1    # CA5
    BENIGN: 14         # CA6-CA19
    UNRELATED: 4       # batched

  by_code_act_type:
    ACCESS_CTRL: 1
    FUND_XFER: 1
    STATE_MOD: 6
    INPUT_VAL: 5
    EVENT_EMIT: 2
    STORAGE_READ: 1
    EXT_CALL: 1
    DELEGATE: 1
    DIRECTIVE: 1
    COMMENT: 1
    DECLARATION: 1
    SYNTAX: 1

  root_causes:
    - id: "CA1"
      line: 20
      type: "ACCESS_CTRL"
      description: "Unprotected initWallet - no require(!initialized) check"

  prerequisites:
    - id: "CA2"
      line: 62
      type: "FUND_XFER"
      description: "selfdestruct - destructive action enabled by root cause"
    - id: "CA3"
      line: 44
      type: "STATE_MOD"
      description: "Sets initialized=true but after ownership granted"
    - id: "CA4"
      line: 38
      type: "STATE_MOD"
      description: "Grants owner status enabling kill() access"

  insufficient_guards:
    - id: "CA5"
      line: 57
      type: "INPUT_VAL"
      description: "isOwner check bypassable via unprotected init"

  vulnerable_lines_mapping:
    20: "CA1 - ROOT_CAUSE - unprotected public function"

  # For scoring: lookup line -> code_act -> security_function
line_to_code_act:
  # Directives (UNRELATED)
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Contract/declarations (UNRELATED)
  4: "CA_DECLARATIONS"
  6: "CA_DECLARATIONS"
  7: "CA_DECLARATIONS"
  8: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  13: "CA_DECLARATIONS"
  14: "CA_DECLARATIONS"
  16: "CA_DECLARATIONS"
  17: "CA_DECLARATIONS"
  18: "CA_DECLARATIONS"
  19: "CA_DECLARATIONS"
  # Comments (UNRELATED)
  5: "CA_COMMENTS"
  10: "CA_COMMENTS"
  32: "CA_COMMENTS"
  47: "CA_COMMENTS"
  48: "CA_COMMENTS"
  49: "CA_COMMENTS"
  50: "CA_COMMENTS"
  51: "CA_COMMENTS"
  # Line 61: empty
  65: "CA_COMMENTS"
  66: "CA_COMMENTS"
  67: "CA_COMMENTS"
  68: "CA_COMMENTS"
  77: "CA_COMMENTS"
  78: "CA_COMMENTS"
  79: "CA_COMMENTS"
  81: "CA_COMMENTS"
  88: "CA_COMMENTS"
  89: "CA_COMMENTS"
  90: "CA_COMMENTS"
  91: "CA_COMMENTS"
  95: "CA_COMMENTS"
  # === SECURITY-RELEVANT CODE ACTS ===
  # initWallet() function
  20: "CA1"       # ROOT_CAUSE - unprotected public
  27: "CA_DECLARATIONS"
  28: "CA6"       # clear owner status
  29: "CA_SYNTAX"
  30: "CA7"       # delete owners
  33: "CA_DECLARATIONS"
  34: "CA_DECLARATIONS"
  35: "CA8"       # zero check
  36: "CA9"       # duplicate check
  38: "CA4"       # PREREQ - grant owner
  39: "CA10"      # push owner
  40: "CA11"      # emit event
  41: "CA_SYNTAX"
  43: "CA12"      # set required
  44: "CA3"       # PREREQ - set initialized
  45: "CA_SYNTAX"
  # isOwnerAddress() function
  52: "CA_DECLARATIONS"
  53: "CA14"      # return isOwner
  54: "CA_SYNTAX"
  # kill() function
  56: "CA_DECLARATIONS"
  57: "CA5"       # INSUFF_GUARD - owner check
  59: "CA13"      # emit event
  62: "CA2"       # ROOT_CAUSE - selfdestruct
  63: "CA_SYNTAX"
  # execute() function
  69: "CA_DECLARATIONS"
  70: "CA15"      # owner check
  72: "CA16"      # external call
  73: "CA17"      # success check
  74: "CA_SYNTAX"
  75: "CA_SYNTAX"
  # ParityWalletProxy contract
  80: "CA_DECLARATIONS"
  82: "CA_DECLARATIONS"
  84: "CA_DECLARATIONS"
  85: "CA18"      # set library address
  86: "CA_SYNTAX"
  92: "CA_DECLARATIONS"
  93: "CA_DECLARATIONS"
  # Line 94: empty
  96: "CA_DECLARATIONS"
  97: "CA_DECLARATIONS"
  98: "CA19"      # delegatecall
  99: "CA_DECLARATIONS"
  # 100 is empty
  101: "CA_DECLARATIONS"
  102: "CA_DECLARATIONS"
  103: "CA_DECLARATIONS"
  104: "CA_SYNTAX"
  105: "CA_DECLARATIONS"
  106: "CA_DECLARATIONS"
  107: "CA_SYNTAX"
  108: "CA_SYNTAX"
  109: "CA_SYNTAX"
  # Line 110: empty
  111: "CA_DECLARATIONS"
  112: "CA_SYNTAX"

code_act_security_functions:
  CA1: "ROOT_CAUSE"
  CA2: "PREREQ"
  CA3: "PREREQ"
  CA4: "PREREQ"
  CA5: "INSUFF_GUARD"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "BENIGN"
  CA14: "BENIGN"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA17: "BENIGN"
  CA18: "BENIGN"
  CA19: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

schema_version: "1.0"
sample_id: "ms_tc_020"
vulnerability_type: "accounting_manipulation"
vulnerable_lines: [78, 97, 119, 128]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    lines: [23, 24, 25, 26, 27]
    code: |
      struct Position {
          address owner;
          uint256 collateral;
          uint256 debtShare;
      }
    security_function: "BENIGN"
    rationale: "Position struct declaration. The struct is neutral - it's how shares are computed (CA11) that is vulnerable, not the struct definition."

  - id: "CA2"
    type: "DECLARATION"
    lines: [29, 30]
    code: |
      mapping(uint256 => Position) public positions;
      uint256 public nextPositionId;
    security_function: "BENIGN"
    rationale: "Position storage mapping. Correctly implemented."

  - id: "CA3"
    type: "DECLARATION"
    lines: [32, 33, 34]
    code: |
      address public cToken;
      uint256 public totalDebt;
      uint256 public totalDebtShare;
    security_function: "BENIGN"
    rationale: "Storage variable declarations. These are architectural context - the vulnerability is in the share calculation logic (CA11) that uses these variables, not the declarations themselves."

  - id: "CA4"
    type: "INITIALIZATION"
    lines: [36, 37, 38, 39]
    code: |
      constructor(address _cToken) {
          cToken = _cToken;
          nextPositionId = 1;
      }
    security_function: "BENIGN"
    rationale: "Constructor initializes cToken address and position counter."

  - id: "CA5"
    type: "STATE_MOD"
    lines: [48]
    code: "positionId = nextPositionId++;"
    security_function: "BENIGN"
    rationale: "Position ID assignment. Correctly increments."

  - id: "CA6"
    type: "STATE_MOD"
    lines: [50, 51, 52, 53, 54]
    code: |
      positions[positionId] = Position({
          owner: msg.sender,
          collateral: collateralAmount,
          debtShare: 0
      });
    security_function: "BENIGN"
    rationale: "Position initialization. debtShare starts at 0, updated by _borrow."

  - id: "CA7"
    type: "CTRL_FLOW"
    lines: [60]
    code: "_borrow(positionId, borrowAmount);"
    security_function: "BENIGN"
    rationale: "Call to _borrow function. The call site is benign - the vulnerability is in _borrow itself (CA11), not the act of calling it."

  - id: "CA8"
    type: "CTRL_FLOW"
    lines: [62]
    code: "return positionId;"
    security_function: "BENIGN"
    rationale: "Return statement."

  - id: "CA9"
    type: "CTRL_FLOW"
    lines: [69]
    code: "Position storage pos = positions[positionId];"
    security_function: "BENIGN"
    rationale: "Position reference for _borrow. Correctly accesses storage."

  - id: "CA10"
    type: "CTRL_FLOW"
    lines: [72, 74, 75, 76]
    code: |
      uint256 share;
      if (totalDebtShare == 0) {
          share = amount;
      } else {
    security_function: "BENIGN"
    rationale: "Standard branching logic for first-borrow vs subsequent-borrow. This is normal control flow, not a vulnerability enabler."

  - id: "CA11"
    type: "COMPUTATION"
    lines: [78, 79]
    code: |
      share = (amount * totalDebtShare) / totalDebt;
      }
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - Debt share calculation depends on totalDebt which can be manipulated via external pool state changes. When totalDebt is artificially inflated, this formula returns fewer shares than deserved, causing attacker's debt to appear smaller than actual borrowed amount."

  - id: "CA12"
    type: "STATE_MOD"
    lines: [81, 82, 83]
    code: |
      pos.debtShare += share;
      totalDebtShare += share;
      totalDebt += amount;
    security_function: "BENIGN"
    rationale: "State updates after share calculation. These operations are correct - they propagate whatever share was computed."

  - id: "CA13"
    type: "EXT_CALL"
    lines: [86]
    code: "ICErc20(cToken).borrow(amount);"
    security_function: "BENIGN"
    rationale: "External borrow from Iron Bank. Correctly implemented."

  - id: "CA14"
    type: "CTRL_FLOW"
    lines: [93]
    code: "Position storage pos = positions[positionId];"
    security_function: "BENIGN"
    rationale: "Position reference in repay."

  - id: "CA15"
    type: "ACCESS_CTRL"
    lines: [94]
    code: 'require(msg.sender == pos.owner, "Not position owner");'
    security_function: "BENIGN"
    rationale: "Owner check in repay. Correctly validates."

  - id: "CA16"
    type: "COMPUTATION"
    lines: [97]
    code: "uint256 shareToRemove = (amount * totalDebtShare) / totalDebt;"
    security_function: "BENIGN"
    rationale: "Share removal calculation in repay. Uses same formula as borrow - this is downstream impact, not an independent vulnerability."

  - id: "CA17"
    type: "INPUT_VAL"
    lines: [99]
    code: 'require(pos.debtShare >= shareToRemove, "Excessive repayment");'
    security_function: "BENIGN"
    rationale: "Repayment validation. Correctly checks share bounds."

  - id: "CA18"
    type: "STATE_MOD"
    lines: [101, 102, 103]
    code: |
      pos.debtShare -= shareToRemove;
      totalDebtShare -= shareToRemove;
      totalDebt -= amount;
    security_function: "BENIGN"
    rationale: "Repayment state updates. Correctly decrements."

  - id: "CA19"
    type: "CTRL_FLOW"
    lines: [114]
    code: "Position storage pos = positions[positionId];"
    security_function: "BENIGN"
    rationale: "Position reference in getPositionDebt."

  - id: "CA20"
    type: "CTRL_FLOW"
    lines: [116]
    code: "if (totalDebtShare == 0) return 0;"
    security_function: "BENIGN"
    rationale: "Zero division guard."

  - id: "CA21"
    type: "COMPUTATION"
    lines: [119]
    code: "return (pos.debtShare * totalDebt) / totalDebtShare;"
    security_function: "BENIGN"
    rationale: "Debt calculation in view function. Uses inverse formula - downstream impact of incorrect shares, not the root cause."

  - id: "CA22"
    type: "CTRL_FLOW"
    lines: [126]
    code: "Position storage pos = positions[positionId];"
    security_function: "BENIGN"
    rationale: "Position reference in liquidate."

  - id: "CA23"
    type: "COMPUTATION"
    lines: [128]
    code: "uint256 debt = (pos.debtShare * totalDebt) / totalDebtShare;"
    security_function: "BENIGN"
    rationale: "Debt calculation in liquidate. Uses same formula - downstream impact where incorrect shares cause wrong debt valuation."

  - id: "CA24"
    type: "INPUT_VAL"
    lines: [132]
    code: 'require(pos.collateral * 100 < debt * 150, "Position is healthy");'
    security_function: "BENIGN"
    rationale: "Liquidation health check. Correctly validates collateral ratio."

  - id: "CA25"
    type: "STATE_MOD"
    lines: [135, 136]
    code: |
      pos.collateral = 0;
      pos.debtShare = 0;
    security_function: "BENIGN"
    rationale: "Liquidation state reset. Correctly clears position."

  # ============================================
  # BATCHED UNRELATED CODE ACTS (for scoring)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [41, 42, 43, 56, 57, 59, 65, 66, 67, 71, 85, 89, 90, 91, 96, 105, 108, 109, 110, 118, 122, 123, 124, 130, 131, 134]
    security_function: "UNRELATED"
    rationale: "NatSpec documentation and inline comments"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 7, 9, 10, 11, 12, 13, 14, 16, 17, 19, 20, 22, 44, 45, 46, 47, 63, 68, 87, 92, 106, 111, 112, 113, 120, 125, 137, 138]
    security_function: "UNRELATED"
    rationale: "Interface, contract, and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: []
    security_function: "UNRELATED"
    rationale: "Closing braces (included in respective code_acts)"

summary:
  total_code_acts: 29
  total_lines_covered: 106

  by_security_function:
    ROOT_CAUSE: 1      # CA11
    PREREQ: 0
    BENIGN: 24         # CA1-CA10, CA12-CA25
    UNRELATED: 4       # batched

  root_causes:
    - id: "CA11"
      lines: [78, 79]
      type: "COMPUTATION"
      description: "Share calculation depends on manipulable totalDebt"

  prerequisites: []

line_to_code_act:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  # Line 6: empty
  7: "CA_DECLARATIONS"
  # Line 8: empty
  9: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  12: "CA_DECLARATIONS"
  13: "CA_DECLARATIONS"
  14: "CA_DECLARATIONS"
  # Line 15: empty
  16: "CA_DECLARATIONS"
  17: "CA_DECLARATIONS"
  # Line 18: empty
  19: "CA_DECLARATIONS"
  20: "CA_DECLARATIONS"
  # Line 21: empty
  22: "CA_DECLARATIONS"
  23: "CA1"
  24: "CA1"
  25: "CA1"
  26: "CA1"
  27: "CA1"
  # Line 28: empty
  29: "CA2"
  30: "CA2"
  # Line 31: empty
  32: "CA3"
  33: "CA3"
  34: "CA3"
  # Line 35: empty
  36: "CA4"
  37: "CA4"
  38: "CA4"
  39: "CA4"
  # Line 40: empty
  41: "CA_COMMENTS"
  42: "CA_COMMENTS"
  43: "CA_COMMENTS"
  44: "CA_DECLARATIONS"
  45: "CA_DECLARATIONS"
  46: "CA_DECLARATIONS"
  47: "CA_DECLARATIONS"
  48: "CA5"
  # Line 49: empty
  50: "CA6"
  51: "CA6"
  52: "CA6"
  53: "CA6"
  54: "CA6"
  # Line 55: empty
  56: "CA_COMMENTS"
  57: "CA_COMMENTS"
  # Line 58: empty
  59: "CA_COMMENTS"
  60: "CA7"
  # Line 61: empty
  62: "CA8"
  63: "CA_DECLARATIONS"
  # Line 64: empty
  65: "CA_COMMENTS"
  66: "CA_COMMENTS"
  67: "CA_COMMENTS"
  68: "CA_DECLARATIONS"
  69: "CA9"
  # Line 70: empty
  71: "CA_COMMENTS"
  72: "CA10"
  # Line 73: empty
  74: "CA10"
  75: "CA10"
  76: "CA10"
  # Line 77: empty
  78: "CA11"
  79: "CA11"
  # Line 80: empty
  81: "CA12"
  82: "CA12"
  83: "CA12"
  # Line 84: empty
  85: "CA_COMMENTS"
  86: "CA13"
  87: "CA_DECLARATIONS"
  # Line 88: empty
  89: "CA_COMMENTS"
  90: "CA_COMMENTS"
  91: "CA_COMMENTS"
  92: "CA_DECLARATIONS"
  93: "CA14"
  94: "CA15"
  # Line 95: empty
  96: "CA_COMMENTS"
  97: "CA16"
  # Line 98: empty
  99: "CA17"
  # Line 100: empty
  101: "CA18"
  102: "CA18"
  103: "CA18"
  # Line 104: empty
  105: "CA_COMMENTS"
  106: "CA_DECLARATIONS"
  # Line 107: empty
  108: "CA_COMMENTS"
  109: "CA_COMMENTS"
  110: "CA_COMMENTS"
  111: "CA_DECLARATIONS"
  112: "CA_DECLARATIONS"
  113: "CA_DECLARATIONS"
  114: "CA19"
  # Line 115: empty
  116: "CA20"
  # Line 117: empty
  118: "CA_COMMENTS"
  119: "CA21"
  120: "CA_DECLARATIONS"
  # Line 121: empty
  122: "CA_COMMENTS"
  123: "CA_COMMENTS"
  124: "CA_COMMENTS"
  125: "CA_DECLARATIONS"
  126: "CA22"
  # Line 127: empty
  128: "CA23"
  # Line 129: empty
  130: "CA_COMMENTS"
  131: "CA_COMMENTS"
  132: "CA24"
  # Line 133: empty
  134: "CA_COMMENTS"
  135: "CA25"
  136: "CA25"
  137: "CA_DECLARATIONS"
  138: "CA_DECLARATIONS"
  # Line 139: empty

code_act_security_functions:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "ROOT_CAUSE"
  CA12: "BENIGN"
  CA13: "BENIGN"
  CA14: "BENIGN"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA17: "BENIGN"
  CA18: "BENIGN"
  CA19: "BENIGN"
  CA20: "BENIGN"
  CA21: "BENIGN"
  CA22: "BENIGN"
  CA23: "BENIGN"
  CA24: "BENIGN"
  CA25: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

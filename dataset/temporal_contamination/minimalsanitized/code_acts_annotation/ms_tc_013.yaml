schema_version: "1.0"
sample_id: "ms_tc_013"
vulnerability_type: "reentrancy"
vulnerable_lines: [80]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    lines: [14]
    code: "mapping(address => uint256) public balances;"
    security_function: "BENIGN"
    rationale: "Balance mapping declaration. Storage existence is not a vulnerability."

  - id: "CA2"
    type: "DECLARATION"
    lines: [15, 16, 17]
    code: |
      uint256 public totalSupply;
      uint256 public totalAssetBorrow;
      uint256 public totalAssetSupply;
    security_function: "BENIGN"
    rationale: "Supply tracking variables. Not directly exploitable."

  - id: "CA3"
    type: "COMPUTATION"
    lines: [25, 26]
    code: |
      uint256 currentPrice = _tokenPrice();
      mintAmount = (msg.value * 1e18) / currentPrice;
    security_function: "BENIGN"
    rationale: "Token price calculation in mint. Correctly computes mint amount."

  - id: "CA4"
    type: "STATE_MOD"
    lines: [28, 29, 30]
    code: |
      balances[receiver] += mintAmount;
      totalSupply += mintAmount;
      totalAssetSupply += msg.value;
    security_function: "BENIGN"
    rationale: "Mint state updates. Correctly tracks balances."

  - id: "CA5"
    type: "INPUT_VAL"
    lines: [54]
    code: 'require(balances[msg.sender] >= amount, "Insufficient balance");'
    security_function: "BENIGN"
    rationale: "Balance check. This is neutral validation, not a prerequisite - it doesn't enable reentrancy."

  - id: "CA6"
    type: "STATE_MOD"
    lines: [56, 57]
    code: |
      balances[msg.sender] -= amount;
      balances[to] += amount;
    security_function: "BENIGN"
    rationale: "State updates before external call. This is correct CEI usage - the bug is the callback after, not the state updates."

  - id: "CA7"
    type: "CTRL_FLOW"
    lines: [59]
    code: "_notifyTransfer(msg.sender, to, amount);"
    security_function: "BENIGN"
    rationale: "Call site to _notifyTransfer. The vulnerability is the external call inside _notifyTransfer (CA9), not this call site."

  - id: "CA8"
    type: "CTRL_FLOW"
    lines: [77]
    code: "if (_isContract(to)) {"
    security_function: "BENIGN"
    rationale: "Branch selector for callback path. This is attack surface selection, not a prerequisite."

  - id: "CA9"
    type: "EXT_CALL"
    lines: [80, 81]
    code: |
      (bool success, ) = to.call("");
      success;
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - External call to recipient contract without gas limit. Triggers fallback function which can reenter transfer() or other functions."

  - id: "CA10"
    type: "INPUT_VAL"
    lines: [92]
    code: 'require(balances[msg.sender] >= amount, "Insufficient balance");'
    security_function: "BENIGN"
    rationale: "Balance check in burnToEther. Correctly validates."

  - id: "CA11"
    type: "COMPUTATION"
    lines: [94, 95]
    code: |
      uint256 currentPrice = _tokenPrice();
      ethAmount = (amount * currentPrice) / 1e18;
    security_function: "BENIGN"
    rationale: "ETH calculation in burn. Correctly computes redemption amount."

  - id: "CA12"
    type: "STATE_MOD"
    lines: [97, 98, 99]
    code: |
      balances[msg.sender] -= amount;
      totalSupply -= amount;
      totalAssetSupply -= ethAmount;
    security_function: "BENIGN"
    rationale: "Burn state updates. Correctly updates before transfer."

  - id: "CA13"
    type: "EXT_CALL"
    lines: [101]
    code: "payable(receiver).transfer(ethAmount);"
    security_function: "BENIGN"
    rationale: "ETH transfer in burn. Uses transfer() with 2300 gas limit."

  - id: "CA14"
    type: "COMPUTATION"
    lines: [110, 111, 112, 113, 114, 115]
    code: |
      function _tokenPrice() internal view returns (uint256) {
          if (totalSupply == 0) {
              return 1e18; // Initial price 1:1
          }
          return (totalAssetSupply * 1e18) / totalSupply;
      }
    security_function: "BENIGN"
    rationale: "Token price calculation. Correctly handles zero supply case."

  - id: "CA15"
    type: "COMPUTATION"
    lines: [120, 121, 122, 123, 124, 125, 126]
    code: |
      function _isContract(address account) internal view returns (bool) {
          uint256 size;
          assembly {
              size := extcodesize(account)
          }
          return size > 0;
      }
    security_function: "BENIGN"
    rationale: "Contract detection helper. This is contextual logic that selects the callback path, not a prerequisite."

  - id: "CA16"
    type: "CTRL_FLOW"
    lines: [128, 129, 130]
    code: |
      function balanceOf(address account) external view returns (uint256) {
          return balances[account];
      }
    security_function: "BENIGN"
    rationale: "View function. No security impact."

  # ============================================
  # BATCHED UNRELATED CODE ACTS (for scoring)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [19, 20, 21, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 64, 65, 66, 67, 73, 74, 76, 78, 85, 86, 87, 106, 107, 108, 117, 118, 119]
    security_function: "UNRELATED"
    rationale: "Inline comments and NatSpec documentation"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 7, 8, 10, 11, 12, 22, 23, 24, 32, 53, 68, 69, 70, 71, 72, 88, 89, 90, 91, 103, 131, 132, 133]
    security_function: "UNRELATED"
    rationale: "Interface, contract, name, symbol, and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [6, 33, 61, 62, 82, 83, 104]
    security_function: "UNRELATED"
    rationale: "Closing braces"

summary:
  total_code_acts: 20
  total_lines_covered: 108  # excludes 27 empty lines

  by_security_function:
    ROOT_CAUSE: 1      # CA9
    PREREQ: 0
    BENIGN: 15         # CA1-CA8, CA10-CA16
    UNRELATED: 4       # batched

  root_causes:
    - id: "CA9"
      lines: [80, 81]
      type: "EXT_CALL"
      description: "External call to recipient triggers fallback enabling reentrancy"

line_to_code_act:
  # Directives (UNRELATED)
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  # IERC20 interface (UNRELATED)
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  # Line 6: empty
  7: "CA_DECLARATIONS"
  8: "CA_DECLARATIONS"
  # Line 9: empty
  # BZXLoanToken contract
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  12: "CA_DECLARATIONS"
  # Line 13: empty
  14: "CA1"
  15: "CA2"
  16: "CA2"
  17: "CA2"
  # Line 18: empty
  19: "CA_COMMENTS"
  20: "CA_COMMENTS"
  21: "CA_COMMENTS"
  22: "CA_DECLARATIONS"
  23: "CA_DECLARATIONS"
  24: "CA_DECLARATIONS"
  25: "CA3"
  26: "CA3"
  # Line 27: empty
  28: "CA4"
  29: "CA4"
  30: "CA4"
  # Line 31: empty
  32: "CA_DECLARATIONS"
  33: "CA_SYNTAX"
  # Line 34: empty
  35: "CA_COMMENTS"
  36: "CA_COMMENTS"
  37: "CA_COMMENTS"
  38: "CA_COMMENTS"
  39: "CA_COMMENTS"
  40: "CA_COMMENTS"
  41: "CA_COMMENTS"
  42: "CA_COMMENTS"
  43: "CA_COMMENTS"
  44: "CA_COMMENTS"
  45: "CA_COMMENTS"
  46: "CA_COMMENTS"
  47: "CA_COMMENTS"
  48: "CA_COMMENTS"
  49: "CA_COMMENTS"
  50: "CA_COMMENTS"
  51: "CA_COMMENTS"
  52: "CA_COMMENTS"
  53: "CA_DECLARATIONS"
  54: "CA5"
  # Line 55: empty
  56: "CA6"
  57: "CA6"
  # Line 58: empty
  59: "CA7"
  # Line 60: empty
  61: "CA_SYNTAX"
  62: "CA_SYNTAX"
  # Line 63: empty
  64: "CA_COMMENTS"
  65: "CA_COMMENTS"
  66: "CA_COMMENTS"
  67: "CA_COMMENTS"
  68: "CA_DECLARATIONS"
  69: "CA_DECLARATIONS"
  70: "CA_DECLARATIONS"
  71: "CA_DECLARATIONS"
  72: "CA_DECLARATIONS"
  # Line 73: empty
  # Line 74: empty
  # Line 75: empty
  76: "CA_COMMENTS"
  77: "CA8"
  78: "CA_COMMENTS"
  # Line 79: empty
  80: "CA9"
  81: "CA9"
  82: "CA_SYNTAX"
  83: "CA_SYNTAX"
  # Line 84: empty
  85: "CA_COMMENTS"
  86: "CA_COMMENTS"
  87: "CA_COMMENTS"
  88: "CA_DECLARATIONS"
  89: "CA_DECLARATIONS"
  90: "CA_DECLARATIONS"
  91: "CA_DECLARATIONS"
  92: "CA10"
  # Line 93: empty
  94: "CA11"
  95: "CA11"
  # Line 96: empty
  97: "CA12"
  98: "CA12"
  99: "CA12"
  # Line 100: empty
  101: "CA13"
  # Line 102: empty
  103: "CA_DECLARATIONS"
  104: "CA_SYNTAX"
  # Line 105: empty
  106: "CA_COMMENTS"
  107: "CA_COMMENTS"
  108: "CA_COMMENTS"
  109: "CA_COMMENTS"  # End of comment block
  110: "CA14"
  111: "CA14"
  112: "CA14"
  113: "CA14"
  114: "CA14"
  115: "CA14"
  # Line 116: empty
  117: "CA_COMMENTS"
  118: "CA_COMMENTS"
  119: "CA_COMMENTS"
  120: "CA15"
  121: "CA15"
  122: "CA15"
  123: "CA15"
  124: "CA15"
  125: "CA15"
  126: "CA15"
  # Line 127: empty
  128: "CA16"
  129: "CA16"
  130: "CA16"
  # Line 131: empty
  132: "CA_DECLARATIONS"
  133: "CA_DECLARATIONS"

code_act_security_functions:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "ROOT_CAUSE"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "BENIGN"
  CA14: "BENIGN"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

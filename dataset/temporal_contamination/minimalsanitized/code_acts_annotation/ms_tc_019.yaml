schema_version: "1.0"
sample_id: "ms_tc_019"
vulnerability_type: "arithmetic_error"
vulnerable_lines: [98, 99, 100, 101]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  - id: "CA1"
    type: "INPUT_VAL"
    lines: [98, 99, 100, 101, 102]
    code: |
      require(
          balance0Adjusted * balance1Adjusted >=
              uint256(_reserve0) * _reserve1 * (1000 ** 2),
          "UraniumSwap: K"
      );
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - K validation uses 1000^2 scale but fee calculation uses 10000 scale. This 100x mismatch allows K to inflate after each swap, enabling attacker to drain pool. The require() pattern is INPUT_VAL per taxonomy, with the bug being in the arithmetic formula inside."

  - id: "CA2"
    type: "DECLARATION"
    lines: [23]
    code: "uint256 public constant TOTAL_FEE = 16; // 0.16% fee"
    security_function: "BENIGN"
    rationale: "Fee constant declaration. Contextual - the fee value alone is not a prerequisite. The exploit depends on the interaction between the scale change (CA3) and incorrect K check (CA1)."

  - id: "CA3"
    type: "COMPUTATION"
    lines: [93, 94]
    code: |
      uint256 balance0Adjusted = balance0 * 10000 - amount0In * TOTAL_FEE;
      uint256 balance1Adjusted = balance1 * 10000 - amount1In * TOTAL_FEE;
    security_function: "PREREQ"
    rationale: "PREREQ - Adjusted balances use 10000 scale for fee calculation, but K check at line 100 uses 1000^2 scale, creating the exploitable mismatch."

  - id: "CA4"
    type: "INPUT_VAL"
    lines: [58, 59, 60, 61]
    code: |
      require(
          amount0Out > 0 || amount1Out > 0,
          "UraniumSwap: INSUFFICIENT_OUTPUT_AMOUNT"
      );
    security_function: "BENIGN"
    rationale: "Output amount validation. Correctly implemented."

  - id: "CA5"
    type: "STATE_MOD"
    lines: [63, 64]
    code: |
      uint112 _reserve0 = reserve0;
      uint112 _reserve1 = reserve1;
    security_function: "BENIGN"
    rationale: "Local reserve copies for gas optimization."

  - id: "CA6"
    type: "INPUT_VAL"
    lines: [66, 67, 68, 69]
    code: |
      require(
          amount0Out < _reserve0 && amount1Out < _reserve1,
          "UraniumSwap: INSUFFICIENT_LIQUIDITY"
      );
    security_function: "BENIGN"
    rationale: "Liquidity check. Correctly implemented."

  - id: "CA7"
    type: "EXT_CALL"
    lines: [72, 73]
    code: |
      if (amount0Out > 0) IERC20(token0).transfer(to, amount0Out);
      if (amount1Out > 0) IERC20(token1).transfer(to, amount1Out);
    security_function: "BENIGN"
    rationale: "Token transfers to recipient. Correctly implemented."

  - id: "CA8"
    type: "EXT_CALL"
    lines: [76, 77]
    code: |
      uint256 balance0 = IERC20(token0).balanceOf(address(this));
      uint256 balance1 = IERC20(token1).balanceOf(address(this));
    security_function: "BENIGN"
    rationale: "Balance reads after transfer."

  - id: "CA9"
    type: "COMPUTATION"
    lines: [80, 81, 82, 83, 84, 85]
    code: |
      uint256 amount0In = balance0 > _reserve0 - amount0Out
          ? balance0 - (_reserve0 - amount0Out)
          : 0;
      uint256 amount1In = balance1 > _reserve1 - amount1Out
          ? balance1 - (_reserve1 - amount1Out)
          : 0;
    security_function: "BENIGN"
    rationale: "Input amount calculation."

  - id: "CA10"
    type: "INPUT_VAL"
    lines: [87, 88, 89, 90]
    code: |
      require(
          amount0In > 0 || amount1In > 0,
          "UraniumSwap: INSUFFICIENT_INPUT_AMOUNT"
      );
    security_function: "BENIGN"
    rationale: "Input amount validation. Correctly implemented."

  - id: "CA11"
    type: "STATE_MOD"
    lines: [105, 106]
    code: |
      reserve0 = uint112(balance0);
      reserve1 = uint112(balance1);
    security_function: "BENIGN"
    rationale: "Reserve updates after swap."

  - id: "CA12"
    type: "EXT_CALL"
    lines: [34, 35]
    code: |
      uint256 balance0 = IERC20(token0).balanceOf(address(this));
      uint256 balance1 = IERC20(token1).balanceOf(address(this));
    security_function: "BENIGN"
    rationale: "Balance reads in mint function."

  - id: "CA13"
    type: "COMPUTATION"
    lines: [37, 38]
    code: |
      uint256 amount0 = balance0 - reserve0;
      uint256 amount1 = balance1 - reserve1;
    security_function: "BENIGN"
    rationale: "Amount calculation in mint."

  - id: "CA14"
    type: "COMPUTATION"
    lines: [41]
    code: "liquidity = sqrt(amount0 * amount1);"
    security_function: "BENIGN"
    rationale: "Liquidity calculation."

  - id: "CA15"
    type: "STATE_MOD"
    lines: [43, 44]
    code: |
      reserve0 = uint112(balance0);
      reserve1 = uint112(balance1);
    security_function: "BENIGN"
    rationale: "Reserve updates in mint."

  - id: "CA16"
    type: "CTRL_FLOW"
    lines: [46]
    code: "return liquidity;"
    security_function: "BENIGN"
    rationale: "Return statement."

  - id: "CA17"
    type: "CTRL_FLOW"
    lines: [113]
    code: "return (reserve0, reserve1, 0);"
    security_function: "BENIGN"
    rationale: "Return statement in getReserves."

  - id: "CA18"
    type: "COMPUTATION"
    lines: [120, 121, 122, 123, 124, 125, 126, 127, 128, 129]
    code: |
      if (y > 3) {
          z = y;
          uint256 x = y / 2 + 1;
          while (x < z) {
              z = x;
              x = (y / x + x) / 2;
          }
      } else if (y != 0) {
          z = 1;
      }
    security_function: "BENIGN"
    rationale: "Square root helper function implementation."

  # ============================================
  # BATCHED UNRELATED CODE ACTS (for scoring)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [30, 31, 32, 40, 49, 50, 51, 71, 75, 79, 92, 104, 109, 110, 111, 116, 117, 118]
    security_function: "UNRELATED"
    rationale: "Inline comments and NatSpec documentation"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 7, 9, 10, 11, 12, 13, 14, 16, 17, 18, 20, 21, 25, 26, 27, 28, 33, 52, 53, 54, 55, 56, 57, 112, 119]
    security_function: "UNRELATED"
    rationale: "Interface, contract, constructor, and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [47, 107, 114, 130, 131]
    security_function: "UNRELATED"
    rationale: "Closing braces"

summary:
  total_code_acts: 22
  total_lines_covered: 105

  by_security_function:
    ROOT_CAUSE: 1      # CA1
    PREREQ: 1          # CA3
    BENIGN: 16         # CA2, CA4-CA18
    UNRELATED: 4       # batched

  root_causes:
    - id: "CA1"
      lines: [98, 99, 100, 101, 102]
      type: "INPUT_VAL"
      description: "K validation uses 1000^2 instead of 10000^2 - invariant scale mismatch with fee calculation"

  prerequisites:
    - id: "CA3"
      description: "Adjusted balances use 10000 scale, mismatched with K check's 1000^2 scale"

line_to_code_act:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  # Line 6: empty
  7: "CA_DECLARATIONS"
  # Line 8: empty
  9: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  12: "CA_DECLARATIONS"
  13: "CA_DECLARATIONS"
  14: "CA_DECLARATIONS"
  # Line 15: empty
  16: "CA_DECLARATIONS"
  17: "CA_DECLARATIONS"
  18: "CA_DECLARATIONS"
  # Line 19: empty
  20: "CA_DECLARATIONS"
  21: "CA_DECLARATIONS"
  # Line 22: empty
  23: "CA2"
  # Line 24: empty
  25: "CA_DECLARATIONS"
  26: "CA_DECLARATIONS"
  27: "CA_DECLARATIONS"
  28: "CA_DECLARATIONS"
  # Line 29: empty
  30: "CA_COMMENTS"
  31: "CA_COMMENTS"
  32: "CA_COMMENTS"
  33: "CA_DECLARATIONS"
  34: "CA12"
  35: "CA12"
  # Line 36: empty
  37: "CA13"
  38: "CA13"
  # Line 39: empty
  40: "CA_COMMENTS"
  41: "CA14"
  # Line 42: empty
  43: "CA15"
  44: "CA15"
  # Line 45: empty
  46: "CA16"
  47: "CA_SYNTAX"
  # Line 48: empty
  49: "CA_COMMENTS"
  50: "CA_COMMENTS"
  51: "CA_COMMENTS"
  52: "CA_DECLARATIONS"
  53: "CA_DECLARATIONS"
  54: "CA_DECLARATIONS"
  55: "CA_DECLARATIONS"
  56: "CA_DECLARATIONS"
  57: "CA_DECLARATIONS"
  58: "CA4"
  59: "CA4"
  60: "CA4"
  61: "CA4"
  # Line 62: empty
  63: "CA5"
  64: "CA5"
  # Line 65: empty
  66: "CA6"
  67: "CA6"
  68: "CA6"
  69: "CA6"
  # Line 70: empty
  71: "CA_COMMENTS"
  72: "CA7"
  73: "CA7"
  # Line 74: empty
  75: "CA_COMMENTS"
  76: "CA8"
  77: "CA8"
  # Line 78: empty
  79: "CA_COMMENTS"
  80: "CA9"
  81: "CA9"
  82: "CA9"
  83: "CA9"
  84: "CA9"
  85: "CA9"
  # Line 86: empty
  87: "CA10"
  88: "CA10"
  89: "CA10"
  90: "CA10"
  # Line 91: empty
  92: "CA_COMMENTS"
  93: "CA3"
  94: "CA3"
  # Line 95: empty
  # Line 96: empty
  # Line 97: empty
  98: "CA1"
  99: "CA1"
  100: "CA1"
  101: "CA1"
  102: "CA1"
  # Line 103: empty
  104: "CA_COMMENTS"
  105: "CA11"
  106: "CA11"
  107: "CA_SYNTAX"
  # Line 108: empty
  109: "CA_COMMENTS"
  110: "CA_COMMENTS"
  111: "CA_COMMENTS"
  112: "CA_DECLARATIONS"
  113: "CA17"
  114: "CA_SYNTAX"
  # Line 115: empty
  116: "CA_COMMENTS"
  117: "CA_COMMENTS"
  118: "CA_COMMENTS"
  119: "CA_DECLARATIONS"
  120: "CA18"
  121: "CA18"
  122: "CA18"
  123: "CA18"
  124: "CA18"
  125: "CA18"
  126: "CA18"
  127: "CA18"
  128: "CA18"
  129: "CA18"
  130: "CA_SYNTAX"
  131: "CA_SYNTAX"
  # Line 132: empty

code_act_security_functions:
  CA1: "ROOT_CAUSE"
  CA2: "BENIGN"
  CA3: "PREREQ"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "BENIGN"
  CA14: "BENIGN"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA17: "BENIGN"
  CA18: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

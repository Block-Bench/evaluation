schema_version: "1.0"
sample_id: "ms_tc_029"
vulnerability_type: "arithmetic_manipulation"
vulnerable_lines: [59, 151]

code_acts:

  - id: "CA1"
    type: "COMPUTATION"
    lines: [59, 60, 61, 62]
    code: |
      reserve.liquidityIndex =
          currentLiquidityIndex +
          (amount * RAY) /
          (reserve.totalLiquidity + 1);
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - LiquidityIndex updated with each deposit. Through 151 nested flashloans, attacker inflates this to astronomical values causing rounding errors in withdrawal calculations."

  - id: "CA2"
    type: "COMPUTATION"
    lines: [149, 150, 151, 152]
    code: |
      function rayDiv(uint256 a, uint256 b) internal pure returns (uint256) {
          uint256 halfB = b / 2;
          require(b != 0, "Division by zero");
          return (a * RAY + halfB) / b;
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - Fixed-point division with rounding. At extreme liquidityIndex values, rounding errors allow extracting more tokens than deposited."

  - id: "CA3"
    type: "EXT_CALL"
    lines: [118, 119, 120, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 136, 137, 138, 139, 140, 141, 142]
    code: "flashLoan loop + callback"
    security_function: "BENIGN"
    rationale: "Flashloan function. Accelerates exploitation but isn't required - repeated deposit/withdraw cycles across blocks would also work."

  - id: "CA4"
    type: "EXT_CALL"
    lines: [48]
    code: "IERC20(asset).transferFrom(msg.sender, address(this), amount);"
    security_function: "BENIGN"
    rationale: "Token transfer in deposit. Correctly implemented."

  - id: "CA5"
    type: "STATE_MOD"
    lines: [50, 53, 54, 55, 56, 63]
    code: "Reserve data updates"
    security_function: "BENIGN"
    rationale: "Reserve state updates for deposit."

  - id: "CA6"
    type: "COMPUTATION"
    lines: [66]
    code: "uint256 rTokenAmount = rayDiv(amount, reserve.liquidityIndex);"
    security_function: "BENIGN"
    rationale: "rToken calculation in mint. Downstream value realization, not the root cause."

  - id: "CA7"
    type: "CTRL_FLOW"
    lines: [67]
    code: "_mintRToken(reserve.rTokenAddress, onBehalfOf, rTokenAmount);"
    security_function: "BENIGN"
    rationale: "Mint rTokens to user."

  - id: "CA8"
    type: "COMPUTATION"
    lines: [82]
    code: "uint256 rTokensToBurn = rayDiv(amount, reserve.liquidityIndex);"
    security_function: "BENIGN"
    rationale: "rToken calculation in burn. Downstream value realization, not the root cause."

  - id: "CA9"
    type: "EXT_CALL"
    lines: [84, 86, 87]
    code: "Burn and transfer in withdraw"
    security_function: "BENIGN"
    rationale: "Withdrawal token operations."

  - id: "CA10"
    type: "EXT_CALL"
    lines: [103]
    code: "IERC20(asset).transfer(onBehalfOf, amount);"
    security_function: "BENIGN"
    rationale: "Simplified borrow transfer."

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [39, 40, 41, 58, 65, 70, 71, 72, 92, 93, 94, 102, 106, 107, 108, 122, 134, 145, 146, 147, 155, 163]
    security_function: "UNRELATED"
    rationale: "Comments and NatSpec"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 7, 8, 9, 10, 11, 13, 15, 16, 18, 19, 20, 21, 22, 23, 24, 25, 26, 28, 29, 31, 32, 33, 34, 35, 37, 42, 43, 44, 45, 46, 47, 73, 74, 75, 76, 77, 78, 89, 95, 96, 97, 98, 99, 100, 101, 109, 110, 111, 112, 113, 114, 115, 116, 117, 143, 148, 154, 156, 158, 159, 160, 161, 162, 164]
    security_function: "UNRELATED"
    rationale: "Declarations and signatures"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [68, 90, 104, 165]
    security_function: "UNRELATED"
    rationale: "Closing braces"

summary:
  total_code_acts: 14
  total_lines_covered: 136

  by_security_function:
    ROOT_CAUSE: 2
    PREREQ: 0
    BENIGN: 8
    UNRELATED: 4

  root_causes:
    - id: "CA1"
      lines: [59, 60, 61, 62]
      description: "LiquidityIndex inflation through repeated deposits"
    - id: "CA2"
      lines: [149, 150, 151, 152]
      description: "Rounding errors in rayDiv at extreme values"

line_to_code_act:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  7: "CA_DECLARATIONS"
  8: "CA_DECLARATIONS"
  9: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  13: "CA_DECLARATIONS"
  15: "CA_DECLARATIONS"
  16: "CA_DECLARATIONS"
  18: "CA_DECLARATIONS"
  19: "CA_DECLARATIONS"
  20: "CA_DECLARATIONS"
  21: "CA_DECLARATIONS"
  22: "CA_DECLARATIONS"
  23: "CA_DECLARATIONS"
  24: "CA_DECLARATIONS"
  25: "CA_DECLARATIONS"
  26: "CA_DECLARATIONS"
  28: "CA_DECLARATIONS"
  29: "CA_DECLARATIONS"
  31: "CA_DECLARATIONS"
  32: "CA_DECLARATIONS"
  33: "CA_DECLARATIONS"
  34: "CA_DECLARATIONS"
  35: "CA_DECLARATIONS"
  # Line 36: empty
  37: "CA_DECLARATIONS"
  39: "CA_COMMENTS"
  40: "CA_COMMENTS"
  41: "CA_COMMENTS"
  42: "CA_DECLARATIONS"
  43: "CA_DECLARATIONS"
  44: "CA_DECLARATIONS"
  45: "CA_DECLARATIONS"
  46: "CA_DECLARATIONS"
  47: "CA_DECLARATIONS"
  48: "CA4"
  50: "CA5"
  53: "CA5"
  54: "CA5"
  55: "CA5"
  56: "CA5"
  58: "CA_COMMENTS"
  59: "CA1"
  60: "CA1"
  61: "CA1"
  62: "CA1"
  63: "CA5"
  65: "CA_COMMENTS"
  66: "CA6"
  67: "CA7"
  68: "CA_SYNTAX"
  70: "CA_COMMENTS"
  71: "CA_COMMENTS"
  72: "CA_COMMENTS"
  73: "CA_DECLARATIONS"
  74: "CA_DECLARATIONS"
  75: "CA_DECLARATIONS"
  76: "CA_DECLARATIONS"
  77: "CA_DECLARATIONS"
  78: "CA_DECLARATIONS"
  # Line 80: empty
  # Line 81: empty
  82: "CA8"
  84: "CA9"
  86: "CA9"
  87: "CA9"
  89: "CA_DECLARATIONS"
  90: "CA_SYNTAX"
  92: "CA_COMMENTS"
  93: "CA_COMMENTS"
  94: "CA_COMMENTS"
  95: "CA_DECLARATIONS"
  96: "CA_DECLARATIONS"
  97: "CA_DECLARATIONS"
  98: "CA_DECLARATIONS"
  99: "CA_DECLARATIONS"
  100: "CA_DECLARATIONS"
  101: "CA_DECLARATIONS"
  102: "CA_COMMENTS"
  103: "CA10"
  104: "CA_SYNTAX"
  106: "CA_COMMENTS"
  107: "CA_COMMENTS"
  108: "CA_COMMENTS"
  109: "CA_DECLARATIONS"
  110: "CA_DECLARATIONS"
  111: "CA_DECLARATIONS"
  112: "CA_DECLARATIONS"
  113: "CA_DECLARATIONS"
  114: "CA_DECLARATIONS"
  115: "CA_DECLARATIONS"
  116: "CA_DECLARATIONS"
  117: "CA_DECLARATIONS"
  118: "CA3"
  119: "CA3"
  120: "CA3"
  122: "CA_COMMENTS"
  123: "CA3"
  124: "CA3"
  125: "CA3"
  126: "CA3"
  127: "CA3"
  128: "CA3"
  129: "CA3"
  130: "CA3"
  131: "CA3"
  132: "CA3"
  134: "CA_COMMENTS"
  136: "CA3"
  137: "CA3"
  138: "CA3"
  139: "CA3"
  140: "CA3"
  141: "CA3"
  142: "CA3"
  143: "CA_DECLARATIONS"
  145: "CA_COMMENTS"
  146: "CA_COMMENTS"
  147: "CA_COMMENTS"
  148: "CA_DECLARATIONS"
  149: "CA2"
  150: "CA2"
  151: "CA2"
  152: "CA2"
  154: "CA_DECLARATIONS"
  155: "CA_COMMENTS"
  156: "CA_DECLARATIONS"
  158: "CA_DECLARATIONS"
  159: "CA_DECLARATIONS"
  160: "CA_DECLARATIONS"
  161: "CA_DECLARATIONS"
  162: "CA_DECLARATIONS"
  163: "CA_COMMENTS"
  164: "CA_DECLARATIONS"
  165: "CA_SYNTAX"

code_act_security_functions:
  CA1: "ROOT_CAUSE"
  CA2: "ROOT_CAUSE"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"

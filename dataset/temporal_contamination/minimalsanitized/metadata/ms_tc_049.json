{
  "sample_id": "ms_tc_049",
  "exploit_name": "Exactly Protocol",
  "timestamp": "2024-08",
  "loss_amount_usd": 12000000,
  "blockchain": "ethereum",
  "vulnerability_type": "oracle_manipulation",
  "sub_category": "malicious_market",
  "severity": "critical",
  "tags": [
    "lending",
    "oracle",
    "debt_previewer",
    "fake_market",
    "user_input_validation",
    "collateral"
  ],
  "difficulty": "expert",
  "temporal_category": "pre_cutoff",
  "cutoff_date": "2024-08",
  "description": "Exactly Protocol lost $12M when attackers exploited the DebtPreviewer helper contract. By providing a malicious market address in the debt calculation, they manipulated their perceived collateral value, allowing over-borrowing far exceeding actual collateral.",
  "vulnerable_lines": [
    40,
    116
  ],
  "vulnerability_details": {
    "root_cause": "DebtPreviewer trusted user-provided market addresses without validation, allowing fake market data injection",
    "attack_vector": "Deploy malicious market returning fake collateral, pass to previewer in borrow check, over-borrow",
    "vulnerable_functions": [
      "previewDebt()",
      "previewMultipleMarkets()",
      "borrow()"
    ],
    "key_weakness": [
      "User-provided market addresses unvalidated",
      "Trusts data from arbitrary contracts",
      "No market whitelist or registry",
      "Batch preview allows mixing real and fake markets",
      "Health factor calculated from manipulated data",
      "Borrow limit check relies on previewer",
      "No sanity checks on collateral values"
    ]
  },
  "attack_flow": [
    "Deploy malicious market contract returning fake data",
    "MaliciousMarket.getAccountSnapshot() returns 1M ETH collateral, 0 debt",
    "Deposit small real collateral: deposit(10 ETH) worth ~$20K",
    "Call borrow with mixed markets array: [realMarket, maliciousMarket]",
    "DebtPreviewer calculates totalCollateral = 10 + 1M = 1,000,010 ETH",
    "Borrow check: maxBorrow = 1M ETH * 80% = 800K ETH allowed",
    "Borrow maximum available liquidity: 5M USDC, 3K ETH, 4M DAI",
    "Total borrowed: ~$12M against $20K real collateral",
    "Transfer borrowed assets to external wallet",
    "Abandon position leaving minimal collateral"
  ],
  "mitigation": [
    "Whitelist approved markets: require(approvedMarkets[market])",
    "Query markets directly from protocol, not external previewer",
    "Integrate trusted price oracle for valuations",
    "Maintain on-chain registry of legitimate markets",
    "Add sanity checks: require(collateralValue < MAX_REASONABLE)",
    "Implement rate limiting per transaction/timeperiod",
    "Two-step verification of debt calculations",
    "Don't allow batch queries mixing multiple markets",
    "Cross-verify calculations through independent methods"
  ],
  "references": [
    "https://twitter.com/ExactlyProtocol",
    "https://etherscan.io/address/0xe097783483D1b7527152eF8B150B99B9B2700c8d"
  ],
  "contract_file": "contracts/ms_tc_049.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "variant_type": "minimalsanitized",
  "variant_parent_id": "tc_049",
  "transformation": {
    "type": "minimal_sanitization",
    "source_dir": "dataset/temporal_contamination/original",
    "source_contract": "dataset/temporal_contamination/original/contracts/tc_049.sol",
    "source_metadata": "dataset/temporal_contamination/original/metadata/tc_049.json",
    "script": "strategies/sanitize/minimal_sanitize.py",
    "changes": [
      "Removed 4 vulnerability comment block(s)",
      "Removed 9 vulnerability hint line(s)"
    ],
    "contract_renames": {},
    "created_date": "2025-12-29T22:32:44.567387"
  },
  "vulnerable_contract": "DebtPreviewer",
  "vulnerable_function": "previewDebt"
}
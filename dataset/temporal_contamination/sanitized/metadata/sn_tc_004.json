{
  "sample_id": "sn_tc_004",
  "exploit_name": "Harvest Finance",
  "date": "2020-10-26",
  "amount_lost_usd": "24000000",
  "blockchain": "ethereum",
  "language": "solidity",
  "vulnerability_type": "price_oracle_manipulation",
  "vulnerability_subtype": "flash_loan_amm_manipulation",
  "severity": "critical",
  "difficulty_tier": 4,
  "is_vulnerable": true,
  "temporal_category": "pre_cutoff",
  "description": "Harvest Finance vault vulnerability where attacker used flash loans to manipulate Curve pool prices, depositing at inflated prices and withdrawing at deflated prices. The vault used spot prices from Curve without TWAP or slippage protection, allowing repeated arbitrage cycles to extract $24M.",
  "vulnerable_contract": "YieldVault",
  "vulnerable_function": "deposit, withdraw",
  "vulnerable_lines": [
    50,
    51,
    69,
    70
  ],
  "attack_scenario": "Attacker takes $50M USDC + $17M USDT flash loans from Uniswap. Swaps USDT->USDC on Curve to inflate USDC price. Deposits 49M USDC into Harvest at inflated price, receiving more fUSDC shares. Swaps USDC->USDT to deflate price. Withdraws fUSDC shares at normal price, receiving more USDC than deposited. Repeats cycle 6 times to amplify profit. Repays flash loans with $24M profit.",
  "root_cause": "The vault calculated share prices using getTotalAssets() which included current balances in Curve pools. These balances could be manipulated via large swaps within a single transaction. The protocol used spot prices instead of time-weighted average prices (TWAP), and had no protection against flash loan manipulation or slippage limits on price changes.",
  "fix_description": "Use Time-Weighted Average Price (TWAP) oracles instead of spot prices from AMMs. Implement deposit/withdrawal fees to make flash loan attacks unprofitable. Add slippage protection on all swaps. Limit maximum deposit/withdrawal amounts per block. Use multiple price sources (Chainlink oracles). Implement commit-reveal pattern for deposits/withdrawals. Add minimum time delay between deposits and withdrawals.",
  "source_reference": "https://github.com/SunWeb3Sec/DeFiHackLabs/blob/main/src/test/2020-10/HarvestFinance_exp.sol",
  "external_references": [
    "https://rekt.news/harvest-finance-rekt/",
    "https://medium.com/harvest-finance/harvest-flashloan-economic-attack-post-mortem-3cf900d65217"
  ],
  "tags": [
    "flash_loan",
    "price_manipulation",
    "oracle",
    "amm",
    "arbitrage",
    "historical"
  ],
  "variant_type": "sanitized",
  "variant_parent_id": "tc_004",
  "notes": "One of the earliest and most significant flash loan price manipulation attacks. Demonstrated that vault protocols cannot safely use AMM spot prices for accounting. The attack was repeated 6 times in rapid succession to maximize profit, showing the attacker's sophistication.",
  "contract_file": "contracts/sn_tc_004.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "transformation": {
    "type": "full_sanitization_from_minimalsanitized",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/minimalsanitized",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/minimalsanitized/contracts/ms_tc_004.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/minimalsanitized/metadata/ms_tc_004.json",
    "original_id": "tc_004",
    "minimalsanitized_id": "ms_tc_004",
    "script": "strategies/sanitize/sanitize_on_minimal_sanitize.py",
    "changes": [
      "Removed comment: Curve...",
      "Removed comment: Curve...",
      "Removed comment: Curve...",
      "Removed comment: Curve...",
      "Removed comment: Curve...",
      "Removed comment: Curve...",
      "Removed comment: Curve...",
      "Removed comment: Curve...",
      "Removed comment: Curve...",
      "Renamed: HarvestVault \u2192 YieldVault",
      "Renamed: ICurvePool \u2192 IStablePool",
      "Renamed: curvePool \u2192 stablePool",
      "Renamed: _curvePool \u2192 _stablePool",
      "Renamed: _investInCurve \u2192 _investInPool",
      "Renamed: _withdrawFromCurve \u2192 _withdrawFromPool",
      "Renamed: curveBalance \u2192 poolBalance"
    ],
    "contract_renames": {
      "HarvestVault": "YieldVault",
      "ICurvePool": "IStablePool",
      "curvePool": "stablePool",
      "_curvePool": "_stablePool",
      "_investInCurve": "_investInPool",
      "_withdrawFromCurve": "_withdrawFromPool",
      "curveBalance": "poolBalance"
    },
    "created_date": "2025-12-31T20:00:31.944705"
  },
  "sanitized_from": "ms_tc_004"
}
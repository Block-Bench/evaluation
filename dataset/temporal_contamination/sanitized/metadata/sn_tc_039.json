{
  "sample_id": "sn_tc_039",
  "exploit_name": "CoW Protocol Callback Exploit",
  "timestamp": "2024-11",
  "loss_amount_usd": 166000,
  "blockchain": "ethereum",
  "vulnerability_type": "access_control",
  "sub_category": "unauthorized_callback",
  "severity": "high",
  "tags": [
    "solver",
    "callback_vulnerability",
    "access_control",
    "uniswap_v3",
    "direct_call",
    "validation_bypass"
  ],
  "difficulty": "advanced",
  "temporal_category": "pre_cutoff",
  "cutoff_date": "2024-11",
  "description": "CoW Protocol's solver contract was exploited for $166K when an attacker directly called the uniswapV3SwapCallback function with crafted parameters. The callback lacked msg.sender validation, allowing anyone to invoke it and extract funds without performing a legitimate swap.",
  "vulnerable_lines": [
    39,
    65,
    67
  ],
  "vulnerability_details": {
    "root_cause": "Missing msg.sender validation in Uniswap V3 callback function, allowing direct external calls",
    "attack_vector": "Directly call uniswapV3SwapCallback with malicious parameters, bypassing swap validation to extract funds",
    "vulnerable_functions": [
      "uniswapV3SwapCallback()"
    ],
    "key_weakness": [
      "No validation that msg.sender is legitimate Uniswap pool",
      "Callback marked as external/public instead of internal",
      "Trusts user-provided addresses in callback data",
      "No access control on sensitive callback",
      "Missing context validation",
      "No reentrancy guards",
      "Lack of swap state verification"
    ]
  },
  "attack_flow": [
    "Identify CowSolver contract with exposed uniswapV3SwapCallback",
    "Craft malicious callback parameters: negative amount0Delta, positive amount1Delta",
    "Encode attacker-controlled addresses in data parameter",
    "Directly call uniswapV3SwapCallback() on solver contract",
    "Contract has no msg.sender validation, processes call",
    "Callback trusts attacker-provided parameters",
    "Contract calculates payment based on manipulated amounts",
    "Withdraws WETH and sends to attacker-specified recipient",
    "Attacker receives ~5.37 WETH (~$166K)",
    "No repayment required since direct call bypassed pool validation"
  ],
  "mitigation": [
    "Validate msg.sender is legitimate Uniswap V3 pool",
    "Maintain whitelist of approved pool addresses",
    "Use Uniswap factory.getPool() to verify pool legitimacy",
    "Implement reentrancy guards",
    "Add access control modifiers to callbacks",
    "Store swap state before initiating, validate in callback",
    "Never trust user-provided addresses in callback data",
    "Make callbacks internal/private when possible",
    "Add emergency pause functionality",
    "Implement maximum transfer limits per callback"
  ],
  "references": [
    "https://x.com/TenArmorAlert/status/1854538807854649791",
    "https://etherscan.io/address/0x9008d19f58aabd9ed0d60971565aa8510560ab41"
  ],
  "contract_file": "contracts/sn_tc_039.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "variant_type": "sanitized",
  "variant_parent_id": "tc_039",
  "transformation": {
    "type": "full_sanitization_from_minimalsanitized",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/minimalsanitized",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/minimalsanitized/contracts/ms_tc_039.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/minimalsanitized/metadata/ms_tc_039.json",
    "original_id": "tc_039",
    "minimalsanitized_id": "ms_tc_039",
    "script": "strategies/sanitize/sanitize_on_minimal_sanitize.py",
    "changes": [
      "Renamed: CowSolver \u2192 BatchSolver"
    ],
    "contract_renames": {
      "CowSolver": "BatchSolver"
    },
    "created_date": "2025-12-31T20:00:32.279601"
  },
  "vulnerable_contract": "BatchSolver",
  "vulnerable_function": "uniswapV3SwapCallback",
  "sanitized_from": "ms_tc_039"
}